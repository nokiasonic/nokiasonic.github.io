<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Obsidian学习（一）</title>
    <url>/2021/09/27/Obsidian%E5%AD%A6%E4%B9%A0%EF%BC%88%E4%B8%80%EF%BC%89/</url>
    <content><![CDATA[<h1 id="背景">背景</h1>
<p>最近对[[【知识管理】Zettelkasten笔记法|Zettelkasten笔记法]]进行学习，也在学习过程中了解到了<code>Obsidian</code>, 它可以帮助人们高效地建立适合自己的知识管理体系。所以在梳理整合自己知识体系的同时，也同步进行了<code>Obsidian</code>的学习。</p>
<a id="more"></a>
<h1 id="obsidian是什么">Obsidian是什么？</h1>
<p><code>Obsidian</code>是什么？正如其<a href="https://obsidian.md/">Obsidian官网</a>宣称的</p>
<blockquote>
<p>Obsidian is a powerful knowledge base that works on top of<br />
a local folder of plain text Markdown files.</p>
</blockquote>
<p>从字里行间我们可以了解到，它是基于<strong>Markdown文件</strong>的<strong>本地</strong>知识管理软件，它的特点可以归纳为: - 本地化 - 基于<code>markdown</code> - 知识管理 第三个特点就决定了它与<code>Typora</code>等markdown编辑器有了本质的区别，它是如何体现出它强大的知识管理能力来呢？</p>
<h1 id="为什么要选择obsidian">为什么要选择Obsidian?</h1>
<h2 id="个人用户免费">个人用户免费</h2>
<p>目前类似的<code>Roam Research</code>等软件收费颇高，像<code>Obsidian</code>如此良心的软件并不多见。<br />
<img src="https://s2.loli.net/2022/04/14/1xH7cp8lkfL2eq4.png" /></p>
<h2 id="数据本地化">数据本地化</h2>
<p><code>Obsidian</code>很好地保护了自己笔记内容的隐私，而其它笔记软件多由于采用数据库方式来管理笔记，一般使用上传内容至服务提供商的方式来实现，而<code>Obsidian</code>使用所谓的<code>库</code>,实际上就是基于文件夹的方式，建立不同的库，可以使用各自的主题，插件，非常方便。使用本地化结构的知识管理系统，最大的优点在于不依赖于工具软件本身，就算有朝一日，决定不用<code>Obsidian</code>,也可以很容易地将自己的知识管理体系进行迁移。</p>
<h2 id="与其它软件的联动较强">与其它软件的联动较强</h2>
<p>可以与<code>Zotero</code>联动实现文献管理互动，可以与<code>logseq</code>联动实现日程管理等等，总而言之，通过有效地使用工具，高效地提升自己的知识管理能力及执行能力。</p>
<h2 id="良好生态的社区环境与丰富的插件">良好生态的社区环境与丰富的插件</h2>
<p><code>Obsidian</code>的社区生态良好，开发了许多实用的第三方插件。</p>
<p><a href="https://forum.obsidian.md/">Obsidian英文社区</a> <a href="https://forum-zh.obsidian.md/">Obsidian中文社区</a> 在软件设置里的<code>社区插件</code>中关闭<code>安全模式</code>后，可以安装自己需要的插件。</p>
<h2 id="优秀的移动端体验">优秀的移动端体验</h2>
<p>在<code>android</code>和<code>ios</code>下都有APP可以安装使用。</p>
<h1 id="obsidian能做什么">Obsidian能做什么？</h1>
<h2 id="撰写技术文章">撰写技术文章</h2>
<p>对于一直习惯用markdown方式来写技术文章的人，<code>Obsidian</code>也提供了不亚于<code>Typora</code>的写作体验。</p>
<h2 id="计划">计划</h2>
<p>例如日清单，工作计划等都可以使用或通过<code>Obsidian</code>及其插件进行。</p>
<h2 id="读书笔记">读书笔记</h2>
<p>以前一直是用<code>Notion</code>来作读书笔记，但相对于把思绪集中在写作内容上，<code>Notion</code>会花费相对多的时间来进行版面的设计。而使用markdown方式的便利性在使用<code>Obsidian</code>的过程中就得到了体现。</p>
<h2 id="双向链接与知识图谱">双向链接与知识图谱</h2>
<p>这也是目前流行的笔记推崇的概念，目的是把头脑里杂乱无章的知识网状化，系统化。</p>
<h1 id="写在最后">写在最后</h1>
<p>无论工具多么先进，最终还是要看执行的人是否真正把关注点放在工具要解决的事务上，而非纠缠、沉溺于工具本身。 希望通过<code>Obsidian</code>学习的同时，也为自己初步建立一个适合自己的知识管理体系。</p>
]]></content>
      <categories>
        <category>专栏</category>
      </categories>
      <tags>
        <tag>Obsidian/学习</tag>
      </tags>
  </entry>
  <entry>
    <title>Obsidian学习（二）</title>
    <url>/2021/10/09/Obsidian%E5%AD%A6%E4%B9%A0%EF%BC%88%E4%BA%8C%EF%BC%89/</url>
    <content><![CDATA[<h1 id="安装">安装</h1>
<p>通过<a href="%5BObsidian%5D(https://obsidian.md/)">官网</a>下载并安装程序。 安装完后，可以在<code>Settings</code> -&gt; <code>About</code> -&gt; <code>Language</code>中选择界面语言，我还是使用英文界面，方便对接英文论坛内容。</p>
<a id="more"></a>
<h1 id="第一条笔记">第一条笔记</h1>
<h2 id="创建新笔记库">创建新笔记库</h2>
<p>打开<code>obsidian</code>, 可以选择从已有目录创建笔记库，也可以直接创建新笔记库，这里的库是基于目录来进行识别的。</p>
<p><img src="https://s2.loli.net/2022/04/14/XuLUyqm5jNVHEJ2.png" /></p>
<h2 id="创建知识管理库结构">创建知识管理库结构</h2>
<p>根据自己的实践需要来建立知识管理库结构，示例：[[我的笔记系统结构]]</p>
<p><img src="https://s2.loli.net/2022/11/16/Ctgh49XyrTA5evU.png" /></p>
<p>这时，在整个库里只有这些目录，在其下是空空如也的。</p>
<h2 id="写第一条笔记">写第一条笔记</h2>
<p>比如撰写<code>中国图书馆分类法</code>条目来作为自己的第一条笔记。</p>
<p><img src="https://s2.loli.net/2022/11/16/PazNvy5nji1GCWZ.png" /></p>
<p>有两种方式来新建一条笔记：</p>
<ol type="1">
<li>点击界面上的<code>Create new file</code>或者使用快捷键<code>Ctrl + N</code>;</li>
<li>点击左侧导航栏处的<code>New note</code>图标。</li>
</ol>
<p>我们在目录<code>01. 闪念笔记</code>下来新建一个名为<code>中国图书馆分类法.md</code>的文件。使用<code>markdown</code>的语法写作内容。</p>
<p><img src="https://s2.loli.net/2022/11/16/4SfdovVqRcatAI2.png" /></p>
<p>屏幕右上角红框处，按住<code>Ctrl</code>键并点击，可以生成一个新的分栏来进行预览。如果只是点击，则是在编辑和预览状态间切换。</p>
<p><img src="https://s2.loli.net/2022/04/14/LNdmnoOMlEhK1vJ.png" /></p>
<p>从<code>ZettleKasten</code>笔记记录的角度来说，需要为每一篇笔记编一个能唯一识别的号码，我们可以在<code>Metadata(元数据)</code>中来增加<code>uid</code>项来实现，同时为了方便归类，也增加<code>cid（classification number）</code>,这可以根据汉语主题词表来进行定义。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">title: 中国图书馆分类法</span><br><span class="line">date: 2021-10-09 22:38:24</span><br><span class="line">uid: 20211009223824</span><br><span class="line">cid: G254.122.001</span><br><span class="line">categories: [知识管理]</span><br><span class="line">tags: [图书馆分类法&#x2F;中图法]</span><br><span class="line">---</span><br></pre></td></tr></table></figure>
<p>可以以此为依据，在<code>obsidian</code>中建立模板，方便撰写新笔记时直接插入。 1. 在<code>Core plugins</code>里启用<code>Templates</code>插件 2. 需要在 <code>Settings</code> -&gt; <code>Templates</code> -&gt; <code>Template folder location</code> 中指定模板文件夹的路径。 3. 在左边导航栏中点击<code>Insert template</code>或者为这功能设置一个快捷键，这里我设为<code>Ctrl + Q</code>。在写新笔记时就可以插入相应的模板内容。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">title: &#123;&#123;title&#125;&#125;</span><br><span class="line">date: &#123;&#123;date:YYYY-MM-DD HH:mm:ss&#125;&#125;</span><br><span class="line">uid: &#123;&#123;date:YYYYMMDDHHmmss&#125;&#125;</span><br><span class="line">cid: xxxx.xxxx.xxx</span><br><span class="line">categories: [xxxx]</span><br><span class="line">tags: [xxxx&#x2F;xxx]</span><br><span class="line">---</span><br></pre></td></tr></table></figure>
<p>至此，第一个笔记已经顺利完成，可以移入分类目录中使用。</p>
<h1 id="学习小结">学习小结</h1>
<ol type="1">
<li>熟悉<code>obsidian</code>的基本界面操作。</li>
<li>模板的配置及使用。</li>
</ol>
]]></content>
      <categories>
        <category>专栏</category>
      </categories>
      <tags>
        <tag>Obsidian/学习</tag>
      </tags>
  </entry>
  <entry>
    <title>docker创建的vhdx文件无法移动或删除</title>
    <url>/2020/12/23/docker%E5%88%9B%E5%BB%BA%E7%9A%84vhdx%E6%96%87%E4%BB%B6%E6%97%A0%E6%B3%95%E7%A7%BB%E5%8A%A8%E6%88%96%E5%88%A0%E9%99%A4/</url>
    <content><![CDATA[<p>操作系统为win10 professional,由于开始使用docker时没有及时调整img存放的位置，导致C盘空间被耗尽。所以决定迁移img至数据盘。但在通过dockerdeskto setting更改存储位置时，发生了异常，没有完全执行成功。初次重启后无法正常启动docker。</p>
<p><img src="https://s2.loli.net/2022/04/14/jYHEVXgAFdQ96tk.png" /></p>
<p>再次重启后发现原有的vhdx文件没有被迁移至指定的位置， 且无法拷贝，移动或删除，提示无管理员权限。</p>
<a id="more"></a>
<p>处理过程如下：</p>
<ol type="1">
<li>开启本机Administrator账户：</li>
</ol>
<p>​ 快捷键Win + X, 计算机管理 - 系统工具 - 本地用户和组 - 用户， 右键选择"Administrator"属性，取消勾选“账户已禁用”，重启计算机， 然后选择Administrator账号登录即可。</p>
<p>​ 但是在尝试拷贝及移动vhdx文件时，仍然提示权限不够。没有解决该问题</p>
<ol start="2" type="1">
<li><p>恢复docker desktop为出厂设置</p>
<p>点击右上“troubleshooting”图标，选择恢复出厂设置</p></li>
</ol>
<p><img src="https://s2.loli.net/2022/04/14/32rOyojniPdGg1E.png" /> 重启后， docker及内部的容器都运行正常，再次尝试改变存储位置。这次运行成功， vhdx文件正常迁移到设定目标位置，且 docker及内部的容器都运行正常。问题得以解决，判断是首次操作时出现异常，导致文件迁移未完成且处于死锁状态。</p>
]]></content>
      <categories>
        <category>技术笔记</category>
        <category>docker</category>
      </categories>
      <tags>
        <tag>docker</tag>
        <tag>hyper-v</tag>
      </tags>
  </entry>
  <entry>
    <title>欢迎来到我的博客</title>
    <url>/2020/11/19/hello-world/</url>
    <content><![CDATA[<h2 id="橘子的博客终于开通了">橘子的博客终于开通了</h2>
<p>一直偷懒，最近终于良心发现，总觉以前的光阴虚度，不想未来同样蹉跎岁月，自当奋起，希望能记录下未来成长过程中的点点滴滴想法和经验。</p>
<p>借词聊表胸怀</p>
<blockquote>
<p><font color=green><strong>江城子·密州出猎</strong></font><br />
<font color=blue><strong>宋 苏轼</strong></font></p>
<p>老夫聊发少年狂， 左牵黄，右擎苍， 锦帽貂裘，千骑卷平冈。 为报倾城随太守，亲射虎，看孙郎。</p>
<p>酒酣胸胆尚开张， 鬓微霜，又何妨! 持节云中，何日遣冯唐? 会挽雕弓如满月，西北望，射天狼。</p>
</blockquote>
<h2 id="本站用途">本站用途</h2>
<p>这是个人用来学习研究金融工程，机器学习的小窝，</p>
]]></content>
      <categories>
        <category>美好生活</category>
      </categories>
      <tags>
        <tag>随笔</tag>
      </tags>
  </entry>
  <entry>
    <title>tqdm进度条的使用</title>
    <url>/2020/12/23/tqdm%E8%BF%9B%E5%BA%A6%E6%9D%A1%E7%9A%84%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<p>以前使用的是processbar来制作进度条， 听闻tqdm性能更好些，遂尝试使用一下。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> tqdm(total=<span class="built_in">len</span>(codelist),<span class="built_in">ascii</span>= <span class="literal">True</span>, ncols=<span class="number">90</span>,colour=<span class="string">&quot;green&quot;</span>) <span class="keyword">as</span> pbar:</span><br><span class="line">    <span class="keyword">for</span> ts_code <span class="keyword">in</span> codelist:</span><br><span class="line">        pbar.set_description(<span class="string">&quot;Processing %s&quot;</span> % ts_code)</span><br><span class="line">        ......</span><br><span class="line">        pbar.update(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p><img src="https://s2.loli.net/2022/04/14/DJqSNL69eTsIZKP.png" /> 参数使用：</p>
<p><code>ascii = True</code>, 缺省是<code>False</code>, 当使用它时，不是以正常块状来做进度条，而是以"123456789#"的方式。</p>
<p><code>ncols = 90</code>, 这里可以根据屏幕大小来进行控制，保证进度条不产生换行的情况。</p>
<p><code>colour = "green"</code>, 在版本4.5之后引入，可以设置进度条的颜色。</p>
<p><code>desc</code>或利用<code>set_desciption</code>，用来设置进度条左侧的文字信息。</p>
<p>从使用情况来看，还是比较令人满意的。</p>
]]></content>
      <categories>
        <category>技术笔记</category>
        <category>python</category>
      </categories>
      <tags>
        <tag>python</tag>
        <tag>tqdm</tag>
      </tags>
  </entry>
  <entry>
    <title>【Arduino】ESP8266开发实例</title>
    <url>/2021/08/23/%E3%80%90Arduino%E3%80%91ESP8266%E5%BC%80%E5%8F%91%E5%AE%9E%E4%BE%8B/</url>
    <content><![CDATA[<h1 id="esp8266的arduino开发环境搭建">ESP8266的Arduino开发环境搭建</h1>
<p>有三种常用的环境搭建方法。</p>
<a id="more"></a>
<h2 id="arduino下的工具的开发板管理器进行在线下载">1. Arduino下的工具的开发板管理器进行在线下载</h2>
<p>步骤：</p>
<p>1/ 首先添加ESP8266板支持</p>
<p>进入<code>首选项（Preferences）</code>，找到<strong>附加开发板管理器地址</strong>（Additional Board Manager URLs），并在其后添加如下信息：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;arduino.esp8266.com&#x2F;stable&#x2F;package_esp8266com_index.json</span><br></pre></td></tr></table></figure>
<p><img src="https://s2.loli.net/2022/04/14/SlmziK2rfdvZqUV.png" /> 2/ 安装硬件包</p>
<p>点击<code>工具 - 开发板 - 开发板管理器</code>，进入开发板管理器界面： 在搜索栏上面输入<code>ESP8266</code>，选择最新版本点击“安装”，</p>
<p><img src="https://s2.loli.net/2022/04/14/OUyNpZagnAS8LYt.png" /></p>
<h2 id="下载esp8266的硬件包再离线安装">2. 下载ESP8266的硬件包再离线安装</h2>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd E:</span><br><span class="line">mkdir esp8266</span><br><span class="line">cd esp8266</span><br><span class="line">git clone https://github.com/esp8266/Arduino.git esp8266</span><br></pre></td></tr></table></figure>
<p>当clone完毕后，在esp8266文件夹下会有板级工具包的目录。进入tools，运行get.py的python文件</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd tools</span><br><span class="line">python get.py</span><br></pre></td></tr></table></figure>
<p><img src="https://s2.loli.net/2022/04/14/FVAK9NDlw3Bga8G.png" /></p>
<h2 id="直接使用封装好的esp8266-sdk进行环境配置">3. 直接使用封装好的ESP8266 SDK进行环境配置</h2>
<p><strong>点击下方链接下载打包好的esp8266安装包，选择任一版本直接运行并解压即可。</strong></p>
<p><a href="https://docs.espressif.com/projects/esp8266-rtos-sdk/en/latest/get-started/windows-setup.html">安装说明</a></p>
<p>无论使用何种方法，只要可以在Arduino IDE中可以看到ESP8266的开发板，开发环境就算搭建好了。可以开始进行开发和学习过程了。</p>
<h1 id="制作一支带逗比功能的笔">制作一支带逗比功能的笔</h1>
<p><img src="https://s2.loli.net/2022/04/14/skItQylPxZMd1A4.png" /></p>
<h2 id="材料准备">材料准备</h2>
<ul>
<li><p>9g舵机3个</p></li>
<li><p>白板笔1支</p></li>
<li><p>NodeMcu ESP8266开发板一块</p></li>
<li><p>舵机拉杆 1.2MM Z字钢丝</p></li>
<li><p>M3x3 平头螺丝若干</p></li>
<li><p>M3 螺母若干</p></li>
<li><p>M3x12 螺丝若干</p></li>
<li><p>M3x6 对接螺丝若干</p></li>
<li><p>亚克力激光切割零件一批</p></li>
<li><p>3D打印笔架与笔帽</p>
<p><img src="https://s2.loli.net/2022/04/14/soLHUcnrTdX6tJV.jpg" /></p></li>
</ul>
<h2 id="制作步骤">制作步骤</h2>
<h3 id="组装">组装</h3>
<ul>
<li><p>左右舵机安装</p>
<p>舵机与板件通过舵机自带的M2螺丝固定（红色框部分），板件中间位置的连接用M3螺丝加螺母固定（橙色框部分）</p>
<p><img src="https://s2.loli.net/2022/04/14/6yFYisQTmX7cRzh.jpg" /></p></li>
<li><p>四杆机械臂安装</p>
<p>将机械臂所需的板件与舵机自带的连接杆粘合，并用M4x10的螺丝加螺母固定（推荐使用M3x6的对接螺丝）。</p>
<p><img src="https://s2.loli.net/2022/04/14/iTMAkhdEWFwo1cY.jpg" /></p>
<p><img src="https://s2.loli.net/2022/04/14/kt8eYSvEh4n7MjC.jpg" /></p>
<p><img src="https://s2.loli.net/2022/04/14/LPAVYJ4NuykgXj8.jpg" /></p>
<p>在舵机调式完毕后，用M2.5x10的螺丝将机械臂固定至舵机上。这里如果有较长的M2螺丝效果会更好一些，舵机自带的M2螺丝稍短了一点。</p></li>
<li><p>上舵机安装</p></li>
</ul>
<p>​ 上龙门架用M3x12的螺丝加螺母连接，舵机与板件用自带的M2螺丝固定</p>
<p>​ <img src="https://s2.loli.net/2022/04/14/9Gqe5czBoAVfwrd.jpg" style="zoom: 50%;" /></p>
<h3 id="esp8266的调试">ESP8266的调试</h3>
<p>将<code>arduinojson5</code>和<code>NTPclient</code>添加到<code>arduino libraries</code>中。</p>
<p><img src="https://s2.loli.net/2022/04/14/Uqh5SKYiDC13XBz.png" /></p>
<p>利用ESP8266自带示例ESP8266-blink及ESP8266WiFi-NTPClient进行测试，ESP8266模块工作正常</p>
<p><img src="https://s2.loli.net/2022/04/14/kHKoFntirpLq1dy.png" /></p>
<p>从无线路由器的用户列表中也可以看到ESP8266确实已经连接成功。</p>
<p><img src="https://s2.loli.net/2022/04/14/b864MIBAxspHUGd.png" /></p>
<h3 id="esp8266与舵机的联调">ESP8266与舵机的联调</h3>
<p>通过坐标的变化来控制笔的行进与书写。</p>
<p>坐标参数的定义如下：</p>
<p><img src="https://s2.loli.net/2022/04/14/pd5rowaAsv19BDJ.jpg" /></p>
<p>打开程序上传代码成功后，左右臂舵机会左右来回旋转，请注意舵机的旋转方向，并在最左或最右时迅速拔掉供电的USB。断电停机后再安装摆臂。摆臂的安装位置，如下图，最左是灰色，最右是白色，让摆臂尽量停留在0,90,180度位置上。安装好摆臂后，接电继续工作，看舵机是否是在灰色和白色两个位置上往复。差距小时，可以修改程序中下面的4个参数修正，差距太大，请拆掉摆臂重装。</p>
<p><img src="https://s2.loli.net/2022/04/14/sUcuHKakiX4MRFf.png" /></p>
<p><code>control.h</code>,原始代码中垂直方向共用<code>SERVOFAKTOR</code>来控制，在微调的时候发现效果不好，分别使用<code>SERVOFAKTORLEFT</code>和<code>SERVOFAKTORRIGHT</code>来控制。</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">  <span class="comment">// When in calibration mode, adjust the following factor until the servos move exactly 90 degrees</span></span><br><span class="line"><span class="keyword">int</span> SERVOFAKTORLEFT = <span class="number">605</span>;</span><br><span class="line"><span class="keyword">int</span> SERVOFAKTORRIGHT = <span class="number">1090</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Zero-position of left and right servo</span></span><br><span class="line">  <span class="comment">// When in calibration mode, adjust the NULL-values so that the servo arms are at all times parallel</span></span><br><span class="line">  <span class="comment">// either to the X or Y axis</span></span><br><span class="line"><span class="keyword">int</span> SERVOLEFTNULL = <span class="number">2000</span>;</span><br><span class="line"><span class="keyword">int</span> SERVORIGHTNULL = <span class="number">800</span>;</span><br></pre></td></tr></table></figure>
<p>相应地，在<code>control.cpp</code>中，修改</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">servo_left.writeMicroseconds(<span class="built_in">floor</span>(((a2 + a1 - M_PI) * SERVOFAKTOR) + SERVOLEFTNULL));</span><br><span class="line">servo_right.writeMicroseconds(<span class="built_in">floor</span>(((a1 - a2) * SERVOFAKTOR) + SERVORIGHTNULL)); </span><br></pre></td></tr></table></figure>
<p>为</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">servo_left.writeMicroseconds(<span class="built_in">floor</span>(((a2 + a1 - M_PI) * SERVOFAKTORLEFT) + SERVOLEFTNULL));</span><br><span class="line">servo_right.writeMicroseconds(<span class="built_in">floor</span>(((a1 - a2) * SERVOFAKTORRIGHT) + SERVORIGHTNULL));</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>调节抬臂舵机的写字，抬笔和抓笔擦位置，。将笔装上后再进行调试，否则因为笔的重量会导致偏差。</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">int</span> LIFT0 = <span class="number">1750</span>;   <span class="comment">//落笔写字 on drawing surface</span></span><br><span class="line"><span class="keyword">int</span> LIFT1 = <span class="number">1650</span>;   <span class="comment">//写字时抬臂动作 between numbers</span></span><br><span class="line"><span class="keyword">int</span> LIFT2 = <span class="number">1470</span>;   <span class="comment">//高抬笔架  going towards sweeper</span></span><br></pre></td></tr></table></figure>
<h3 id="工作原理">工作原理</h3>
<p>xy坐标到舵机角度转换</p>
<p><img src="https://s2.loli.net/2022/04/14/KMlaAFi2m3Ngzkn.png" /></p>
<h2 id="演示">演示</h2>
<p>制作完成！</p>
<p><a href="https://www.bilibili.com/video/BV1r64y1a76r/">制作及演示视频</a></p>
<h1 id="参考">参考</h1>
<p>1/ <a href="https://zhuanlan.zhihu.com/p/67700105">如何制作一支带逗比功能的笔 - 知乎 (zhihu.com)</a></p>
<p>2/ <a href="https://www.amobbs.com/thread-5687693-1-1.html">用stc15w4k32移植arduino小贱钟Plotclock (amobbs.com 阿莫电子论坛)</a></p>
<p>3/ <a href="https://www.geek-workshop.com/thread-10024-1-1.html">Plotclock小贱钟的调试方法 - 机械坊 - 极客工坊 - Powered by Discuz! (geek-workshop.com)</a></p>
]]></content>
      <categories>
        <category>技术笔记</category>
        <category>arduino</category>
      </categories>
      <tags>
        <tag>arduino</tag>
        <tag>ESP8266</tag>
      </tags>
  </entry>
  <entry>
    <title>【Hexo】Next主题更好地支持LaTeX数学公式</title>
    <url>/2020/12/17/%E3%80%90Hexo%E3%80%91Next%E4%B8%BB%E9%A2%98%E6%9B%B4%E5%A5%BD%E5%9C%B0%E6%94%AF%E6%8C%81LaTeX%E6%95%B0%E5%AD%A6%E5%85%AC%E5%BC%8F/</url>
    <content><![CDATA[<p>在Typora中可以正常显示的<span class="math inline">\(L^AT_EX\)</span>数学公式，在Hexo NexT主题下却渲染得不是太理想。我们去最新的<a href="https://theme-next.js.org/docs/third-party-services/math-equations.html">NexT官方文档</a>里看看如何解决吧！</p>
<a id="more"></a>
<h2 id="实施步骤">实施步骤</h2>
<p>NexT主题现在提供两种数学公式的渲染方式 <a href="https://www.mathjax.org/">MathJax</a> 及 <a href="https://katex.org/">KaTeX</a>。其中<code>katex</code>的速度更快，但是对于<span class="math inline">\(L^AT_EX\)</span>的支持有一定的限制。所以除非你的博客数量实在是过于庞大，不然就可以直接使用<code>mathjax</code>。</p>
<p>使用<code>mathjax</code>，可以选择多种渲染引擎，但推荐使用</p>
<ul>
<li><a href="https://github.com/wzpan/hexo-renderer-pandoc">hexo-renderer-pandoc</a></li>
</ul>
<p>使用其它诸如<a href="https://github.com/hexojs/hexo-renderer-marked">hexo-renderer-marked</a>之类的引擎（这是Hexo默认首先用来渲染MarkDown的），然后再交给<code>mathjax</code>渲染。<code>hexo-renderer-marked</code>会把一些特殊的MarkDown符号转换为相应的html标签，比如在MarkDown语法中，下划线 _ 代表斜体，会被转化为&lt; em&gt;标签，\也会被转义成一个。而类<span class="math inline">\(L^AT_EX\)</span>格式书写的数学公式下划线 _ 表示角标，\表示公式换行，有特殊的含义，所以<code>mathjax</code>引擎在渲染数学公式的时候就会无法正常渲染。</p>
<h3 id="安装pandoc">安装pandoc</h3>
<p><a href="https://github.com/jgm/pandoc/blob/master/INSTALL.md">安装文档</a>及<a href="https://github.com/jgm/pandoc/releases/latest">下载链接</a>]，因为在安装<code>Anaconda</code>时已经含有pandoc。这里不再单独进行安装。</p>
<h3 id="配置next">配置NexT</h3>
<ol type="1">
<li>首先，在NexT主题配置文件中将<code>mathjax</code>设为渲染引擎</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">math:</span></span><br><span class="line">  <span class="string">...</span></span><br><span class="line">  <span class="attr">mathjax:</span></span><br><span class="line">    <span class="attr">enable:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<ol start="2" type="1">
<li>然后，卸载最初的<code>hexo-renderer-marked</code>引擎并安装<code>hexo-renderer-pandoc</code>。</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> npm un hexo-renderer-marked</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> npm i hexo-renderer-pandoc</span></span><br></pre></td></tr></table></figure>
<p><img src="https://s2.loli.net/2022/04/14/LcFgNREOrmaQWsS.png" /></p>
<ol start="3" type="1">
<li>在更换完渲染引擎后，执行一下<code>hexo clean</code>，然后再进行部署或启动本地服务器来验证渲染是否工作正常。</li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> hexo clean &amp;&amp; hexo g -d</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> or hexo clean &amp;&amp; hexo s</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>技术笔记</category>
        <category>博客</category>
      </categories>
      <tags>
        <tag>Hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>【Hexo】Next主题标题颜色设置</title>
    <url>/2020/12/10/%E3%80%90Hexo%E3%80%91Next%E4%B8%BB%E9%A2%98%E6%A0%87%E9%A2%98%E9%A2%9C%E8%89%B2%E8%AE%BE%E7%BD%AE/</url>
    <content><![CDATA[<p>主题采用的是Next的Mist。 不太喜欢全部都是黑灰白色的主基调，希望将标题来点明亮的颜色。以下来介绍具体的配置方法。</p>
<a id="more"></a>
<h2 id="更改标题配色">更改标题配色</h2>
<p>找到<code>\themes\next\source\css\_common\outline\header\site-meta.styl</code>文件。编辑修改<code>.brand&#123;&#125;</code>里<code>color</code>参数配置</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.brand</span> &#123;</span><br><span class="line">  <span class="attribute">border-bottom</span>: none;</span><br><span class="line">//  color: var(--brand-color);</span><br><span class="line">  <span class="selector-tag">color</span>: <span class="selector-id">#fc6423</span> !<span class="selector-tag">important</span>;</span><br><span class="line">  <span class="selector-tag">display</span>: <span class="selector-tag">inline-block</span>;</span><br><span class="line">  line-height: $font-size-title;</span><br><span class="line">  <span class="selector-tag">padding</span>: 0 40<span class="selector-tag">px</span>;</span><br><span class="line">  <span class="selector-tag">position</span>: <span class="selector-tag">relative</span>;</span><br><span class="line"></span><br><span class="line">  &amp;<span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: <span class="built_in">var</span>(--brand-hover-color);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="更改标题上下横线配色">更改标题上下横线配色</h2>
<p>找到<code>\themes\next\source\css\_schemes\Mist\_header.styl</code>。编辑修改<code>i&#123;&#125;</code>里的<code>background</code>参数配置</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"> <span class="selector-tag">i</span> &#123;</span><br><span class="line">   //background: var(--brand-color);</span><br><span class="line"><span class="selector-tag">background</span>: <span class="selector-id">#fc6423</span> !<span class="selector-tag">important</span>;</span><br><span class="line">   <span class="selector-tag">display</span>: <span class="selector-tag">block</span>;</span><br><span class="line">   <span class="selector-tag">height</span>: 2<span class="selector-tag">px</span>;</span><br><span class="line">   <span class="selector-tag">position</span>: <span class="selector-tag">relative</span>;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>技术笔记</category>
        <category>博客</category>
      </categories>
      <tags>
        <tag>Hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>【Hexo】美化表格</title>
    <url>/2020/12/09/%E3%80%90Hexo%E3%80%91%E7%BE%8E%E5%8C%96%E8%A1%A8%E6%A0%BC/</url>
    <content><![CDATA[<p>通过jupyter notebook导出的markdown文件中的表格过于丑陋，遂尝试对生成的表格内容进行美化。</p>
<a id="more"></a>
<h2 id="步骤">步骤</h2>
<h3 id="创建自定义的css文件">创建自定义的CSS文件</h3>
<p>在<code>themes/next/source/css/main.styl</code>中添加一行内容。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">@import <span class="string">&quot;_custom/custom&quot;</span></span><br></pre></td></tr></table></figure>
<p>然后在<code>themes/next/source/css</code>目录下创建<code>_custom</code>文件夹。再进入该文件夹创建名为custom.styl的文件， 用它来配置自己需要的CSS样式。</p>
<h3 id="基本样式">基本样式</h3>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">table</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100%</span>; <span class="comment">/*表格宽度*/</span></span><br><span class="line">    <span class="attribute">max-width</span>: <span class="number">65em</span>; <span class="comment">/*表格最大宽度，避免表格过宽*/</span></span><br><span class="line">    <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#dedede</span>; <span class="comment">/*表格外边框设置*/</span></span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">15px</span> auto; <span class="comment">/*外边距*/</span></span><br><span class="line">    <span class="attribute">border-collapse</span>: collapse; <span class="comment">/*使用单一线条的边框*/</span></span><br><span class="line">    <span class="attribute">empty-cells</span>: show; <span class="comment">/*单元格无内容依旧绘制边框*/</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-tag">table</span> <span class="selector-tag">th</span>,</span><br><span class="line"><span class="selector-tag">table</span> <span class="selector-tag">td</span> &#123;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">25px</span>; <span class="comment">/*统一每一行的默认高度*/</span></span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">10px</span>;  <span class="comment">/*行内字符大小*/</span></span><br><span class="line">  <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#dedede</span>; <span class="comment">/*内部边框样式*/</span></span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">0</span> <span class="number">10px</span>; <span class="comment">/*内边距*/</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="表头样式">表头样式</h3>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">table</span> <span class="selector-tag">th</span> &#123;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">10px</span>;  <span class="comment">/*表头字符大小*/</span></span><br><span class="line">    <span class="attribute">font-weight</span>: bold; <span class="comment">/*加粗*/</span></span><br><span class="line">    <span class="attribute">text-align</span>: center <span class="meta">!important</span>; <span class="comment">/*内容居中，加上 !important 避免被 Markdown 样式覆盖*/</span></span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">158</span>,<span class="number">188</span>,<span class="number">226</span>,<span class="number">0.2</span>); <span class="comment">/*背景色*/</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="示例">示例</h3>
<table>
<thead>
<tr class="header">
<th></th>
<th></th>
<th>open</th>
<th>high</th>
<th>low</th>
<th>close</th>
<th>volume</th>
<th>amount</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>date</td>
<td>code</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="even">
<td>2020-11-16</td>
<td>000001</td>
<td>17.08</td>
<td>17.43</td>
<td>16.90</td>
<td>17.37</td>
<td>759856.0</td>
<td>1.308190e+09</td>
</tr>
<tr class="odd">
<td></td>
<td>000002</td>
<td>29.39</td>
<td>29.50</td>
<td>29.00</td>
<td>29.20</td>
<td>516576.0</td>
<td>1.509810e+09</td>
</tr>
<tr class="even">
<td></td>
<td>000004</td>
<td>31.15</td>
<td>31.46</td>
<td>30.11</td>
<td>30.61</td>
<td>72456.0</td>
<td>2.223127e+08</td>
</tr>
<tr class="odd">
<td></td>
<td>000005</td>
<td>2.68</td>
<td>2.70</td>
<td>2.65</td>
<td>2.69</td>
<td>64372.0</td>
<td>1.725762e+07</td>
</tr>
<tr class="even">
<td></td>
<td>000006</td>
<td>5.66</td>
<td>5.74</td>
<td>5.62</td>
<td>5.72</td>
<td>98253.0</td>
<td>5.592563e+07</td>
</tr>
<tr class="odd">
<td></td>
<td>000007</td>
<td>9.42</td>
<td>9.42</td>
<td>9.18</td>
<td>9.20</td>
<td>22567.0</td>
<td>2.094628e+07</td>
</tr>
<tr class="even">
<td></td>
<td>000008</td>
<td>2.72</td>
<td>2.74</td>
<td>2.70</td>
<td>2.73</td>
<td>171930.0</td>
<td>4.678304e+07</td>
</tr>
<tr class="odd">
<td></td>
<td>000009</td>
<td>7.71</td>
<td>7.88</td>
<td>7.66</td>
<td>7.82</td>
<td>320180.0</td>
<td>2.492149e+08</td>
</tr>
<tr class="even">
<td></td>
<td>000010</td>
<td>4.19</td>
<td>4.27</td>
<td>4.10</td>
<td>4.24</td>
<td>71661.0</td>
<td>3.004320e+07</td>
</tr>
<tr class="odd">
<td></td>
<td>000011</td>
<td>13.76</td>
<td>14.40</td>
<td>13.58</td>
<td>14.39</td>
<td>105639.0</td>
<td>1.489735e+08</td>
</tr>
</tbody>
</table>
<p>参考：</p>
<ol type="1">
<li><p><a href="https://hexo.imydl.tech/archives/6742.html">Hexo下表格的美化和优化</a></p></li>
<li><p><a href="https://www.jianshu.com/p/6c1651fe5374">完美解决：Hexo Next主题本地可预览CSS，但部署到网站CSS失效问题！</a></p></li>
</ol>
]]></content>
      <categories>
        <category>技术笔记</category>
        <category>博客</category>
      </categories>
      <tags>
        <tag>Hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>【Hexo】常用操作指令</title>
    <url>/2020/11/20/%E3%80%90Hexo%E3%80%91%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C%E6%8C%87%E4%BB%A4/</url>
    <content><![CDATA[<p>欢迎使用 <a href="https://hexo.io/">Hexo</a>! 有关hexo的详细说明参见 <a href="https://hexo.io/docs/">documentation</a> 。 相关的问题解决参见 <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> 。</p>
<a id="more"></a>
<h2 id="快速入门">快速入门</h2>
<h3 id="创建新贴">创建新贴</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>
<p>详见: <a href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="启动本地服务">启动本地服务</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>详见: <a href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="生成静态页面">生成静态页面</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>详见: <a href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="部署到远程">部署到远程</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>详见: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>
]]></content>
      <categories>
        <category>技术笔记</category>
        <category>博客</category>
      </categories>
      <tags>
        <tag>Hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>【Hexo】github开启令牌验证后无法更新Blog的问题</title>
    <url>/2021/08/30/%E3%80%90Hexo%E3%80%91github%E5%BC%80%E5%90%AF%E4%BB%A4%E7%89%8C%E9%AA%8C%E8%AF%81%E5%90%8E%E6%97%A0%E6%B3%95%E6%9B%B4%E6%96%B0Blog%E7%9A%84%E9%97%AE%E9%A2%98/</url>
    <content><![CDATA[<p>从2021年8月13日起， github不再支持帐号密码验证Git操作，改用token(令牌)或SSH密钥。</p>
<p><img src="https://s2.loli.net/2022/04/14/L6YvJDdyVg5uxot.png" /></p>
<p><strong>解决方案</strong></p>
<p>1/ 首先登入Github 账户，<code>Setting - Developer settings - Personal access tokens - Generate new token</code>, Note 填写 Hexo 或 Blog 之类，勾选第一项 repo，然后 Generate token；为Hexo项目生成一个令牌。</p>
<p>2/ 修改<code>_config.yml</code>,</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Deployment</span></span><br><span class="line"><span class="comment">## Docs: https://hexo.io/docs/one-command-deployment</span></span><br><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">&#x27;git&#x27;</span></span><br><span class="line">  <span class="attr">repo:</span> <span class="string">https://[复制生成的token]@github.com/nokiasonic/nokiasonic.github.io.git</span></span><br><span class="line">  <span class="attr">branch:</span> <span class="string">main</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>即可正常hexo d更新blog。</p>
]]></content>
      <categories>
        <category>技术笔记</category>
        <category>Hexo</category>
      </categories>
      <tags>
        <tag>Hexo</tag>
        <tag>Github</tag>
      </tags>
  </entry>
  <entry>
    <title>【Jupyter】JupyterLab中如何设置终端类型</title>
    <url>/2024/06/04/%E3%80%90Jupyter%E3%80%91JupyterLab%E4%B8%AD%E5%A6%82%E4%BD%95%E8%AE%BE%E7%BD%AE%E7%BB%88%E7%AB%AF%E7%B1%BB%E5%9E%8B/</url>
    <content><![CDATA[<p>如何将<code>JupyterLab</code>中的终端设置为<code>Windows CMD</code>,并且具有和<code>Anaconda Prompt</code>相同的效果，启动后直接进入特定的<code>Conda</code>环境?</p>
<p>1.生成配置文件 <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">jupyter lab --generate-config</span><br></pre></td></tr></table></figure> 该命令会在用户目录中创建一个名字<code>jupyter_lab_config.py</code>的文件，以<code>Windows</code>系统为例，该文件位于<code>C:\User\&lt;user name&gt;\.jupyter\</code>下。</p>
<p>2.修改配置 编辑<code>jupyter_lab_config.py</code>,查找<code>c.ServerApp.terminado_settings</code>。进行以下设置： <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">## Supply overrides for terminado. Currently only supports &quot;shell_command&quot;.</span></span><br><span class="line"><span class="comment">#  Default: &#123;&#125;</span></span><br><span class="line">c.ServerApp.terminado_settings = &#123;<span class="string">&#x27;shell_command&#x27;</span>:[<span class="string">&#x27;c:\\Windows\\System32\\cmd.exe&#x27;</span>, <span class="string">&#x27;/k&#x27;</span>,<span class="string">&#x27;D:\\anaconda3\\Scripts\\activate_terminal.bat&#x27;</span>,<span class="string">&#x27;&amp;title&#x27;</span>,<span class="string">&#x27;Conda&#x27;</span>]&#125;</span><br></pre></td></tr></table></figure> <code>shell_command</code>是以字典方式表式，值为列表方式。目录分隔符使用"\"。执行时等效于 <code>c:\Windows\System32\cmd.exe /k D:\anaconda3\Scripts\activate_terminal.bat &amp;title Conda</code>。</p>
<p>其中<code>active_terminal.bat</code>内容如下： <figure class="highlight text"><table><tr><td class="code"><pre><span class="line">@echo off</span><br><span class="line">call D:\anaconda3\Scripts\activate.bat D:\anaconda3</span><br><span class="line">call conda activate Python3.10.14</span><br></pre></td></tr></table></figure> <code>Python3.10.14</code>为创建好的<code>Conda</code>环境名。</p>
<p>3.效果 <img src="https://s2.loli.net/2024/06/04/MfglEu96QPZjHGi.png" alt="|600" /></p>
]]></content>
      <categories>
        <category>软件工程</category>
      </categories>
      <tags>
        <tag>python</tag>
        <tag>anaconda</tag>
        <tag>jupyter</tag>
      </tags>
  </entry>
  <entry>
    <title>【Jupyter】启动时有报错信息</title>
    <url>/2021/05/11/%E3%80%90Jupyter%E3%80%91%E5%90%AF%E5%8A%A8%E6%97%B6%E6%9C%89%E6%8A%A5%E9%94%99%E4%BF%A1%E6%81%AF/</url>
    <content><![CDATA[<h1 id="说明">说明</h1>
<p>在升级jupyter到版本6.x以上时，在启动的时候会报很多行以下错误 <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Config option &#96;template_path&#96; not recognized by &#96;LenvsLatexExporter&#96;. Did you mean one of: &#96;template_file, template_name, template_paths&#96;?</span><br></pre></td></tr></table></figure></p>
<h1 id="解决方案">解决方案</h1>
<p>使用VS Code依次打开python安装目录下的/lib/site-packages/ ('jupyter_contrib_nbextensions', 'jupyter_latex_envs' 及'latex_envs')子目录。</p>
<p>通过'Edit/Replace in Files'来查找'template_path'并替换为'template_paths'。</p>
<p>注意有的内容已经是template_paths，不需要修改。</p>
<h1 id="参考">参考</h1>
<p>1/ [jupyter代码自动补全插件、安装后出现警告“Config option <code>template_path</code> not recognized by <code>LenvsLatexExporter</code>”的解决方案](<a href="https://blog.csdn.net/DTFT_/article/details/111242118">jupyter代码自动补全插件、安装后出现警告"Config option not recognized by "的解决方案_Sun's Blog-CSDN博客</a>)</p>
<p>2/ <a href="https://github.com/ipython-contrib/jupyter_contrib_nbextensions/issues/1529">Config option <code>template_path</code> not recognized by <code>LenvsLatexExporter</code>. Did you mean one of: <code>template_file, template_name, template_paths</code>? · Issue #1529 · ipython-contrib/jupyter_contrib_nbextensions (github.com)</a>)</p>
]]></content>
      <categories>
        <category>技术笔记</category>
      </categories>
      <tags>
        <tag>python</tag>
        <tag>jupyter</tag>
      </tags>
  </entry>
  <entry>
    <title>【Markdown】Typora画流程图实践</title>
    <url>/2021/01/08/%E3%80%90Markdown%E3%80%91Typora%E7%94%BB%E6%B5%81%E7%A8%8B%E5%9B%BE%E5%AE%9E%E8%B7%B5/</url>
    <content><![CDATA[<p><code>Typrora</code>中使用了<code>Mermaid</code>来提供强劲的绘制流程图、时序图的功能。</p>
<h2 id="关于mermaid">关于Mermaid</h2>
<p>是一种简单的类似 Markdown 的脚本语言，通过 JavaScript 编程语言，将文本转换为图片。因此，真正实现画图功能的并不是 Typora 本身，它只是内置了对 Mermaid 的支持。</p>
<p><img src="https://s2.loli.net/2022/04/14/FiZR16eYrtTWm3g.png" /></p>
<h2 id="图形介绍">图形介绍</h2>
<h3 id="流程图flowchart">流程图(flowchart)</h3>
<p>主要语法说明：</p>
<p>graph - 表明是流程图</p>
<p>方向：</p>
<ul>
<li>TB - top to bottom</li>
<li>TD - top-down/ same as top to bottom</li>
<li>BT - bottom to top</li>
<li>RL - right to left</li>
<li>LR - left to right</li>
</ul>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">graph TD;</span><br><span class="line">    A--&gt;B;</span><br><span class="line">    A--&gt;C;</span><br><span class="line">    B--&gt;D;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">graph TD;</span><br><span class="line">    A--&gt;B;</span><br><span class="line">    A--&gt;C;</span><br><span class="line">    B--&gt;D;</span><br></pre></td></tr></table></figure>
<h3 id="时序图"><strong>时序图</strong></h3>
<p>语法解释：<code>-&gt;&gt;</code> 代表实线箭头，<code>--&gt;&gt;</code> 则代表虚线。</p>
<h1 id="参考">参考</h1>
<p>[1] <a href="https://mermaid-js.github.io/mermaid/#/">Mermaid:https://mermaid-js.github.io/mermaid/#/</a></p>
]]></content>
      <categories>
        <category>技术笔记</category>
        <category>markdown</category>
      </categories>
      <tags>
        <tag>typora</tag>
        <tag>mermaid</tag>
      </tags>
  </entry>
  <entry>
    <title>【Linux】终端提示符自定义</title>
    <url>/2024/06/12/%E3%80%90Linux%E3%80%91%E7%BB%88%E7%AB%AF%E6%8F%90%E7%A4%BA%E7%AC%A6%E8%87%AA%E5%AE%9A%E4%B9%89/</url>
    <content><![CDATA[<p>以下设置为了在每次启动终端时都生效，需要修改 <strong><em>.bashrc</em></strong></p>
<h1 id="ls彩色命令"><code>ls</code>彩色命令</h1>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> LS_OPTIONS=<span class="string">&#x27;--color=auto&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> ls=<span class="string">&#x27;ls $LS_OPTIONS&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> ll=<span class="string">&#x27;ls $LS_OPTIONS -l&#x27;</span></span><br><span class="line"><span class="built_in">alias</span> l=<span class="string">&#x27;ls $LS_OPTIONS -lA&#x27;</span></span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h1 id="彩色提示符">彩色提示符</h1>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> PS1=<span class="string">&quot;\[\e[0;38;5;154m\][\[\e[1;38;5;46m\]\A\[\e[0;38;5;154m\]] \[\e[1;38;5;196m\]\u\[\e[38;5;202m\]@\[\e[38;5;208m\]\h \[\e[38;5;220m\]\w \[\e[38;5;46m\]\$\[\e[0m\] &quot;</span></span><br></pre></td></tr></table></figure>
<p><strong>说明：</strong><br />
1. 配置<code>PS</code>变量常用参数 <figure class="highlight c"><table><tr><td class="code"><pre><span class="line">参数描述</span><br><span class="line"></span><br><span class="line">\d 代表日期，格式为weekday month date，例如：”Mon Aug <span class="number">1</span>”</span><br><span class="line">\H 完整的主机名称。例如：我的机器名称为：fc4.linux，则这个名称就是fc4.linux</span><br><span class="line">\h 仅取主机的第一个名字，如上例，则为fc4，.linux则被省略</span><br><span class="line">\t 显示时间为<span class="number">24</span>小时格式，如：HH：MM：SS</span><br><span class="line">\T 显示时间为<span class="number">12</span>小时格式</span><br><span class="line">\A 显示时间为<span class="number">24</span>小时格式：HH：MM</span><br><span class="line">\u 当前用户的账号名称</span><br><span class="line">\v BASH的版本信息</span><br><span class="line">\w 完整的工作目录名称。家目录会以 ~代替</span><br><span class="line">\W 利用basename取得工作目录名称，所以只会列出最后一个目录</span><br><span class="line">\# 下达的第几个命令</span><br><span class="line">\$ 提示字符，如果是root时，提示符为：# ，普通用户则为：$</span><br><span class="line">\[ 字符”[“</span><br><span class="line">\] 字符”]”</span><br><span class="line">\! 命令行动态统计历史命令次数</span><br></pre></td></tr></table></figure></p>
<ol start="2" type="1">
<li>表示色彩的格式 使用 <strong><em>88/256</em></strong> 色设置方案进行设置。色谱表如下：</li>
</ol>
<figure>
<img src="https://s2.loli.net/2024/06/13/v1YERhseI9TfWXA.png" alt="|600" /><figcaption aria-hidden="true">|600</figcaption>
</figure>
<p>使用<code>ESC</code>转义字符串来格式化后续文本的颜色。 在<code>bash</code>中，<code>ESC</code>转义可以用以下三种方式表示：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">- `\e`    </span><br><span class="line">- `\033`    </span><br><span class="line">- `\x1B`</span><br></pre></td></tr></table></figure>
<p>举例说明：用<code>\[\e[0;38;5;105m\]</code>表示某种颜色，其中开始与结束时的<code>\[</code>,<code>\]</code>均为转义，<code>\e[0</code>表示不使用特殊格式。<code>38;5; ColorNumber</code>表示前景颜色（字体颜色），如果是背景颜色用<code>48;5; ColorNumber</code>来表示。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">特殊格式</span><br><span class="line"></span><br><span class="line"><span class="number">0</span> 关闭</span><br><span class="line"><span class="number">1</span> 粗体/高亮</span><br><span class="line"><span class="number">2</span> 灰暗</span><br><span class="line"><span class="number">4</span> 下划线</span><br><span class="line"><span class="number">5</span> 闪烁</span><br><span class="line"><span class="number">7</span> 反白 (交换前景与背景颜色）</span><br><span class="line"><span class="number">8</span> 隐藏 (用于密码显示)</span><br></pre></td></tr></table></figure>
<ol start="3" type="1">
<li><p>实例演示 <img src="https://s2.loli.net/2024/06/13/ge6iMSQvUhqpnHX.png" /> 效果如下： <img src="https://s2.loli.net/2024/06/13/pE7U8KgWrmTXSOz.png" /> <strong>说明：</strong><br />
①显示左右括号<code>[]</code>，用颜色<code>\[\e[0;38;5;154m\]</code>表示，'0':不使用特殊格式。<br />
②显示时间<code>\A</code>，格式为<code>HH:MM</code>,用颜色<code>\[\e[1;38;5;46m\]</code>表示，'1':粗体高亮。<br />
③显示用户名<code>\u</code>, 用颜色<code>\[\e[1;38;5;196m\]</code>表示。<br />
④显示<code>@</code>,用颜色<code>\[\e[38;5;202m\]</code>表示，因为从用户名之后，后续文本均使用粗体高亮，就不在其中使用特殊格式数字，除非有格式上的变化。<br />
⑤显示主机名<code>\h</code>,用颜色<code>\[\e[38;5;208m\]</code>表示。<br />
⑥显示完整工作路径<code>\w</code>,用颜色<code>\[\e[38;5;220m\]</code>表示，如果仅想显示当前目录，可以用<code>\W</code>。<br />
⑦显示提示符<code>\$</code>,用颜色<code>\[\e[38;5;46m\]</code>表示。<br />
⑧停止使用调色，用<code>\e[0m</code>表示，这里使用了<code>\33[0m</code>，作用完全相同，仅是为了测试。</p></li>
<li><p><code>Conda</code>虚拟环境激活后的提示符前缀处理。<br />
前缀为<code>(base)</code>或<code>(激活后的环境名)</code>，默认为系统前景色。如何对其也进行定制呢？</p></li>
</ol>
<p><strong>步骤(1) </strong></p>
<p>在终端 shell 中输入以下命令，使<code>conda</code>不再显示提示符前缀。<br />
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">conda config --set changeps1 false</span><br></pre></td></tr></table></figure> 若想再开启，输入<br />
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">conda config --set changeps1 true</span><br></pre></td></tr></table></figure> <strong>步骤(2)</strong></p>
<p>继续修改环境变量<code>PS1</code>。用<code>\[\e[0;38;5;105m\](\[\e[1;38;5;141m\]\$&#123;CONDA_DEFAULT_ENV&#125;\[\e[0;38;5;105m\])</code>用来自定义<code>Conda</code>环境提示符前缀。完整<code>PS1</code>的定义如下：<br />
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> PS1=<span class="string">&quot;\[\e[0;38;5;105m\](\[\e[1;38;5;141m\]\$&#123;CONDA_DEFAULT_ENV&#125;\[\e[0;38;5;105m\]) \[\e[0;38;5;154m\][\[\e[1;38;5;46m\]\A\[\e[0;38;5;154m\]] \[\e[1;38;5;196m\]\u\[\e[38;5;202m\]@\[\e[38;5;208m\]\h \[\e[38;5;220m\]\w \[\e[38;5;46m\]\$\[\e[0m\] &quot;</span></span><br></pre></td></tr></table></figure> 效果为： <img src="https://s2.loli.net/2024/06/13/Vs7g8KQjGeAJzDp.png" /></p>
<h1 id="参考">参考</h1>
<ol type="1">
<li><a href="https://robotmoon.com/bash-prompt-generator/">Bash prompt generator with colors (robotmoon.com)</a></li>
<li><a href="https://unix.stackexchange.com/questions/124407/what-color-codes-can-i-use-in-my-bash-ps1-prompt">What color codes can I use in my Bash PS1 prompt?</a></li>
<li><a href="https://unix.stackexchange.com/questions/93268/bash-ps1-256-colors-with-bold">terminal - bash PS1 256 colors with bold</a></li>
<li><a href="https://misc.flogisoft.com/bash/tip_colors_and_formatting">bash:tip_colors_and_formatting</a></li>
</ol>
]]></content>
      <categories>
        <category>软件工程</category>
        <category>技术笔记</category>
      </categories>
      <tags>
        <tag>linux</tag>
        <tag>prompt</tag>
      </tags>
  </entry>
  <entry>
    <title>【Obsidian】农历日历插件Dust Calendar美化</title>
    <url>/2024/06/11/%E3%80%90Obsidian%E3%80%91%E5%86%9C%E5%8E%86%E6%97%A5%E5%8E%86%E6%8F%92%E4%BB%B6Dust%20Calendar%E7%BE%8E%E5%8C%96/</url>
    <content><![CDATA[<h1 id="需求">需求</h1>
<p><code>Dust Calendar</code>是<code>Obsidian</code>的日历插件。更符合中国习惯的日历插件，支持同时显示公历、农历、星期、节气、节假日、调休等信息。 但是默认的界面与我的整体工作区不太协调。 需要进行定制美化。</p>
<a id="more"></a>
<h1 id="插件安装">插件安装</h1>
<p>官网:<a href="https://github.com/a-nano-dust/dust-obsidian-calendar">dust-obsidian-calendar: obsidian 日历插件</a></p>
<h2 id="从-obsidian-的社区插件来安装">从 Obsidian 的社区插件来安装</h2>
<ol type="1">
<li>打开 <code>设置/第三方插件</code>；<br />
</li>
<li>关闭 <code>安全模式</code>；<br />
</li>
<li>点击 <code>浏览</code> 按钮来查看第三方插件市场；<br />
</li>
<li>输入搜索：<strong>Dust Calendar</strong>；<br />
</li>
<li>点击 <code>安装</code> 按钮；<br />
</li>
<li>一旦安装成功，先关闭当前社区插件窗口，然后在已安装插件列表下激活刚安装的插件；</li>
</ol>
<h2 id="手动安装">手动安装</h2>
<ol type="1">
<li>下载 <a href="https://github.com/a-nano-dust/dust-obsidian-calendar/releases/latest">latest release</a>；</li>
<li>解压并提取 dust-obsidian-calendar 文件夹，然后放到你 Obsidian 库中的插件目录中 <code>&lt;仓库根目录&gt;/.obsidian/plugins/</code> （注意： <code>.obsidian</code> 文件夹可能被隐藏了，我们需要先将该文件夹展示出来）</li>
<li>打开 <code>设置/第三方插件</code>，启用该插件。</li>
</ol>
<h1 id="实现">实现</h1>
<p>在 <code>.obsidian\snippets</code>目录下新建 css 文件。如：<strong>【日历】dust-calendar.css</strong>，写入以下内容。 <figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* dust-obsidian-calendar-plugin */</span></span><br><span class="line"><span class="comment">/* https://github.com/a-nano-dust/dust-obsidian-calendar */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="selector-class">.d-hover-bg-color-base-50</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#5CB3CC</span>;</span><br><span class="line">  <span class="attribute">font-weight</span>: bold;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.d-color-base-100</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#5CB3CC</span>;</span><br><span class="line">  <span class="attribute">font-weight</span>: bold;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.d-bg-color-blue</span> &#123;</span><br><span class="line">  <span class="attribute">font-weight</span>: bold;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#5CB3CC</span>;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="built_in">rgba</span>(var(--table-color-rgb), <span class="number">0.9</span>) <span class="meta">!important</span>;	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">div</span><span class="selector-class">.calendar-view-body</span> &#123;</span><br><span class="line">  <span class="attribute">gap</span>:<span class="number">1px</span>;	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">div</span><span class="selector-class">.calendar-view-body</span> <span class="selector-tag">div</span><span class="selector-class">.calendar-view-row</span><span class="selector-pseudo">:nth-child(1)</span> &#123;</span><br><span class="line">  <span class="attribute">border-bottom</span>: <span class="number">2px</span> solid <span class="number">#5CB3CC</span>;</span><br><span class="line">  <span class="attribute">margin-bottom</span>: <span class="number">1px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">div</span><span class="selector-class">.calendar-view-body</span> <span class="selector-tag">div</span><span class="selector-class">.calendar-view-row</span><span class="selector-pseudo">:nth-child(2)</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="built_in">rgba</span>(var(--table-color-rgb), <span class="number">0.1</span>) <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">div</span><span class="selector-class">.calendar-view-body</span> <span class="selector-tag">div</span><span class="selector-class">.calendar-view-row</span><span class="selector-pseudo">:nth-child(3)</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="built_in">rgba</span>(var(--table-color-rgb), <span class="number">0.2</span>) <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">div</span><span class="selector-class">.calendar-view-body</span> <span class="selector-tag">div</span><span class="selector-class">.calendar-view-row</span><span class="selector-pseudo">:nth-child(4)</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="built_in">rgba</span>(var(--table-color-rgb), <span class="number">0.3</span>) <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">div</span><span class="selector-class">.calendar-view-body</span> <span class="selector-tag">div</span><span class="selector-class">.calendar-view-row</span><span class="selector-pseudo">:nth-child(5)</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="built_in">rgba</span>(var(--table-color-rgb), <span class="number">0.4</span>) <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">div</span><span class="selector-class">.calendar-view-body</span> <span class="selector-tag">div</span><span class="selector-class">.calendar-view-row</span><span class="selector-pseudo">:nth-child(6)</span> &#123;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="built_in">rgba</span>(var(--table-color-rgb), <span class="number">0.5</span>) <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">div</span><span class="selector-class">.calendar-view-item</span><span class="selector-class">.d-bg-color-blue</span> &#123;</span><br><span class="line">  <span class="attribute">box-shadow</span>: <span class="number">0</span> <span class="number">0</span> <span class="number">5px</span> <span class="built_in">var</span>(--text-accent);	</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="built_in">rgba</span>(var(--table-color-rgb), <span class="number">0.9</span>) <span class="meta">!important</span>;		</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> 我的主题用的是<code>Blue Topaz</code>, 所以部分颜色变量使用了其预定义好的值。如每行的背景色选用了<code>var(--table-color-rgb)</code>,并根据透明度（0.1-0.9)不同来区别。为了整体风格统一，对于表头下线及选中日期均使用色号<code>#5CB3CC</code>，可以自己调整这些配置。</p>
<h1 id="效果对比">效果对比</h1>
<table border="0" cellspacing="0" cellpadding="0">
<tr style="border-style: none;">
<td style="border-style: none;">
默认
</td>
<td style="border-style: none;">
美化后
</td>
</tr>
<tr style="border-style: none;">
<td>
<img src="https://s2.loli.net/2024/06/11/RvK47mBIdi6wano.png" border=0, width=400/>
</td>
<td>
<img src="https://s2.loli.net/2024/06/11/9nP1d8jTEcB4pt3.png" border=0, width=400/>
</td>
</tr>
</table>
]]></content>
      <categories>
        <category>应用软件</category>
      </categories>
      <tags>
        <tag>Obsidian</tag>
        <tag>Obsidian/BlueTopaz</tag>
      </tags>
  </entry>
  <entry>
    <title>【Polars】基于Rust内核的Jupyter Notebook中的Polars数据表格呈现</title>
    <url>/2024/05/20/%E3%80%90Polars%E3%80%91%E5%9F%BA%E4%BA%8ERust%E5%86%85%E6%A0%B8%E7%9A%84Jupyter%20Notebook%E4%B8%AD%E7%9A%84Polars%E6%95%B0%E6%8D%AE%E8%A1%A8%E6%A0%BC%E5%91%88%E7%8E%B0/</url>
    <content><![CDATA[<p>为了在<code>Jupyter Notebook</code>中使用<code>Rust</code>和<code>Polars</code>库以类似于<code>Pandas</code>的方式输出<code>HTML</code>表格，我们可以使用 <code>evcxr_jupyter</code> 内核和<code>HTML</code>格式化。虽然<code>Rust</code>没有直接提供像<code>Pandas</code>那样的内置<code>HTML</code>表格输出，但我们可以通过手动构建<code>HTML</code>表格并在<code>Jupyter Notebook</code>中显示来实现这一点。</p>
<p>以下是一个详细的指南和示例代码：</p>
<h3 id="安装和设置">安装和设置</h3>
<ol type="1">
<li><p><strong>安装 Rust 和 <code>evcxr_jupyter</code> 内核</strong> 首先，确保你已经安装了<code>Rust</code>，然后安装 <code>evcxr_jupyter</code>。 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cargo install evcxr_jupyter</span><br><span class="line">evcxr_jupyter --install</span><br></pre></td></tr></table></figure></p></li>
<li><p><strong>启动 Jupyter Notebook</strong> 启动<code>Jupyter Notebook</code>并新建一个<code>Rust</code>内核的笔记。</p></li>
</ol>
<h3 id="编写代码">编写代码</h3>
<p>以下是一个使用<code>Polars</code>库创建<code>DataFrame</code>并生成<code>HTML</code>表格的示例代码： <figure class="highlight rust"><table><tr><td class="code"><pre><span class="line">:dep polars = &#123;version = <span class="string">&quot;0.39.1&quot;</span>&#125;</span><br><span class="line">:dep serde_json = <span class="string">&quot;1.0&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> polars::prelude::*;</span><br><span class="line"><span class="keyword">use</span> polars::df;</span><br><span class="line"><span class="keyword">use</span> polars::frame::DataFrame;</span><br><span class="line"><span class="keyword">use</span> serde_json::json;</span><br><span class="line"><span class="keyword">use</span> std::fmt::Write;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">create_dataframe</span></span>() -&gt; DataFrame &#123;</span><br><span class="line">    <span class="keyword">let</span> s0 = Series::new(<span class="string">&quot;days&quot;</span>, &amp;[<span class="string">&quot;mon&quot;</span>, <span class="string">&quot;tue&quot;</span>, <span class="string">&quot;wed&quot;</span>, <span class="string">&quot;thu&quot;</span>, <span class="string">&quot;fri&quot;</span>]);</span><br><span class="line">    <span class="keyword">let</span> s1 = Series::new(<span class="string">&quot;temp&quot;</span>, &amp;[<span class="number">23</span>, <span class="number">34</span>, <span class="number">15</span>, <span class="number">30</span>, <span class="number">10</span>]);</span><br><span class="line">    DataFrame::new(<span class="built_in">vec!</span>[s0, s1]).expect(<span class="string">&quot;DataFrame creation failed&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">dataframe_to_html</span></span>(df: &amp;DataFrame) &#123;</span><br><span class="line">    <span class="keyword">let</span> columns = df.get_columns();</span><br><span class="line">    <span class="keyword">let</span> headers: <span class="built_in">Vec</span>&lt;&amp;<span class="built_in">str</span>&gt; = columns.iter().map(|s| s.name()).collect();</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> html = <span class="built_in">String</span>::new();</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">write!</span>(</span><br><span class="line">        html,</span><br><span class="line">        <span class="string">&quot;&lt;table border=\&quot;1\&quot;&gt;&lt;tr&gt;&#123;&#125;&lt;/tr&gt;&quot;</span>,</span><br><span class="line">        headers</span><br><span class="line">            .iter()</span><br><span class="line">            .map(|h| <span class="built_in">format!</span>(<span class="string">&quot;&lt;th&gt;&#123;&#125;&lt;/th&gt;&quot;</span>, h))</span><br><span class="line">            .collect::&lt;<span class="built_in">Vec</span>&lt;<span class="built_in">String</span>&gt;&gt;()</span><br><span class="line">            .join(<span class="string">&quot;&quot;</span>)</span><br><span class="line">    )</span><br><span class="line">    .unwrap();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="number">0</span>..df.height() &#123;</span><br><span class="line">        <span class="built_in">write!</span>(html, <span class="string">&quot;&lt;tr&gt;&quot;</span>).unwrap();</span><br><span class="line">        <span class="keyword">for</span> col <span class="keyword">in</span> columns.iter() &#123;</span><br><span class="line">            <span class="built_in">write!</span>(html, <span class="string">&quot;&lt;td&gt;&#123;&#125;&lt;/td&gt;&quot;</span>, col.get(i).unwrap()).unwrap();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">write!</span>(html, <span class="string">&quot;&lt;/tr&gt;&quot;</span>).unwrap();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">write!</span>(html, <span class="string">&quot;&lt;/table&gt;&quot;</span>).unwrap();</span><br><span class="line">    <span class="built_in">println!</span>(<span class="string">&quot;EVCXR_BEGIN_CONTENT text/html\n&#123;&#125;\nEVCXR_END_CONTENT&quot;</span>, html);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> df = create_dataframe();</span><br><span class="line"><span class="keyword">let</span> html_table = dataframe_to_html(&amp;df);</span><br><span class="line">html_table</span><br></pre></td></tr></table></figure></p>
<h3 id="解释代码">解释代码</h3>
<ol type="1">
<li><p><strong>加载依赖项</strong> 在 <code>Jupyter Notebook</code>中，我们使用 <code>:dep</code> 命令来添加所需的依赖项：<code>polars</code> 和 <code>serde_json</code>。</p></li>
<li><p><strong>创建 DataFrame</strong> 函数 <code>create_dataframe</code> 创建了一个简单的<code>DataFrame</code>，包含两个列：<code>days</code> 和 <code>temp</code>。</p></li>
<li><p><strong>生成 HTML 表格</strong> 函数 <code>dataframe_to_html</code> 将<code>DataFrame</code>转换为<code>HTML</code>表格格式：</p>
<ul>
<li>获取<code>DataFrame</code>的列并生成表头。</li>
<li>遍历每一行，生成表格的每一行数据。</li>
<li>使用 <code>write!</code> 宏构建<code>HTML</code>字符串。</li>
</ul></li>
<li><p><strong>输出 HTML 表格</strong> 最后，在<code>println!</code>函数中需要标明每个块以包含<code>EVCXR BEGIN CONTENT</code>的一行开始，然后是<code>mime</code>类型，然后是换行符，然后内容以包含<code>EVCXR END CONTENT</code>的一行结束。生成的<code>HTML</code>表格字符串被输出。<code>Jupyter Notebook</code>会自动渲染<code>HTML</code>字符串，从而显示漂亮的表格。</p></li>
</ol>
<h3 id="结果呈现">结果呈现</h3>
<p><img src="https://s2.loli.net/2024/05/20/ZmYgJAPvLT4Hhp2.png" /></p>
]]></content>
      <categories>
        <category>程序语言</category>
      </categories>
      <tags>
        <tag>jupyter</tag>
        <tag>rust，polars</tag>
      </tags>
  </entry>
  <entry>
    <title>【Python】Pandas与numpy的方差计算</title>
    <url>/2021/07/16/%E3%80%90Python%E3%80%91Pandas%E4%B8%8Enumpy%E7%9A%84%E6%96%B9%E5%B7%AE%E8%AE%A1%E7%AE%97/</url>
    <content><![CDATA[<h1 id="目的">目的</h1>
<p>方差在统计描述和概率分布中各有不同的定义，并有不同的公式。<br />
在统计描述中，方差用来计算每一个变量（观察值）与总体均数之间的差异。为避免出现离均差总和为零，离均差平方和受样本含量的影响，统计学采用平均离均差平方和来描述变量的变异程度。<br />
<code>总体方差计算公式</code>： <span class="math inline">\({\sigma}^2=\frac{\sum_{i=1}^{N}(X_i-\bar{\mu})}{N}\)</span><br />
其中<span class="math inline">\({\sigma}^2\)</span>为总体方差，<span class="math inline">\(X_i\)</span>为变量，<span class="math inline">\(\bar{\mu}\)</span>为总体均值，<span class="math inline">\(N\)</span>为总体例数。</p>
<p>实际工作中，总体均数难以得到时，应用样本统计量代替总体参数，经校正后，<br />
<code>样本方差计算公式</code>： <span class="math inline">\({S}^2=\frac{\sum_{i=1}^{N}(X_i-\bar{X})}{n-1}\)</span><br />
其中<span class="math inline">\({S}^2\)</span>为样本方差，<span class="math inline">\(X_i\)</span>为变量，<span class="math inline">\(\bar{X}\)</span>为样本均值，<span class="math inline">\(n\)</span>为样本例数。</p>
<a id="more"></a>
<h1 id="方差的计算">方差的计算</h1>
<h2 id="数据准备">数据准备</h2>
<p>取一定周期的沪深300指数(000300.SH)的每日行情数据，如：2019年全年。为了计算每日涨跌幅，故多取了2018年最后一个交易日的数据。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> QUANTAXIS <span class="keyword">as</span> QA</span><br><span class="line"><span class="keyword">from</span> IPython.core.interactiveshell <span class="keyword">import</span> InteractiveShell</span><br><span class="line">InteractiveShell.ast_node_interactivity = <span class="string">&quot;all&quot;</span> </span><br><span class="line"></span><br><span class="line">index = QA.QA_fetch_index_day_adv(<span class="string">&#x27;000300&#x27;</span>,<span class="string">&#x27;2018-12-28&#x27;</span>,<span class="string">&#x27;2019-12-31&#x27;</span>)</span><br><span class="line">display(index.data)</span><br><span class="line"><span class="comment"># 计算每日涨跌幅</span></span><br><span class="line">returns_index = index.data.close.pct_change()</span><br><span class="line">display(returns_index)</span><br></pre></td></tr></table></figure>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
</th>
<th>
open
</th>
<th>
close
</th>
<th>
high
</th>
<th>
low
</th>
<th>
vol
</th>
<th>
amount
</th>
<th>
up_count
</th>
<th>
down_count
</th>
<th>
date_stamp
</th>
<th>
volume
</th>
</tr>
<tr>
<th>
date
</th>
<th>
code
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
2018-12-28
</th>
<th>
000300
</th>
<td>
2994.80
</td>
<td>
3010.65
</td>
<td>
3024.35
</td>
<td>
2984.82
</td>
<td>
710537.0
</td>
<td>
7.814531e+10
</td>
<td>
200
</td>
<td>
81
</td>
<td>
1.545926e+09
</td>
<td>
710537.0
</td>
</tr>
<tr>
<th>
2019-01-02
</th>
<th>
000300
</th>
<td>
3017.07
</td>
<td>
2969.54
</td>
<td>
3018.78
</td>
<td>
2958.49
</td>
<td>
686630.0
</td>
<td>
7.610557e+10
</td>
<td>
70
</td>
<td>
216
</td>
<td>
1.546358e+09
</td>
<td>
686630.0
</td>
</tr>
<tr>
<th>
2019-01-03
</th>
<th>
000300
</th>
<td>
2963.02
</td>
<td>
2964.84
</td>
<td>
3000.44
</td>
<td>
2953.26
</td>
<td>
708671.0
</td>
<td>
7.666480e+10
</td>
<td>
145
</td>
<td>
142
</td>
<td>
1.546445e+09
</td>
<td>
708671.0
</td>
</tr>
<tr>
<th>
2019-01-04
</th>
<th>
000300
</th>
<td>
2940.19
</td>
<td>
3035.87
</td>
<td>
3036.81
</td>
<td>
2935.83
</td>
<td>
1033189.0
</td>
<td>
1.071410e+11
</td>
<td>
286
</td>
<td>
12
</td>
<td>
1.546531e+09
</td>
<td>
1033189.0
</td>
</tr>
<tr>
<th>
2019-01-07
</th>
<th>
000300
</th>
<td>
3055.15
</td>
<td>
3054.30
</td>
<td>
3061.75
</td>
<td>
3035.91
</td>
<td>
1011643.0
</td>
<td>
1.057039e+11
</td>
<td>
217
</td>
<td>
73
</td>
<td>
1.546790e+09
</td>
<td>
1011643.0
</td>
</tr>
<tr>
<th>
...
</th>
<th>
...
</th>
<td>
...
</td>
<td>
...
</td>
<td>
...
</td>
<td>
...
</td>
<td>
...
</td>
<td>
...
</td>
<td>
...
</td>
<td>
...
</td>
<td>
...
</td>
<td>
...
</td>
</tr>
<tr>
<th>
2019-12-25
</th>
<th>
000300
</th>
<td>
3988.66
</td>
<td>
3990.87
</td>
<td>
4000.56
</td>
<td>
3976.36
</td>
<td>
949388.0
</td>
<td>
1.318965e+11
</td>
<td>
117
</td>
<td>
168
</td>
<td>
1.577203e+09
</td>
<td>
949388.0
</td>
</tr>
<tr>
<th>
2019-12-26
</th>
<th>
000300
</th>
<td>
3993.67
</td>
<td>
4025.99
</td>
<td>
4025.99
</td>
<td>
3993.54
</td>
<td>
1088606.0
</td>
<td>
1.408150e+11
</td>
<td>
236
</td>
<td>
53
</td>
<td>
1.577290e+09
</td>
<td>
1088606.0
</td>
</tr>
<tr>
<th>
2019-12-27
</th>
<th>
000300
</th>
<td>
4029.25
</td>
<td>
4022.03
</td>
<td>
4066.80
</td>
<td>
4019.72
</td>
<td>
1509264.0
</td>
<td>
1.950904e+11
</td>
<td>
116
</td>
<td>
173
</td>
<td>
1.577376e+09
</td>
<td>
1509264.0
</td>
</tr>
<tr>
<th>
2019-12-30
</th>
<th>
000300
</th>
<td>
4015.52
</td>
<td>
4081.63
</td>
<td>
4083.69
</td>
<td>
4001.50
</td>
<td>
1559714.0
</td>
<td>
2.168147e+11
</td>
<td>
241
</td>
<td>
53
</td>
<td>
1.577635e+09
</td>
<td>
1559714.0
</td>
</tr>
<tr>
<th>
2019-12-31
</th>
<th>
000300
</th>
<td>
4077.75
</td>
<td>
4096.58
</td>
<td>
4098.14
</td>
<td>
4069.01
</td>
<td>
1232642.0
</td>
<td>
1.731193e+11
</td>
<td>
189
</td>
<td>
95
</td>
<td>
1.577722e+09
</td>
<td>
1232642.0
</td>
</tr>
</tbody>
</table>
<p>
245 rows × 10 columns
</p>
</div>
<pre><code>date        code  
2018-12-28  000300         NaN
2019-01-02  000300   -0.013655
2019-01-03  000300   -0.001583
2019-01-04  000300    0.023957
2019-01-07  000300    0.006071
                        ...   
2019-12-25  000300   -0.000523
2019-12-26  000300    0.008800
2019-12-27  000300   -0.000984
2019-12-30  000300    0.014818
2019-12-31  000300    0.003663
Name: close, Length: 245, dtype: float64</code></pre>
<h2 id="使用numpy计算">使用numpy计算</h2>
<p>numpy 中计算的方差就是总体方差。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">np.var(returns_index)</span><br></pre></td></tr></table></figure>
<pre><code>0.00015577588074696037</code></pre>
<h2 id="使用pandas计算">使用pandas计算</h2>
<p>pandas 中计算的方差为样本方差。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">returns_index.var()</span><br></pre></td></tr></table></figure>
<pre><code>0.0001564169337541495</code></pre>
<h1 id="小结">小结</h1>
<p>在计算方差时，使用numpy和pandas会得到不一样的计算结果，需要根据实际需要样本方差还是总体方差来决定使用何种方式。</p>
]]></content>
      <categories>
        <category>技术笔记</category>
        <category>量化投资</category>
      </categories>
      <tags>
        <tag>python</tag>
        <tag>线性代数</tag>
      </tags>
  </entry>
  <entry>
    <title>【Python】使用PYQT5来构建持仓盈亏监控(续)</title>
    <url>/2021/07/02/%E3%80%90Python%E3%80%91%E4%BD%BF%E7%94%A8PYQT5%E6%9D%A5%E6%9E%84%E5%BB%BA%E6%8C%81%E4%BB%93%E7%9B%88%E4%BA%8F%E7%9B%91%E6%8E%A7%20(%E7%BB%AD)/</url>
    <content><![CDATA[<h1 id="目的">目的</h1>
<p>实时通过图形的方式呈现盈亏情况</p>
<a id="more"></a>
<h1 id="安装pyqtgraph">安装PyQtgraph</h1>
<h2 id="安装">安装</h2>
<p>通过pip进行安装</p>
<blockquote>
<p>pip install pyqtgraph</p>
</blockquote>
<h2 id="界面设计">界面设计</h2>
<h3 id="使用qtdesigner来设计界面">使用QtDesigner来设计界面</h3>
<ol type="1">
<li>初始界面 初始界面设计如下： <img src="https://s2.loli.net/2022/04/14/zcTQvBmEta5WwuP.png" /></li>
</ol>
<p>在此基础上，增加一个<code>label</code>及<code>widget</code>。</p>
<p><img src="https://s2.loli.net/2022/04/14/sNtdLJD436alhbv.png" /> 将widget重命名为<code>“graphWidget"</code>。</p>
<p><img src="https://s2.loli.net/2022/04/14/JtQwUzni7kbOdMP.png" /> 点击右键，选择<code>“提升为...”</code>， 提升的类名称为<code>“PlotWidget”</code>, 头文件为<code>“pyqtgraph”</code>。</p>
<p><img src="https://s2.loli.net/2022/04/14/zwo5gmBSaQJ3Axy.png" /></p>
<p>之所以使用这种方法，是因为按一般做法，利用Qt Designer新建一个布局，在代码中动态添加一个PlotWidget到这个布局来实现，代码如下:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pyqtgraph <span class="keyword">as</span> pg</span><br><span class="line">plot_plt = pg.PlotWidget(background=(<span class="number">69</span>,<span class="number">69</span>,<span class="number">69</span>), axisItems=&#123;<span class="string">&#x27;bottom&#x27;</span>: TimeAxisItem(orientation=<span class="string">&#x27;bottom&#x27;</span>)&#125;)</span><br><span class="line">verticalLayout.addWidget(plot_plt) </span><br></pre></td></tr></table></figure>
<p>这里指定了背景色及坐标轴使用的模板。</p>
<p>这样的做法，我一直没有找到控制PlotWidget大小的方法，导致出来的图形结果与我的期望不太一致。因此才尝试在UI设计时就固定住该部件的大小。</p>
<h3 id="获取数据并展示">获取数据并展示</h3>
<ol type="1">
<li><p>将实时取得的持仓盈亏数据存入列表</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">self.data_list = []</span><br><span class="line">self.data_list.append(<span class="built_in">float</span>(self.data_summary[<span class="string">&#x27;day_float_amount&#x27;</span>]))</span><br></pre></td></tr></table></figure></li>
<li><p>将时间进行时间戳转化存入列表</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">timestamp</span>():</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">int</span>(time.mktime(datetime.datetime.now().timetuple()))</span><br><span class="line"></span><br><span class="line">self.time_list = []</span><br><span class="line">self.time_list.append(timestamp())</span><br></pre></td></tr></table></figure></li>
<li><p>坐标轴显示为时间</p>
<p>默认pyqtgraph会使用0开始的整数来作为坐标轴的值。 这里希望使用实时取到的时间来做为显示的值，因此需要重写pyqtgraph的AxisItem类。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TimeAxisItem</span>(<span class="params">pg.AxisItem</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, *args, **kwargs</span>):</span></span><br><span class="line">        <span class="built_in">super</span>().__init__(*args, **kwargs)</span><br><span class="line">        <span class="comment">#self.setLabel(text=&#x27;Time&#x27;, units=None)</span></span><br><span class="line">        self.enableAutoSIPrefix(<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">tickStrings</span>(<span class="params">self, values, scale, spacing</span>):</span></span><br><span class="line">        <span class="keyword">return</span> [datetime.datetime.fromtimestamp(value).strftime(<span class="string">&quot;%H:%M:%S&quot;</span>) <span class="keyword">for</span> value <span class="keyword">in</span> values]</span><br></pre></td></tr></table></figure></li>
<li><p>展示</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">graphWidget.plot().setData(self.model.time_list, self.model.data_list,pen=<span class="string">&#x27;g&#x27;</span>)</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="效果">效果</h1>
<p>完成后的应用界面效果如下： <img src="https://s2.loli.net/2022/04/14/pqdJtr7F5bMEcRV.png" /> # 参考 4. <a href="%5BPyQt5的PyQtGraph实践系列3：实时数据更新绘制图形%20-%20州的先生%20(zmister.com)%5D(https://zmister.com/archives/826.html)">PyQt5的PyQtGraph实践系列3：实时数据更新绘制图形</a> 2. <a href="%5BEmbedding%20PyQtGraph%20(or%20any%20other%20custom%20PyQt5%20widgets)%20from%20Qt%20Designer%20(mfitzp.com)%5D(https://www.mfitzp.com/tutorials/embed-pyqtgraph-custom-widgets-qt-app/)">Embedding custom widgets from Qt Designer</a></p>
]]></content>
      <categories>
        <category>技术笔记</category>
        <category>python</category>
        <category>量化投资</category>
      </categories>
      <tags>
        <tag>python</tag>
        <tag>pyqt5</tag>
      </tags>
  </entry>
  <entry>
    <title>【Python】PyMongoArrow实践</title>
    <url>/2024/05/29/%E3%80%90Python%E3%80%91PyMongoArrow%E5%AE%9E%E8%B7%B5/</url>
    <content><![CDATA[<h1 id="pymongoarrow简介"><code>PyMongoArrow</code>简介</h1>
<p><code>PyMongoArrow</code> 是 <a href="http://pymongo.readthedocs.io/">PyMongo</a> 包含用于加载 <a href="http://www.mongodb.org/">MongoDB</a> 的工具的扩展,以 <a href="http://arrow.apache.org/">Apache Arrow</a> 形式查询结果集、 表格、 <a href="https://numpy.org/">NumPy</a> 数组和 <a href="https://pandas.pydata.org/">Pandas</a> 或 <a href="https://pola.rs/">Polars</a> DataFrames。 <code>PyMongoArrow</code> 是将 <code>MongoDB</code> 查询结果集物化为适合内存中分析处理应用程序的连续内存类型数组的推荐方法。[^1] 1. <code>PyMongoArrow</code>使用手册[^2]</p>
<ol start="2" type="1">
<li><code>PyMongoArrow</code>简明教程[^3]</li>
</ol>
<h1 id="安装">安装</h1>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">pip install pymongoarrow</span><br></pre></td></tr></table></figure>
<p>或 <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">conda install --channel conda-forge pymongoarrow</span><br></pre></td></tr></table></figure></p>
<h1 id="使用">使用</h1>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pymongoarrow</span><br><span class="line"><span class="keyword">import</span> pymongo</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> polars <span class="keyword">as</span> pl</span><br><span class="line"><span class="keyword">from</span> pymongoarrow.monkey <span class="keyword">import</span> patch_all</span><br><span class="line"></span><br><span class="line"><span class="comment"># establish connection with our MongoDB database</span></span><br><span class="line">client = pymongo.MongoClient(<span class="string">&#x27;localhost&#x27;</span>, <span class="number">27017</span>)</span><br><span class="line">db = client[<span class="string">&#x27;quantaxis&#x27;</span>]</span><br><span class="line">collection = db[<span class="string">&#x27;stock_day&#x27;</span>]</span><br><span class="line">patch_all()</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="查询结果转化为pandas数据帧">查询结果转化为<code>Pandas</code>数据帧</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">df_pandas = collection.find_pandas_all(&#123;&#125;)</span><br><span class="line">df_pandas</span><br></pre></td></tr></table></figure>
输出：
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
_id
</th>
<th>
open
</th>
<th>
close
</th>
<th>
high
</th>
<th>
low
</th>
<th>
vol
</th>
<th>
amount
</th>
<th>
date
</th>
<th>
code
</th>
<th>
date_stamp
</th>
</tr>
</thead>
<tbody>
<tr>
<td>
0
</td>
<td>
5f0fd6243530c3ea823c573e
</td>
<td>
49.00
</td>
<td>
49.00
</td>
<td>
49.00
</td>
<td>
49.00
</td>
<td>
32768.5
</td>
<td>
5.000000e+03
</td>
<td>
1991-04-03
</td>
<td>
000001
</td>
<td>
6.706080e+08
</td>
</tr>
<tr>
<td>
1
</td>
<td>
5f0fd6243530c3ea823c573f
</td>
<td>
48.76
</td>
<td>
48.76
</td>
<td>
48.76
</td>
<td>
48.76
</td>
<td>
4098.0
</td>
<td>
1.500000e+04
</td>
<td>
1991-04-04
</td>
<td>
000001
</td>
<td>
6.706944e+08
</td>
</tr>
<tr>
<td>
2
</td>
<td>
5f0fd6243530c3ea823c5740
</td>
<td>
48.52
</td>
<td>
48.52
</td>
<td>
48.52
</td>
<td>
48.52
</td>
<td>
2.0
</td>
<td>
1.000000e+04
</td>
<td>
1991-04-05
</td>
<td>
000001
</td>
<td>
6.707808e+08
</td>
</tr>
<tr>
<td>
3
</td>
<td>
5f0fd6243530c3ea823c5741
</td>
<td>
48.28
</td>
<td>
48.28
</td>
<td>
48.28
</td>
<td>
48.28
</td>
<td>
7.0
</td>
<td>
3.400000e+04
</td>
<td>
1991-04-06
</td>
<td>
000001
</td>
<td>
6.708672e+08
</td>
</tr>
<tr>
<td>
4
</td>
<td>
5f0fd6243530c3ea823c5742
</td>
<td>
48.04
</td>
<td>
48.04
</td>
<td>
48.04
</td>
<td>
48.04
</td>
<td>
2.0
</td>
<td>
1.000000e+04
</td>
<td>
1991-04-08
</td>
<td>
000001
</td>
<td>
6.710400e+08
</td>
</tr>
<tr>
<td>
...
</td>
<td>
...
</td>
<td>
...
</td>
<td>
...
</td>
<td>
...
</td>
<td>
...
</td>
<td>
...
</td>
<td>
...
</td>
<td>
...
</td>
<td>
...
</td>
<td>
...
</td>
</tr>
<tr>
<td>
14705153
</td>
<td>
665deedfcd3d51f9534dd7ca
</td>
<td>
45.10
</td>
<td>
44.85
</td>
<td>
45.49
</td>
<td>
44.69
</td>
<td>
314630.0
</td>
<td>
1.414729e+09
</td>
<td>
2024-05-31
</td>
<td>
688981
</td>
<td>
1.717085e+09
</td>
</tr>
<tr>
<td>
14705154
</td>
<td>
665deedfcd3d51f9534dd7cb
</td>
<td>
44.96
</td>
<td>
45.44
</td>
<td>
46.36
</td>
<td>
44.80
</td>
<td>
393681.0
</td>
<td>
1.796427e+09
</td>
<td>
2024-06-03
</td>
<td>
688981
</td>
<td>
1.717344e+09
</td>
</tr>
<tr>
<td>
14705155
</td>
<td>
665deedfcd3d51f9534dd7cc
</td>
<td>
37.45
</td>
<td>
37.77
</td>
<td>
37.90
</td>
<td>
37.02
</td>
<td>
48175.0
</td>
<td>
1.810881e+08
</td>
<td>
2024-05-30
</td>
<td>
689009
</td>
<td>
1.716998e+09
</td>
</tr>
<tr>
<td>
14705156
</td>
<td>
665deedfcd3d51f9534dd7cd
</td>
<td>
37.69
</td>
<td>
37.51
</td>
<td>
38.35
</td>
<td>
37.31
</td>
<td>
45055.0
</td>
<td>
1.706379e+08
</td>
<td>
2024-05-31
</td>
<td>
689009
</td>
<td>
1.717085e+09
</td>
</tr>
<tr>
<td>
14705157
</td>
<td>
665deedfcd3d51f9534dd7ce
</td>
<td>
37.73
</td>
<td>
38.11
</td>
<td>
39.26
</td>
<td>
37.29
</td>
<td>
95049.0
</td>
<td>
3.641072e+08
</td>
<td>
2024-06-03
</td>
<td>
689009
</td>
<td>
1.717344e+09
</td>
</tr>
</tbody>
</table>
<h2 id="查询结果转化为polars数据帧">查询结果转化为<code>Polars</code>数据帧</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">df_polars = collection.find_polars_all(&#123;&#125;)</span><br><span class="line">df_polars</span><br></pre></td></tr></table></figure>
输出：
<table border="1" class="dataframe">
<thead>
<tr>
<th>
_id
</th>
<th>
open
</th>
<th>
close
</th>
<th>
high
</th>
<th>
low
</th>
<th>
vol
</th>
<th>
amount
</th>
<th>
date
</th>
<th>
code
</th>
<th>
date_stamp
</th>
</tr>
<tr>
<td>
binary
</td>
<td>
f64
</td>
<td>
f64
</td>
<td>
f64
</td>
<td>
f64
</td>
<td>
f64
</td>
<td>
f64
</td>
<td>
str
</td>
<td>
str
</td>
<td>
f64
</td>
</tr>
</thead>
<tbody>
<tr>
<td>
b"_0f$50&lt;W&gt;"
</td>
<td>
49.0
</td>
<td>
49.0
</td>
<td>
49.0
</td>
<td>
49.0
</td>
<td>
32768.5
</td>
<td>
5000.0
</td>
<td>
"1991-04-03"
</td>
<td>
"000001"
</td>
<td>
6.70608e8
</td>
</tr>
<tr>
<td>
b"_0f$50&lt;W?"
</td>
<td>
48.76
</td>
<td>
48.76
</td>
<td>
48.76
</td>
<td>
48.76
</td>
<td>
4098.0
</td>
<td>
15000.0
</td>
<td>
"1991-04-04"
</td>
<td>
"000001"
</td>
<td>
6.706944e8
</td>
</tr>
<tr>
<td>
b"_0f$50&lt;W@"
</td>
<td>
48.52
</td>
<td>
48.52
</td>
<td>
48.52
</td>
<td>
48.52
</td>
<td>
2.0
</td>
<td>
10000.0
</td>
<td>
"1991-04-05"
</td>
<td>
"000001"
</td>
<td>
6.707808e8
</td>
</tr>
<tr>
<td>
b"_0f$50&lt;WA"
</td>
<td>
48.28
</td>
<td>
48.28
</td>
<td>
48.28
</td>
<td>
48.28
</td>
<td>
7.0
</td>
<td>
34000.0
</td>
<td>
"1991-04-06"
</td>
<td>
"000001"
</td>
<td>
6.708672e8
</td>
</tr>
<tr>
<td>
b"_0f$50&lt;WB"
</td>
<td>
48.04
</td>
<td>
48.04
</td>
<td>
48.04
</td>
<td>
48.04
</td>
<td>
2.0
</td>
<td>
10000.0
</td>
<td>
"1991-04-08"
</td>
<td>
"000001"
</td>
<td>
6.7104e8
</td>
</tr>
<tr>
<td>
…
</td>
<td>
…
</td>
<td>
…
</td>
<td>
…
</td>
<td>
…
</td>
<td>
…
</td>
<td>
…
</td>
<td>
…
</td>
<td>
…
</td>
<td>
…
</td>
</tr>
<tr>
<td>
b"f]=Q9SM"
</td>
<td>
45.1
</td>
<td>
44.85
</td>
<td>
45.49
</td>
<td>
44.69
</td>
<td>
314630.0
</td>
<td>
1.4147e9
</td>
<td>
"2024-05-31"
</td>
<td>
"688981"
</td>
<td>
1.7171e9
</td>
</tr>
<tr>
<td>
b"f]=Q9SM"
</td>
<td>
44.96
</td>
<td>
45.44
</td>
<td>
46.36
</td>
<td>
44.8
</td>
<td>
393681.0
</td>
<td>
1.7964e9
</td>
<td>
"2024-06-03"
</td>
<td>
"688981"
</td>
<td>
1.7173e9
</td>
</tr>
<tr>
<td>
b"f]=Q9SM"
</td>
<td>
37.45
</td>
<td>
37.77
</td>
<td>
37.9
</td>
<td>
37.02
</td>
<td>
48175.0
</td>
<td>
1.81088112e8
</td>
<td>
"2024-05-30"
</td>
<td>
"689009"
</td>
<td>
1.7170e9
</td>
</tr>
<tr>
<td>
b"f]=Q9SM"
</td>
<td>
37.69
</td>
<td>
37.51
</td>
<td>
38.35
</td>
<td>
37.31
</td>
<td>
45055.0
</td>
<td>
1.70637904e8
</td>
<td>
"2024-05-31"
</td>
<td>
"689009"
</td>
<td>
1.7171e9
</td>
</tr>
<tr>
<td>
b"f]=Q9SM"
</td>
<td>
37.73
</td>
<td>
38.11
</td>
<td>
39.26
</td>
<td>
37.29
</td>
<td>
95049.0
</td>
<td>
3.64107232e8
</td>
<td>
"2024-06-03"
</td>
<td>
"689009"
</td>
<td>
1.7173e9
</td>
</tr>
</tbody>
</table>
<h2 id="查询结果转化为numpy数组">查询结果转化为<code>Numpy</code>数组</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">ndarrays = collection.find_numpy_all(&#123;&#125;)</span><br><span class="line">ndarrays</span><br></pre></td></tr></table></figure>
<p>输出： <figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;&#x27;_id&#x27;: array([b&#x27;_\x0f\xd6$50\xc3\xea\x82&lt;W&gt;&#x27;, b&#x27;_\x0f\xd6$50\xc3\xea\x82&lt;W?&#x27;,</span><br><span class="line">        b&#x27;_\x0f\xd6$50\xc3\xea\x82&lt;W@&#x27;, ...,</span><br><span class="line">        b&#x27;f]\xee\xdf\xcd=Q\xf9SM\xd7\xcc&#x27;,</span><br><span class="line">        b&#x27;f]\xee\xdf\xcd=Q\xf9SM\xd7\xcd&#x27;,</span><br><span class="line">        b&#x27;f]\xee\xdf\xcd=Q\xf9SM\xd7\xce&#x27;], dtype=object),</span><br><span class="line"> &#x27;open&#x27;: array([49.  , 48.76, 48.52, ..., 37.45, 37.69, 37.73]),</span><br><span class="line"> &#x27;close&#x27;: array([49.  , 48.76, 48.52, ..., 37.77, 37.51, 38.11]),</span><br><span class="line"> &#x27;high&#x27;: array([49.  , 48.76, 48.52, ..., 37.9 , 38.35, 39.26]),</span><br><span class="line"> &#x27;low&#x27;: array([49.  , 48.76, 48.52, ..., 37.02, 37.31, 37.29]),</span><br><span class="line"> &#x27;vol&#x27;: array([3.27685e+04, 4.09800e+03, 2.00000e+00, ..., 4.81750e+04,</span><br><span class="line">        4.50550e+04, 9.50490e+04]),</span><br><span class="line"> &#x27;amount&#x27;: array([5.00000000e+03, 1.50000000e+04, 1.00000000e+04, ...,</span><br><span class="line">        1.81088112e+08, 1.70637904e+08, 3.64107232e+08]),</span><br><span class="line"> &#x27;date&#x27;: array([&#x27;1991-04-03&#x27;, &#x27;1991-04-04&#x27;, &#x27;1991-04-05&#x27;, ..., &#x27;2024-05-30&#x27;,</span><br><span class="line">        &#x27;2024-05-31&#x27;, &#x27;2024-06-03&#x27;], dtype=&#x27;&lt;U10&#x27;),</span><br><span class="line"> &#x27;code&#x27;: array([&#x27;000001&#x27;, &#x27;000001&#x27;, &#x27;000001&#x27;, ..., &#x27;689009&#x27;, &#x27;689009&#x27;, &#x27;689009&#x27;],</span><br><span class="line">       dtype=&#x27;&lt;U6&#x27;),</span><br><span class="line"> &#x27;date_stamp&#x27;: array([6.7060800e+08, 6.7069440e+08, 6.7078080e+08, ..., 1.7169984e+09,</span><br><span class="line">        1.7170848e+09, 1.7173440e+09])&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="查询结果转化为arrow表">查询结果转化为<code>Arrow</code>表</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">arrow_table = collection.find_arrow_all(&#123;&#125;)</span><br><span class="line">arrow_table</span><br></pre></td></tr></table></figure>
<p>输出： <figure class="highlight"><table><tr><td class="code"><pre><span class="line">_id: extension&lt;pymongoarrow.objectid&lt;ObjectIdType&gt;&gt;</span><br><span class="line">open: double</span><br><span class="line">close: double</span><br><span class="line">high: double</span><br><span class="line">low: double</span><br><span class="line">vol: double</span><br><span class="line">amount: double</span><br><span class="line">date: string</span><br><span class="line">code: string</span><br><span class="line">date_stamp: double</span><br><span class="line">----</span><br><span class="line">_id: [[5F0FD6243530C3EA823C573E,5F0FD6243530C3EA823C573F,5F0FD6243530C3EA823C5740,5F0FD6243530C3EA823C5741,5F0FD6243530C3EA823C5742,...,665DEEDFCD3D51F9534DD7CA,665DEEDFCD3D51F9534DD7CB,665DEEDFCD3D51F9534DD7CC,665DEEDFCD3D51F9534DD7CD,665DEEDFCD3D51F9534DD7CE]]</span><br><span class="line">open: [[49,48.76,48.52,48.28,48.04,...,45.1,44.96,37.45,37.69,37.73]]</span><br><span class="line">close: [[49,48.76,48.52,48.28,48.04,...,44.85,45.44,37.77,37.51,38.11]]</span><br><span class="line">high: [[49,48.76,48.52,48.28,48.04,...,45.49,46.36,37.9,38.35,39.26]]</span><br><span class="line">low: [[49,48.76,48.52,48.28,48.04,...,44.69,44.8,37.02,37.31,37.29]]</span><br><span class="line">vol: [[32768.5,4098,2,7,2,...,314630,393681,48175,45055,95049]]</span><br><span class="line">amount: [[5000,15000,10000,34000,10000,...,1414729472,1796427392,181088112,170637904,364107232]]</span><br><span class="line">date: [[&quot;1991-04-03&quot;,&quot;1991-04-04&quot;,&quot;1991-04-05&quot;,&quot;1991-04-06&quot;,&quot;1991-04-08&quot;,...,&quot;2024-05-31&quot;,&quot;2024-06-03&quot;,&quot;2024-05-30&quot;,&quot;2024-05-31&quot;,&quot;2024-06-03&quot;]]</span><br><span class="line">code: [[&quot;000001&quot;,&quot;000001&quot;,&quot;000001&quot;,&quot;000001&quot;,&quot;000001&quot;,...,&quot;688981&quot;,&quot;688981&quot;,&quot;689009&quot;,&quot;689009&quot;,&quot;689009&quot;]]</span><br><span class="line">date_stamp: [[670608000,670694400,670780800,670867200,671040000,...,1717084800,1717344000,1716998400,1717084800,1717344000]]</span><br></pre></td></tr></table></figure> # 参考 [^1]: <a href="https://www.mongodb.com/developer/languages/python/pymongoarrow-and-data-analysis/">PyMongoArrow: Bridging the Gap Between MongoDB and Your Data Analysis App | MongoDB</a> [^2]: <a href="https://www.mongodb.com/zh-cn/docs/languages/python/pymongo-arrow-driver/current/">MongoDB PyMongoArrow - PyMongoArrow v 1.3</a> [^3]: <a href="https://learn.mongodb.com/courses/pymongoarrow?_ga=2.97978335.1908670558.1716903068-485749430.1709679362">PyMongoArrow Extension Course | MongoDB University</a></p>
]]></content>
      <categories>
        <category>软件工程</category>
      </categories>
      <tags>
        <tag>python</tag>
        <tag>mongodb</tag>
        <tag>pymongoarrow</tag>
        <tag>pandas</tag>
        <tag>polars</tag>
        <tag>arrow</tag>
        <tag>numpy</tag>
      </tags>
  </entry>
  <entry>
    <title>【Python】Pandas之dataframe与series的协方差计算</title>
    <url>/2021/07/16/%E3%80%90Python%E3%80%91Pandas%E4%B9%8Bdataframe%E4%B8%8Eseries%E7%9A%84%E5%8D%8F%E6%96%B9%E5%B7%AE%E8%AE%A1%E7%AE%97/</url>
    <content><![CDATA[<h1 id="目的">目的</h1>
<h2 id="什么是协方差">什么是协方差</h2>
<p><code>协方差（Covariance）</code>在概率论和统计学中用于衡量两个变量的总体误差。而方差是协方差的一种特殊情况，即当两个变量是相同的情况。 协方差表示的是两个变量的总体的误差，这与只表示一个变量误差的方差不同。 如果两个变量的变化趋势一致，也就是说如果其中一个大于自身的期望值，另外一个也大于自身的期望值，那么两个变量之间的协方差就是正值。 如果两个变量的变化趋势相反，即其中一个大于自身的期望值，另外一个却小于自身的期望值，那么两个变量之间的协方差就是负值。<br />
<span class="math inline">\(Cov(X,Y) = E[(X-E(X))(Y-E(Y))]\)</span></p>
<a id="more"></a>
<h2 id="协方差的性质">协方差的性质</h2>
<ol type="1">
<li><span class="math inline">\(Cov(X,Y)=Cov(Y,X)\)</span><br />
</li>
<li><span class="math inline">\(Cov(aX,bY)=abCov(X,Y)\)</span>，（a，b是常数）<br />
</li>
<li><span class="math inline">\(Cov(X_1+X_2,Y)=Cov(X_1,Y)+Cov(X_2,Y)\)</span><br />
</li>
<li><span class="math inline">\(Cov(X+a,Y+b)=Cov(X,Y)\)</span></li>
</ol>
<h1 id="协方差的计算">协方差的计算</h1>
<p>可以使用<code>pandas</code>,<code>numpy</code>来计算两个变量的协方差，下面举例分别说明</p>
<h2 id="获取数据">获取数据</h2>
<p>分别取<code>顺丰控股(002352.SZ)</code>，<code>沪深300指数(000300.SH)</code>自2018年12月28日至2019年12月31日的数据，这里是为了计算每日涨跌幅，故多取了2018年最后一个交易日的数据</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> QUANTAXIS <span class="keyword">as</span> QA</span><br><span class="line"><span class="keyword">from</span> IPython.core.interactiveshell <span class="keyword">import</span> InteractiveShell</span><br><span class="line">InteractiveShell.ast_node_interactivity = <span class="string">&quot;all&quot;</span> </span><br><span class="line"></span><br><span class="line">stock = QA.QA_fetch_stock_day_adv(<span class="string">&#x27;002352&#x27;</span>,<span class="string">&#x27;2018-12-28&#x27;</span>,<span class="string">&#x27;2019-12-31&#x27;</span>)</span><br><span class="line">index = QA.QA_fetch_index_day_adv(<span class="string">&#x27;000300&#x27;</span>,<span class="string">&#x27;2018-12-28&#x27;</span>,<span class="string">&#x27;2019-12-31&#x27;</span>)</span><br><span class="line">display(stock.data)</span><br><span class="line">display(index.data)</span><br></pre></td></tr></table></figure>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
</th>
<th>
open
</th>
<th>
high
</th>
<th>
low
</th>
<th>
close
</th>
<th>
volume
</th>
<th>
amount
</th>
</tr>
<tr>
<th>
date
</th>
<th>
code
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
2018-12-28
</th>
<th>
002352
</th>
<td>
32.75
</td>
<td>
33.02
</td>
<td>
32.50
</td>
<td>
32.75
</td>
<td>
55314.0
</td>
<td>
181019008.0
</td>
</tr>
<tr>
<th>
2019-01-02
</th>
<th>
002352
</th>
<td>
32.50
</td>
<td>
32.71
</td>
<td>
32.21
</td>
<td>
32.71
</td>
<td>
16457.0
</td>
<td>
53470292.0
</td>
</tr>
<tr>
<th>
2019-01-03
</th>
<th>
002352
</th>
<td>
32.63
</td>
<td>
32.88
</td>
<td>
32.23
</td>
<td>
32.73
</td>
<td>
22575.0
</td>
<td>
73397384.0
</td>
</tr>
<tr>
<th>
2019-01-04
</th>
<th>
002352
</th>
<td>
32.59
</td>
<td>
32.99
</td>
<td>
32.11
</td>
<td>
32.95
</td>
<td>
36217.0
</td>
<td>
118465936.0
</td>
</tr>
<tr>
<th>
2019-01-07
</th>
<th>
002352
</th>
<td>
32.88
</td>
<td>
32.91
</td>
<td>
32.62
</td>
<td>
32.80
</td>
<td>
31058.0
</td>
<td>
101845472.0
</td>
</tr>
<tr>
<th>
...
</th>
<th>
...
</th>
<td>
...
</td>
<td>
...
</td>
<td>
...
</td>
<td>
...
</td>
<td>
...
</td>
<td>
...
</td>
</tr>
<tr>
<th>
2019-12-25
</th>
<th>
002352
</th>
<td>
38.39
</td>
<td>
38.45
</td>
<td>
37.73
</td>
<td>
37.90
</td>
<td>
70724.0
</td>
<td>
268576480.0
</td>
</tr>
<tr>
<th>
2019-12-26
</th>
<th>
002352
</th>
<td>
38.00
</td>
<td>
38.38
</td>
<td>
37.52
</td>
<td>
37.75
</td>
<td>
72621.0
</td>
<td>
274198528.0
</td>
</tr>
<tr>
<th>
2019-12-27
</th>
<th>
002352
</th>
<td>
37.75
</td>
<td>
38.03
</td>
<td>
37.38
</td>
<td>
37.51
</td>
<td>
97280.0
</td>
<td>
367301696.0
</td>
</tr>
<tr>
<th>
2019-12-30
</th>
<th>
002352
</th>
<td>
37.52
</td>
<td>
37.87
</td>
<td>
37.00
</td>
<td>
37.70
</td>
<td>
106665.0
</td>
<td>
399623008.0
</td>
</tr>
<tr>
<th>
2019-12-31
</th>
<th>
002352
</th>
<td>
37.80
</td>
<td>
37.85
</td>
<td>
37.00
</td>
<td>
37.19
</td>
<td>
78659.0
</td>
<td>
292803712.0
</td>
</tr>
</tbody>
</table>
<p>
245 rows × 6 columns
</p>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
</th>
<th>
open
</th>
<th>
close
</th>
<th>
high
</th>
<th>
low
</th>
<th>
vol
</th>
<th>
amount
</th>
<th>
up_count
</th>
<th>
down_count
</th>
<th>
date_stamp
</th>
<th>
volume
</th>
</tr>
<tr>
<th>
date
</th>
<th>
code
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
2018-12-28
</th>
<th>
000300
</th>
<td>
2994.80
</td>
<td>
3010.65
</td>
<td>
3024.35
</td>
<td>
2984.82
</td>
<td>
710537.0
</td>
<td>
7.814531e+10
</td>
<td>
200
</td>
<td>
81
</td>
<td>
1.545926e+09
</td>
<td>
710537.0
</td>
</tr>
<tr>
<th>
2019-01-02
</th>
<th>
000300
</th>
<td>
3017.07
</td>
<td>
2969.54
</td>
<td>
3018.78
</td>
<td>
2958.49
</td>
<td>
686630.0
</td>
<td>
7.610557e+10
</td>
<td>
70
</td>
<td>
216
</td>
<td>
1.546358e+09
</td>
<td>
686630.0
</td>
</tr>
<tr>
<th>
2019-01-03
</th>
<th>
000300
</th>
<td>
2963.02
</td>
<td>
2964.84
</td>
<td>
3000.44
</td>
<td>
2953.26
</td>
<td>
708671.0
</td>
<td>
7.666480e+10
</td>
<td>
145
</td>
<td>
142
</td>
<td>
1.546445e+09
</td>
<td>
708671.0
</td>
</tr>
<tr>
<th>
2019-01-04
</th>
<th>
000300
</th>
<td>
2940.19
</td>
<td>
3035.87
</td>
<td>
3036.81
</td>
<td>
2935.83
</td>
<td>
1033189.0
</td>
<td>
1.071410e+11
</td>
<td>
286
</td>
<td>
12
</td>
<td>
1.546531e+09
</td>
<td>
1033189.0
</td>
</tr>
<tr>
<th>
2019-01-07
</th>
<th>
000300
</th>
<td>
3055.15
</td>
<td>
3054.30
</td>
<td>
3061.75
</td>
<td>
3035.91
</td>
<td>
1011643.0
</td>
<td>
1.057039e+11
</td>
<td>
217
</td>
<td>
73
</td>
<td>
1.546790e+09
</td>
<td>
1011643.0
</td>
</tr>
<tr>
<th>
...
</th>
<th>
...
</th>
<td>
...
</td>
<td>
...
</td>
<td>
...
</td>
<td>
...
</td>
<td>
...
</td>
<td>
...
</td>
<td>
...
</td>
<td>
...
</td>
<td>
...
</td>
<td>
...
</td>
</tr>
<tr>
<th>
2019-12-25
</th>
<th>
000300
</th>
<td>
3988.66
</td>
<td>
3990.87
</td>
<td>
4000.56
</td>
<td>
3976.36
</td>
<td>
949388.0
</td>
<td>
1.318965e+11
</td>
<td>
117
</td>
<td>
168
</td>
<td>
1.577203e+09
</td>
<td>
949388.0
</td>
</tr>
<tr>
<th>
2019-12-26
</th>
<th>
000300
</th>
<td>
3993.67
</td>
<td>
4025.99
</td>
<td>
4025.99
</td>
<td>
3993.54
</td>
<td>
1088606.0
</td>
<td>
1.408150e+11
</td>
<td>
236
</td>
<td>
53
</td>
<td>
1.577290e+09
</td>
<td>
1088606.0
</td>
</tr>
<tr>
<th>
2019-12-27
</th>
<th>
000300
</th>
<td>
4029.25
</td>
<td>
4022.03
</td>
<td>
4066.80
</td>
<td>
4019.72
</td>
<td>
1509264.0
</td>
<td>
1.950904e+11
</td>
<td>
116
</td>
<td>
173
</td>
<td>
1.577376e+09
</td>
<td>
1509264.0
</td>
</tr>
<tr>
<th>
2019-12-30
</th>
<th>
000300
</th>
<td>
4015.52
</td>
<td>
4081.63
</td>
<td>
4083.69
</td>
<td>
4001.50
</td>
<td>
1559714.0
</td>
<td>
2.168147e+11
</td>
<td>
241
</td>
<td>
53
</td>
<td>
1.577635e+09
</td>
<td>
1559714.0
</td>
</tr>
<tr>
<th>
2019-12-31
</th>
<th>
000300
</th>
<td>
4077.75
</td>
<td>
4096.58
</td>
<td>
4098.14
</td>
<td>
4069.01
</td>
<td>
1232642.0
</td>
<td>
1.731193e+11
</td>
<td>
189
</td>
<td>
95
</td>
<td>
1.577722e+09
</td>
<td>
1232642.0
</td>
</tr>
</tbody>
</table>
<p>
245 rows × 10 columns
</p>
</div>
<p>每日涨跌幅的计算公式为：<span class="math inline">\(\frac{当日收盘价-前日收盘价}{前日收盘价}\)</span><br />
可以有两种方式计算</p>
<ul>
<li>直接计算</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">returns_stock = (stock.data[<span class="string">&#x27;close&#x27;</span>]-stock.data[<span class="string">&#x27;close&#x27;</span>].shift(<span class="number">1</span>))/stock.data[<span class="string">&#x27;close&#x27;</span>].shift(<span class="number">1</span>)</span><br><span class="line">returns_index = (index.data[<span class="string">&#x27;close&#x27;</span>]-index.data[<span class="string">&#x27;close&#x27;</span>].shift(<span class="number">1</span>))/index.data[<span class="string">&#x27;close&#x27;</span>].shift(<span class="number">1</span>)</span><br><span class="line">display(returns_stock,returns_index)</span><br></pre></td></tr></table></figure>
<pre><code>date        code  
2018-12-28  002352         NaN
2019-01-02  002352   -0.001221
2019-01-03  002352    0.000611
2019-01-04  002352    0.006722
2019-01-07  002352   -0.004552
                        ...   
2019-12-25  002352   -0.012764
2019-12-26  002352   -0.003958
2019-12-27  002352   -0.006358
2019-12-30  002352    0.005065
2019-12-31  002352   -0.013528
Name: close, Length: 245, dtype: float64



date        code  
2018-12-28  000300         NaN
2019-01-02  000300   -0.013655
2019-01-03  000300   -0.001583
2019-01-04  000300    0.023957
2019-01-07  000300    0.006071
                        ...   
2019-12-25  000300   -0.000523
2019-12-26  000300    0.008800
2019-12-27  000300   -0.000984
2019-12-30  000300    0.014818
2019-12-31  000300    0.003663
Name: close, Length: 245, dtype: float64</code></pre>
<ul>
<li>使用<code>pct_change()</code>计算</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">returns_stock = stock.data.close.pct_change()</span><br><span class="line">returns_index = index.data.close.pct_change()</span><br><span class="line">display(returns_stock,returns_index)</span><br></pre></td></tr></table></figure>
<pre><code>date        code  
2018-12-28  002352         NaN
2019-01-02  002352   -0.001221
2019-01-03  002352    0.000611
2019-01-04  002352    0.006722
2019-01-07  002352   -0.004552
                        ...   
2019-12-25  002352   -0.012764
2019-12-26  002352   -0.003958
2019-12-27  002352   -0.006358
2019-12-30  002352    0.005065
2019-12-31  002352   -0.013528
Name: close, Length: 245, dtype: float64



date        code  
2018-12-28  000300         NaN
2019-01-02  000300   -0.013655
2019-01-03  000300   -0.001583
2019-01-04  000300    0.023957
2019-01-07  000300    0.006071
                        ...   
2019-12-25  000300   -0.000523
2019-12-26  000300    0.008800
2019-12-27  000300   -0.000984
2019-12-30  000300    0.014818
2019-12-31  000300    0.003663
Name: close, Length: 245, dtype: float64</code></pre>
<h2 id="使用numpy计算协方差">使用<code>numpy</code>计算协方差</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">covr_matrix = np.cov(returns_stock, returns_index)</span><br><span class="line">print(covr_matrix)</span><br></pre></td></tr></table></figure>
<pre><code>[[nan nan]
 [nan nan]]</code></pre>
<p>使用numpy计算协方差时，不会自动排除<code>NaN</code>的数据，所以需要手动清洗数据。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">covr_matrix = np.cov(returns_stock[<span class="number">1</span>:], returns_index[<span class="number">1</span>:])</span><br><span class="line">print(covr_matrix)</span><br></pre></td></tr></table></figure>
<pre><code>[[3.19837928e-04 9.71284226e-05]
 [9.71284226e-05 1.56416934e-04]]</code></pre>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">covr = covr_matrix[<span class="number">0</span>][<span class="number">1</span>]</span><br><span class="line">print(covr)</span><br></pre></td></tr></table></figure>
<pre><code>9.712842264272448e-05</code></pre>
<h2 id="使用pandas计算协方差">使用<code>pandas</code>计算协方差</h2>
<p>因为取出的数据是多含多重索引的series数据，在使用<code>pandas.series.cov()</code>进行协方差计算时，如果索引不一致，会出现计算结果为<code>nan</code>的情况</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">covr = returns_stock.cov(returns_index)</span><br><span class="line">print(covr)</span><br></pre></td></tr></table></figure>
<pre><code>nan</code></pre>
<p>需要先去除多重索引，办法有多种，如使用<code>droplevel()</code>,<code>unstack()</code>等，以下分别举例说明。</p>
<ul>
<li>使用<code>droplevel()</code>来完成</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">covr = returns_stock.droplevel(<span class="number">1</span>).cov(returns_index.droplevel(<span class="number">1</span>))</span><br><span class="line">print(covr)</span><br></pre></td></tr></table></figure>
<pre><code>9.712842264272448e-05</code></pre>
<ul>
<li>使用<code>unstack()</code>来完成</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">df = pd.concat([returns_stock.unstack(), returns_index.unstack()],axis=<span class="number">1</span>)</span><br><span class="line">display(df)</span><br><span class="line">df.cov()</span><br><span class="line">covr = df.cov().loc[<span class="string">&#x27;002352&#x27;</span>,<span class="string">&#x27;000300&#x27;</span>]</span><br><span class="line">print(covr)</span><br></pre></td></tr></table></figure>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
code
</th>
<th>
002352
</th>
<th>
000300
</th>
</tr>
<tr>
<th>
date
</th>
<th>
</th>
<th>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
2018-12-28
</th>
<td>
NaN
</td>
<td>
NaN
</td>
</tr>
<tr>
<th>
2019-01-02
</th>
<td>
-0.001221
</td>
<td>
-0.013655
</td>
</tr>
<tr>
<th>
2019-01-03
</th>
<td>
0.000611
</td>
<td>
-0.001583
</td>
</tr>
<tr>
<th>
2019-01-04
</th>
<td>
0.006722
</td>
<td>
0.023957
</td>
</tr>
<tr>
<th>
2019-01-07
</th>
<td>
-0.004552
</td>
<td>
0.006071
</td>
</tr>
<tr>
<th>
...
</th>
<td>
...
</td>
<td>
...
</td>
</tr>
<tr>
<th>
2019-12-25
</th>
<td>
-0.012764
</td>
<td>
-0.000523
</td>
</tr>
<tr>
<th>
2019-12-26
</th>
<td>
-0.003958
</td>
<td>
0.008800
</td>
</tr>
<tr>
<th>
2019-12-27
</th>
<td>
-0.006358
</td>
<td>
-0.000984
</td>
</tr>
<tr>
<th>
2019-12-30
</th>
<td>
0.005065
</td>
<td>
0.014818
</td>
</tr>
<tr>
<th>
2019-12-31
</th>
<td>
-0.013528
</td>
<td>
0.003663
</td>
</tr>
</tbody>
</table>
<p>
245 rows × 2 columns
</p>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
code
</th>
<th>
002352
</th>
<th>
000300
</th>
</tr>
<tr>
<th>
code
</th>
<th>
</th>
<th>
</th>
</tr>
</thead>
<tbody>
<tr>
<th>
002352
</th>
<td>
0.000320
</td>
<td>
0.000097
</td>
</tr>
<tr>
<th>
000300
</th>
<td>
0.000097
</td>
<td>
0.000156
</td>
</tr>
</tbody>
</table>
</div>
<pre><code>9.71284226427245e-05</code></pre>
<p>使用<code>pandas.dataframe.cov()</code>或<code>panadas.series.cov()</code>时,会自动排除<code>NaN</code>的数据，这一点与用numpy来计算是有区别的。</p>
]]></content>
      <categories>
        <category>技术笔记</category>
        <category>量化投资</category>
      </categories>
      <tags>
        <tag>python</tag>
        <tag>线性代数</tag>
      </tags>
  </entry>
  <entry>
    <title>【Python】pandas dataframe输出格式对齐美化的思路</title>
    <url>/2021/05/14/%E3%80%90Python%E3%80%91pandas%20dataframe%E8%BE%93%E5%87%BA%E6%A0%BC%E5%BC%8F%E5%AF%B9%E9%BD%90%E7%BE%8E%E5%8C%96%E7%9A%84%E6%80%9D%E8%B7%AF/</url>
    <content><![CDATA[<h1 id="需求">需求</h1>
<p>在jupyter中可以直接使用用dataframe的名字输出美观的表格形式，例如：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> QUANTAXIS <span class="keyword">as</span> QA</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">通过本地数据库获取股票日线数据：</span></span><br><span class="line"><span class="string">QA.QA_fetch_stock_day_adv(</span></span><br><span class="line"><span class="string">    code,</span></span><br><span class="line"><span class="string">    start=&#x27;all&#x27;,</span></span><br><span class="line"><span class="string">    end=None,</span></span><br><span class="line"><span class="string">    if_drop_index=True,</span></span><br><span class="line"><span class="string">    collections=Collection(Database(MongoClient(host=[&#x27;localhost:27017&#x27;], document_class=dict, tz_aware=False, connect=True), &#x27;quantaxis&#x27;), &#x27;stock_day&#x27;),</span></span><br><span class="line"><span class="string">)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">data=QA.QA_fetch_stock_day_adv([<span class="string">&quot;002003&quot;</span>,<span class="string">&#x27;300999&#x27;</span>,<span class="string">&#x27;603899&#x27;</span>],<span class="string">&#x27;2021-05-12&#x27;</span>,<span class="string">&#x27;2021-05-13&#x27;</span>)</span><br><span class="line">df = data.data</span><br><span class="line">df</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
</th>
<th>
open
</th>
<th>
high
</th>
<th>
low
</th>
<th>
close
</th>
<th>
volume
</th>
<th>
amount
</th>
</tr>
<tr>
<th>
date
</th>
<th>
code
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
</tr>
</thead>
<tbody>
<tr>
<th rowspan="3" valign="top">
2021-05-12
</th>
<th>
002003
</th>
<td>
7.32
</td>
<td>
7.51
</td>
<td>
7.28
</td>
<td>
7.48
</td>
<td>
80536.0
</td>
<td>
5.980900e+07
</td>
</tr>
<tr>
<th>
300999
</th>
<td>
76.12
</td>
<td>
76.75
</td>
<td>
75.11
</td>
<td>
76.20
</td>
<td>
146625.0
</td>
<td>
1.114936e+09
</td>
</tr>
<tr>
<th>
603899
</th>
<td>
86.80
</td>
<td>
87.85
</td>
<td>
85.71
</td>
<td>
86.60
</td>
<td>
19172.0
</td>
<td>
1.656046e+08
</td>
</tr>
<tr>
<th rowspan="3" valign="top">
2021-05-13
</th>
<th>
002003
</th>
<td>
7.44
</td>
<td>
7.63
</td>
<td>
7.34
</td>
<td>
7.55
</td>
<td>
98429.0
</td>
<td>
7.403393e+07
</td>
</tr>
<tr>
<th>
300999
</th>
<td>
75.00
</td>
<td>
75.60
</td>
<td>
74.04
</td>
<td>
74.20
</td>
<td>
144742.0
</td>
<td>
1.080974e+09
</td>
</tr>
<tr>
<th>
603899
</th>
<td>
85.71
</td>
<td>
88.12
</td>
<td>
85.10
</td>
<td>
87.59
</td>
<td>
14734.0
</td>
<td>
1.280291e+08
</td>
</tr>
</tbody>
</table>
</div>
<p>在使用<code>print</code>输出时的结果是这样的。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">print(df)</span><br></pre></td></tr></table></figure>
<pre><code>                    open   high    low  close    volume        amount
date       code                                                      
2021-05-12 002003   7.32   7.51   7.28   7.48   80536.0  5.980900e+07
           300999  76.12  76.75  75.11  76.20  146625.0  1.114936e+09
           603899  86.80  87.85  85.71  86.60   19172.0  1.656046e+08
2021-05-13 002003   7.44   7.63   7.34   7.55   98429.0  7.403393e+07
           300999  75.00  75.60  74.04  74.20  144742.0  1.080974e+09
           603899  85.71  88.12  85.10  87.59   14734.0  1.280291e+08</code></pre>
<p>而当DataFrame中存在中英文混合的时候，会出现print()打印无法对齐的情况，导致输出的结果都没有对齐，十分不美观。如:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">df1 = df</span><br><span class="line">df1.columns = [<span class="string">&quot;开盘价&quot;</span>, <span class="string">&quot;最高价&quot;</span>, <span class="string">&quot;最低价&quot;</span>, <span class="string">&quot;收盘价&quot;</span>, <span class="string">&quot;成交量&quot;</span>, <span class="string">&quot;成交金额&quot;</span>]</span><br><span class="line">print(df1)</span><br></pre></td></tr></table></figure>
<pre><code>                     开盘价    最高价    最低价    收盘价       成交量          成交金额
date       code                                                      
2021-05-12 002003   7.32   7.51   7.28   7.48   80536.0  5.980900e+07
           300999  76.12  76.75  75.11  76.20  146625.0  1.114936e+09
           603899  86.80  87.85  85.71  86.60   19172.0  1.656046e+08
2021-05-13 002003   7.44   7.63   7.34   7.55   98429.0  7.403393e+07
           300999  75.00  75.60  74.04  74.20  144742.0  1.080974e+09
           603899  85.71  88.12  85.10  87.59   14734.0  1.280291e+08</code></pre>
<p>那么问题来了。 1. 有没有办法使用<code>print</code>输出中英文混合的dataframe可以对齐美观？ 2. 在执行完整的python代码时(非jupyter)，有办法象jupyter中一样输出美观的dataframe表格么？</p>
<h1 id="解决办法">解决办法</h1>
<h2 id="问题1-有没有办法使用print输出中英文混合的dataframe可以对齐美观">问题1 有没有办法使用print输出中英文混合的dataframe可以对齐美观？</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line">pd.set_option(<span class="string">&#x27;display.unicode.ambiguous_as_wide&#x27;</span>, <span class="literal">True</span>)</span><br><span class="line">pd.set_option(<span class="string">&#x27;display.unicode.east_asian_width&#x27;</span>, <span class="literal">True</span>)</span><br><span class="line">pd.set_option(<span class="string">&#x27;display.width&#x27;</span>, <span class="number">180</span>)                       <span class="comment"># 设置打印宽度(**重要**)</span></span><br><span class="line">print(df1)</span><br></pre></td></tr></table></figure>
<pre><code>                   开盘价  最高价  最低价  收盘价    成交量      成交金额
date       code                                                          
2021-05-12 002003    7.32    7.51    7.28    7.48   80536.0  5.980900e+07
           300999   76.12   76.75   75.11   76.20  146625.0  1.114936e+09
           603899   86.80   87.85   85.71   86.60   19172.0  1.656046e+08
2021-05-13 002003    7.44    7.63    7.34    7.55   98429.0  7.403393e+07
           300999   75.00   75.60   74.04   74.20  144742.0  1.080974e+09
           603899   85.71   88.12   85.10   87.59   14734.0  1.280291e+08</code></pre>
<h2 id="问题2-在执行完整的python代码时非jupyter有办法象jupyter中一样输出美观的dataframe表格么">问题2 在执行完整的python代码时(非jupyter)，有办法象jupyter中一样输出美观的dataframe表格么？</h2>
<p>使用<code>IPython.display</code>来替换<code>print</code>的输出效果。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> IPython.display <span class="keyword">import</span> display</span><br><span class="line"></span><br><span class="line">display(df)</span><br><span class="line">display(df1)</span><br></pre></td></tr></table></figure>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
</th>
<th>
开盘价
</th>
<th>
最高价
</th>
<th>
最低价
</th>
<th>
收盘价
</th>
<th>
成交量
</th>
<th>
成交金额
</th>
</tr>
<tr>
<th>
date
</th>
<th>
code
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
</tr>
</thead>
<tbody>
<tr>
<th rowspan="3" valign="top">
2021-05-12
</th>
<th>
002003
</th>
<td>
7.32
</td>
<td>
7.51
</td>
<td>
7.28
</td>
<td>
7.48
</td>
<td>
80536.0
</td>
<td>
5.980900e+07
</td>
</tr>
<tr>
<th>
300999
</th>
<td>
76.12
</td>
<td>
76.75
</td>
<td>
75.11
</td>
<td>
76.20
</td>
<td>
146625.0
</td>
<td>
1.114936e+09
</td>
</tr>
<tr>
<th>
603899
</th>
<td>
86.80
</td>
<td>
87.85
</td>
<td>
85.71
</td>
<td>
86.60
</td>
<td>
19172.0
</td>
<td>
1.656046e+08
</td>
</tr>
<tr>
<th rowspan="3" valign="top">
2021-05-13
</th>
<th>
002003
</th>
<td>
7.44
</td>
<td>
7.63
</td>
<td>
7.34
</td>
<td>
7.55
</td>
<td>
98429.0
</td>
<td>
7.403393e+07
</td>
</tr>
<tr>
<th>
300999
</th>
<td>
75.00
</td>
<td>
75.60
</td>
<td>
74.04
</td>
<td>
74.20
</td>
<td>
144742.0
</td>
<td>
1.080974e+09
</td>
</tr>
<tr>
<th>
603899
</th>
<td>
85.71
</td>
<td>
88.12
</td>
<td>
85.10
</td>
<td>
87.59
</td>
<td>
14734.0
</td>
<td>
1.280291e+08
</td>
</tr>
</tbody>
</table>
</div>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
</th>
<th>
开盘价
</th>
<th>
最高价
</th>
<th>
最低价
</th>
<th>
收盘价
</th>
<th>
成交量
</th>
<th>
成交金额
</th>
</tr>
<tr>
<th>
date
</th>
<th>
code
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
</tr>
</thead>
<tbody>
<tr>
<th rowspan="3" valign="top">
2021-05-12
</th>
<th>
002003
</th>
<td>
7.32
</td>
<td>
7.51
</td>
<td>
7.28
</td>
<td>
7.48
</td>
<td>
80536.0
</td>
<td>
5.980900e+07
</td>
</tr>
<tr>
<th>
300999
</th>
<td>
76.12
</td>
<td>
76.75
</td>
<td>
75.11
</td>
<td>
76.20
</td>
<td>
146625.0
</td>
<td>
1.114936e+09
</td>
</tr>
<tr>
<th>
603899
</th>
<td>
86.80
</td>
<td>
87.85
</td>
<td>
85.71
</td>
<td>
86.60
</td>
<td>
19172.0
</td>
<td>
1.656046e+08
</td>
</tr>
<tr>
<th rowspan="3" valign="top">
2021-05-13
</th>
<th>
002003
</th>
<td>
7.44
</td>
<td>
7.63
</td>
<td>
7.34
</td>
<td>
7.55
</td>
<td>
98429.0
</td>
<td>
7.403393e+07
</td>
</tr>
<tr>
<th>
300999
</th>
<td>
75.00
</td>
<td>
75.60
</td>
<td>
74.04
</td>
<td>
74.20
</td>
<td>
144742.0
</td>
<td>
1.080974e+09
</td>
</tr>
<tr>
<th>
603899
</th>
<td>
85.71
</td>
<td>
88.12
</td>
<td>
85.10
</td>
<td>
87.59
</td>
<td>
14734.0
</td>
<td>
1.280291e+08
</td>
</tr>
</tbody>
</table>
</div>
<h3 id="问题3-输出dataframe数据时可以不输出索引号么">问题3 输出dataframe数据时，可以不输出索引号么？</h3>
<p><code>python 2.7</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">print</span> df.to_string(index=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>
<p><code>python 3</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">print(df.to_string(index=<span class="literal">False</span>))</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>技术笔记</category>
        <category>python</category>
      </categories>
      <tags>
        <tag>dataframe</tag>
      </tags>
  </entry>
  <entry>
    <title>【Quantaxis】QAAccount简单回测</title>
    <url>/2024/06/13/%E3%80%90Quantaxis%E3%80%91QAAccount%E7%AE%80%E5%8D%95%E5%9B%9E%E6%B5%8B/</url>
    <content><![CDATA[<h1 id="qaaccount与mongodb"># QAAccount与MongoDB</h1>
<p>在使用<code>QAAccoount</code>类进行回测时，<code>MongoDB</code>数据库<code>quantaxis</code>中，会涉及到的数据表有 5 个， 分别是：</p>
<ul>
<li>portfolio</li>
<li>user</li>
<li>account</li>
<li>risk</li>
<li>strategy</li>
</ul>
<h1 id="回测中的逻辑关系">回测中的逻辑关系</h1>
<figure>
<img src="https://s2.loli.net/2024/06/15/3wCHVAOBfc7Ml6v.png" alt="|1000" /><figcaption aria-hidden="true">|1000</figcaption>
</figure>
<a id="more"></a>
<h1 id="示例">示例</h1>
<h2 id="创建资产用户资产组合帐户">创建资产用户/资产组合/帐户</h2>
<p><code>Quantaxis</code> v1.3.0以后, QA_Account需要由组合来进行创建(推荐)。为避免出过多因使用未来版本会降级的函数导致的警告信息。 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> warnings</span><br><span class="line">warnings.filterwarnings(<span class="string">&#x27;ignore&#x27;</span>)</span><br></pre></td></tr></table></figure></p>
<h3 id="创建用户">创建用户</h3>
<p>用户名为<code>qaacc</code>,密码为<code>qaacc</code> <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> QUANTAXIS <span class="keyword">as</span> QA</span><br><span class="line"></span><br><span class="line">user = QA.QA_User(username=<span class="string">&#x27;qaacc&#x27;</span>, password=<span class="string">&#x27;qaacc&#x27;</span>)</span><br></pre></td></tr></table></figure> ### 创建资产组合 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">portfolio = user.new_portfolio(<span class="string">&#x27;stock&#x27;</span>)</span><br></pre></td></tr></table></figure></p>
<h3 id="创建帐户">创建帐户</h3>
<p>可以创建多市场的帐户，这里以创建股票市场帐户为例。 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">account = portfolio.new_account(account_cookie=<span class="string">&#x27;lvjun&#x27;</span>)</span><br></pre></td></tr></table></figure></p>
<h2 id="账户的初始资金初始仓位">账户的初始资金/初始仓位</h2>
<p>默认账户是无仓位, 默认现金 <strong><em>1,000,000</em></strong> RMB <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">account.init_assets</span><br></pre></td></tr></table></figure> 输出： <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">&#123;&#x27;cash&#x27;: 1000000, &#x27;hold&#x27;: &#123;&#125;&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">account.init_cash</span><br></pre></td></tr></table></figure>
<p>输出： <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">1000000</span><br></pre></td></tr></table></figure></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">account.init_hold</span><br></pre></td></tr></table></figure>
<p>输出： <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Series([], Name: amount, dtype: object)</span><br></pre></td></tr></table></figure></p>
<h1 id="简单回测">简单回测</h1>
<p>用帐户<code>account_cookie='lvjun'</code>进行简单回测。<code>Quantaxis</code>版本为 <strong><em>1.10.19</em></strong>。</p>
<h2 id="新建策略">新建策略</h2>
<p><code>MACD_JCSC</code>策略思想是MACD指标出现金叉（DIF向上突破DEA)买入，出现死叉（DIF向下跌破DEA）卖出。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> QUANTAXIS <span class="keyword">as</span> QA</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="comment"># define the MACD strategy</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">MACD_JCSC</span>(<span class="params">dataframe, SHORT=<span class="number">12</span>, LONG=<span class="number">26</span>, M=<span class="number">9</span></span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    1.DIF向上突破DEA，买入信号参考。</span></span><br><span class="line"><span class="string">    2.DIF向下跌破DEA，卖出信号参考。</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    CLOSE = dataframe.close</span><br><span class="line">    DIFF = QA.EMA(CLOSE, SHORT) - QA.EMA(CLOSE, LONG)</span><br><span class="line">    DEA = QA.EMA(DIFF, M)</span><br><span class="line">    MACD = <span class="number">2</span>*(DIFF-DEA)</span><br><span class="line"></span><br><span class="line">    CROSS_JC = QA.CROSS(DIFF, DEA)</span><br><span class="line">    CROSS_SC = QA.CROSS(DEA, DIFF)</span><br><span class="line">    ZERO = <span class="number">0</span></span><br><span class="line">    <span class="keyword">return</span> pd.DataFrame(&#123;<span class="string">&#x27;DIFF&#x27;</span>: DIFF, <span class="string">&#x27;DEA&#x27;</span>: DEA, <span class="string">&#x27;MACD&#x27;</span>: MACD, <span class="string">&#x27;CROSS_JC&#x27;</span>: CROSS_JC, <span class="string">&#x27;CROSS_SC&#x27;</span>: CROSS_SC, <span class="string">&#x27;ZERO&#x27;</span>: ZERO&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="初始化回测broker及保存策略">初始化回测broker及保存策略</h2>
<p>策略源码保存可以保存到网络侧(127.0.0.1:8010)，也可以保存到本地。 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">Broker = QA.QA_BacktestBroker()</span><br><span class="line"><span class="comment"># 策略保存到本地, 当含参`if_save=True`时, 会保存到本地。 在数据表·strategy`中可以看到具体信息。</span></span><br><span class="line">QA.QA_SU_save_strategy(<span class="string">&#x27;MACD_JCSC&#x27;</span>, <span class="string">&#x27;Indicator&#x27;</span>, account.account_cookie)</span><br></pre></td></tr></table></figure></p>
<h2 id="选择测试标的物数据">选择测试标的物数据</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># get data from mongodb</span></span><br><span class="line">codelist = [<span class="string">&#x27;000001&#x27;</span>]</span><br><span class="line">data = QA.QA_fetch_stock_day_adv(codelist, <span class="string">&#x27;2017-09-01&#x27;</span>, <span class="string">&#x27;2018-05-20&#x27;</span>)</span><br><span class="line">data = data.to_qfq()</span><br></pre></td></tr></table></figure>
<h2 id="计算指标信号">计算指标信号</h2>
<p>指标的计算可以在回测前，也可以在回测中进行。区别在于回测前的计算则是批量计算，效率较高。而回测中进行计算，效率略低，但代码量较小，易于理解。 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">ind = data.add_func(MACD_JCSC)</span><br><span class="line">print(<span class="string">&quot;金叉信号出现：%d 次&quot;</span> % ind[<span class="string">&#x27;CROSS_JC&#x27;</span>].value_counts()[<span class="number">1</span>])</span><br><span class="line">print(<span class="string">&quot;死叉信号出现：%d 次&quot;</span> % ind[<span class="string">&#x27;CROSS_SC&#x27;</span>].value_counts()[<span class="number">1</span>])</span><br></pre></td></tr></table></figure> <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">金叉信号出现：8 次</span><br><span class="line">死叉信号出现：7 次</span><br></pre></td></tr></table></figure> 列出出现信号时的数据。 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">ind.loc[(ind[<span class="string">&#x27;CROSS_JC&#x27;</span>] == <span class="number">1</span>) | (ind[<span class="string">&#x27;CROSS_SC&#x27;</span>] == <span class="number">1</span>)]</span><br></pre></td></tr></table></figure> 输出：<br />
<img src="https://s2.loli.net/2024/06/15/glrQXEwnaJIdKFS.png" alt="|500" /></p>
<h2 id="回测">回测</h2>
<p>通过迭代产生<code>Dataframe</code>截面数据的方式，对产生信号的标的物进行交易回测。 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> items <span class="keyword">in</span> data_forbacktest.panel_gen:</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> items.security_gen:</span><br><span class="line">        daily_ind = ind.loc[item.index]</span><br><span class="line">        <span class="keyword">if</span> daily_ind.CROSS_JC.iloc[<span class="number">0</span>] &gt; <span class="number">0</span>:</span><br><span class="line">            order = account.send_order(</span><br><span class="line">                code=item.code[<span class="number">0</span>],</span><br><span class="line">                time=item.date[<span class="number">0</span>],</span><br><span class="line">                amount=<span class="number">1000</span>,</span><br><span class="line">                towards=QA.ORDER_DIRECTION.BUY,</span><br><span class="line">                price=<span class="number">0</span>,</span><br><span class="line">                order_model=QA.ORDER_MODEL.CLOSE,</span><br><span class="line">                amount_model=QA.AMOUNT_MODEL.BY_AMOUNT</span><br><span class="line">            )</span><br><span class="line"></span><br><span class="line">            Broker.receive_order(QA.QA_Event(order=order, market_data=item))</span><br><span class="line">            trade_mes = Broker.query_orders(account.account_cookie, <span class="string">&#x27;filled&#x27;</span>)</span><br><span class="line">            res = trade_mes.loc[order.account_cookie, order.realorder_id]</span><br><span class="line">            order.trade(res.trade_id, res.trade_price,res.trade_amount, res.trade_time)</span><br><span class="line">        <span class="keyword">elif</span> daily_ind.CROSS_SC.iloc[<span class="number">0</span>] &gt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">if</span> account.sell_available.get(item.code[<span class="number">0</span>], <span class="number">0</span>) &gt; <span class="number">0</span>:</span><br><span class="line">                order = account.send_order(</span><br><span class="line">                    code=item.code[<span class="number">0</span>],</span><br><span class="line">                    time=item.date[<span class="number">0</span>],</span><br><span class="line">                    amount=account.sell_available.get(item.code[<span class="number">0</span>], <span class="number">0</span>),</span><br><span class="line">                    towards=QA.ORDER_DIRECTION.SELL,</span><br><span class="line">                    price=<span class="number">0</span>,</span><br><span class="line">                    order_model=QA.ORDER_MODEL.MARKET,</span><br><span class="line">                    amount_model=QA.AMOUNT_MODEL.BY_AMOUNT</span><br><span class="line">                )</span><br><span class="line">                Broker.receive_order(QA.QA_Event(order=order, market_data=item))</span><br><span class="line">                trade_mes = Broker.query_orders(account.account_cookie, <span class="string">&#x27;filled&#x27;</span>)</span><br><span class="line">                res = trade_mes.loc[order.account_cookie, order.realorder_id]</span><br><span class="line">                order.trade(res.trade_id, res.trade_price,res.trade_amount, res.trade_time)</span><br><span class="line">    account.settle()</span><br></pre></td></tr></table></figure> 输出： <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">QAACCOUNT ==&gt; receive deal  Time 2018-01-02 00:00:00/ Code:000001/ Price:12.48/ TOWARDS:1/ Amounts:1000</span><br><span class="line">QAACCOUNT ==&gt; receive deal  Time 2018-01-03 00:00:00/ Code:000001/ Price:12.32/ TOWARDS:-1/ Amounts:1000</span><br><span class="line">QAACCOUNT ==&gt; receive deal  Time 2018-01-12 00:00:00/ Code:000001/ Price:12.34/ TOWARDS:1/ Amounts:1000</span><br><span class="line">QAACCOUNT ==&gt; receive deal  Time 2018-01-29 00:00:00/ Code:000001/ Price:12.68/ TOWARDS:-1/ Amounts:1000</span><br><span class="line">QAACCOUNT ==&gt; receive deal  Time 2018-03-08 00:00:00/ Code:000001/ Price:11.03/ TOWARDS:1/ Amounts:1000</span><br><span class="line">QAACCOUNT ==&gt; receive deal  Time 2018-03-26 00:00:00/ Code:000001/ Price:10.05/ TOWARDS:-1/ Amounts:1000</span><br><span class="line">QAACCOUNT ==&gt; receive deal  Time 2018-04-10 00:00:00/ Code:000001/ Price:10.4/ TOWARDS:1/ Amounts:1000</span><br></pre></td></tr></table></figure></p>
<h2 id="风险与绩效分析">风险与绩效分析</h2>
<p>可以手工完成分析，或是进入 Web 界面调用数据分析。</p>
<h3 id="风险分析">风险分析</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">Risk = QA.QA_Risk(account)</span><br><span class="line">Risk.plot_assets_curve()</span><br></pre></td></tr></table></figure>
<p>输出：<br />
<img src="https://s2.loli.net/2024/06/15/bNjOUB68xyTqvLh.png" alt="|600" /></p>
<h3 id="绩效分析">绩效分析</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">Performance = QA.QA_Performance(account)</span><br><span class="line">Performance.base_message(Performance.pnl)</span><br></pre></td></tr></table></figure>
<p>输出：<br />
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;status&quot;: 200,</span><br><span class="line">    &quot;result&quot;: &#123;</span><br><span class="line">        &quot;total_profit&quot;: 340.0,</span><br><span class="line">        &quot;total_loss&quot;: -1140.0,</span><br><span class="line">        &quot;total_pnl&quot;: 0.3,</span><br><span class="line">        &quot;trading_amounts&quot;: 3,</span><br><span class="line">        &quot;profit_amounts&quot;: 1,</span><br><span class="line">        &quot;loss_amounts&quot;: 2,</span><br><span class="line">        &quot;even_amounts&quot;: 0,</span><br><span class="line">        &quot;profit_precentage&quot;: 0.33,</span><br><span class="line">        &quot;loss_precentage&quot;: 0.67,</span><br><span class="line">        &quot;even_precentage&quot;: 0.0,</span><br><span class="line">        &quot;average_profit&quot;: 340.0,</span><br><span class="line">        &quot;average_loss&quot;: -570.0,</span><br><span class="line">        &quot;average_pnl&quot;: 0.6,</span><br><span class="line">        &quot;max_profit&quot;: 340.0,</span><br><span class="line">        &quot;max_loss&quot;: -980.0,</span><br><span class="line">        &quot;max_pnl&quot;: 0.35,</span><br><span class="line">        &quot;netprofio_maxloss_ratio&quot;: 0.82,</span><br><span class="line">        &quot;continue_profit_amount&quot;: 1,</span><br><span class="line">        &quot;continue_loss_amount&quot;: 1,</span><br><span class="line">        &quot;average_holdgap&quot;: &quot;12 days 00:00:00&quot;,</span><br><span class="line">        &quot;average_profitholdgap&quot;: &quot;17 days 00:00:00&quot;,</span><br><span class="line">        &quot;average_losssholdgap&quot;: &quot;9 days 12:00:00&quot;,</span><br><span class="line">        &quot;buyopen&quot;: &#123;</span><br><span class="line">            &quot;total_profit&quot;: 340.0,</span><br><span class="line">            &quot;total_loss&quot;: -1140.0,</span><br><span class="line">            &quot;total_pnl&quot;: 0.3,</span><br><span class="line">            &quot;trading_amounts&quot;: 3,</span><br><span class="line">            &quot;profit_amounts&quot;: 1,</span><br><span class="line">            &quot;loss_amounts&quot;: 2,</span><br><span class="line">            &quot;even_amounts&quot;: 0,</span><br><span class="line">            &quot;profit_precentage&quot;: 0.33,</span><br><span class="line">            &quot;loss_precentage&quot;: 0.67,</span><br><span class="line">            &quot;even_precentage&quot;: 0.0,</span><br><span class="line">            &quot;average_profit&quot;: 340.0,</span><br><span class="line">            &quot;average_loss&quot;: -570.0,</span><br><span class="line">            &quot;average_pnl&quot;: 0.6,</span><br><span class="line">            &quot;max_profit&quot;: 340.0,</span><br><span class="line">            &quot;max_loss&quot;: -980.0,</span><br><span class="line">            &quot;max_pnl&quot;: 0.35,</span><br><span class="line">            &quot;netprofio_maxloss_ratio&quot;: 0.82,</span><br><span class="line">            &quot;continue_profit_amount&quot;: 1,</span><br><span class="line">            &quot;continue_loss_amount&quot;: 1,</span><br><span class="line">            &quot;average_holdgap&quot;: &quot;12 days 00:00:00&quot;,</span><br><span class="line">            &quot;average_profitholdgap&quot;: &quot;17 days 00:00:00&quot;,</span><br><span class="line">            &quot;average_losssholdgap&quot;: &quot;9 days 12:00:00&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;sellopen&quot;: &#123;</span><br><span class="line">            &quot;total_profit&quot;: 0,</span><br><span class="line">            &quot;total_loss&quot;: 0,</span><br><span class="line">            &quot;total_pnl&quot;: 0,</span><br><span class="line">            &quot;trading_amounts&quot;: 0,</span><br><span class="line">            &quot;profit_amounts&quot;: 0,</span><br><span class="line">            &quot;loss_amounts&quot;: 0,</span><br><span class="line">            &quot;even_amounts&quot;: 0,</span><br><span class="line">            &quot;profit_precentage&quot;: 0,</span><br><span class="line">            &quot;loss_precentage&quot;: 0,</span><br><span class="line">            &quot;even_precentage&quot;: 0,</span><br><span class="line">            &quot;average_profit&quot;: 0,</span><br><span class="line">            &quot;average_loss&quot;: 0,</span><br><span class="line">            &quot;average_pnl&quot;: 0,</span><br><span class="line">            &quot;max_profit&quot;: 0,</span><br><span class="line">            &quot;max_loss&quot;: 0,</span><br><span class="line">            &quot;max_pnl&quot;: 0,</span><br><span class="line">            &quot;netprofio_maxloss_ratio&quot;: 0,</span><br><span class="line">            &quot;continue_profit_amount&quot;: 0,</span><br><span class="line">            &quot;continue_loss_amount&quot;: 0,</span><br><span class="line">            &quot;average_holdgap&quot;: &quot;no trade&quot;,</span><br><span class="line">            &quot;average_profitholdgap&quot;: &quot;no trade&quot;,</span><br><span class="line">            &quot;average_losssholdgap&quot;: &quot;no trade&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="web浏览方式">Web浏览方式</h3>
<p>浏览器输入：<a href="http://127.0.0.1:81">http://127.0.0.1:81</a> ,使用回测时创建用户名/密码。</p>
<ul>
<li>风险与绩效分析<br />
<img src="https://s2.loli.net/2024/06/15/Eaj94dUTFVboZ5W.png" alt="|600" /></li>
<li>买卖信号记录<br />
<img src="https://s2.loli.net/2024/06/15/pH9gx73RDtJCOnZ.png" alt="|600" /></li>
</ul>
<h1 id="备注">备注：</h1>
<p>计算 <code>Performance.continue_profit_amount</code> 等指标时时，原代码中使用了 <code> for _, item in pnl.pnl_money.items():</code>, 在 <strong><em>Pandas ≥ 1.5</em></strong> 时，<code>Series.iteritems()</code>, <code>DataFrame.iteritems()</code> 及 <code>HDFStore.iteritems()</code> 均使用 <code>obj.items</code> 进行替代。<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">### What’s new in 1.5.0 (September 19, 2022)</span><br><span class="line">- Deprecated &#96;DataFrame.iteritems()&#96;, &#96;Series.iteritems()&#96;, &#96;HDFStore.iteritems()&#96; in favor of [&#96;DataFrame.items()&#96;](https:&#x2F;&#x2F;pandas.pydata.org&#x2F;pandas-docs&#x2F;stable&#x2F;reference&#x2F;api&#x2F;pandas.DataFrame.items.html#pandas.DataFrame.items &quot;pandas.DataFrame.items&quot;), [&#96;Series.items()&#96;](https:&#x2F;&#x2F;pandas.pydata.org&#x2F;pandas-docs&#x2F;stable&#x2F;reference&#x2F;api&#x2F;pandas.Series.items.html#pandas.Series.items &quot;pandas.Series.items&quot;), &#96;HDFStore.items()&#96; ([GH 45321](https:&#x2F;&#x2F;github.com&#x2F;pandas-dev&#x2F;pandas&#x2F;issues&#x2F;45321))</span><br><span class="line"></span><br><span class="line">### What’s new in 2.0.0 (April 3, 2023)</span><br><span class="line">- Removed deprecated &#96;Series.iteritems()&#96;, &#96;DataFrame.iteritems()&#96;, use &#96;obj.items&#96; instead ([GH 45321](https:&#x2F;&#x2F;github.com&#x2F;pandas-dev&#x2F;pandas&#x2F;issues&#x2F;45321))</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="参考">参考</h1>
<section class="footnotes" role="doc-endnotes">
<hr />
<ol>
<li id="fn1" role="doc-endnote"><p><a href="https://pandas.pydata.org/pandas-docs/stable/search.html?q=iteritems">Search - pandas 2.2.2 documentation (pydata.org)</a><a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>
]]></content>
      <categories>
        <category>量化交易</category>
      </categories>
      <tags>
        <tag>python</tag>
        <tag>quantaxis</tag>
      </tags>
  </entry>
  <entry>
    <title>【Rust】Rust在win10下开发环境的搭建</title>
    <url>/2021/01/04/%E3%80%90Rust%E3%80%91Rust%E5%9C%A8win10%E4%B8%8B%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E7%9A%84%E6%90%AD%E5%BB%BA/</url>
    <content><![CDATA[<p>记录下如何在Windows 10环境下部署VScode的Rust开发环境。</p>
<h1 id="配置步骤">配置步骤</h1>
<h2 id="环境变量设置">环境变量设置</h2>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">RUST&#x3D;d:\Program Files\RUST\.rustup\toolchains\stable-x86_64-pc-windows-msvc  </span><br><span class="line">CARGO HOME &#x3D; D:\Program Files\RUST\.cargo  </span><br><span class="line">RUSTUP_DIST_SERVER &#x3D; https:&#x2F;&#x2F;mirrors.ustc.edu.cn&#x2F;rust-static  </span><br><span class="line">RUSTUP_HOME &#x3D; D:\Program Files\RUST\.rustup  </span><br><span class="line">RUSTUP_UPDATE_ROOT &#x3D; https:&#x2F;&#x2F;mirrors.ustc.edu.cn&#x2F;rust-static&#x2F;rustup  </span><br><span class="line">RUST_SRC_PATH &#x3D; d:\Program Files\RUST\.rustup\toolchains\stable-x86_64-pc-windows-msvc\lib\rustlib\src\rust\src</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="配置windows的rust和crates.io国内镜像">配置Windows的Rust和Crates.io国内镜像</h2>
<h3 id="修改crates.io国内镜像">修改Crates.io国内镜像</h3>
<p>修改<code>~/.cargo/config</code> <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[source.crates-io]  </span><br><span class="line">registry &#x3D; &quot;https:&#x2F;&#x2F;github.com&#x2F;rust-lang&#x2F;crates.io-index&quot;  </span><br><span class="line"></span><br><span class="line">#Replace with any mirror source  </span><br><span class="line">replace-with &#x3D; &#39;ustc&#39;  </span><br><span class="line">#replace-with &#x3D; &#39;tuna&#39;  </span><br><span class="line">#replace-with &#x3D; &#39;sjtu&#39;  </span><br><span class="line">#replace-with &#x3D; &#39;rustcc&#39;  </span><br><span class="line"></span><br><span class="line">#University of science and technology of China  </span><br><span class="line">[source.ustc]  </span><br><span class="line">registry &#x3D; &quot;git:&#x2F;&#x2F;mirrors.ustc.edu.cn&#x2F;crates.io-index&quot;  </span><br><span class="line"></span><br><span class="line">#Tsinghua University  </span><br><span class="line">[source.tuna]  </span><br><span class="line">registry &#x3D; &quot;https:&#x2F;&#x2F;mirrors.tuna.tsinghua.edu.cn&#x2F;git&#x2F;crates.io-index.git&quot;  </span><br><span class="line"></span><br><span class="line">#Shanghai Jiaotong University  </span><br><span class="line">[source.sjtu]  </span><br><span class="line">registry &#x3D; &quot;https:&#x2F;&#x2F;mirrors.sjtug.sjtu.edu.cn&#x2F;git&#x2F;crates.io-index&quot;  </span><br><span class="line"></span><br><span class="line">#Rustcc community  </span><br><span class="line">[source.rustcc]  </span><br><span class="line">registry &#x3D; &quot;git:&#x2F;&#x2F;crates.rustcc.cn&#x2F;crates.io-index&quot;  </span><br></pre></td></tr></table></figure> ### 修改rustup国内镜像</p>
<p>在系统环境变量中设置 <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CARGO HOME &#x3D; D:\Program Files\RUST\.cargo  </span><br><span class="line">RUSTUP_DIST_SERVER &#x3D; https:&#x2F;&#x2F;mirrors.ustc.edu.cn&#x2F;rust-static  </span><br><span class="line">RUSTUP_HOME &#x3D; D:\Program Files\RUST\.rustup  </span><br><span class="line">RUSTUP_UPDATE_ROOT &#x3D; https:&#x2F;&#x2F;mirrors.ustc.edu.cn&#x2F;rust-static&#x2F;rustup  </span><br></pre></td></tr></table></figure></p>
<h2 id="vs-code插件安装">VS Code插件安装</h2>
<ol type="1">
<li><p>rust-analyzer</p>
<p>该插件有说明与会与官方的Rust有冲突，二者只能先激活一个。</p>
<p><img src="https://s2.loli.net/2022/04/14/vGay32FOwzkAWtL.png" /></p></li>
<li><p>CodeLLDB</p>
<p>基于LLDB的原生debugger.详见<a href="https://github.com/vadimcn/vscode-lldb">官网</a></p></li>
<li><p>TabNine</p>
<p>基于深度学习的智能提示插件, 详见<a href="https://www.tabnine.com/">官网</a></p></li>
</ol>
<h2 id="开启vs-code进行测试">开启VS Code进行测试</h2>
<p>安装插件，重启VS Code后。</p>
<p>现在运行官网示例。</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="keyword">use</span> ferris_says::say; <span class="comment">// from the previous step</span></span><br><span class="line"><span class="keyword">use</span> std::io::&#123;stdout, BufWriter&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> stdout = stdout();</span><br><span class="line">    <span class="keyword">let</span> message = <span class="built_in">String</span>::from(<span class="string">&quot;Hello fellow Rustaceans!&quot;</span>);</span><br><span class="line">    <span class="keyword">let</span> width = message.chars().count();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut</span> writer = BufWriter::new(stdout.lock());</span><br><span class="line">    say(message.as_bytes(), width, &amp;<span class="keyword">mut</span> writer).unwrap();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://s2.loli.net/2022/04/14/6qljpGuyzBgOmE4.png" /></p>
<p>测试， RA、CodeLLDB及TabNine工作正常。</p>
]]></content>
      <categories>
        <category>技术笔记</category>
        <category>rust</category>
      </categories>
      <tags>
        <tag>rust</tag>
        <tag>VScode</tag>
      </tags>
  </entry>
  <entry>
    <title>【Python】使用PYQT5来构建持仓盈亏监控</title>
    <url>/2021/05/14/%E3%80%90Python%E3%80%91%E4%BD%BF%E7%94%A8PYQT5%E6%9D%A5%E6%9E%84%E5%BB%BA%E6%8C%81%E4%BB%93%E7%9B%88%E4%BA%8F%E7%9B%91%E6%8E%A7/</url>
    <content><![CDATA[<h1 id="目的">目的</h1>
<p>通过win10的通知来监控持仓盈亏，会在托盘上累积太多的图标，而且经常受到专注助手影响，效果不是太理想。所以尝试利用PyQt5来构建一个监控系统，实现类似雪球网页上同样的功能。</p>
<a id="more"></a>
<h1 id="安装pyqt5">安装PyQt5</h1>
<h2 id="安装pyqt5-1">安装PyQt5</h2>
<ol type="1">
<li><p>pip安装 &gt;pip install PyQt5</p></li>
<li><p>官网下载文件安装<br />
下载地址：<a href="https://pypi.org/project/PyQt5/#files">PyQt下载官网</a> <img src="https://s2.loli.net/2022/04/14/ATIvDBfZr6N1WL5.png" /> 安装方法：打开命令行，通过命令行进入到下载的whl文件所在的文件夹，输入如下命令，安装即可。 &gt;pip install PyQt5-5.15.4-cp36.cp37.cp38.cp39-none-win_amd64.whl</p></li>
</ol>
<h2 id="安装pyqt5-tools">安装PyQt5-tools</h2>
<p>PyQt5-tools里含有图形界面开发工具QtDesigner及国际化翻译工具Liguist。 1. pip安装 &gt;pip install PyQt5-tools</p>
<ol start="2" type="1">
<li>官网下载文件安装<br />
下载地址：<a href="https://pypi.org/project/pyqt5-tools/#files">PyQt下载官网</a> <img src="https://s2.loli.net/2022/04/14/KNDVktjGFofTnZ3.png" /> 安装方法：打开命令行，通过命令行进入到下载的whl文件所在的文件夹，输入如下命令，安装即可。 &gt;pip install pyqt5_tools-5.15.2.3.0.2-py3-none-any.whl</li>
</ol>
<p>在系统中加入以下环境变量 &gt;d:-packages_tools<br />
</p>
<h2 id="与vscode集成">与VScode集成</h2>
<ol type="1">
<li>安装pyqt integration插件 <img src="https://s2.loli.net/2022/04/14/vS2MUFCL8oNT1Kl.png" /> 对pyqt integration插件进行配置，主要是pyuic5及qt designer的路径 <img src="https://s2.loli.net/2022/04/14/W4FUgXOnvAVjqI5.png" /></li>
</ol>
<h2 id="界面设计">界面设计</h2>
<p>用小窗口来实现监控。</p>
<h3 id="术语">术语</h3>
<ul>
<li>布局<br />
采用了布局之后能够让我们的程序在使用上更加美观，不会随着窗体的大小发生改变而改变，符合我们的使用习惯。在PyQt5中，有多种布局的方式供我们选择，比较常用的布局有以下几种：
<ul>
<li>表单布局：QFormLayout</li>
<li>网格布局：QGridLayout</li>
<li>水平排列布局：QHBoxLayout</li>
<li>垂直排列布局：QVBoxLayout</li>
</ul></li>
</ul>
<p>比较详细的说明可以参考<a href="https://zhuanlan.zhihu.com/p/28559136">PyQt5系列教程（6）：布局</a></p>
<ul>
<li>MVC模式 MVC 模式 指 Model-View-Controller（模型-视图-控制器） 模式。这种模式多应用于应用程序的分层开发。
<ul>
<li>Model是一个数据模型、一个虚拟的东西，显示不出来的，如果我们要把这些数据显示出来，就需要使用view。</li>
<li>View：用来显示Model这种数据</li>
<li>Controler：如果我们要编辑数据，就需要使用controler,不使用controler，我们只能对数据进行查看不能编辑</li>
</ul></li>
</ul>
<h3 id="使用qtdesigner来设计界面">使用QtDesigner来设计界面</h3>
<ol type="1">
<li>初始界面 初始界面设计如下： <img src="https://s2.loli.net/2022/04/14/zcTQvBmEta5WwuP.png" /></li>
</ol>
<p>相应的组件及布局如下： <img src="https://s2.loli.net/2022/04/14/Pb6hNWke3I9Lngf.png" /></p>
<p>计划使用QLabel来显示总的持仓盈亏情况，用Qtableview来显示具体的股票信息， Qlabel使用<code>gridLayout</code>, Qtableview使用<code>verticalLayout</code>。</p>
<ol start="2" type="1">
<li>界面美化 在自定义的View类中写入代码进行美化。</li>
</ol>
<ul>
<li>去除丑陋的边框</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">self.setWindowFlag(QtCore.Qt.FramelessWindowHint) </span><br></pre></td></tr></table></figure>
<ul>
<li>增加关闭及最小化按钮（以MacOS的样式） 用pyqtSlot装饰器来实现点击按钮关闭和最小化的操作。</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">self.CloseButton.setFixedSize(<span class="number">15</span>,<span class="number">15</span>) </span><br><span class="line">self.MinButton.setFixedSize(<span class="number">15</span>,<span class="number">15</span>) </span><br><span class="line">self.CloseButton.setStyleSheet(<span class="string">&quot;QPushButton&#123;background:#F76677;border-radius:7px;&#125;QPushButton:hover&#123;background:red;&#125;&quot;</span>)</span><br><span class="line">self.MinButton.setStyleSheet(<span class="string">&quot;QPushButton&#123;background:#6DDF6D;border-radius:7px;&#125;QPushButton:hover&#123;background:green;&#125;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@pyqtSlot()</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_CloseButton_clicked</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    关闭窗口</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    self.close()</span><br><span class="line"></span><br><span class="line"><span class="meta">@pyqtSlot()</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_MinButton_clicked</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    最小化窗口</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    self.showMinimized()    </span><br></pre></td></tr></table></figure>
<ul>
<li>针对盈亏对显示结果使用不同颜色</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="built_in">float</span>(self.label_4.text().split(<span class="string">&#x27;(&#x27;</span>)[<span class="number">0</span>]) &lt; <span class="number">0</span>:</span><br><span class="line">    self.label_2.setStyleSheet(<span class="string">&quot;QLabel&#123;color:#01D68A;font-size:15px;font-weight:bold;font-family:Hack;&#125;&quot;</span>)</span><br><span class="line">    self.label_4.setStyleSheet(<span class="string">&quot;QLabel&#123;color:#01D68A;font-size:15px;font-weight:bold;font-family:Hack;&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    self.label_2.setStyleSheet(<span class="string">&quot;QLabel&#123;color:#FF0018;font-size:15px;font-weight:bold;font-family:Hack;&#125;&quot;</span>)</span><br><span class="line">    self.label_4.setStyleSheet(<span class="string">&quot;QLabel&#123;color:#FF0018;font-size:15px;font-weight:bold;font-family:Hack;&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">float</span>(self.label_6.text().split(<span class="string">&#x27;(&#x27;</span>)[<span class="number">0</span>]) &lt; <span class="number">0</span>:</span><br><span class="line">    self.label_6.setStyleSheet(<span class="string">&quot;QLabel&#123;color:#01D68A;font-size:15px;font-weight:bold;font-family:Hack;&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    self.label_6.setStyleSheet(<span class="string">&quot;QLabel&#123;color:#FF0018;font-size:15px;font-weight:bold;font-family:Hack;&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">float</span>(self.label_8.text().split(<span class="string">&#x27;(&#x27;</span>)[<span class="number">0</span>]) &lt; <span class="number">0</span>:</span><br><span class="line">    self.label_8.setStyleSheet(<span class="string">&quot;QLabel&#123;color:#01D68A;font-size:15px;font-weight:bold;font-family:Hack;&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    self.label_8.setStyleSheet(<span class="string">&quot;QLabel&#123;color:#FF0018;font-size:15px;font-weight:bold;font-family:Hack;&#125;&quot;</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>Qtableview的表头使用与窗口同样的背景色以及文字左对齐</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">self.tableView.setStyleSheet(<span class="string">&quot;border-width: 0px; border-style: solid;&quot;</span>)</span><br><span class="line">self.tableView.horizontalHeader().setStyleSheet(<span class="string">&quot;QHeaderView::section&#123;Background-color:#454545;border-radius: 0px;&#125;&quot;</span>)</span><br><span class="line">self.tableView_2.setStyleSheet(<span class="string">&quot;border-width: 0px; border-style: solid;&quot;</span>)</span><br><span class="line">self.tableView_2.horizontalHeader().setStyleSheet(<span class="string">&quot;QHeaderView::section&#123;Background-color:#454545;border-radius: 0px;&#125;&quot;</span>)</span><br><span class="line">self.tableView.horizontalHeader().setDefaultAlignment(Qt.AlignLeft)</span><br><span class="line">self.tableView_2.horizontalHeader().setDefaultAlignment(Qt.AlignLeft)</span><br></pre></td></tr></table></figure>
<ul>
<li>Qtableview显示的数据也同样根据盈亏使用不同的颜色<br />
这个在Model类中的data()函数中实现</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">data</span>(<span class="params">self, index, role=Qt.DisplayRole</span>):</span></span><br><span class="line">    <span class="keyword">if</span> index.isValid():</span><br><span class="line">        value = self._data.iloc[index.row(), index.column()]            </span><br><span class="line">        <span class="keyword">if</span> role == Qt.ForegroundRole <span class="keyword">and</span> <span class="built_in">isinstance</span>(value, <span class="built_in">float</span>) <span class="keyword">and</span> index.column() == <span class="number">3</span>:</span><br><span class="line">            next_value = self._data.iloc[index.row(), index.column() + <span class="number">1</span>]</span><br><span class="line">            <span class="keyword">if</span>  next_value &lt; <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">return</span> QtGui.QColor(<span class="string">&#x27;#01D68A&#x27;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> QtGui.QColor(<span class="string">&#x27;#FF0018&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> role == Qt.ForegroundRole <span class="keyword">and</span> <span class="built_in">isinstance</span>(value, <span class="built_in">float</span>) <span class="keyword">and</span> index.column() != <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">if</span>  value &lt; <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">return</span> QtGui.QColor(<span class="string">&#x27;#01D68A&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> QtGui.QColor(<span class="string">&#x27;#FF0018&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> role == Qt.DisplayRole:</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">str</span>(self._data.iloc[index.row(), index.column()])</span><br><span class="line"><span class="keyword">return</span> <span class="literal">None</span></span><br></pre></td></tr></table></figure>
<ul>
<li>重写鼠标事件，实现窗口拖放</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">initDrag</span>(<span class="params">self</span>):</span></span><br><span class="line"><span class="comment"># 设置鼠标跟踪判断扳机默认值</span></span><br><span class="line">    self._move_drag   = <span class="literal">False</span></span><br><span class="line">    self._corner_drag = <span class="literal">False</span></span><br><span class="line">    self._bottom_drag = <span class="literal">False</span></span><br><span class="line">    self._right_drag  = <span class="literal">False</span></span><br><span class="line">    self._padding     = <span class="number">5</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">resizeEvent</span>(<span class="params">self, QResizeEvent</span>):</span>        </span><br><span class="line">    <span class="comment"># 重新调整边界范围以备实现鼠标拖放缩放窗口大小，采用三个列表生成式生成三个列表</span></span><br><span class="line">    self._right_rect = [QPoint(x, y) <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(self.width() - self._padding, self.width() + <span class="number">1</span>) <span class="keyword">for</span> y <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, self.height() - self._padding)]</span><br><span class="line">    self._bottom_rect = [QPoint(x, y) <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, self.width() - self._padding)</span><br><span class="line">     <span class="keyword">for</span> y <span class="keyword">in</span> <span class="built_in">range</span>(self.height() - self._padding, self.height() + <span class="number">1</span>)]</span><br><span class="line">    self._corner_rect = [QPoint(x, y) <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(self.width() - self._padding, self.width() + <span class="number">1</span>) <span class="keyword">for</span> y <span class="keyword">in</span> <span class="built_in">range</span>(self.height() - self._padding, self.height() + <span class="number">1</span>)]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mousePressEvent</span>(<span class="params">self, event</span>):</span></span><br><span class="line">    <span class="comment"># 重写鼠标点击的事件</span></span><br><span class="line">    <span class="keyword">if</span> (event.button() == Qt.LeftButton) <span class="keyword">and</span> (event.pos() <span class="keyword">in</span> self._corner_rect):</span><br><span class="line">        <span class="comment"># 鼠标左键点击右下角边界区域</span></span><br><span class="line">        self._corner_drag = <span class="literal">True</span></span><br><span class="line">        event.accept()</span><br><span class="line">    <span class="keyword">elif</span> (event.button() == Qt.LeftButton) <span class="keyword">and</span> (event.pos() <span class="keyword">in</span> self._right_rect):</span><br><span class="line">        <span class="comment"># 鼠标左键点击右侧边界区域</span></span><br><span class="line">        self._right_drag = <span class="literal">True</span></span><br><span class="line">        event.accept()</span><br><span class="line">        self.setCursor(QCursor(Qt.SizeHorCursor))</span><br><span class="line">    <span class="keyword">elif</span> (event.button() == Qt.LeftButton) <span class="keyword">and</span> (event.pos() <span class="keyword">in</span> self._bottom_rect):</span><br><span class="line">        <span class="comment"># 鼠标左键点击下侧边界区域</span></span><br><span class="line">        self._bottom_drag = <span class="literal">True</span></span><br><span class="line">        event.accept()</span><br><span class="line">        self.setCursor(QCursor(Qt.SizeVerCursor))</span><br><span class="line">    <span class="keyword">elif</span> (event.button() == Qt.LeftButton) <span class="keyword">and</span> (event.y() &lt; self.label_10.y()+self.label_10.height() <span class="keyword">or</span> (event.y() &gt; self.label_9.y() <span class="keyword">and</span> event.y() &lt; self.tableView_2.y())):</span><br><span class="line">        <span class="comment"># 鼠标左键点击标题栏区域</span></span><br><span class="line">        self._move_drag = <span class="literal">True</span></span><br><span class="line">        self.move_DragPosition = event.globalPos() - self.pos()</span><br><span class="line">        event.accept()</span><br><span class="line">        self.setCursor(QCursor(Qt.OpenHandCursor))  <span class="comment">#更改鼠标图标</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mouseMoveEvent</span>(<span class="params">self, QMouseEvent</span>):</span></span><br><span class="line">    <span class="comment"># 判断鼠标位置切换鼠标手势</span></span><br><span class="line">    <span class="comment"># if QMouseEvent.pos() in self._corner_rect:</span></span><br><span class="line">    <span class="comment">#     self.setCursor(Qt.SizeFDiagCursor)</span></span><br><span class="line">    <span class="comment">#     print(&quot;corner:%s, in %s&quot; %(QMouseEvent.pos(),self._corner_rect))</span></span><br><span class="line">    <span class="comment">#print(QMouseEvent.globalPos(), QMouseEvent.pos(), self.graphWidget.x(), self.graphWidget.y(), self.graphWidget.pos(), self.graphWidget.width(), self.graphWidget.height())</span></span><br><span class="line">    <span class="keyword">if</span> QMouseEvent.pos() <span class="keyword">in</span> self._bottom_rect:</span><br><span class="line">        self.setCursor(QCursor(Qt.SizeVerCursor))</span><br><span class="line">    <span class="keyword">elif</span> QMouseEvent.pos() <span class="keyword">in</span> self._right_rect:</span><br><span class="line">        self.setCursor(QCursor(Qt.SizeHorCursor))</span><br><span class="line">    <span class="keyword">elif</span> QMouseEvent.pos() <span class="keyword">in</span> self._corner_rect:</span><br><span class="line">        self.setCursor(QCursor(Qt.SizeFDiagCursor))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        self.setCursor(QCursor(Qt.ArrowCursor))</span><br><span class="line">    <span class="comment"># 当鼠标左键点击不放及满足点击区域的要求后，分别实现不同的窗口调整</span></span><br><span class="line">    <span class="comment"># 没有定义左方和上方相关的5个方向，主要是因为实现起来不难，但是效果很差，拖放的时候窗口闪烁，再研究研究是否有更好的实现</span></span><br><span class="line">    <span class="keyword">if</span> Qt.LeftButton <span class="keyword">and</span> self._right_drag:</span><br><span class="line">        <span class="comment"># 右侧调整窗口宽度</span></span><br><span class="line">        self.resize(QMouseEvent.pos().x(), self.height())</span><br><span class="line">        QMouseEvent.accept()</span><br><span class="line">    <span class="keyword">elif</span> Qt.LeftButton <span class="keyword">and</span> self._bottom_drag:</span><br><span class="line">        <span class="comment"># 下侧调整窗口高度</span></span><br><span class="line">        self.resize(self.width(), QMouseEvent.pos().y())</span><br><span class="line">        QMouseEvent.accept()</span><br><span class="line">    <span class="keyword">elif</span> Qt.LeftButton <span class="keyword">and</span> self._corner_drag:</span><br><span class="line">        <span class="comment"># 右下角同时调整高度和宽度</span></span><br><span class="line">        self.resize(QMouseEvent.pos().x(), QMouseEvent.pos().y())</span><br><span class="line">        QMouseEvent.accept()</span><br><span class="line">    <span class="keyword">elif</span> Qt.LeftButton <span class="keyword">and</span> self._move_drag:</span><br><span class="line">        <span class="comment"># 标题栏拖放窗口位置</span></span><br><span class="line">        self.move(QMouseEvent.globalPos() - self.move_DragPosition)</span><br><span class="line">        QMouseEvent.accept()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mouseReleaseEvent</span>(<span class="params">self, QMouseEvent</span>):</span></span><br><span class="line">    <span class="comment"># 鼠标释放后，各扳机复位</span></span><br><span class="line">    self._move_drag = <span class="literal">False</span></span><br><span class="line">    self._corner_drag = <span class="literal">False</span></span><br><span class="line">    self._bottom_drag = <span class="literal">False</span></span><br><span class="line">    self._right_drag = <span class="literal">False</span></span><br><span class="line">    self.setCursor(QCursor(Qt.ArrowCursor))</span><br></pre></td></tr></table></figure>
<h1 id="效果">效果</h1>
<p>完成后的应用界面效果如下： <img src="https://s2.loli.net/2022/04/14/ykQ7onW4ducAseD.png" /> # 参考 1. <a href="https://blog.csdn.net/weixin_40014984/article/details/104531359">VSCode配置Python、PyQt5、QtDesigner环境并创建一个ui界面测试</a> 2. <a href="https://zhuanlan.zhihu.com/p/66758263">python界面编程：VScode+pyqt+pyqt integration配置备忘</a> 3. <a href="https://blog.csdn.net/AzureMouse/article/details/90338961">PyQt5（designer）入门教程</a> 4. <a href="%5BEmbedding%20PyQtGraph%20(or%20any%20other%20custom%20PyQt5%20widgets)%20from%20Qt%20Designer%20(mfitzp.com)%5D(https://www.mfitzp.com/tutorials/embed-pyqtgraph-custom-widgets-qt-app/)">Embedding custom widgets from Qt Designer</a></p>
]]></content>
      <categories>
        <category>技术笔记</category>
        <category>python</category>
        <category>量化投资</category>
      </categories>
      <tags>
        <tag>python</tag>
        <tag>pyqt5</tag>
      </tags>
  </entry>
  <entry>
    <title>【Rust】Rust的安装及卸载升级</title>
    <url>/2021/01/04/%E3%80%90Rust%E3%80%91Rust%E7%9A%84%E5%AE%89%E8%A3%85%E5%8D%B8%E8%BD%BD%E5%8F%8A%E5%8D%87%E7%BA%A7/</url>
    <content><![CDATA[<h1 id="安装">安装</h1>
<h2 id="下载rust的安装器">下载Rust的安装器</h2>
<p>从<a href="https://www.rust-lang.org/zh-CN/tools/install">官网</a>下载<code>rustup-init.exe</code>。</p>
<p><img src="https://s2.loli.net/2022/04/14/niWOEIa1qNCkS4D.png" /></p>
<p>说明：</p>
<blockquote>
<p><code>rustup</code>是安装和管理 <strong>Rust 构建版本</strong>的工具。rustup 用于管理不同平台下的 Rust 构建版本并使其互相兼容， 支持安装由 Beta 和 Nightly 频道发布的版本，并支持其他用于交叉编译的编译版本 <code>cargo</code>是rust的<strong>包管理器和构建系统工具</strong>。它将常用命令集于一身，无需引入其它命令。</p>
<p>rustup程序是rust的安装程序，也是他的版本管理程序，类似于Python的Anaconda发行版的conda工具，非常方便使用管理。cargo是rust的构建工具，暂不介绍，需要明白的是：rustup是管理语言自身的，cargo是管理第三方拓展的。</p>
</blockquote>
<a id="more"></a>
<h2 id="配置path环境变量">配置<code>path</code>环境变量</h2>
<p>在 Rust 开发环境中，所有工具都安装在 <code>~/.cargo/bin</code> 目录中，您可以在这里找到包括 <code>rustc</code>、<code>cargo</code> 和 <code>rustup</code> 在内的 Rust 工具链。</p>
<p>所以，如果打算修改默认的安装位置，可以在环境变量中这样设置，以安装路径为<code>D:\Program Files\Rust\</code>为例。否则会默认安装在 C 盘下。 <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CARGO_HOME：D:\Program Files\RUST\.cargo</span><br><span class="line">RUSTUP_HOME：D:\Program Files\RUST\.rustup</span><br></pre></td></tr></table></figure></p>
<h2 id="安装-1">安装</h2>
<h3 id="msvc工具链方式">MSVC工具链方式</h3>
<p>下载完成后直接点击执行，会出现一个CMD窗口：仔细阅读上面的内容，如果没有安装Microsoft 2019 builder tools，就从<a href="https://visualstudio.microsoft.com/downloads/">这里</a>进行下载安装。</p>
<p><img src="https://s2.loli.net/2022/04/14/bImn2Ea5iWvBjyq.png" /></p>
<p>下载build tools之后，在Visual studio installer中只选择“C++生成工具”，然后只选择"MSVC v142 - VS2019 C++ x64/x86 生成工具"。安装上去大约需要1.8G硬盘空间。</p>
<p><img src="https://s2.loli.net/2022/04/14/vtG5I9asQCFJRel.png" /></p>
<h3 id="安装rust">安装Rust</h3>
<p>运行<code>rustup-init.exe</code></p>
<p>然后，在下面输入1，进行默认安装：</p>
<p><img src="https://s2.loli.net/2022/04/14/Cj57oheYcTtazVw.png" /> 检查是否安装成功</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">rustc --version</span><br><span class="line">cargo --version　　</span><br></pre></td></tr></table></figure>
<p><img src="https://s2.loli.net/2022/04/14/8TDtqLRv5nohfUC.png" /></p>
<h3 id="gnu工具链方式">GNU工具链方式</h3>
<p>gnu（本文使用MinGW-w64）占用空间小（500M），对于初步的rust使用足够了。</p>
<p><a href="http://www.mingw-w64.org/doku.php">MinGW-w64下载</a></p>
<h4 id="安装mingw-w64">安装MinGW-w64</h4>
<p><img src="https://s2.loli.net/2022/04/14/stGr4SkjB6O5UyA.png" /> 这里你可以选择安装的版本, 建议只更改第二项至x86_64, 其他选项不做改动。</p>
<p><img src="https://s2.loli.net/2022/04/14/vXhQYsD5CEOa6ZU.png" /> <strong>关于Threads选项的说明：</strong></p>
<p>To summarize:</p>
<ul>
<li><code>posix</code>: enable C++11/C11 multithreading features. Makes libgcc depend on libwinpthreads, so that even if you don't directly call pthreads API, you'll be distributing the winpthreads DLL. There's nothing wrong with distributing one more DLL with your application.</li>
<li><code>win32</code>: No C++11 multithreading features.</li>
</ul>
<p>Neither have influence on any user code calling Win32 APIs or pthreads APIs. You can always use both.</p>
<p>exception seh (for Structured Exception Handling mechanism).</p>
<p>这里可以设置安装目录, 我安装在</p>
<p><img src="https://s2.loli.net/2022/04/14/36j1DTMVsA8moLq.png" /> ### 环境变量的配置</p>
<p>新增 <code>D:\Program Files\mingw-w64\x86_64-8.1.0-posix-seh-rt_v6-rev0\mingw64\bin</code>到<code>PATH</code>。</p>
<h3 id="检查安装是否成功">检查安装是否成功</h3>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">C:\Users\junlv&gt;mingw32<span class="literal">-make</span> -<span class="literal">-version</span></span><br><span class="line">GNU Make <span class="number">4.2</span>.<span class="number">1</span></span><br><span class="line">Built <span class="keyword">for</span> x86_64<span class="literal">-w64</span><span class="literal">-mingw32</span></span><br><span class="line">Copyright (C) <span class="number">1988</span><span class="literal">-2016</span> Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version <span class="number">3</span> or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.</span><br><span class="line"></span><br><span class="line">C:\Users\junlv&gt;g++ -<span class="literal">-version</span></span><br><span class="line">g++ (x86_64<span class="literal">-posix</span><span class="literal">-seh</span><span class="literal">-rev0</span>, Built by MinGW<span class="literal">-W64</span> project) <span class="number">8.1</span>.<span class="number">0</span></span><br><span class="line">Copyright (C) <span class="number">2018</span> Free Software Foundation, Inc.</span><br><span class="line">This is free software; see the source <span class="keyword">for</span> copying conditions.  There is NO</span><br><span class="line">warranty; not even <span class="keyword">for</span> MERCHANTABILITY or FITNESS <span class="keyword">FOR</span> A PARTICULAR PURPOSE.</span><br></pre></td></tr></table></figure>
<h3 id="安装rust-1">安装Rust</h3>
<p>运行<code>rustup-init.exe</code></p>
<p>然后，在下面输入2，进行定制化安装：</p>
<p><code>default host triple</code>修改为<code>x86_64-pc-windows-gnu</code></p>
<p><img src="https://s2.loli.net/2022/04/14/kGcCHQeSyV4FI58.png" /></p>
<p>继续选1进行安装即可。</p>
<p>安装验证</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">E:\Downloads\Programs&gt;rustc -<span class="literal">-version</span></span><br><span class="line">rustc <span class="number">1.49</span>.<span class="number">0</span> (e1884a8e3 <span class="number">2020</span><span class="literal">-12</span><span class="literal">-29</span>)</span><br><span class="line"></span><br><span class="line">E:\Downloads\Programs&gt;cargo -<span class="literal">-version</span></span><br><span class="line">cargo <span class="number">1.49</span>.<span class="number">0</span> (d00d64df9 <span class="number">2020</span><span class="literal">-12</span><span class="literal">-05</span>)</span><br></pre></td></tr></table></figure>
<p>安装源代码用于代码补全</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">E:\Downloads\Programs&gt;rustup component add rust<span class="literal">-src</span></span><br><span class="line">info: downloading component <span class="string">&#x27;rust-src&#x27;</span></span><br><span class="line">info: installing component <span class="string">&#x27;rust-src&#x27;</span></span><br><span class="line">info: <span class="keyword">using</span> up to 500.0 MiB of RAM to unpack components</span><br></pre></td></tr></table></figure>
<h1 id="卸载">卸载</h1>
<p>如果想卸载 Rust，可以运行 <code>rustup self uninstall</code></p>
<p><img src="https://s2.loli.net/2022/04/14/EyY1jSnGU8LptcT.png" /> # 升级 如果曾经安装过 <code>rustup</code>，可以执行 <code>rustup update</code> 来升级 Rust。 在升级过程中，如果遇到无法下载<code>rustup-init.exe</code>文件之类的错误，尝试更改国内镜像。使用中科大和清华源时出现过该类问题。更改为字节跳动镜像。 <code>RUSTUP_DIST_SERVER="https://rsproxy.cn" export RUSTUP_UPDATE_ROOT="https://rsproxy.cn/rustup"</code></p>
<h1 id="升级-1.81.0">升级 1.81.0</h1>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">E:\My Project\QArust  </span><br><span class="line">$ rustc --version</span><br><span class="line">rustc 1.81.0 (eeb90cda1 2024-09-04)</span><br><span class="line"></span><br><span class="line">E:\My Project\QArust  </span><br><span class="line">$ cargo --version</span><br><span class="line">warning: &#96;D:\Program Files\RUST\.cargo\config&#96; is deprecated in favor of &#96;config.toml&#96;</span><br><span class="line">note: if you need to support cargo 1.38 or earlier, you can symlink &#96;config&#96; to &#96;config.toml&#96;</span><br><span class="line">cargo 1.81.0 (2dbb1af80 2024-08-20)</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>技术笔记</category>
        <category>rust</category>
      </categories>
      <tags>
        <tag>rust</tag>
      </tags>
  </entry>
  <entry>
    <title>【Quantaxis】QAStrategy回测</title>
    <url>/2024/06/17/%E3%80%90Quantaxis%E3%80%91QAStrategy%E5%9B%9E%E6%B5%8B/</url>
    <content><![CDATA[<h1 id="回测中使用的模块">回测中使用的模块</h1>
<ul>
<li><code>QAStrategy</code></li>
</ul>
<h1 id="示例">示例</h1>
<p><code>Quantaxis</code> 版本为 <strong><em>1.10.19</em></strong>。仍以 <code>MACD_JCSC</code> 策略进行回测。</p>
<a id="more"></a>
<h2 id="创建-strategy-类回测">创建 Strategy 类回测</h2>
<p>在原 <code>QAStrategy</code> 回测文档中，多使用在 <code>on_bar</code> 函数中处理每一条 <code>bar</code> 数据，生成指标或回测信号。如下例代码所示的回测。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> QAStrategy.qastockbase <span class="keyword">import</span> QAStrategyStockBase</span><br><span class="line"><span class="keyword">import</span> QUANTAXIS <span class="keyword">as</span> QA</span><br><span class="line"><span class="keyword">from</span> Risk_util <span class="keyword">import</span> QA_Risk_Abstract</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> deque</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> rich <span class="keyword">import</span> <span class="built_in">print</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MACD_JCSC</span>(<span class="params">QAStrategyStockBase</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">on_bar</span>(<span class="params">self, bar</span>):</span></span><br><span class="line">        res = self.macd_jcsc()</span><br><span class="line">        print(res)</span><br><span class="line">        print(res.iloc[-<span class="number">1</span>]) </span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> res.iloc[-<span class="number">1</span>].CROSS_JC == <span class="number">1</span>:</span><br><span class="line">            print(<span class="string">&quot;[%s] %s 出现买入信号！！！&quot;</span> % bar.name)</span><br><span class="line">            <span class="keyword">if</span> self.get_positions(bar.name[<span class="number">1</span>]).volume_long == <span class="number">0</span>:</span><br><span class="line">                self.send_order(<span class="string">&quot;BUY&quot;</span>, <span class="string">&quot;OPEN&quot;</span>, code=bar.name[<span class="number">1</span>], price=bar.close, volume=<span class="number">1000</span>)</span><br><span class="line">                print(<span class="string">&quot;交易：以%.2f价格买入！！！&quot;</span> % bar.close)</span><br><span class="line">        <span class="keyword">elif</span> res.iloc[-<span class="number">1</span>].CROSS_SC == <span class="number">1</span>:</span><br><span class="line">            print(<span class="string">&quot;[%s] %s 出现卖出信号！！！&quot;</span> % bar.name)</span><br><span class="line">            <span class="keyword">if</span> self.get_positions(bar.name[<span class="number">1</span>]).volume_long &gt; <span class="number">0</span>:</span><br><span class="line">                self.send_order(<span class="string">&quot;SELL&quot;</span>, <span class="string">&quot;CLOSE&quot;</span>,code=bar.name[<span class="number">1</span>], price=bar.close, volume=<span class="number">1000</span>)</span><br><span class="line">                print(<span class="string">&quot;交易：以%.2f价格卖出！！！&quot;</span> % bar.close)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">macd_jcsc</span>(<span class="params">self, SHORT=<span class="number">12</span>, LONG=<span class="number">26</span>, M=<span class="number">9</span></span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        1.DIF向上突破DEA，买入信号参考。</span></span><br><span class="line"><span class="string">        2.DIF向下跌破DEA，卖出信号参考。</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        CLOSE = self.market_data.close</span><br><span class="line">        DIFF = QA.EMA(CLOSE, SHORT) - QA.EMA(CLOSE, LONG)</span><br><span class="line">        DEA = QA.EMA(DIFF, M)</span><br><span class="line">        MACD = <span class="number">2</span>*(DIFF-DEA)</span><br><span class="line"></span><br><span class="line">        CROSS_JC = QA.CROSS(DIFF, DEA)</span><br><span class="line">        CROSS_SC = QA.CROSS(DEA, DIFF)</span><br><span class="line">        ZERO = <span class="number">0</span></span><br><span class="line">        <span class="keyword">return</span> pd.DataFrame(&#123;<span class="string">&#x27;DIFF&#x27;</span>: DIFF, <span class="string">&#x27;DEA&#x27;</span>: DEA, <span class="string">&#x27;MACD&#x27;</span>: MACD, <span class="string">&#x27;CROSS_JC&#x27;</span>: CROSS_JC, <span class="string">&#x27;CROSS_SC&#x27;</span>: CROSS_SC, <span class="string">&#x27;ZERO&#x27;</span>: ZERO&#125;)</span><br><span class="line">    </span><br><span class="line">st1=datetime.datetime.now()</span><br><span class="line">print(<span class="string">&#x27;开始回测 -- &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(datetime.datetime.now()))</span><br><span class="line">code_list = [<span class="string">&#x27;000001&#x27;</span>]</span><br><span class="line"><span class="comment">#code_list = QA.QA_fetch_stock_list_adv().code.tolist()</span></span><br><span class="line"></span><br><span class="line">s = MACD_JCSC(</span><br><span class="line">    code        = code_list,</span><br><span class="line">    frequence   = <span class="string">&#x27;day&#x27;</span>,</span><br><span class="line">    start       = <span class="string">&#x27;2019-01-01&#x27;</span>,</span><br><span class="line">    end         = <span class="string">&#x27;2024-06-27&#x27;</span>,</span><br><span class="line">    strategy_id = <span class="string">&#x27;s-without_unit_init&#x27;</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#s.debug()  //不保存进数据库</span></span><br><span class="line"><span class="comment">#s._debug_sim()   //模拟盘测试</span></span><br><span class="line">s.run_backtest()</span><br><span class="line">r = QA_Risk_Abstract(QA.QA_Risk(s.acc))</span><br><span class="line">print(<span class="string">&#x27;[bold magenta][风险指标][/bold magenta]&#x27;</span>)</span><br><span class="line">print(r.message)</span><br><span class="line">p = QA.QA_Performance(s.acc)</span><br><span class="line">print(<span class="string">&#x27;[bold magenta][绩效指标][/bold magenta]&#x27;</span>)</span><br><span class="line">print(p.base_message(p.pnl))</span><br><span class="line">print(<span class="string">&#x27;回测耗时 -- &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(datetime.datetime.now()-st1))</span><br></pre></td></tr></table></figure>
<p>但对于像<code>MACD</code>这类指标，会使用前N天（比如26天）的数据进行计算，在生成<code>market_data</code>时，该数据在回测时即提取的历史数据源，在模拟/实盘时为行情数据。根据它的定义 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@property</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">market_data</span>(<span class="params">self</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> self.running_mode == <span class="string">&#x27;sim&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> self._market_data</span><br><span class="line">    <span class="keyword">elif</span> self.running_mode == <span class="string">&#x27;backtest&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> pd.concat(self._market_data[-<span class="number">100</span>:], axis=<span class="number">1</span>, sort=<span class="literal">False</span>).T</span><br></pre></td></tr></table></figure> 会使用最后100条记录生成 DataFrame。所以在计算<code>MACD</code>时，指标会随着数据的更新发生一些变化。</p>
<ul>
<li>但数据不足100条时的计算情况</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">                        DIFF       DEA      MACD  CROSS_JC  CROSS_SC  ZERO</span><br><span class="line">2019-01-02 000001       NaN       NaN       NaN         0         0     0</span><br><span class="line">2019-01-03 000001       NaN       NaN       NaN         0         0     0</span><br><span class="line">2019-01-04 000001       NaN       NaN       NaN         0         0     0</span><br><span class="line">2019-01-07 000001       NaN       NaN       NaN         0         0     0</span><br><span class="line">2019-01-08 000001       NaN       NaN       NaN         0         0     0</span><br><span class="line">2019-01-09 000001       NaN       NaN       NaN         0         0     0</span><br><span class="line">2019-01-10 000001       NaN       NaN       NaN         0         0     0</span><br><span class="line">2019-01-11 000001       NaN       NaN       NaN         0         0     0</span><br><span class="line">2019-01-14 000001       NaN       NaN       NaN         0         0     0</span><br><span class="line">2019-01-15 000001       NaN       NaN       NaN         0         0     0</span><br><span class="line">2019-01-16 000001       NaN       NaN       NaN         0         0     0</span><br><span class="line">2019-01-17 000001       NaN       NaN       NaN         0         0     0</span><br><span class="line">2019-01-18 000001       NaN       NaN       NaN         0         0     0</span><br><span class="line">2019-01-21 000001       NaN       NaN       NaN         0         0     0</span><br><span class="line">2019-01-22 000001       NaN       NaN       NaN         0         0     0</span><br><span class="line">2019-01-23 000001       NaN       NaN       NaN         0         0     0</span><br><span class="line">2019-01-24 000001       NaN       NaN       NaN         0         0     0</span><br><span class="line">2019-01-25 000001       NaN       NaN       NaN         0         0     0</span><br><span class="line">2019-01-28 000001       NaN       NaN       NaN         0         0     0</span><br><span class="line">2019-01-29 000001       NaN       NaN       NaN         0         0     0</span><br><span class="line">2019-01-30 000001       NaN       NaN       NaN         0         0     0</span><br><span class="line">2019-01-31 000001       NaN       NaN       NaN         0         0     0</span><br><span class="line">2019-02-01 000001       NaN       NaN       NaN         0         0     0</span><br><span class="line">2019-02-11 000001       NaN       NaN       NaN         0         0     0</span><br><span class="line">2019-02-12 000001  0.201445       NaN       NaN         0         0     0</span><br><span class="line">2019-02-13 000001  0.213348       NaN       NaN         0         0     0</span><br><span class="line">2019-02-14 000001  0.212171       NaN       NaN         0         0     0</span><br><span class="line">2019-02-15 000001  0.190256       NaN       NaN         0         0     0</span><br><span class="line">2019-02-18 000001  0.196467       NaN       NaN         0         0     0</span><br><span class="line">2019-02-19 000001  0.193391       NaN       NaN         0         0     0</span><br><span class="line">2019-02-20 000001  0.197590       NaN       NaN         0         0     0</span><br><span class="line">2019-02-21 000001  0.195407  0.197895 -0.004975         0         0     0</span><br><span class="line">2019-02-22 000001  0.202954  0.199063  0.007781         1         0     0</span><br></pre></td></tr></table></figure>
<ul>
<li>数据大于100条后的计算情况</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">                       DIFF       DEA      MACD  CROSS_JC  CROSS_SC  ZERO</span><br><span class="line">2019-01-07 000001       NaN       NaN       NaN         0         0     0</span><br><span class="line">2019-01-08 000001       NaN       NaN       NaN         0         0     0</span><br><span class="line">2019-01-09 000001       NaN       NaN       NaN         0         0     0</span><br><span class="line">2019-01-10 000001       NaN       NaN       NaN         0         0     0</span><br><span class="line">2019-01-11 000001       NaN       NaN       NaN         0         0     0</span><br><span class="line">2019-01-14 000001       NaN       NaN       NaN         0         0     0</span><br><span class="line">2019-01-15 000001       NaN       NaN       NaN         0         0     0</span><br><span class="line">2019-01-16 000001       NaN       NaN       NaN         0         0     0</span><br><span class="line">2019-01-17 000001       NaN       NaN       NaN         0         0     0</span><br><span class="line">2019-01-18 000001       NaN       NaN       NaN         0         0     0</span><br><span class="line">2019-01-21 000001       NaN       NaN       NaN         0         0     0</span><br><span class="line">2019-01-22 000001       NaN       NaN       NaN         0         0     0</span><br><span class="line">2019-01-23 000001       NaN       NaN       NaN         0         0     0</span><br><span class="line">2019-01-24 000001       NaN       NaN       NaN         0         0     0</span><br><span class="line">2019-01-25 000001       NaN       NaN       NaN         0         0     0</span><br><span class="line">2019-01-28 000001       NaN       NaN       NaN         0         0     0</span><br><span class="line">2019-01-29 000001       NaN       NaN       NaN         0         0     0</span><br><span class="line">2019-01-30 000001       NaN       NaN       NaN         0         0     0</span><br><span class="line">2019-01-31 000001       NaN       NaN       NaN         0         0     0</span><br><span class="line">2019-02-01 000001       NaN       NaN       NaN         0         0     0</span><br><span class="line">2019-02-11 000001       NaN       NaN       NaN         0         0     0</span><br><span class="line">2019-02-12 000001       NaN       NaN       NaN         0         0     0</span><br><span class="line">2019-02-13 000001       NaN       NaN       NaN         0         0     0</span><br><span class="line">2019-02-14 000001       NaN       NaN       NaN         0         0     0</span><br><span class="line">2019-02-15 000001  0.157022       NaN       NaN         0         0     0</span><br><span class="line">2019-02-18 000001  0.164416       NaN       NaN         0         0     0</span><br><span class="line">2019-02-19 000001  0.162747       NaN       NaN         0         0     0</span><br><span class="line">2019-02-20 000001  0.168194       NaN       NaN         0         0     0</span><br><span class="line">2019-02-21 000001  0.167374       NaN       NaN         0         0     0</span><br><span class="line">2019-02-22 000001  0.176082       NaN       NaN         0         0     0</span><br><span class="line">2019-02-25 000001  0.244633       NaN       NaN         0         0     0</span><br><span class="line">2019-02-26 000001  0.273117  0.207987  0.130260         0         0     0</span><br><span class="line">2019-02-27 000001  0.305015  0.230401  0.149227         0         0     0</span><br><span class="line">2019-02-28 000001  0.323862  0.251342  0.145041         0         0     0</span><br><span class="line">2019-03-01 000001  0.360723  0.275274  0.170898         0         0     0</span><br><span class="line">2019-03-04 000001  0.400339  0.302133  0.196413         0         0     0</span><br><span class="line">2019-03-05 000001  0.431294  0.329467  0.203652         0         0     0</span><br><span class="line">2019-03-06 000001  0.451868  0.355074  0.193588         0         0     0</span><br><span class="line">2019-03-07 000001  0.440428  0.372767  0.135322         0         0     0</span><br><span class="line">2019-03-08 000001  0.397392  0.377835  0.039115         0         0     0</span><br><span class="line">2019-03-11 000001  0.360469  0.374282 -0.027626         0         1     0</span><br><span class="line">2019-03-12 000001  0.330084  0.365280 -0.070391         0         0     0</span><br><span class="line">2019-03-13 000001  0.303178  0.352678 -0.098999         0         0     0</span><br><span class="line">2019-03-14 000001  0.282642  0.338507 -0.111731         0         0     0</span><br><span class="line">2019-03-15 000001  0.268008  0.324276 -0.112537         0         0     0</span><br><span class="line">2019-03-18 000001  0.280965  0.315550 -0.069168         0         0     0</span><br><span class="line">2019-03-19 000001  0.279837  0.308365 -0.057055         0         0     0</span><br><span class="line">2019-03-20 000001  0.273061  0.301270 -0.056420         0         0     0</span><br><span class="line">2019-03-21 000001  0.260586  0.293103 -0.065034         0         0     0</span><br><span class="line">2019-03-22 000001  0.241083  0.282667 -0.083168         0         0     0</span><br><span class="line">2019-03-25 000001  0.190592  0.264207 -0.147231         0         0     0</span><br><span class="line">2019-03-26 000001  0.148189  0.240959 -0.185540         0         0     0</span><br><span class="line">2019-03-27 000001  0.132268  0.219187 -0.173838         0         0     0</span><br><span class="line">2019-03-28 000001  0.107424  0.196807 -0.178765         0         0     0</span><br><span class="line">2019-03-29 000001  0.127513  0.182934 -0.110842         0         0     0</span><br><span class="line">2019-04-01 000001  0.166284  0.179601 -0.026636         0         0     0</span><br><span class="line">2019-04-02 000001  0.207012  0.185087  0.043850         1         0     0</span><br><span class="line">2019-04-03 000001  0.242006  0.196477  0.091059         0         0     0</span><br><span class="line">2019-04-04 000001  0.295303  0.216250  0.158106         0         0     0</span><br><span class="line">2019-04-08 000001  0.340510  0.241110  0.198800         0         0     0</span><br><span class="line">2019-04-09 000001  0.361793  0.265253  0.193080         0         0     0</span><br><span class="line">2019-04-10 000001  0.368870  0.285981  0.165778         0         0     0</span><br><span class="line">2019-04-11 000001  0.357212  0.300229  0.113965         0         0     0</span><br><span class="line">2019-04-12 000001  0.335793  0.307343  0.056900         0         0     0</span><br><span class="line">2019-04-15 000001  0.333666  0.312608  0.042116         0         0     0</span><br><span class="line">2019-04-16 000001  0.389150  0.327918  0.122465         0         0     0</span><br><span class="line">2019-04-17 000001  0.412419  0.344819  0.135200         0         0     0</span><br><span class="line">2019-04-18 000001  0.425260  0.360908  0.128703         0         0     0</span><br><span class="line">2019-04-19 000001  0.457213  0.380170  0.154085         0         0     0</span><br><span class="line">2019-04-22 000001  0.437246  0.391586  0.091321         0         0     0</span><br><span class="line">2019-04-23 000001  0.411128  0.395494  0.031268         0         0     0</span><br><span class="line">2019-04-24 000001  0.411374  0.398670  0.025408         0         0     0</span><br><span class="line">2019-04-25 000001  0.385593  0.396055 -0.020923         0         1     0</span><br><span class="line">2019-04-26 000001  0.337650  0.384374 -0.093448         0         0     0</span><br><span class="line">2019-04-29 000001  0.317533  0.371005 -0.106945         0         0     0</span><br><span class="line">2019-04-30 000001  0.280976  0.352999 -0.144047         0         0     0</span><br><span class="line">2019-05-06 000001  0.181789  0.318757 -0.273936         0         0     0</span><br><span class="line">2019-05-07 000001  0.107507  0.276507 -0.338000         0         0     0</span><br><span class="line">2019-05-08 000001  0.024025  0.226010 -0.403970         0         0     0</span><br><span class="line">2019-05-09 000001 -0.071904  0.166427 -0.476663         0         0     0</span><br><span class="line">2019-05-10 000001 -0.110485  0.111045 -0.443058         0         0     0</span><br><span class="line">2019-05-13 000001 -0.165585  0.055719 -0.442606         0         0     0</span><br><span class="line">2019-05-14 000001 -0.193798  0.005815 -0.399226         0         0     0</span><br><span class="line">2019-05-15 000001 -0.184113 -0.032170 -0.303885         0         0     0</span><br><span class="line">2019-05-16 000001 -0.179243 -0.061585 -0.235315         0         0     0</span><br><span class="line">2019-05-17 000001 -0.201593 -0.089587 -0.224013         0         0     0</span><br><span class="line">2019-05-20 000001 -0.220935 -0.115856 -0.210157         0         0     0</span><br><span class="line">2019-05-21 000001 -0.221183 -0.136922 -0.168523         0         0     0</span><br><span class="line">2019-05-22 000001 -0.229868 -0.155511 -0.148714         0         0     0</span><br><span class="line">2019-05-23 000001 -0.241623 -0.172733 -0.137780         0         0     0</span><br><span class="line">2019-05-24 000001 -0.243949 -0.186976 -0.113945         0         0     0</span><br><span class="line">2019-05-27 000001 -0.241615 -0.197904 -0.087421         0         0     0</span><br><span class="line">2019-05-28 000001 -0.228771 -0.204077 -0.049387         0         0     0</span><br><span class="line">2019-05-29 000001 -0.222297 -0.207721 -0.029151         0         0     0</span><br><span class="line">2019-05-30 000001 -0.227083 -0.211594 -0.030979         0         0     0</span><br><span class="line">2019-05-31 000001 -0.230999 -0.215475 -0.031049         0         0     0</span><br><span class="line">2019-06-03 000001 -0.250713 -0.222522 -0.056381         0         0     0</span><br><span class="line">2019-06-04 000001 -0.266744 -0.231367 -0.070754         0         0     0</span><br><span class="line">2019-06-05 000001 -0.268000 -0.238693 -0.058613         0         0     0</span><br><span class="line">2019-06-06 000001 -0.269373 -0.244829 -0.049088         0         0     0</span><br></pre></td></tr></table></figure>
<p>而且每次调用<code>on_bar</code>，都需要对指标进行一次计算。 所以考虑在<code>QAStragety</code>类自带的<code>user_init</code>中先统一根据所有数据计算完并生成信号后,再在<code>on_bar</code>中判断信号出现与否,再完成下单动作。修改代码如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> QAStrategy.qastockbase <span class="keyword">import</span> QAStrategyStockBase</span><br><span class="line"><span class="keyword">import</span> QUANTAXIS <span class="keyword">as</span> QA</span><br><span class="line"><span class="keyword">from</span> Risk_util <span class="keyword">import</span> QA_Risk_Abstract</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> deque</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> rich <span class="keyword">import</span> <span class="built_in">print</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MACD_JCSC</span>(<span class="params">QAStrategyStockBase</span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">user_init</span>(<span class="params">self</span>):</span></span><br><span class="line">        data = QA.QA_fetch_stock_day_adv(</span><br><span class="line">            self.code, self.start, self.end).to_qfq()</span><br><span class="line">        self.signal = data.add_func(self.macd_jcsc)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">on_bar</span>(<span class="params">self, bar</span>):</span></span><br><span class="line">        cursor_date = bar.name[<span class="number">0</span>].date().strftime(<span class="string">&quot;%Y-%m-%d&quot;</span>)</span><br><span class="line">        cursor_code = bar.name[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> self.signal.loc[cursor_date].loc[cursor_code].CROSS_JC == <span class="number">1</span>:</span><br><span class="line">            print(<span class="string">&quot;[%s] %s 出现买入信号！！！&quot;</span> % bar.name)</span><br><span class="line">            <span class="keyword">if</span> self.get_positions(bar.name[<span class="number">1</span>]).volume_long == <span class="number">0</span>:</span><br><span class="line">                self.send_order(<span class="string">&quot;BUY&quot;</span>, <span class="string">&quot;OPEN&quot;</span>, code=bar.name[<span class="number">1</span>], price=bar.close, volume=<span class="number">1000</span>)</span><br><span class="line">                print(<span class="string">&quot;交易：以%.2f价格买入！！！&quot;</span> % bar.close)</span><br><span class="line">        <span class="keyword">elif</span> self.signal.loc[cursor_date].loc[cursor_code].CROSS_SC == <span class="number">1</span>:</span><br><span class="line">            print(<span class="string">&quot;[%s] %s 出现卖出信号！！！&quot;</span> % bar.name)</span><br><span class="line">            <span class="keyword">if</span> self.get_positions(bar.name[<span class="number">1</span>]).volume_long &gt; <span class="number">0</span>:</span><br><span class="line">                self.send_order(<span class="string">&quot;SELL&quot;</span>, <span class="string">&quot;CLOSE&quot;</span>,code=bar.name[<span class="number">1</span>], price=bar.close, volume=<span class="number">1000</span>)</span><br><span class="line">                print(<span class="string">&quot;交易：以%.2f价格卖出！！！&quot;</span> % bar.close)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">macd_jcsc</span>(<span class="params">self, dataframe, SHORT=<span class="number">12</span>, LONG=<span class="number">26</span>, M=<span class="number">9</span></span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        1.DIF向上突破DEA，买入信号参考。</span></span><br><span class="line"><span class="string">        2.DIF向下跌破DEA，卖出信号参考。</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        CLOSE = dataframe.close</span><br><span class="line">        DIFF = QA.EMA(CLOSE, SHORT) - QA.EMA(CLOSE, LONG)</span><br><span class="line">        DEA = QA.EMA(DIFF, M)</span><br><span class="line">        MACD = <span class="number">2</span>*(DIFF-DEA)</span><br><span class="line"></span><br><span class="line">        CROSS_JC = QA.CROSS(DIFF, DEA)</span><br><span class="line">        CROSS_SC = QA.CROSS(DEA, DIFF)</span><br><span class="line">        ZERO = <span class="number">0</span></span><br><span class="line">        <span class="keyword">return</span> pd.DataFrame(&#123;<span class="string">&#x27;DIFF&#x27;</span>: DIFF, <span class="string">&#x27;DEA&#x27;</span>: DEA, <span class="string">&#x27;MACD&#x27;</span>: MACD, <span class="string">&#x27;CROSS_JC&#x27;</span>: CROSS_JC, <span class="string">&#x27;CROSS_SC&#x27;</span>: CROSS_SC, <span class="string">&#x27;ZERO&#x27;</span>: ZERO&#125;)</span><br><span class="line"></span><br><span class="line">st1=datetime.datetime.now()</span><br><span class="line">print(<span class="string">&#x27;开始回测 -- &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(datetime.datetime.now()))</span><br><span class="line">code_list = [<span class="string">&#x27;000001&#x27;</span>]</span><br><span class="line"><span class="comment">#code_list = QA.QA_fetch_stock_list_adv().code.tolist()</span></span><br><span class="line"></span><br><span class="line">s = MACD_JCSC(</span><br><span class="line">    code        = code_list,</span><br><span class="line">    frequence   = <span class="string">&#x27;day&#x27;</span>,</span><br><span class="line">    start       = <span class="string">&#x27;2019-01-01&#x27;</span>,</span><br><span class="line">    end         = <span class="string">&#x27;2024-06-27&#x27;</span>,</span><br><span class="line">    strategy_id = <span class="string">&#x27;s-with_unit_init&#x27;</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#s.debug()  //不保存进数据库</span></span><br><span class="line"><span class="comment">#s._debug_sim()   //模拟盘测试</span></span><br><span class="line">s.run_backtest()</span><br><span class="line">r = QA_Risk_Abstract(QA.QA_Risk(s.acc))</span><br><span class="line">print(<span class="string">&#x27;[bold magenta][风险指标][/bold magenta]&#x27;</span>)</span><br><span class="line">print(r.message)</span><br><span class="line">p = QA.QA_Performance(s.acc)</span><br><span class="line">print(<span class="string">&#x27;[bold magenta][绩效指标][/bold magenta]&#x27;</span>)</span><br><span class="line">print(p.base_message(p.pnl))</span><br><span class="line">print(<span class="string">&#x27;回测耗时 -- &#123;&#125;&#x27;</span>.<span class="built_in">format</span>(datetime.datetime.now()-st1))</span><br></pre></td></tr></table></figure>
<p>修改前完成单只股票5年半的回测需要 <strong><em>33.95秒</em></strong>, 而修改后仅需 <strong><em>25.71秒</em></strong>。</p>
<h2 id="回测结果">回测结果</h2>
<p>回测的结果可以直接在终端上可见，也可以能过 <code>Web</code> 方式(http://127.0.0.1:81/) 查询。</p>
<h3 id="风险分析">风险分析</h3>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &#x27;account_cookie&#x27;: &#x27;s-with_unit_init&#x27;,</span><br><span class="line">    &#x27;annualize_return&#x27;: 0.0,</span><br><span class="line">    &#x27;profit&#x27;: 0.0,</span><br><span class="line">    &#x27;max_dropback&#x27;: 0.01,</span><br><span class="line">    &#x27;time_gap&#x27;: 1330,</span><br><span class="line">    &#x27;volatility&#x27;: 0.43,</span><br><span class="line">    &#x27;benchmark_code&#x27;: &#x27;000300&#x27;,</span><br><span class="line">    &#x27;bm_annualizereturn&#x27;: 0.03,</span><br><span class="line">    &#x27;bm_profit&#x27;: 0.16,</span><br><span class="line">    &#x27;beta&#x27;: 0.01,</span><br><span class="line">    &#x27;alpha&#x27;: -0.0,</span><br><span class="line">    &#x27;sharpe&#x27;: -0.12,</span><br><span class="line">    &#x27;sortino&#x27;: -395.75,</span><br><span class="line">    &#x27;last_assets&#x27;: &#x27;1002633.56&#x27;,</span><br><span class="line">    &#x27;total_tax&#x27;: -644.7,</span><br><span class="line">    &#x27;total_commission&#x27;: -481.4,</span><br><span class="line">    &#x27;profit_money&#x27;: 2633.56,</span><br><span class="line">    &#x27;ir&#x27;: 0.0,</span><br><span class="line">    &#x27;month_profit&#x27;: &#123;</span><br><span class="line">        &#x27;2019-01-31 00:00:00&#x27;: 0.0,</span><br><span class="line">        &#x27;2019-02-28 00:00:00&#x27;: 703.1234393180348,</span><br><span class="line">        &#x27;2019-03-31 00:00:00&#x27;: -50.181729689240456,</span><br><span class="line">        &#x27;2019-04-30 00:00:00&#x27;: 642.743004972348,</span><br><span class="line">        &#x27;2019-05-31 00:00:00&#x27;: 0.0,</span><br><span class="line">        &#x27;2019-06-30 00:00:00&#x27;: 1368.4163899420528,</span><br><span class="line">        &#x27;2019-07-31 00:00:00&#x27;: -353.5741839206312,</span><br><span class="line">        &#x27;2019-08-31 00:00:00&#x27;: -773.1137744144071,</span><br><span class="line">        &#x27;2019-09-30 00:00:00&#x27;: 68.32695359084755,</span><br><span class="line">        &#x27;2019-10-31 00:00:00&#x27;: 705.2476993447635,</span><br><span class="line">        &#x27;2019-11-30 00:00:00&#x27;: 0.0,</span><br><span class="line">        &#x27;2019-12-31 00:00:00&#x27;: 684.6625807939563,</span><br><span class="line">        &#x27;2020-01-31 00:00:00&#x27;: 250.99576606589835,</span><br><span class="line">        &#x27;2020-02-29 00:00:00&#x27;: -764.5018294820329,</span><br><span class="line">        &#x27;2020-03-31 00:00:00&#x27;: -639.1336695251521,</span><br><span class="line">        &#x27;2020-04-30 00:00:00&#x27;: 986.47938771802,</span><br><span class="line">        &#x27;2020-05-31 00:00:00&#x27;: -627.6430917717516,</span><br><span class="line">        &#x27;2020-06-30 00:00:00&#x27;: -518.7461710819043,</span><br><span class="line">        &#x27;2020-07-31 00:00:00&#x27;: 607.8399459136417,</span><br><span class="line">        &#x27;2020-08-31 00:00:00&#x27;: 220.76756709371693,</span><br><span class="line">        &#x27;2020-09-30 00:00:00&#x27;: 17.090446144808084,</span><br><span class="line">        &#x27;2020-10-31 00:00:00&#x27;: 1495.516639258014,</span><br><span class="line">        &#x27;2020-11-30 00:00:00&#x27;: 711.2246544788359,</span><br><span class="line">        &#x27;2020-12-31 00:00:00&#x27;: -293.4999780562939,</span><br><span class="line">        &#x27;2021-01-31 00:00:00&#x27;: 2069.263243380934,</span><br><span class="line">        &#x27;2021-02-28 00:00:00&#x27;: 621.7155406653183,</span><br><span class="line">        &#x27;2021-03-31 00:00:00&#x27;: 456.697427464067,</span><br><span class="line">        &#x27;2021-04-30 00:00:00&#x27;: 229.10599464632105,</span><br><span class="line">        &#x27;2021-05-31 00:00:00&#x27;: -48.13997128745541,</span><br><span class="line">        &#x27;2021-06-30 00:00:00&#x27;: -277.31763577868696,</span><br><span class="line">        &#x27;2021-07-31 00:00:00&#x27;: 0.0,</span><br><span class="line">        &#x27;2021-08-31 00:00:00&#x27;: -626.0138344422448,</span><br><span class="line">        &#x27;2021-09-30 00:00:00&#x27;: -1153.6153345350176,</span><br><span class="line">        &#x27;2021-10-31 00:00:00&#x27;: 84.48616837000009,</span><br><span class="line">        &#x27;2021-11-30 00:00:00&#x27;: -1622.0463032894768,</span><br><span class="line">        &#x27;2021-12-31 00:00:00&#x27;: -97.31165447854437,</span><br><span class="line">        &#x27;2022-01-31 00:00:00&#x27;: -2169.600942116813,</span><br><span class="line">        &#x27;2022-02-28 00:00:00&#x27;: -588.2864658574108,</span><br><span class="line">        &#x27;2022-03-31 00:00:00&#x27;: 701.9407301229658,</span><br><span class="line">        &#x27;2022-04-30 00:00:00&#x27;: -492.56538836390246,</span><br><span class="line">        &#x27;2022-05-31 00:00:00&#x27;: -407.6765322362771,</span><br><span class="line">        &#x27;2022-06-30 00:00:00&#x27;: 728.7865806339541,</span><br><span class="line">        &#x27;2022-07-31 00:00:00&#x27;: -519.0264483509818,</span><br><span class="line">        &#x27;2022-08-31 00:00:00&#x27;: 359.32954159996007,</span><br><span class="line">        &#x27;2022-09-30 00:00:00&#x27;: -307.7851737852907,</span><br><span class="line">        &#x27;2022-10-31 00:00:00&#x27;: 0.0,</span><br><span class="line">        &#x27;2022-11-30 00:00:00&#x27;: 2007.9207173399627,</span><br><span class="line">        &#x27;2022-12-31 00:00:00&#x27;: 46.82587729266379,</span><br><span class="line">        &#x27;2023-01-31 00:00:00&#x27;: 586.5987326084869,</span><br><span class="line">        &#x27;2023-02-28 00:00:00&#x27;: 0.0,</span><br><span class="line">        &#x27;2023-03-31 00:00:00&#x27;: -523.4222982611973,</span><br><span class="line">        &#x27;2023-04-30 00:00:00&#x27;: -376.4062199871987,</span><br><span class="line">        &#x27;2023-05-31 00:00:00&#x27;: -239.97391489637084,</span><br><span class="line">        &#x27;2023-06-30 00:00:00&#x27;: -623.9189663539873,</span><br><span class="line">        &#x27;2023-07-31 00:00:00&#x27;: 769.7435180819593,</span><br><span class="line">        &#x27;2023-08-31 00:00:00&#x27;: -622.6199320594314,</span><br><span class="line">        &#x27;2023-09-30 00:00:00&#x27;: -305.4354766883189,</span><br><span class="line">        &#x27;2023-10-31 00:00:00&#x27;: -183.30302026984282,</span><br><span class="line">        &#x27;2023-11-30 00:00:00&#x27;: -627.8779737370787,</span><br><span class="line">        &#x27;2023-12-31 00:00:00&#x27;: 200.35370358801447,</span><br><span class="line">        &#x27;2024-01-31 00:00:00&#x27;: 65.3398147780681,</span><br><span class="line">        &#x27;2024-02-29 00:00:00&#x27;: 1054.7712957019685,</span><br><span class="line">        &#x27;2024-03-31 00:00:00&#x27;: -257.3330304133706,</span><br><span class="line">        &#x27;2024-04-30 00:00:00&#x27;: -14.334259253926575,</span><br><span class="line">        &#x27;2024-05-31 00:00:00&#x27;: 292.6508590914309,</span><br><span class="line">        &#x27;2024-06-30 00:00:00&#x27;: 0.0</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="绩效分析">绩效分析</h3>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &#x27;total_profit&#x27;: 17887.74,</span><br><span class="line">    &#x27;total_loss&#x27;: -14128.09,</span><br><span class="line">    &#x27;total_pnl&#x27;: 1.27,</span><br><span class="line">    &#x27;trading_amounts&#x27;: 48,</span><br><span class="line">    &#x27;profit_amounts&#x27;: 20,</span><br><span class="line">    &#x27;loss_amounts&#x27;: 28,</span><br><span class="line">    &#x27;even_amounts&#x27;: 0,</span><br><span class="line">    &#x27;profit_precentage&#x27;: 0.42,</span><br><span class="line">    &#x27;loss_precentage&#x27;: 0.58,</span><br><span class="line">    &#x27;even_precentage&#x27;: 0.0,</span><br><span class="line">    &#x27;average_profit&#x27;: 894.39,</span><br><span class="line">    &#x27;average_loss&#x27;: -504.57,</span><br><span class="line">    &#x27;average_pnl&#x27;: 1.77,</span><br><span class="line">    &#x27;max_profit&#x27;: 3782.37,</span><br><span class="line">    &#x27;max_loss&#x27;: -1342.29,</span><br><span class="line">    &#x27;max_pnl&#x27;: 2.82,</span><br><span class="line">    &#x27;netprofio_maxloss_ratio&#x27;: 2.8,</span><br><span class="line">    &#x27;continue_profit_amount&#x27;: 4,</span><br><span class="line">    &#x27;continue_loss_amount&#x27;: 9,</span><br><span class="line">    &#x27;average_holdgap&#x27;: &#x27;20 days 00:00:00&#x27;,</span><br><span class="line">    &#x27;average_profitholdgap&#x27;: &#x27;32 days 15:36:00&#x27;,</span><br><span class="line">    &#x27;average_losssholdgap&#x27;: &#x27;10 days 23:08:34.285714285&#x27;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="回测中遇到的问题">回测中遇到的问题</h2>
<p>回测使用的 <code>pandas</code> 版本为 <strong><em>2.2</em></strong>以上，比 <code>Quantaxis</code> 发布时使用的版本要高得多，所以在回测时会遇到大量用法未来会舍弃的告警。如：</p>
<blockquote>
<p>①FutureWarning: Series.__getitem__ treating keys as positions is deprecated. In a future version, integer keys will always be treated as labels (consistent with DataFrame behavior). To access a value by position, use <code>ser.iloc[pos]</code><br />
②FutureWarning: 'M' is deprecated and will be removed in a future version, please use 'ME' instead.<br />
③Removed deprecated Series.iteritems(), DataFrame.iteritems() and HDFStore.iteritems() use obj.items instead (GH 45321)<br />
④FutureWarning: Series.fillna with 'method' is deprecated and will raise in a future version. Use obj.ffill() or obj.bfill() instead.<br />
⑤FutureWarning: The 'axis' keyword in DataFrame.groupby is deprecated and will be removed in a future version.</p>
</blockquote>
<p>可以有两种办法解决。</p>
<ol type="1">
<li><p>屏蔽告警 <figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> warnings</span><br><span class="line">warnings.filterwarnings(<span class="string">&#x27;ignore&#x27;</span>) </span><br></pre></td></tr></table></figure></p></li>
<li><p>根据告警中的提示修改源代码以符合未来版本的要求。 我在所修改的部分，都加注了详细的文档注解，方便以后回溯。具体改动在 [[Quantaxis适配pandas2.x的修改]]。</p></li>
</ol>
<h1 id="参考">参考</h1>
<ol type="1">
<li><a href="https://zhuanlan.zhihu.com/p/412911980">投资没有银弹 -- （五连阳回测代码勘误与更快的回测实现)</a></li>
<li><a href="https://blog.csdn.net/qq_16381291/article/details/131061594">QUANTAXIS探索（七）量化策略实现类QAStrategy的回测模式</a></li>
</ol>
]]></content>
  </entry>
  <entry>
    <title>【Rust】在jupyter notebook中使用Rust</title>
    <url>/2021/01/07/%E3%80%90Rust%E3%80%91%E5%9C%A8jupyter-notebook%E4%B8%AD%E4%BD%BF%E7%94%A8Rust/</url>
    <content><![CDATA[<p>在jupyter notebook中是否也可以像python那样使用呢？ 答案是可以的。现在来记录一下配置步骤。</p>
<h1 id="使用evcxr作为jupyter-notebook内核">使用EvCxR作为jupyter notebook内核</h1>
<h2 id="安装">安装</h2>
<ol type="1">
<li><p>安装jupyter notebook或者jupyter lab</p></li>
<li><p>安装<a href="https://cmake.org/download/">CMake</a>，在安装EvCxR编译时会使用到。</p></li>
<li><p>安装EvCxR</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">cargo install evcxr_jupyter</span><br><span class="line">evcxr_jupyter -<span class="literal">-install</span></span><br></pre></td></tr></table></figure></li>
</ol>
<a id="more"></a>
<h2 id="问题">问题</h2>
<p>安装过程中，原来rust选择的是gnu的工具链编译，但在编译libzmq时会报错，</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">D:\PROGRA~<span class="number">1</span>\MINGW-~<span class="number">1</span>\X86_64~<span class="number">1.0</span><span class="literal">-P</span>\mingw64\bin\G__~<span class="number">1</span>.EXE   <span class="literal">-std</span>=gnu++<span class="number">11</span> <span class="literal">-Wno</span><span class="literal">-tautological</span><span class="literal">-constant</span><span class="literal">-compare</span>  <span class="literal">-o</span> CMakeFiles\cmTC_57766.dir\CheckSymbolExists.cxx.obj <span class="literal">-c</span> E:\Tmp\libzmq<span class="literal">-4</span>.<span class="number">3.3</span>\build\CMakeFiles\CMakeTmp\CheckSymbolExists.cxx</span><br><span class="line"></span><br><span class="line">E:\Tmp\libzmq<span class="literal">-4</span>.<span class="number">3.3</span>\build\CMakeFiles\CMakeTmp\CheckSymbolExists.cxx: <span class="keyword">In</span> <span class="function"><span class="keyword">function</span> &#x27;<span class="title">int</span> <span class="title">main</span><span class="params">(int, char**)</span>&#x27;:</span></span><br><span class="line">E:\Tmp\libzmq<span class="literal">-4</span>.<span class="number">3.3</span>\build\CMakeFiles\CMakeTmp\CheckSymbolExists.cxx:<span class="number">8</span>:<span class="number">19</span>: error: <span class="string">&#x27;strlcpy&#x27;</span> was not declared <span class="keyword">in</span> this scope</span><br><span class="line">   <span class="keyword">return</span> ((int*)(&amp;strlcpy))[<span class="type">argc</span>];</span><br><span class="line">                   ^~~~~~~</span><br><span class="line">E:\Tmp\libzmq<span class="literal">-4</span>.<span class="number">3.3</span>\build\CMakeFiles\CMakeTmp\CheckSymbolExists.cxx:<span class="number">8</span>:<span class="number">19</span>: note: suggested alternative: <span class="string">&#x27;strncpy&#x27;</span></span><br><span class="line">   <span class="keyword">return</span> ((int*)(&amp;strlcpy))[<span class="type">argc</span>];</span><br><span class="line">                   ^~~~~~~</span><br><span class="line">                   strncpy</span><br><span class="line">At global scope:</span><br><span class="line">cc1plus.exe: warning: unrecognized command line option <span class="string">&#x27;-Wno-tautological-constant-compare&#x27;</span></span><br><span class="line">mingw32<span class="literal">-make</span>.exe[<span class="number">1</span>]: *** [<span class="type">CMakeFiles</span>\<span class="type">cmTC_57766.dir</span>\<span class="type">build.make</span>:<span class="number">84</span>: <span class="type">CMakeFiles</span>/<span class="type">cmTC_57766.dir</span>/<span class="type">CheckSymbolExists.cxx.obj</span>] Error <span class="number">1</span></span><br><span class="line"></span><br><span class="line">mingw32<span class="literal">-make</span>.exe[<span class="number">1</span>]: Leaving directory <span class="string">&#x27;E:/Tmp/libzmq-4.3.3/build/CMakeFiles/CMakeTmp&#x27;</span></span><br><span class="line"></span><br><span class="line">mingw32<span class="literal">-make</span>.exe: *** [<span class="type">Makefile</span>:<span class="number">139</span>: <span class="type">cmTC_57766</span>/<span class="type">fast</span>] Error <span class="number">2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">File E:/Tmp/libzmq<span class="literal">-4</span>.<span class="number">3.3</span>/build/CMakeFiles/CMakeTmp/CheckSymbolExists.cxx:</span><br><span class="line">/* */</span><br><span class="line"><span class="comment">#include &lt;string.h&gt;</span></span><br><span class="line"></span><br><span class="line">int main(int argc, char** argv)</span><br><span class="line">&#123;</span><br><span class="line">  (void)argv;</span><br><span class="line"><span class="comment">#ifndef strlcpy</span></span><br><span class="line">  <span class="keyword">return</span> ((int*)(&amp;strlcpy))[<span class="type">argc</span>];</span><br><span class="line"><span class="comment">#else</span></span><br><span class="line">  (void)argc;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="comment">#endif</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>尝试手动编译libzmq, 但无论4.3.3或4.3.2版本都无法成功。 具体原因从issue里也没有太多参考意义。后来从<a href="https://github.com/google/evcxr/issues/53">EvCxR issue 53</a>中得到些启发，将rust的工具链换回msvc工具链。重新安装EvCxR，成功。</p>
<p><img src="https://s2.loli.net/2022/04/14/qIxXnlzYaC7kETM.png" /> 测试</p>
<p><img src="https://s2.loli.net/2022/04/14/IxYUjVNrOBfE1el.png" /> # 参考</p>
<ol type="1">
<li><a href="https://github.com/google/evcxr/blob/master/evcxr_jupyter/README.md">EvCxR Jupyter Kernel</a></li>
</ol>
]]></content>
      <categories>
        <category>技术笔记</category>
        <category>rust</category>
      </categories>
      <tags>
        <tag>rust</tag>
        <tag>jupyternotebook</tag>
      </tags>
  </entry>
  <entry>
    <title>【Sunflower】Dash应用程序实践（一）</title>
    <url>/2024/11/10/%E3%80%90Sunflower%E3%80%91Dash%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E5%AE%9E%E8%B7%B5%EF%BC%88%E4%B8%80%EF%BC%89/</url>
    <content><![CDATA[<h1 id="目的">目的</h1>
<p>在回测分析系统完成后，需要由原来的文字型输出结果转为 web 应用输出。因为输出中需要含有图，表类型的展示元素。考虑使用 <code>Plotly</code> 来完成。原因是基于 <code>Plotly</code> 同时出品了 <code>Dash</code> 生成 app。以及 [[【Dash】Dash-bootstrap主题|Dash Bootstrap 框架]] 来快速开发 web 应用。</p>
<h1 id="布局设计">布局设计</h1>
<p>应用主要展示两个内容：</p>
<ul>
<li>绩效分析</li>
<li>交易明细</li>
</ul>
<p>设计思路分别如下：</p>
<p><img src="https://s2.loli.net/2024/11/10/iCSw9bKD3ROFoyv.png" alt="|500" /> <img src="https://s2.loli.net/2024/11/10/gvrjK8FQub6faXo.png" alt="|500" /></p>
<a id="more"></a>
<p>其中<strong>绩效分析</strong>中主要使用折线图、柱状图展示组合及对标指数在回测期间内的业绩表现。而使用表格展示组合的风险及收益等指标。而<strong>交易明细</strong>中的蜡烛图及柱状图则用来展现组合中单标的物在回测期间内的日线行情数据、成交量。且使用表格记录详细的回测交易情况。所需要的数据均从数据库中提取或通过其计算生成。</p>
<h1 id="实现">实现</h1>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> dash_bootstrap_components <span class="keyword">as</span> dbc</span><br><span class="line"><span class="keyword">from</span> dash <span class="keyword">import</span> Dash, dcc, html, Input, Output, State, dash_table, no_update</span><br><span class="line"><span class="keyword">import</span> plotly.graph_objects <span class="keyword">as</span> go</span><br><span class="line"></span><br><span class="line">app = Dash(__name__, suppress_callback_exceptions=<span class="literal">True</span>, external_stylesheets=[dbc.themes.CERULEAN])</span><br><span class="line"></span><br><span class="line"><span class="comment"># App layout</span></span><br><span class="line">app.layout = dbc.Container(    </span><br><span class="line">    [   </span><br><span class="line">        dcc.Location(<span class="built_in">id</span>=<span class="string">&quot;url-refresh&quot;</span>, refresh=<span class="literal">True</span>),</span><br><span class="line">        <span class="comment"># Header</span></span><br><span class="line">        dbc.Container(</span><br><span class="line">            [</span><br><span class="line">                generate_header()</span><br><span class="line">            ],</span><br><span class="line">            <span class="built_in">id</span>=<span class="string">&quot;header-container&quot;</span>,</span><br><span class="line">            fluid=<span class="literal">True</span>,            </span><br><span class="line">        ),</span><br><span class="line">        dbc.Row(</span><br><span class="line">            [</span><br><span class="line">                dbc.Col(<span class="built_in">id</span>=<span class="string">&quot;left-column&quot;</span>, children=generate_control_card(), md=<span class="number">2</span>),</span><br><span class="line">                dbc.Col(<span class="built_in">id</span>=<span class="string">&quot;right-column&quot;</span>, children=generate_display_tabs(), md=<span class="number">10</span>),</span><br><span class="line">            ]</span><br><span class="line"></span><br><span class="line">        ),</span><br><span class="line">       </span><br><span class="line">               </span><br><span class="line">    ],</span><br><span class="line">    <span class="built_in">id</span>=<span class="string">&quot;app-container&quot;</span>,</span><br><span class="line">    fluid=<span class="literal">True</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Run the server</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    app.run_server(debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<p><strong>代码详解:</strong></p>
<p>这段代码实现了一个 Dash 应用的布局，包含导航栏、控制区域、和数据展示区域。布局以 <code>dbc.Container</code> 为基础，使用了 <code>Dash Bootstrap</code> 组件（<code>dash_bootstrap_components</code>），同时还加载了<code>Plotly</code> 进行数据可视化。</p>
<ol type="1">
<li><strong>应用初始化</strong> <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">app = Dash(__name__, suppress_callback_exceptions=<span class="literal">True</span>, external_stylesheets=[dbc.themes.CERULEAN])</span><br></pre></td></tr></table></figure>
<ul>
<li><code>app</code> 是应用实例。</li>
<li><code>suppress_callback_exceptions=True</code>：允许未在初始布局中定义的组件在回调中使用。这在条件性显示组件时有用。</li>
<li><code>external_stylesheets=[dbc.themes.CERULEAN]</code>：应用 Bootstrap 主题（<code>CERULEAN</code>）来美化布局。</li>
</ul></li>
<li><strong>布局结构</strong> <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">app.layout = dbc.Container([...], <span class="built_in">id</span>=<span class="string">&quot;app-container&quot;</span>, fluid=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>整个布局被包含在一个 <code>dbc.Container</code> 中，<code>fluid=True</code> 使其响应式，适配各种屏幕大小。</li>
<li><code>id="app-container"</code>：设置容器的唯一 ID。</li>
</ul></li>
<li><strong>页面刷新</strong> <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">dcc.Location(<span class="built_in">id</span>=<span class="string">&quot;url-refresh&quot;</span>, refresh=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li><code>dcc.Location</code> 组件用于检测和更新 URL 变化。</li>
<li><code>refresh=True</code>：在回调中更新 <code>href</code> 时触发页面刷新。</li>
</ul></li>
<li><strong>Header（标题栏）</strong> <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">dbc.Container([generate_header()], <span class="built_in">id</span>=<span class="string">&quot;header-container&quot;</span>, fluid=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li><code>generate_header()</code> 是一个自定义函数（未在此代码中定义），用于生成标题栏内容。</li>
<li>该标题栏被包裹在一个响应式的 <code>dbc.Container</code> 中，<code>fluid=True</code> 确保在不同设备上都能适配。</li>
</ul></li>
<li><strong>主要内容区域</strong> <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">dbc.Row([...])</span><br></pre></td></tr></table></figure>
<ul>
<li>使用 <code>dbc.Row</code> 来组织主要内容部分。</li>
<li><code>dbc.Row</code> 内包含两个列：左侧为控制卡片，右侧为显示标签页。</li>
</ul></li>
<li><strong>左侧控制栏</strong> <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">dbc.Col(<span class="built_in">id</span>=<span class="string">&quot;left-column&quot;</span>, children=generate_control_card(), md=<span class="number">2</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li><code>left-column</code> 是包含控制卡片的 <code>dbc.Col</code>，宽度占 2 列。</li>
<li><code>generate_control_card()</code> 是一个自定义函数，用于生成控制栏的内容。</li>
</ul></li>
<li><strong>右侧内容展示区域</strong> <figure class="highlight python"><table><tr><td class="code"><pre><span class="line">dbc.Col(<span class="built_in">id</span>=<span class="string">&quot;right-column&quot;</span>, children=generate_display_tabs(), md=<span class="number">10</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li><code>right-column</code> 是右侧的展示区域，宽度占 10 列。</li>
<li><code>generate_display_tabs()</code> 是一个自定义函数，用于生成展示内容的标签页布局。</li>
</ul></li>
</ol>
<h3 id="小结">小结</h3>
<p>该布局包含了一个标题栏、一个控制栏、和一个展示区域。应用使用 <code>dash_bootstrap_components</code> 提供的栅格系统 (<code>dbc.Row</code> 和 <code>dbc.Col</code>) 来控制布局结构，具有响应式设计，使其适配不同屏幕大小。</p>
<h1 id="参考">参考</h1>
<p>【1】<a href="https://dash.plotly.com/">Dash Documentation &amp; User Guide | Plotly</a><br />
【2】<a href="https://dash-bootstrap-components.opensource.faculty.ai/docs/">dbc docs</a></p>
]]></content>
      <categories>
        <category>量化交易</category>
      </categories>
      <tags>
        <tag>python</tag>
        <tag>dash</tag>
        <tag>plotly</tag>
      </tags>
  </entry>
  <entry>
    <title>【Rust】Rust配置日志记录</title>
    <url>/2022/04/13/%E3%80%90Rust%E3%80%91Rust%E9%85%8D%E7%BD%AE%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95/</url>
    <content><![CDATA[<p>利用 <code>log</code> 及 <code>env_logger</code>来配置日志。</p>
<h1 id="简介">简介</h1>
<h2 id="crate-log"><em>Crate</em> log</h2>
<h3 id="功能说明">功能说明</h3>
<p><code>log</code> 提供了一个单独的日志记录 <em>API</em>，给出了日志库的一般抽象，后面具体的日志库需要基于这个抽象实现具体的实例。</p>
<p>日志请求由目标，级别和内容组成。目标是一个字符串，其默认为日志请求的位置的模块路径，尽管可能会覆盖默认值。记录器实现通常使用目标基于某些用户配置来过滤日志请求。</p>
<h3 id="记录器实现">记录器实现</h3>
<p>为了生成日志输出，必须使用与 <code>log</code> 兼容的日志记录器实现。有许多可用的实现可供选择，这里有一些常用的： - 精简版记录器: - <a href="https://docs.rs/env_logger/*/env_logger/">env_logger</a> - <a href="https://github.com/borntyping/rust-simple_logger">simple_logger</a> - <a href="https://github.com/drakulix/simplelog.rs">simplelog</a> - <a href="https://docs.rs/pretty_env_logger/*/pretty_env_logger/">pretty_env_logger</a> - <a href="https://docs.rs/stderrlog/*/stderrlog/">stderrlog</a> - <a href="https://docs.rs/flexi_logger/*/flexi_logger/">flexi_logger</a> - 复杂且可配置的框架: - <a href="https://docs.rs/log4rs/*/log4rs/">log4rs</a> - <a href="https://docs.rs/fern/*/fern/">fern</a> - 专用适配: - <a href="https://docs.rs/syslog/*/syslog/">syslog</a> - <a href="https://docs.rs/slog-stdlog/*/slog_stdlog/">slog-stdlog</a> - <a href="https://docs.rs/log/latest/log/(https://docs.rs/systemd-journal-logger/*/systemd_journal_logger/)">systemd-journal-logger</a> - <a href="https://docs.rs/log/latest/log/(https://docs.rs/android_log/*/android_log/)">android_log</a> - <a href="https://docs.rs/log/latest/log/(https://docs.rs/win_dbg_logger/*/win_dbg_logger/)">win_dbg_logger</a> - WebAssembly可用: - <a href="https://docs.rs/log/latest/log/(https://docs.rs/console_log/*/console_log/)">console_log</a> - 动态库: - 构建在<code>log</code>之上的 FFI-safe wrapper 来初始化库。</p>
<a id="more"></a>
<h3 id="日志分级">日志分级</h3>
<p><code>log</code>的最基本的用法是通过5个宏来实现的。 <strong>定义</strong>如下： <figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="meta">#[repr(usize)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">enum</span> <span class="title">Level</span></span> &#123;</span><br><span class="line">    Error,</span><br><span class="line">    Warn,</span><br><span class="line">    Info,</span><br><span class="line">    <span class="built_in">Debug</span>,</span><br><span class="line">    Trace,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> <strong>优先级</strong>：<code>error!</code> &gt; <code>warn!</code> &gt; <code>info!</code> &gt; <code>debug!</code> &gt; <code>trace!</code>。<code>error!</code>的优先级最高，<code>trace!</code>优先级最低。</p>
<h2 id="crate-env_logger"><em>Crate</em> env_logger</h2>
<p><code>env_logger</code> 通过配置环境变量来实现日志记录器的功能。</p>
<h3 id="应用示例">应用示例</h3>
<ol type="1">
<li>打印不同级别日志 <figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="meta">#[cfg(test)]</span></span><br><span class="line"><span class="keyword">mod</span> logtests &#123;</span><br><span class="line">    <span class="meta">#[test]</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">test_log_default</span></span>()&#123;</span><br><span class="line">		<span class="keyword">use</span> log::&#123;debug, error, warn, info&#125;;</span><br><span class="line"></span><br><span class="line">		env_logger::init();</span><br><span class="line"></span><br><span class="line">		debug!(<span class="string">&quot;debug message&quot;</span>);</span><br><span class="line">		info!(<span class="string">&quot;informational message&quot;</span>);</span><br><span class="line">		warn!(<span class="string">&quot;warning message&quot;</span>);</span><br><span class="line">		error!(<span class="string">&quot;error message&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure> 运行<code>cargo test -- test_log_default</code>进行测试，结果如下： <img src="https://s2.loli.net/2022/04/13/5BoA2P6TvVd3GCD.png" /> 为什么无法看到 <em>error</em> 以下级别的日志呢？ 从 <code>env_logger</code> 的源代码中有以下说明： &gt;Log levels are controlled on a per-module basis, and <strong>by default all logging is disabled except for the <code>error</code> level</strong>.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></li>
</ol>
<p>基于<code>env_logger</code>的工作模式，需要对 环境变量 <em>RUST_LOG</em> 进行预定义，对以上代码使用以下方式测试。 先设置环境变量 <em>RUST_LOG</em> ，然后运行测试， <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">set</span> RUST_LOG=trace</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cargo <span class="built_in">test</span> -- test_log_default</span></span><br></pre></td></tr></table></figure> 结果如下： <img src="https://s2.loli.net/2022/04/13/MZbY89mlxsUIXBo.png" /></p>
<ol start="2" type="1">
<li><p>采用本地时间作为时间戳 这时需要创建日志生成器 <em>builder</em> 中的 <em>format</em> 方法来完成输出格式的配置。 <figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure> 运行<code>set RUST_LOG=trace &amp;&amp; cargo test -- test_log_localtime</code><a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> 结果如下： <img src="https://s2.loli.net/2022/04/13/qr49HXw6BNJmakA.png" /> 可以看出， 时间戳已经更改为本地时间，但是整个日志格式比较简陋。</p></li>
<li><p>输出格式美化 依照默认输出时的格式，在时间戳、级别、目标前后加入方括号。方括号表现为较高亮度，级别用不同颜色区别。</p></li>
</ol>
<ul>
<li>对级别及方括号分别创建样式 <em>Style</em> ，</li>
<li><em>Style</em> 中的 <em>set_intense</em> 方法用来设置高亮度</li>
<li><em>Style</em> 中的 <em>set_color</em> 方法用来设置颜色，参数为 <em>enum</em> 类型 <figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="meta">#[non_exhaustive]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">enum</span> <span class="title">Color</span></span> &#123;</span><br><span class="line">    Black,</span><br><span class="line">    Blue,</span><br><span class="line">    Green,</span><br><span class="line">    Red,</span><br><span class="line">    Cyan,</span><br><span class="line">    Magenta,</span><br><span class="line">    Yellow,</span><br><span class="line">    White,</span><br><span class="line">    Ansi256(<span class="built_in">u8</span>),</span><br><span class="line">    Rgb(<span class="built_in">u8</span>, <span class="built_in">u8</span>, <span class="built_in">u8</span>),</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><em>Style</em> 中的 <em>set_bold</em> 方法用来设置字体粗细</li>
<li><em>Style</em> 中的 <em>value</em> 方法用来封装需要格式化的内容</li>
</ul>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="meta">#[test]</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">test_log_beautify</span></span>()&#123;</span><br><span class="line">        <span class="keyword">use</span> log::&#123;debug, error, warn, info, trace&#125;;</span><br><span class="line">        <span class="keyword">use</span> env_logger::Builder;</span><br><span class="line">        <span class="keyword">use</span> env_logger::fmt::Color;</span><br><span class="line">        <span class="keyword">use</span> chrono::Local;</span><br><span class="line">        <span class="keyword">use</span> std::io::Write;</span><br><span class="line">        <span class="keyword">use</span> log::Level;      </span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建env_logger生成器， 也可直接写成env_logger::builder()</span></span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> builder = Builder::from_default_env();</span><br><span class="line">        </span><br><span class="line">        builder</span><br><span class="line">        .format(|buf, record| &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut</span> level_style = buf.style();</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut</span> brace_style = buf.style();</span><br><span class="line">            level_style.set_intense(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">match</span> record.level() &#123;</span><br><span class="line">                Level::Trace =&gt; level_style.set_color(Color::Cyan).set_bold(<span class="literal">true</span>),</span><br><span class="line">                Level::<span class="built_in">Debug</span> =&gt; level_style.set_color(Color::Blue).set_bold(<span class="literal">true</span>),</span><br><span class="line">                Level::Info =&gt; level_style.set_color(Color::Green).set_bold(<span class="literal">true</span>),</span><br><span class="line">                Level::Warn =&gt; level_style.set_color(Color::Yellow).set_bold(<span class="literal">true</span>),</span><br><span class="line">                Level::Error =&gt; level_style.set_color(Color::Red).set_bold(<span class="literal">true</span>),</span><br><span class="line">            &#125;;</span><br><span class="line">            brace_style.set_color(Color::Black).set_intense(<span class="literal">true</span>);</span><br><span class="line">            <span class="built_in">writeln!</span>(buf, <span class="string">&quot;&#123;&#125;&#123;&#125; &#123;&#125; &#123;&#125;&#123;&#125; &#123;&#125;&quot;</span>, </span><br><span class="line">                    brace_style.value(<span class="string">&quot;[&quot;</span>),</span><br><span class="line">                    Local::now().format(<span class="string">&quot;%Y-%m-%d %H:%M:%S%.3f&quot;</span>), </span><br><span class="line">                    level_style.value(record.level()), </span><br><span class="line">                    record.target(), </span><br><span class="line">                    brace_style.value(<span class="string">&quot;]&quot;</span>), </span><br><span class="line">                    record.args())</span><br><span class="line">           &#125;)</span><br><span class="line">        .init();</span><br><span class="line"></span><br><span class="line">        trace!(<span class="string">&quot;trace message&quot;</span>);</span><br><span class="line">        debug!(<span class="string">&quot;debug message&quot;</span>);</span><br><span class="line">        info!(<span class="string">&quot;informational message&quot;</span>);</span><br><span class="line">        warn!(<span class="string">&quot;warning message&quot;</span>);</span><br><span class="line">        error!(<span class="string">&quot;error message&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>运行<code>set RUST_LOG=trace &amp;&amp; cargo test -- test_log_beautify</code> 结果如下： <img src="https://s2.loli.net/2022/04/13/lvO2d5gfNskSyMJ.png" /></p>
<h1 id="参考">参考</h1>
<ol type="1">
<li><a href="https://docs.rs/crate/log/latest">log 文档</a></li>
<li><a href="https://docs.rs/crate/env_logger/0.9.0">env_logger 文档</a></li>
</ol>
<h1 id="注释">注释</h1>
<section class="footnotes" role="doc-endnotes">
<hr />
<ol>
<li id="fn1" role="doc-endnote"><p><a href="https://docs.rs/env_logger/latest/src/env_logger/lib.rs.html#11-1315">lib.rs - source (docs.rs)</a>, 第92行。<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2" role="doc-endnote"><p>该命令可以在 <em>cmd</em> 下同时执行多条命令, 命令格式：<strong>command1 &amp;&amp; command2</strong> ，command1执行成后后才能执行command2。<a href="#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section>
]]></content>
      <categories>
        <category>程序语言</category>
      </categories>
      <tags>
        <tag>计算机技术/程序语言</tag>
        <tag>Rust</tag>
        <tag>日志</tag>
      </tags>
  </entry>
  <entry>
    <title>【cmder】cmder+fluent terminal的使用及配置</title>
    <url>/2021/03/18/%E3%80%90cmder%E3%80%91cmder+fluent%20terminal%E7%9A%84%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<p>Windows的cmd实在过于丑陋，且使用起来有诸多的不方便， 平时也会使用git bash, 那么有没有办法将它们集成在一起，并且有个漂亮的外观呢？ 答案是肯定的。 那就是cmder + fluent terminal。</p>
<a id="more"></a>
<h2 id="特点">特点</h2>
<ul>
<li>便携，解压即可用</li>
<li>自带git、ls、curl等命令</li>
<li>可设置命令别名</li>
<li>丰富的颜色主题（Solarized、Twilight、Ubuntu、xterm、Monokai，甚至接受自定）、可定制字体</li>
<li>支持tab分页、同屏多端口（支持水平分割、垂直分割）</li>
<li>支持自定terminal，无论是CMD、PowerShell、bash都可以，还可以注入环境变量</li>
</ul>
<h2 id="安装">安装</h2>
<p>从<a href="https://cmder.net/">官网</a>下载，解压即可。这里我用的是mini版。</p>
<h2 id="配置">配置</h2>
<h3 id="外观配置">外观配置</h3>
<p>右键Tab栏空白处，弹出菜单选择<code>Settings</code>, 在这里可以进行cmder的配置</p>
<ul>
<li><p>字体</p>
<p>这里默认是<code>Consolas</code>, 可以根据自己喜好选择合适的字体，推荐使用<code>input Mono</code>、<code>Inconsolata</code>、<code>Consolas</code>、<code>Courier New</code>。</p></li>
<li><p>色彩方案</p>
<p><code>Features-&gt;Colors</code>来选择色彩方案，可以使用预先定义好的多种方案，也可以自定义。</p>
<p>可以参考<a href="https://github.com/joonro/ConEmu-Color-Themes">Github | joonro/ConEmu-Color-Themes</a></p></li>
<li><p>集成fluent terminal</p>
<p>比较喜欢fluent terminal的风格，把cmder从ConEmu里解放出来。</p>
<ul>
<li><p>从<a href="https://github.com/felixse/FluentTerminal#automatic-install">github</a>或<a href="https://www.microsoft.com/zh-cn/p/fluent-terminal/9p2krlmfxf9t?cid=storebadge&amp;ocid=badge&amp;rtc=1&amp;activetab=pivot:overviewtab">microsoft store</a>安装。</p></li>
<li><p>将以下配置保存为<code>Monokai.flutecolors</code>, 在设置主题时会使用到。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">  &#123;</span><br><span class="line">    &quot;Name&quot;: &quot;Monokai&quot;,</span><br><span class="line">    &quot;Author&quot;: &quot;David Refoua &lt;David@Refoua.me&gt;&quot;,</span><br><span class="line">    &quot;Colors&quot;: &#123;</span><br><span class="line">      &quot;Foreground&quot;: &quot;#F8F8F0&quot;,</span><br><span class="line">      &quot;Background&quot;: &quot;#282828&quot;,</span><br><span class="line">      &quot;Cursor&quot;: &quot;#f8f8f0&quot;,</span><br><span class="line">      &quot;CursorAccent&quot;: &quot;#272822&quot;,</span><br><span class="line">      &quot;Selection&quot;: &quot;rgba(73, 72, 62, 0.3)&quot;,</span><br><span class="line">      &quot;Black&quot;: &quot;#2E3436&quot;,</span><br><span class="line">      &quot;Red&quot;: &quot;#CB064D&quot;,</span><br><span class="line">      &quot;Green&quot;: &quot;#8dd006&quot;,</span><br><span class="line">      &quot;Yellow&quot;: &quot;#e6db74&quot;,</span><br><span class="line">      &quot;Blue&quot;: &quot;#0376dd&quot;,</span><br><span class="line">      &quot;Magenta&quot;: &quot;#9d74e6&quot;,</span><br><span class="line">      &quot;Cyan&quot;: &quot;#52aebf&quot;,</span><br><span class="line">      &quot;White&quot;: &quot;#F8F8F2&quot;,</span><br><span class="line">      &quot;BrightBlack&quot;: &quot;#555753&quot;,</span><br><span class="line">      &quot;BrightRed&quot;: &quot;#F92672&quot;, &#x2F;&#x2F; #f3044b</span><br><span class="line">      &quot;BrightGreen&quot;: &quot;#A6E22E&quot;,</span><br><span class="line">      &quot;BrightYellow&quot;: &quot;#FED330&quot;,</span><br><span class="line">      &quot;BrightBlue&quot;: &quot;#0383f5&quot;,</span><br><span class="line">      &quot;BrightMagenta&quot;: &quot;#AE81FF&quot;,</span><br><span class="line">      &quot;BrightCyan&quot;: &quot;#66D9EF&quot;,</span><br><span class="line">      &quot;BrightWhite&quot;: &quot;#F8F8F0&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>打开<code>Fluent Terminal</code>， 进入设置或热键<code>Ctrl-Shift ,</code>在主题中导入<code>Monokai.flutecolors</code>文件，保存并设置为默认主题。</p></li>
<li><p>参考<a href="https://github.com/cmderdev/cmder/wiki/Setting-up-Environment-Variables">cmder环境变量设置</a>对<code>%CMDER_ROOT%</code>、<code>%ConEmuDir%</code>加入环境变量中。</p></li>
</ul></li>
</ul>
<h2 id="终端类型配置">终端类型配置</h2>
<h3 id="cmder中的配置">cmder中的配置</h3>
<h4 id="git-bash">Git bash</h4>
<p>Task parameters</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;icon &quot;D:\Program Files\Git\etc\git.ico&quot;</span><br></pre></td></tr></table></figure>
<p>Commands</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&quot;D:\Program Files\Git\bin\sh.exe&quot; -l -new_console:d:%USERPROFILE%</span><br></pre></td></tr></table></figure>
<h4 id="cmd">CMD</h4>
<p>Commands</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cmd.exe &#x2F;k &quot;%ConEmuBaseDir%\CmdInit.cmd&quot;</span><br></pre></td></tr></table></figure>
<h4 id="cmdadmin">CMD(admin)</h4>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cmd.exe &#x2F;k &quot;%ConEmuBaseDir%\CmdInit.cmd&quot; -new_console:a</span><br></pre></td></tr></table></figure>
<h4 id="docker">Docker</h4>
<p>Task parameters</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;icon &quot;c:\Program Files\Docker\Docker\resources\ddvp.ico&quot;</span><br></pre></td></tr></table></figure>
<p>Commands</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cmd.exe &#x2F;k docker exec -it 138b49276cbb &#x2F;bin&#x2F;bash -cur_console:n</span><br></pre></td></tr></table></figure>
<h3 id="fluent-terminal中的配置">### fluent terminal中的配置</h3>
<p>进入设置-配置文件（Profile），依次创建各类需要的终端配置。</p>
<h4 id="cmd-1">CMD</h4>
<table>
<thead>
<tr class="header">
<th>配置或参数</th>
<th>值</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Name</td>
<td>Cmder</td>
</tr>
<tr class="even">
<td>Shell executable location</td>
<td>C:.exe</td>
</tr>
<tr class="odd">
<td>Working directory</td>
<td>E:Project</td>
</tr>
<tr class="even">
<td>Arguments</td>
<td>/k title Cmder &amp; "%CMDER_ROOT%.bat"</td>
</tr>
<tr class="odd">
<td>Theme</td>
<td>Monokai</td>
</tr>
</tbody>
</table>
<h3 id="docker-1">docker</h3>
<table>
<thead>
<tr class="header">
<th>配置或参数</th>
<th>值</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Name</td>
<td>Docker</td>
</tr>
<tr class="even">
<td>Shell executable location</td>
<td>C:.exe</td>
</tr>
<tr class="odd">
<td>Working directory</td>
<td>E:Project</td>
</tr>
<tr class="even">
<td>Arguments</td>
<td>/k title Docker &amp; %DOCKER_DIR%exec -it 138b49276cbb /bin/bash</td>
</tr>
<tr class="odd">
<td>Theme</td>
<td>Monokai</td>
</tr>
</tbody>
</table>
<h3 id="提示符自定义">提示符自定义</h3>
<p>将<code>λ</code>修改为<code>$</code>,并且将颜色设为'Bright Cryan'。在<code>%CMDER_DIR%\vendor</code>目录下打开<code>clink.lua</code>, 找到</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">local cmder_prompt &#x3D;</span><br><span class="line">local lambda &#x3D;</span><br></pre></td></tr></table></figure>
<p>将{lamb}的色彩定义为1b[1;96;40m{lamb}，lambda值设为"$"。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">local cmder_prompt &#x3D; &quot;\x1b[1;32;40m&#123;cwd&#125; &#123;git&#125;&#123;hg&#125;&#123;svn&#125; \n\x1b[1;96;40m&#123;lamb&#125; \x1b[0m&quot;</span><br><span class="line">local lambda &#x3D; &quot;$&quot;</span><br></pre></td></tr></table></figure>
<h3 id="卡顿">卡顿</h3>
<p>在进入含有git项目的目录时，因为初始设定会完整遍历该目录，所以会感觉到卡顿。可以同样修改<code>clink.lua</code>,找到</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">local git_dir &#x3D; get_git_dir()</span><br></pre></td></tr></table></figure>
<p>将其注释掉即可。缺点是不会显示git相关的信息。</p>
<h2 id="展示">展示</h2>
<p>配置完成后的cmder+fluent terminal如图：</p>
<p><img src="https://s2.loli.net/2022/04/14/leuNCy4g9FPtUL3.png" /></p>
<h2 id="参考">参考</h2>
<p>1/ <a href="https://zhuanlan.zhihu.com/p/71706782">Windows命令行终端神器Cmder配置及美化指南</a></p>
<p>2/ <a href="https://github.com/cmderdev/cmder/wiki/Seamless-FluentTerminal-Integration">Seamless FluentTerminal Integration</a></p>
]]></content>
      <categories>
        <category>技术笔记</category>
        <category>软件</category>
      </categories>
      <tags>
        <tag>cmder</tag>
        <tag>fluent terminal</tag>
      </tags>
  </entry>
  <entry>
    <title>【python】multiprocessing进程间的通信（一）队列</title>
    <url>/2021/01/01/%E3%80%90python%E3%80%91multiprocessing%E8%BF%9B%E7%A8%8B%E9%97%B4%E7%9A%84%E9%80%9A%E4%BF%A1/</url>
    <content><![CDATA[<p>multiprocessing模块支持进程间通信的三种主要形式:<code>队列</code>、<code>管道</code>及<code>共享内存</code>。下面我们来学习一下队列的使用情况。</p>
<a id="more"></a>
<h1 id="队列multiprocessing.queue">队列（multiprocessing.queue)</h1>
<p>队列是线程和进程安全的，也就是一次只能有一个进程或线程进行操作。</p>
<p><strong>示例：</strong>将子进程产生的信息统一写入父进程，这里是使用pool来创建进程池。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Pool, RLock, freeze_support,Queue,Pipe</span><br><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"><span class="keyword">import</span> functools</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"><span class="keyword">from</span> TS_logs <span class="keyword">import</span> TS_log_info</span><br><span class="line"><span class="keyword">from</span>  TS_util <span class="keyword">import</span> (</span><br><span class="line">    TS_util_get_tradelist,</span><br><span class="line">    TS_util_get_real_date,</span><br><span class="line">    TS_util_get_next_datetime,</span><br><span class="line">    TS_util_get_now_time,</span><br><span class="line">    TS_util_date_convert,</span><br><span class="line">    trade_date_sse</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">log_c</span>(<span class="params">q,codelist,n</span>):</span>    </span><br><span class="line">    <span class="keyword">for</span> trade_date <span class="keyword">in</span> codelist[n::<span class="number">8</span>]:</span><br><span class="line">        msg = <span class="string">&#x27;&#123;&#125; #Job&#123;&#125; Trying updating data of trade date &#123;&#125; .&#x27;</span> \</span><br><span class="line">                .<span class="built_in">format</span>(datetime.datetime.now().strftime(<span class="string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span>),n,trade_date)</span><br><span class="line">        sleep(<span class="number">0.05</span>)</span><br><span class="line">        q.put(msg)</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">L = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">8</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:    </span><br><span class="line">    freeze_support()  <span class="comment"># for Windows support</span></span><br><span class="line">    manager = multiprocessing.Manager()</span><br><span class="line">    <span class="comment"># 父进程创建Queue，并传给各个子进程：</span></span><br><span class="line">    q = manager.Queue()</span><br><span class="line">    tqdm.set_lock(RLock())</span><br><span class="line">    codelist = trade_date_sse</span><br><span class="line">    func = functools.partial(log_c,q,codelist)</span><br><span class="line">    p = Pool(initializer=tqdm.set_lock, initargs=(tqdm.get_lock(),))</span><br><span class="line">    p.<span class="built_in">map</span>(func, L)</span><br><span class="line">    p.close()</span><br><span class="line">    p.join()</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> q.empty():</span><br><span class="line">        TS_log_info(q.get())</span><br></pre></td></tr></table></figure>
<p>如果要使用Pool创建进程，就需要使用multiprocessing.Manager()中的Queue()，而不是multiprocessing.Queue()，否则会得到一条如下的错误信息：<br />
<code>RuntimeError: Queue objects should only be shared between processes through inheritance.</code></p>
]]></content>
      <categories>
        <category>技术笔记</category>
        <category>python</category>
      </categories>
      <tags>
        <tag>python</tag>
        <tag>multiprocessing</tag>
      </tags>
  </entry>
  <entry>
    <title>【cmder】在VsCode使用Cmder作为默认终端</title>
    <url>/2021/09/11/%E3%80%90cmder%E3%80%91%E5%9C%A8VsCode%E4%BD%BF%E7%94%A8Cmder%E4%BD%9C%E4%B8%BA%E9%BB%98%E8%AE%A4%E7%BB%88%E7%AB%AF/</url>
    <content><![CDATA[<h1 id="前言">前言</h1>
<p>实在忍受不了<code>VsCode</code>里的默认终端为<code>powershell</code>或<code>cmd</code>, 希望能使用<code>cmder</code>来作为默认终端。</p>
<h1 id="配置步骤">配置步骤</h1>
<p>旧版的<code>VsCode</code>使用以下方法修改。</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&quot;terminal.integrated.shellArgs.windows&quot;:[&quot;/k %CMDER_ROOT%\\vendor\\init.bat&quot;]</span><br></pre></td></tr></table></figure>
<p>当VSCode升级至1.57.1(2021.6.17)时，会出现警告提示：</p>
<p><img src="https://s2.loli.net/2022/04/14/hT1As3nwuqpFCyQ.png" /></p>
<p>意思是此项已弃用，<code>Microsoft</code>官方配置默认 shell 的新推荐方法是在 #terminal.integrated.profiles.windows# 中创建一个终端配置文件，并将其配置文件名称设置为 #terminal.integrated.defaultProfile.windows# 中的默认值。此操作当前将优先于新的配置文件设置，但将来会发生更改。</p>
<ol type="1">
<li>打开<code>User Settings</code>(<code>File</code>-&gt; <code>Preferences</code>-&gt; <code>Settings</code>)。</li>
<li>输入栏：<code>terminal.integrated.Profiles.windows</code>, 并点击<code>Edit in settings.son</code>。</li>
</ol>
<p><img src="https://s2.loli.net/2022/04/14/ltZiaKGOpsSDTkE.png" /></p>
<ol start="3" type="1">
<li><p>添加新的配置， 并设置<code>cmder</code>为默认配置。</p></li>
<li><p>打开一个新终端(<code>Terminal</code> -&gt; <code>New Terminal</code>)</p>
<table>
<thead>
<tr class="header">
<th><img src="https://s2.loli.net/2022/04/14/WbDMzE32fayt8Hg.png" /></th>
<th><img src="https://s2.loli.net/2022/04/14/sGTVRWPSaAH2E9f.png" /></th>
</tr>
</thead>
<tbody>
</tbody>
</table></li>
</ol>
<h1 id="参考">参考</h1>
<p>1/ <a href="https://code.visualstudio.com/docs/editor/integrated-terminal#_terminal-profiles">Integrated Terminal in Visual Studio Code</a></p>
]]></content>
      <categories>
        <category>技术笔记</category>
        <category>软件</category>
      </categories>
      <tags>
        <tag>cmder</tag>
        <tag>VsCode</tag>
      </tags>
  </entry>
  <entry>
    <title>【python】multiprocessing进程间的通信（二）管道</title>
    <url>/2021/01/08/%E3%80%90python%E3%80%91multiprocessing%E8%BF%9B%E7%A8%8B%E9%97%B4%E7%9A%84%E9%80%9A%E4%BF%A1%EF%BC%88%E4%BA%8C%EF%BC%89%E7%AE%A1%E9%81%93/</url>
    <content><![CDATA[<p><code>multiprocessing.Pipe()</code>用来创建管道，返回两个连接对象，代表管道的两端，一般用于进程或者线程之间的通信，不同于<code>os.pipe()</code>,<code>os.pipe()</code>主要用来创建两个文件描述符，一个读，一个写，是单向的。而<code>multiprocessing.Pipe()</code>则可以双向通信。</p>
<a id="more"></a>
<h1 id="管道multiprocessing.pipe">管道（multiprocessing.Pipe）</h1>
<blockquote>
<p><code>multiprocessing.``Pipe</code>([<em>duplex</em>])</p>
<p>返回一对 <a href="https://docs.python.org/zh-cn/3/library/multiprocessing.html#multiprocessing.connection.Connection"><code>Connection</code></a> 对象 <code>(conn1, conn2)</code> ， 分别表示管道的两端。</p>
<p>如果 <em>duplex</em> 被置为 <code>True</code> (默认值)，那么该管道是双向的。如果 <em>duplex</em> 被置为 <code>False</code> ，那么该管道是单向的，即 <code>conn1</code> 只能用于接收消息，而 <code>conn2</code> 仅能用于发送消息。</p>
</blockquote>
<p><strong>示例：</strong>将子进程产生的信息统一写入父进程，这里是使用pool来创建进程池。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Pool, RLock, freeze_support,Queue,Pipe</span><br><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"><span class="keyword">import</span> functools</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"><span class="keyword">from</span> TS_logs <span class="keyword">import</span> TS_log_info</span><br><span class="line"><span class="keyword">from</span>  TS_util <span class="keyword">import</span> (</span><br><span class="line">    TS_util_get_tradelist,</span><br><span class="line">    TS_util_get_real_date,</span><br><span class="line">    TS_util_get_next_datetime,</span><br><span class="line">    TS_util_get_now_time,</span><br><span class="line">    TS_util_date_convert,</span><br><span class="line">    trade_date_sse</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">log_c</span>(<span class="params">child_conn,codelist,n</span>):</span> </span><br><span class="line">    <span class="keyword">for</span> trade_date <span class="keyword">in</span> codelist[n::<span class="number">8</span>][<span class="number">0</span>:<span class="number">17</span>]:</span><br><span class="line">        msg = <span class="string">&#x27;&#123;&#125; #Job&#123;&#125;  trade date &#123;&#125;.&#x27;</span> \</span><br><span class="line">                .<span class="built_in">format</span>(datetime.datetime.now().strftime(<span class="string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span>),n,trade_date)</span><br><span class="line">        child_conn.send(msg)</span><br><span class="line">    print(<span class="string">&#x27;workers exit&#x27;</span>)</span><br><span class="line"></span><br><span class="line">L = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">8</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:    </span><br><span class="line">    freeze_support()  <span class="comment"># for Windows support</span></span><br><span class="line">    parent_conn,child_conn = Pipe()</span><br><span class="line">    tqdm.set_lock(RLock())</span><br><span class="line">    codelist = trade_date_sse</span><br><span class="line">    func = functools.partial(log_c,child_conn,codelist)</span><br><span class="line">    p = Pool(initializer=tqdm.set_lock, initargs=(tqdm.get_lock(),))</span><br><span class="line">    p.<span class="built_in">map</span>(func, L)</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">while</span> parent_conn.poll(<span class="number">0.001</span>):</span><br><span class="line">        print(parent_conn.recv())</span><br><span class="line">    p.close()</span><br><span class="line">    p.join()</span><br><span class="line">    parent_conn.close()</span><br><span class="line">    child_conn.close()</span><br></pre></td></tr></table></figure>
<p>当子进程发送一定量的数据之后会卡住，没有任何报错和提示，卡住不动！！测试大概是7000字节左右。原因尚未找到。按文档看，应该与OS有关，最大应该可达32M。</p>
]]></content>
      <categories>
        <category>技术笔记</category>
        <category>python</category>
      </categories>
      <tags>
        <tag>python</tag>
        <tag>multiprocessing</tag>
      </tags>
  </entry>
  <entry>
    <title>【python】在多进程下输出日志</title>
    <url>/2021/01/08/%E3%80%90python%E3%80%91%E5%9C%A8%E5%A4%9A%E8%BF%9B%E7%A8%8B%E4%B8%8B%E8%BE%93%E5%87%BA%E6%97%A5%E5%BF%97/</url>
    <content><![CDATA[<p>可以利用队列或管道来进行多进程下的日志输出，但<a href="https://docs.python.org/3/howto/logging-cookbook.html#logging-to-a-single-file-from-multiple-processes">官方文档</a>推荐了一种利用<code>logging.SocketHandler</code>的方案来实现多进程日志输出。</p>
<p>其原理是：多个进程将各自环境下的日志通过<code>Socket</code>发送给一个专门打印日志的进程，这样就可以防止多进程打印的冲突与混乱情况。</p>
]]></content>
      <categories>
        <category>技术笔记</category>
        <category>python</category>
      </categories>
      <tags>
        <tag>python</tag>
        <tag>multiprocessing</tag>
        <tag>logging</tag>
      </tags>
  </entry>
  <entry>
    <title>【应用软件】ShareX截图工具的使用</title>
    <url>/2021/09/24/%E3%80%90%E5%BA%94%E7%94%A8%E8%BD%AF%E4%BB%B6%E3%80%91ShareX%E6%88%AA%E5%9B%BE%E5%B7%A5%E5%85%B7%E7%9A%84%E4%BD%BF%E7%94%A8/</url>
    <content><![CDATA[<p>截图，使用过的工具有<code>sngait</code>， <code>greenshot</code>, 前者功能强大，但需要付费。后者轻巧，但软件功能较少且更新较慢，最后的稳定版还是2017年发布的。至于QQ等截图工具，需要打开QQ软件本身，不太省心。</p>
<p>在写博客的时候，大多数工具均采用矩形截图的方式， 如果需要对所截取的图片进行圆角，阴影等效果的添加，就必须使用其它软件来进行后处理。</p>
<p><code>shareX</code>恰好满足这些需求。且体量也不算大。</p>
<a id="more"></a>
<h1 id="sharex简介">shareX简介</h1>
<p>ShareX 是一款功能非常强大且免费开源的截图与屏幕记录工具 。除了正常的截图功能外，还提供多区域截图、滚动截图、屏幕取色，屏幕录制，添加水印等实用的功能。而且还可以上传到多种文件存储服务器上。可以让截图更加高效、美观。</p>
<p>更多信息及下载详见<a href="https://getsharex.com/">shareX官网</a></p>
<h1 id="sharex截图美化的实现">shareX截图美化的实现</h1>
<ol type="1">
<li><p>打开<code>shareX</code>--&gt; <code>动作设置</code>。<br />
<img src="https://s2.loli.net/2022/04/14/uNx2cCDt3eIpYgE.png" /></p></li>
<li><p>在<code>图像</code>--&gt;<code>效果</code>中点击<code>图像效果配置</code>。 <img src="https://gitee.com/nokiasonic/pic/raw/master/img/ShareX_yGfFOIJKcC.png" /> <img src="https://s2.loli.net/2022/04/14/oW1LIdqnyaslbfx.png" /></p></li>
<li><p>圆角美化 新建效果，取合适的名称，然后从<code>操作</code>中选择<code>Rounded corners</code>, 参数选择圆角弧度大小。 <img src="https://s2.loli.net/2022/04/14/yUxfQT8RnWSFp2J.png" /></p></li>
<li><p>阴影美化 从<code>过滤器</code>中选择<code>Shadow</code>, 设置合适的参数。 <img src="https://s2.loli.net/2022/04/14/tkcMVJoGjpheWLP.png" /></p></li>
<li><p>添加水印 从<code>绘图</code>中选择<code>Text watermark</code>, 并对其位置，大小，字体等参数进行设置。 <img src="https://s2.loli.net/2022/04/14/UQzq48bHKdZufSO.png" /></p></li>
</ol>
<p>这里只尝试了几种截图美化，效果，shareX内置了许多图片效果，还有已做好的模板可供选择，可见<a href="https://getsharex.com/image-effects/">Image effects - ShareX (getsharex.com)</a></p>
<h1 id="sharex截图上传">shareX截图上传</h1>
<p>内置的图床或文件上传器多为国外服务器，考虑到今后图片使用的便捷性和易维护性，尝试自定义github或gitee图床的上传。 <img src="https://s2.loli.net/2022/04/14/W7QSUtIq6pcDlN1.png" /></p>
<p><img src="https://s2.loli.net/2022/04/14/Gg9blyzh4WuFCTE.png" /> 参考<a href="https://getsharex.com/docs/custom-uploader">Custom uploader guide - ShareX (getsharex.com)</a>进行上传器的自定义，这时发现无论github还是gitee, 利用<code>API</code>上传时，</p>
<p><img src="https://s2.loli.net/2022/04/14/Chidkgf5KowXHAu.png" /></p>
<p>上传的图片内容需要用base64编码后放入<code>content</code>参数中，也就是说上传前需要对图片内容做一次base64的编码，这个目前在shareX中并没有提供，就此做罢。</p>
<p>最后采取的上传解决方案是，截图后通过<code>picgo</code>预设的图床进行上传。</p>
<p>其间遇到的问题是，shareX截图加阴影后，会将阴影部分的背景透明化，拷贝到剪粘板再通过picgo上传后，会丢失该部分透明化的背景，而变之为白色背景，这个应该是picgo无法正确从剪粘板上读取shareX处理图片的透明化信息所致。但从生成的文件上传确是正常的。这个与shareX使用.net方法不能正常通过alpha通道来处理剪粘板拷贝内容的透明度有关。 <img src="https://s2.loli.net/2022/04/14/FyLdfDVCRnQljS2.png" /></p>
<p>解决方法： shareX截图后的处理动作里，可以不选择<code>图像复制到剪粘板</code>，而是选择上<code>保存图像文件</code>及<code>将文件复制到剪粘板</code>,通过重新读取文件内容来规避。 <img src="https://s2.loli.net/2022/04/14/h5GwJnbNFegjqXv.png" /></p>
<p>至此, shareX可以满足我对博客图片美化的要求。</p>
<h1 id="参考">参考</h1>
<p>1/ <a href="https://zhuanlan.zhihu.com/p/338226481"># 一般人都不会用的强大的屏幕截图工具，添加水印、截图特效等，让你的截图更完美！</a><br />
2/ <a href="https://getsharex.com/">shareX官网</a><br />
3/ <a href="https://docs.github.com/cn/rest">GitHub REST API - GitHub Docs</a><br />
4/ <a href="https://gitee.com/api/v5/swagger#/getV5ReposOwnerRepoStargazers?ex=no">Gitee open API</a></p>
]]></content>
      <categories>
        <category>应用软件</category>
      </categories>
      <tags>
        <tag>shareX</tag>
        <tag>效率工具</tag>
        <tag>截图</tag>
      </tags>
  </entry>
  <entry>
    <title>为博客文章增加Valine评论系统</title>
    <url>/2020/12/10/%E4%B8%BA%E5%8D%9A%E5%AE%A2%E6%96%87%E7%AB%A0%E5%A2%9E%E5%8A%A0Valine%E8%AF%84%E8%AE%BA%E7%B3%BB%E7%BB%9F/</url>
    <content><![CDATA[<p>目前常用的评论系统有以下这些：</p>
<ul>
<li><p>Github大礼包：<a href="https://link.zhihu.com/?target=https%3A//github.com/iissnan/hexo-theme-next/issues/1604">gitment</a>， <a href="https://link.zhihu.com/?target=https%3A//github.com/iissnan/hexo-theme-next/pull/2037">gitalk</a><strong>（推荐），</strong><a href="https://link.zhihu.com/?target=https%3A//www.vincentqin.tech/2016/08/09/build-a-website-using-hexo/%23%E5%A2%9E%E5%8A%A0Gitter">gitter</a><strong>（推荐）;</strong> 三个都支持<strong>Markdown；</strong></p></li>
<li><p>基于leancloud的无后端评论系统：<a href="https://link.zhihu.com/?target=https%3A//valine.js.org/%23/">Valine</a><strong>（推荐，</strong>支持<strong>Markdown）；</strong></p></li>
<li><p>国外的有几个：<a href="https://link.zhihu.com/?target=http%3A//www.disqus.com/">disqus</a>(漂亮，但需翻墙)，<a href="https://link.zhihu.com/?target=https%3A//www.hypercomments.com/">hypercomments</a><strong>（推荐，</strong>不支持<strong>Markdown）。</strong></p></li>
</ul>
<p>来试试如何用Valine搭建评论系统吧。</p>
<a id="more"></a>
<h2 id="注册leanclound获取app-id-和-app-key">注册LeanClound,获取APP ID 和 APP Key</h2>
<p>Valine 是基于 <a href="https://leancloud.cn/">LeanCloud</a> 作为数据存储的，所以需要注册一个账号，因为备案与否的关系，选择在国际区注册，在注册完成后，需要创建应用。</p>
<p><img src="https://s2.loli.net/2022/04/14/kCUuMnrTcDtp6Ol.png" /></p>
<p><img src="https://s2.loli.net/2022/04/14/jJgkvhER96HTxIP.png" /></p>
<p>点击<code>存储</code>设置，查看是否有<code>Comment</code>和 <code>Counter</code>，没有则创建，权限设为无限制。</p>
<p><img src="https://s2.loli.net/2022/04/14/Ph8VWKl45Rsgvnm.png" /></p>
<p>在<code>安全中心</code>里将除<code>数据存储</code>之外的服务全部关闭。</p>
<p><img src="https://s2.loli.net/2022/04/14/dCbk2I5LfuQVqlo.png" /></p>
<p>最后点击<code>应用 Keys</code> 取得我们 <code>AppKey</code> 和 <code>App id</code></p>
<h2 id="在hexo-next主题中配置">在Hexo Next主题中配置</h2>
<p>首先打开 https://www.jsdelivr.com/package/npm/valine 获取最新的 valine.min.js 的cdn地址：</p>
<p><img src="https://s2.loli.net/2022/04/14/L53GDIsQKOmekbq.png" /></p>
<p>修改博客项目目录下的<code>_config.next.yml</code>文件：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Valine</span></span><br><span class="line"><span class="comment"># valine: //cdn.jsdelivr.net/npm/valine@1/dist/Valine.min.js</span></span><br><span class="line"><span class="comment"># valine: //cdnjs.cloudflare.com/ajax/libs/valine/1.3.10/Valine.min.js</span></span><br><span class="line"><span class="string">valine:https://cdn.jsdelivr.net/npm/valine@1.4.14/dist/Valine.min.js</span></span><br></pre></td></tr></table></figure>
<p>以及</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">valine:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">appid:</span> <span class="comment"># Your leancloud application appid</span></span><br><span class="line">  <span class="attr">appkey:</span> <span class="comment"># Your leancloud application appkey</span></span><br><span class="line">  <span class="attr">notify:</span> <span class="literal">false</span> <span class="comment"># Mail notifier</span></span><br><span class="line">  <span class="attr">verify:</span> <span class="literal">false</span> <span class="comment"># Verification code</span></span><br><span class="line">  <span class="attr">placeholder:</span> <span class="string">Just</span> <span class="string">go</span> <span class="string">go</span> <span class="comment"># Comment box placeholder</span></span><br><span class="line">  <span class="attr">avatar:</span> <span class="string">mm</span> <span class="comment"># Gravatar style</span></span><br><span class="line">  <span class="attr">guest_info:</span> <span class="string">nick,mail,link</span> <span class="comment"># Custom comment header</span></span><br><span class="line">  <span class="attr">pageSize:</span> <span class="number">10</span> <span class="comment"># Pagination size</span></span><br><span class="line">  <span class="attr">language:</span> <span class="comment"># Language, available values: en, zh-cn</span></span><br><span class="line">  <span class="attr">visitor:</span> <span class="literal">false</span> <span class="comment"># Article reading statistic</span></span><br><span class="line">  <span class="attr">comment_count:</span> <span class="literal">true</span> <span class="comment"># If false, comment count will only be displayed in post page, not in home page</span></span><br><span class="line">  <span class="attr">recordIP:</span> <span class="literal">false</span> <span class="comment"># Whether to record the commenter IP</span></span><br><span class="line">  <span class="attr">serverURLs:</span> <span class="comment"># When the custom domain name is enabled, fill it in here (it will be detected automatically by default, no need to fill in)</span></span><br><span class="line">  <span class="comment">#post_meta_order: 0</span></span><br></pre></td></tr></table></figure>
<p>appid及appkey就填写我们从LeanClound那里获得的信息。</p>
<h2 id="利用valine-admin进行评论管理">利用Valine Admin进行评论管理</h2>
<p>Valine Admin 是Valine的扩展和增强，主要实现评论邮件通知、评论管理、垃圾评论过滤等功能。支持完全自定义的邮件通知模板，基于 Akismet API 实现准确的垃圾评论过滤。</p>
<h3 id="部署">部署</h3>
<ol type="1">
<li>在 <a href="https://leancloud.cn/dashboard/#/apps">Leancloud</a> 云引擎部署界面，填写代码库并保存：https://github.com/DesertsP/Valine-Admin.git</li>
</ol>
<p><img src="https://s2.loli.net/2022/04/14/J5gvLmkdSjYGDRp.png" /></p>
<ol start="2" type="1">
<li><p>在 <a href="https://leancloud.cn/dashboard/#/apps">Leancloud</a> 云引擎设置界面，设置环境变量以及 Web 二级域名。</p>
<p><img src="https://s2.loli.net/2022/04/14/iFGUe98r3PghSfR.png" /></p></li>
<li><p>环境变量说明</p></li>
</ol>
<table>
<colgroup>
<col style="width: 12%" />
<col style="width: 27%" />
<col style="width: 59%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">变量</th>
<th style="text-align: left;">示例</th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">SITE_NAME</td>
<td style="text-align: left;">Deserts</td>
<td style="text-align: left;">[必填]博客名称</td>
</tr>
<tr class="even">
<td style="text-align: left;">SITE_URL</td>
<td style="text-align: left;">https://nokiasonic.github.io</td>
<td style="text-align: left;">[必填]首页地址</td>
</tr>
<tr class="odd">
<td style="text-align: left;">SMTP_SERVICE</td>
<td style="text-align: left;"></td>
<td style="text-align: left;">[新版支持]邮件服务提供商，支持 QQ、163、126、Gmail 以及 更多</td>
</tr>
<tr class="even">
<td style="text-align: left;">SMTP_USER</td>
<td style="text-align: left;">xxxxx@hotmail.com</td>
<td style="text-align: left;">[必填] SMTP 登录用户, 这个在注册访问管理员注册页面<code>https://nokiasonic.github.io/sign-up</code>，会用作注册管理员登录信息。</td>
</tr>
<tr class="odd">
<td style="text-align: left;">SMTP_PASS</td>
<td style="text-align: left;">ccxxxxxxxxch</td>
<td style="text-align: left;">[必填] SMTP 登录密码（QQ邮箱需要获取独立密码）</td>
</tr>
<tr class="even">
<td style="text-align: left;">SENDER_NAME</td>
<td style="text-align: left;">nokiasonic</td>
<td style="text-align: left;">[必填]发件人</td>
</tr>
<tr class="odd">
<td style="text-align: left;">SENDER_EMAIL</td>
<td style="text-align: left;">xxxxx@hotmail.com</td>
<td style="text-align: left;">[必填]发件邮箱</td>
</tr>
<tr class="even">
<td style="text-align: left;">ADMIN_URL</td>
<td style="text-align: left;">https://xxx.avosapps.us</td>
<td style="text-align: left;">[建议] Web 主机二级域名，用于自动唤醒</td>
</tr>
<tr class="odd">
<td style="text-align: left;">BLOGGER_EMAIL</td>
<td style="text-align: left;">xxxxx@hotmail.com</td>
<td style="text-align: left;">[可选]博主通知收件地址，默认使用 SENDER_EMAIL</td>
</tr>
<tr class="even">
<td style="text-align: left;">AKISMET_KEY</td>
<td style="text-align: left;">xxxxxxxxxxxx</td>
<td style="text-align: left;">[可选] Akismet Key 用于垃圾评论检测，设为 MANUAL_REVIEW 开启人工审核，留空不使用反垃圾</td>
</tr>
</tbody>
</table>
<p>登入ADMIN_URL对应的链接，可以进行评论的查看及管理。</p>
<p><img src="https://s2.loli.net/2022/04/14/TjoOWhpUJXZ2asv.png" /></p>
]]></content>
      <categories>
        <category>技术笔记</category>
        <category>美好生活</category>
        <category>博客</category>
      </categories>
      <tags>
        <tag>Valine</tag>
      </tags>
  </entry>
  <entry>
    <title>【量化投资】通达信板块数据提取</title>
    <url>/2021/09/06/%E3%80%90%E9%87%8F%E5%8C%96%E6%8A%95%E8%B5%84%E3%80%91%E9%80%9A%E8%BE%BE%E4%BF%A1%E6%9D%BF%E5%9D%97%E6%95%B0%E6%8D%AE%E6%8F%90%E5%8F%96/</url>
    <content><![CDATA[<h1 id="数据提取">数据提取</h1>
<p>从MongoDB中进取通达信板块数据，该数据均通过通达信api从服务器上提取并存入MongoDB。</p>
<h2 id="实例">实例</h2>
<h3 id="模糊查询">1. 模糊查询</h3>
<p>MongoDB 使用 <strong><code>$regex</code></strong> 操作符来设置匹配字符串的正则表达式来进行模糊查询。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pymongo <span class="keyword">import</span> MongoClient</span><br><span class="line"></span><br><span class="line"><span class="comment">#存入数据</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_block_list</span>(<span class="params">database</span>):</span></span><br><span class="line">    stocklist = []</span><br><span class="line">    collection = db[<span class="string">&#x27;stock_block&#x27;</span>]</span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> collection.find(&#123;<span class="string">&#x27;blockname&#x27;</span>:&#123;<span class="string">&#x27;$regex&#x27;</span>:<span class="string">&#x27;酒&#x27;</span>&#125;&#125;,&#123;<span class="string">&#x27;_id&#x27;</span>:<span class="number">0</span>,<span class="string">&#x27;code&#x27;</span>:<span class="number">1</span>&#125;):</span><br><span class="line">        stocklist.append(item[<span class="string">&#x27;code&#x27;</span>])</span><br><span class="line">    stocklist = <span class="built_in">list</span>(<span class="built_in">set</span>(stocklist))</span><br><span class="line">    <span class="keyword">return</span> stocklist</span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    client = MongoClient(<span class="string">&#x27;localhost&#x27;</span>, <span class="number">27017</span>)</span><br><span class="line">    db = client[<span class="string">&#x27;quantaxis&#x27;</span>]</span><br><span class="line">    stocklist = get_block_list(database=db)</span><br><span class="line">    print(<span class="string">&quot;Total &#123;&#125; stocks are in this block.\n&#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">len</span>(stocklist),stocklist))</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Total 69 stocks are in this block.</span><br><span class="line">[&#39;600257&#39;, &#39;000752&#39;, &#39;600616&#39;, &#39;600766&#39;, &#39;600779&#39;, &#39;601579&#39;, &#39;603919&#39;, &#39;603198&#39;, &#39;600771&#39;, &#39;603101&#39;, &#39;600132&#39;, &#39;000524&#39;, &#39;600258&#39;, &#39;605108&#39;, &#39;000428&#39;, &#39;600750&#39;, &#39;000888&#39;, &#39;603025&#39;, &#39;002461&#39;, &#39;600238&#39;, &#39;600754&#39;, &#39;601007&#39;, &#39;000929&#39;, &#39;000596&#39;, &#39;600573&#39;, &#39;600600&#39;, &#39;603299&#39;, &#39;600059&#39;, &#39;600197&#39;, &#39;002772&#39;, &#39;600559&#39;, &#39;300237&#39;, &#39;600260&#39;, &#39;600543&#39;, &#39;000721&#39;, &#39;600084&#39;, &#39;600365&#39;, &#39;000930&#39;, &#39;000858&#39;, &#39;000860&#39;, &#39;603369&#39;, &#39;000568&#39;, &#39;600655&#39;, &#39;600809&#39;, &#39;600702&#39;, &#39;002304&#39;, &#39;002568&#39;, &#39;000869&#39;, &#39;600382&#39;, &#39;600781&#39;, &#39;002342&#39;, &#39;000829&#39;, &#39;600381&#39;, &#39;600199&#39;, &#39;002646&#39;, &#39;603589&#39;, &#39;603777&#39;, &#39;002183&#39;, &#39;000995&#39;, &#39;600252&#39;, &#39;000729&#39;, &#39;603779&#39;, &#39;002803&#39;, &#39;002186&#39;, &#39;600395&#39;, &#39;600696&#39;, &#39;600519&#39;, &#39;000007&#39;, &#39;000799&#39;]</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="提取板块名称">2. 提取板块名称</h3>
<h4 id="用mongodb命令提取">用MongoDB命令提取</h4>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">db.getCollection(&#x27;stock_block&#x27;).distinct(&#x27;blockname&#x27;)</span><br></pre></td></tr></table></figure>
<p><img src="https://gitee.com/nokiasonic/pic/raw/master/img/20210906121720.png" /></p>
<h4 id="用pymongo模块提取">用pymongo模块提取</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pymongo <span class="keyword">import</span> MongoClient</span><br><span class="line"></span><br><span class="line">client = MongoClient(<span class="string">&#x27;localhost&#x27;</span>, <span class="number">27017</span>)</span><br><span class="line">db = client[<span class="string">&#x27;quantaxis&#x27;</span>]</span><br><span class="line">collection = db[<span class="string">&#x27;stock_block&#x27;</span>]</span><br><span class="line"></span><br><span class="line">res = collection.distinct(<span class="string">&#x27;blockname&#x27;</span>)</span><br><span class="line">print(res[:<span class="number">10</span>])</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<blockquote>
<p>[None, '300ESG', '300周期', '300非周', '3D打印', '5G概念', 'BIPV概念', 'C2M概念', 'CRO概念', 'ETC概念']</p>
</blockquote>
<p>如需要知道酒类板块的名称，可以采用模糊查询的方式来提取数据。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">db.getCollection(&#x27;stock_block&#x27;).distinct(&#x27;blockname&#x27;,&#123;&#x27;blockname&#x27;:&#123;$regex:&#x27;酒&#x27;&#125;&#125;)</span><br></pre></td></tr></table></figure>
<p><img src="https://gitee.com/nokiasonic/pic/raw/master/img/20210906125011.png" /></p>
<h3 id="提取板块中的股票代码及名称">3. 提取板块中的股票代码及名称</h3>
<p>查询板块<code>白酒</code>及<code>白酒概念</code>中的股票列表（包括代码及名称)</p>
<h4 id="仅提取代码">仅提取代码</h4>
<h5 id="用mongodb命令提取-1">用MongoDB命令提取</h5>
<p>因通达信同一板块定义中包含通达信行业、申万行业等不同分类，含有重复项，所以用去重方式进行查询。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">db.getCollection(&#x27;stock_block&#x27;).distinct(&#x27;code&#x27;,&#123;&#x27;blockname&#x27;:&#x27;白酒&#x27;&#125;)</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">db.getCollection(&#x27;stock_block&#x27;).distinct(&#x27;code&#x27;,&#123;&#x27;blockname&#x27;:&#x27;白酒概念&#x27;&#125;)</span><br></pre></td></tr></table></figure>
<p><img src="https://gitee.com/nokiasonic/pic/raw/master/img/20210907095910.png" /></p>
<h5 id="用pymongo模块提取-1">用pymongo模块提取</h5>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pymongo <span class="keyword">import</span> MongoClient</span><br><span class="line"></span><br><span class="line">client = MongoClient(<span class="string">&#x27;localhost&#x27;</span>, <span class="number">27017</span>)</span><br><span class="line">db = client[<span class="string">&#x27;quantaxis&#x27;</span>]</span><br><span class="line">collection = db[<span class="string">&#x27;stock_block&#x27;</span>]</span><br><span class="line"></span><br><span class="line">res = collection.distinct(<span class="string">&#x27;code&#x27;</span>,&#123;<span class="string">&#x27;blockname&#x27;</span>:<span class="string">&#x27;白酒&#x27;</span>&#125;)</span><br><span class="line">print(<span class="string">&quot;Total &#123;&#125; stocks are in this block&quot;</span>.<span class="built_in">format</span>(<span class="built_in">len</span>(res)))</span><br><span class="line">print(res)</span><br></pre></td></tr></table></figure>
<p>​</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Total 20 stocks are in this block</span><br><span class="line">[&#x27;000568&#x27;, &#x27;000596&#x27;, &#x27;000799&#x27;, &#x27;000858&#x27;, &#x27;000860&#x27;, &#x27;000995&#x27;, &#x27;002304&#x27;, &#x27;002646&#x27;, &#x27;600197&#x27;, &#x27;600199&#x27;, &#x27;600519&#x27;, &#x27;600559&#x27;, &#x27;600702&#x27;, &#x27;600779&#x27;, &#x27;600809&#x27;, &#x27;603025&#x27;, &#x27;603198&#x27;, &#x27;603369&#x27;, &#x27;603589&#x27;, &#x27;603919&#x27;]</span><br></pre></td></tr></table></figure>
<h4 id="提取代码及名称">提取代码及名称</h4>
<p>需要使用联表查询，使用<code>aggregate</code>函数。</p>
<h5 id="用mongodb命令提取-2">用MongoDB命令提取</h5>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">db.getCollection(&#x27;stock_block&#x27;).aggregate([&#123;</span><br><span class="line"><span class="meta">  $</span><span class="bash">lookup: &#123; // 左连接</span></span><br><span class="line">    from: &quot;stock_list&quot;,   // 关联到stock_list表</span><br><span class="line">    localField: &quot;code&quot;,   // stock_block 表关联的字段</span><br><span class="line">    foreignField: &quot;code&quot;, // stock_list 表关联的字段</span><br><span class="line">    as: &quot;stock_list&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br><span class="line">&#123; $match : &#123;&#x27;blockname&#x27; : &#x27;白酒&#x27;&#125;&#125;,</span><br><span class="line">&#123; $project: &#123;&#x27;code&#x27;:1,&#x27;stock_list.name&#x27;:1,&#x27;_id&#x27;:0&#125;&#125;,</span><br><span class="line">&#123; $unwind:&#x27;$stock_list&#x27;&#125;,</span><br><span class="line">&#123; $replaceWith:&#123;&#x27;code&#x27;:&#x27;$code&#x27;,&#x27;name&#x27;:&#x27;$stock_list.name&#x27;&#125;&#125;,</span><br><span class="line">&#123; $group: &#123;_id:&#x27;$code&#x27;,&#x27;name&#x27;:&#123; $first:&quot;$name&quot; &#125;&#125;&#125;,</span><br><span class="line">&#123; $replaceWith:&#123;&#x27;code&#x27;:&#x27;$_id&#x27;,&#x27;name&#x27;:&#x27;$name&#x27;&#125;&#125;</span><br><span class="line">])</span><br></pre></td></tr></table></figure>
<p><img src="https://gitee.com/nokiasonic/pic/raw/master/img/20210907113155.png" /></p>
<h5 id="用pymongo模块提取-2">用pymongo模块提取</h5>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pymongo <span class="keyword">import</span> MongoClient</span><br><span class="line"></span><br><span class="line">client = MongoClient(<span class="string">&#x27;localhost&#x27;</span>, <span class="number">27017</span>)</span><br><span class="line">db = client[<span class="string">&#x27;quantaxis&#x27;</span>]</span><br><span class="line">collection = db[<span class="string">&#x27;stock_block&#x27;</span>]</span><br><span class="line">count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">res = collection.aggregate(</span><br><span class="line">  [</span><br><span class="line">      &#123;</span><br><span class="line">          <span class="string">&#x27;$lookup&#x27;</span>: &#123;    <span class="comment">#左连接              </span></span><br><span class="line">            <span class="string">&#x27;from&#x27;</span>: <span class="string">&quot;stock_list&quot;</span>,    <span class="comment"># 关联到stock_list表</span></span><br><span class="line">            <span class="string">&#x27;localField&#x27;</span>: <span class="string">&quot;code&quot;</span>,    <span class="comment"># stock_block 表关联的字段</span></span><br><span class="line">            <span class="string">&#x27;foreignField&#x27;</span>: <span class="string">&quot;code&quot;</span>,  <span class="comment"># stock_list 表关联的字段</span></span><br><span class="line">            <span class="string">&#x27;as&#x27;</span>: <span class="string">&quot;stock_list&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br><span class="line">&#123; <span class="string">&#x27;$match&#x27;</span> : &#123;<span class="string">&#x27;blockname&#x27;</span> : <span class="string">&#x27;白酒&#x27;</span>&#125;&#125;,</span><br><span class="line">&#123; <span class="string">&#x27;$project&#x27;</span>: &#123;<span class="string">&#x27;code&#x27;</span>:<span class="number">1</span>,<span class="string">&#x27;stock_list.name&#x27;</span>:<span class="number">1</span>,<span class="string">&#x27;_id&#x27;</span>:<span class="number">0</span>&#125;&#125;,</span><br><span class="line">&#123; <span class="string">&#x27;$unwind&#x27;</span>:<span class="string">&#x27;$stock_list&#x27;</span>&#125;,</span><br><span class="line">&#123; <span class="string">&#x27;$replaceWith&#x27;</span>:&#123;<span class="string">&#x27;code&#x27;</span>:<span class="string">&#x27;$code&#x27;</span>,<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;$stock_list.name&#x27;</span>&#125;&#125;,</span><br><span class="line">&#123; <span class="string">&#x27;$group&#x27;</span>: &#123;<span class="string">&#x27;_id&#x27;</span>:<span class="string">&#x27;$code&#x27;</span>,<span class="string">&#x27;name&#x27;</span>:&#123; <span class="string">&#x27;$first&#x27;</span>:<span class="string">&quot;$name&quot;</span> &#125;&#125;&#125;,</span><br><span class="line">&#123; <span class="string">&#x27;$replaceWith&#x27;</span>:&#123;<span class="string">&#x27;code&#x27;</span>:<span class="string">&#x27;$_id&#x27;</span>,<span class="string">&#x27;name&#x27;</span>:<span class="string">&#x27;$name&#x27;</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> res:</span><br><span class="line">    print(item)</span><br><span class="line">    count = count + <span class="number">1</span></span><br><span class="line">print(<span class="string">&quot;Total &#123;&#125; stocks are in this block&quot;</span>.<span class="built_in">format</span>(count))</span><br></pre></td></tr></table></figure>
<ul>
<li><code>白酒</code>板块</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">&#123;&#x27;code&#x27;: &#x27;000858&#x27;, &#x27;name&#x27;: &#x27;五 粮 液&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;600519&#x27;, &#x27;name&#x27;: &#x27;贵州茅台&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;002646&#x27;, &#x27;name&#x27;: &#x27;青青稞酒&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;600809&#x27;, &#x27;name&#x27;: &#x27;山西汾酒&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;000995&#x27;, &#x27;name&#x27;: &#x27;皇台酒业&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;603025&#x27;, &#x27;name&#x27;: &#x27;大豪科技&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;002304&#x27;, &#x27;name&#x27;: &#x27;洋河股份&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;000596&#x27;, &#x27;name&#x27;: &#x27;古井贡酒&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;600559&#x27;, &#x27;name&#x27;: &#x27;老白干酒&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;603198&#x27;, &#x27;name&#x27;: &#x27;迎驾贡酒&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;000799&#x27;, &#x27;name&#x27;: &#x27;酒鬼酒&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;603369&#x27;, &#x27;name&#x27;: &#x27;今世缘&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;603589&#x27;, &#x27;name&#x27;: &#x27;口子窖&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;600779&#x27;, &#x27;name&#x27;: &#x27;水井坊&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;600199&#x27;, &#x27;name&#x27;: &#x27;金种子酒&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;600702&#x27;, &#x27;name&#x27;: &#x27;舍得酒业&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;000860&#x27;, &#x27;name&#x27;: &#x27;顺鑫农业&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;603919&#x27;, &#x27;name&#x27;: &#x27;金徽酒&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;000568&#x27;, &#x27;name&#x27;: &#x27;泸州老窖&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;600197&#x27;, &#x27;name&#x27;: &#x27;伊力特&#x27;&#125;</span><br><span class="line">Total 20 stocks are in this block</span><br></pre></td></tr></table></figure>
<ul>
<li><code>白酒概念</code>板块</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">&#123;&#x27;code&#x27;: &#x27;600238&#x27;, &#x27;name&#x27;: &#x27;海南椰岛&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;002304&#x27;, &#x27;name&#x27;: &#x27;洋河股份&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;000596&#x27;, &#x27;name&#x27;: &#x27;古井贡酒&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;600382&#x27;, &#x27;name&#x27;: &#x27;*ST广珠&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;600750&#x27;, &#x27;name&#x27;: &#x27;江中药业&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;600252&#x27;, &#x27;name&#x27;: &#x27;中恒集团&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;002646&#x27;, &#x27;name&#x27;: &#x27;青青稞酒&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;600519&#x27;, &#x27;name&#x27;: &#x27;贵州茅台&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;600696&#x27;, &#x27;name&#x27;: &#x27;岩石股份&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;600771&#x27;, &#x27;name&#x27;: &#x27;广誉远&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;600809&#x27;, &#x27;name&#x27;: &#x27;山西汾酒&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;603919&#x27;, &#x27;name&#x27;: &#x27;金徽酒&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;600655&#x27;, &#x27;name&#x27;: &#x27;豫园股份&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;000888&#x27;, &#x27;name&#x27;: &#x27;峨眉山Ａ&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;000930&#x27;, &#x27;name&#x27;: &#x27;中粮科技&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;000829&#x27;, &#x27;name&#x27;: &#x27;天音控股&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;002183&#x27;, &#x27;name&#x27;: &#x27;怡 亚 通&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;002342&#x27;, &#x27;name&#x27;: &#x27;巨力索具&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;000799&#x27;, &#x27;name&#x27;: &#x27;酒鬼酒&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;002803&#x27;, &#x27;name&#x27;: &#x27;吉宏股份&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;300237&#x27;, &#x27;name&#x27;: &#x27;美晨生态&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;600257&#x27;, &#x27;name&#x27;: &#x27;大湖股份&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;002772&#x27;, &#x27;name&#x27;: &#x27;众兴菌业&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;600260&#x27;, &#x27;name&#x27;: &#x27;ST凯乐&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;600395&#x27;, &#x27;name&#x27;: &#x27;盘江股份&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;600559&#x27;, &#x27;name&#x27;: &#x27;老白干酒&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;000995&#x27;, &#x27;name&#x27;: &#x27;皇台酒业&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;600766&#x27;, &#x27;name&#x27;: &#x27;*ST园城&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;603101&#x27;, &#x27;name&#x27;: &#x27;汇嘉时代&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;603198&#x27;, &#x27;name&#x27;: &#x27;迎驾贡酒&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;603025&#x27;, &#x27;name&#x27;: &#x27;大豪科技&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;603369&#x27;, &#x27;name&#x27;: &#x27;今世缘&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;603777&#x27;, &#x27;name&#x27;: &#x27;来伊份&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;000568&#x27;, &#x27;name&#x27;: &#x27;泸州老窖&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;600197&#x27;, &#x27;name&#x27;: &#x27;伊力特&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;000858&#x27;, &#x27;name&#x27;: &#x27;五 粮 液&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;600779&#x27;, &#x27;name&#x27;: &#x27;水井坊&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;600199&#x27;, &#x27;name&#x27;: &#x27;金种子酒&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;600702&#x27;, &#x27;name&#x27;: &#x27;舍得酒业&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;000860&#x27;, &#x27;name&#x27;: &#x27;顺鑫农业&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;600781&#x27;, &#x27;name&#x27;: &#x27;ST辅仁&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;603589&#x27;, &#x27;name&#x27;: &#x27;口子窖&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;600381&#x27;, &#x27;name&#x27;: &#x27;青海春天&#x27;&#125;</span><br><span class="line">&#123;&#x27;code&#x27;: &#x27;603299&#x27;, &#x27;name&#x27;: &#x27;苏盐井神&#x27;&#125;</span><br><span class="line">Total 44 stocks are in this block</span><br></pre></td></tr></table></figure>
<h3 id="查询股票所属板块">4. 查询股票所属板块</h3>
<p>以<code>贵州茅台（600519）</code>为例：</p>
<h4 id="用mongodb命令提取-3">用MongoDB命令提取</h4>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">db.getCollection(&#x27;stock_block&#x27;).distinct(&#x27;blockname&#x27;,&#123;&#x27;code&#x27;:&#x27;600519&#x27;&#125;)</span><br></pre></td></tr></table></figure>
<p><img src="https://gitee.com/nokiasonic/pic/raw/master/img/20210907180637.png" /></p>
<h4 id="用pymongo模块提取-3">用pymongo模块提取</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pymongo <span class="keyword">import</span> MongoClient</span><br><span class="line"></span><br><span class="line">client = MongoClient(<span class="string">&#x27;localhost&#x27;</span>, <span class="number">27017</span>)</span><br><span class="line">db = client[<span class="string">&#x27;quantaxis&#x27;</span>]</span><br><span class="line">collection = db[<span class="string">&#x27;stock_block&#x27;</span>]</span><br><span class="line"></span><br><span class="line">res = collection.distinct(<span class="string">&#x27;blockname&#x27;</span>,&#123;<span class="string">&#x27;code&#x27;</span>:<span class="string">&#x27;600519&#x27;</span>&#125;)</span><br><span class="line">print(<span class="string">&quot;The stock belongs to Total &#123;&#125; blocks&quot;</span>.<span class="built_in">format</span>(<span class="built_in">len</span>(res)))</span><br><span class="line">print(res)</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">The stock belongs to Total 36 blocks</span><br><span class="line">[&#x27;300ESG&#x27;, &#x27;300非周&#x27;, &#x27;MSCI成份&#x27;, &#x27;上证180&#x27;, &#x27;上证50&#x27;, &#x27;上证混改&#x27;, &#x27;上证超大&#x27;, &#x27;中华A80&#x27;, &#x27;中证100&#x27;, &#x27;中证龙头&#x27;, &#x27;保险重仓&#x27;, &#x27;北上重仓&#x27;, &#x27;国证农业&#x27;, &#x27;国证成长&#x27;, &#x27;基金重仓&#x27;, &#x27;大盘成长&#x27;, &#x27;大盘股&#x27;, &#x27;央视50&#x27;, &#x27;富时A50&#x27;, &#x27;投资时钟&#x27;, &#x27;持续增长&#x27;, &#x27;昨成交20&#x27;, &#x27;沪深300&#x27;, &#x27;泛珠三角&#x27;, &#x27;白酒&#x27;, &#x27;白酒概念&#x27;, &#x27;百元股&#x27;, &#x27;绩优股&#x27;, &#x27;罗素大盘&#x27;, &#x27;股权转让&#x27;, &#x27;融资融券&#x27;, &#x27;行业龙头&#x27;, &#x27;证金汇金&#x27;, &#x27;通达信88&#x27;, &#x27;银河99&#x27;, &#x27;高市净率&#x27;]</span><br></pre></td></tr></table></figure>
<h1 id="参考">参考</h1>
<p>1/ <a href="https://docs.mongodb.com/manual/aggregation/">Aggregation — MongoDB Manual</a></p>
<p>2/ <a href="https://docs.mongodb.com/manual/reference/operator/aggregation/group/">$group (aggregation) — MongoDB Manual</a></p>
]]></content>
      <categories>
        <category>技术笔记</category>
        <category>量化投资</category>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>python</tag>
        <tag>通达信</tag>
        <tag>MongoDB</tag>
      </tags>
  </entry>
  <entry>
    <title>如何用pandas高速处理数据</title>
    <url>/2020/12/08/%E5%A6%82%E4%BD%95%E7%94%A8pandas%E9%AB%98%E9%80%9F%E5%A4%84%E7%90%86%E6%95%B0%E6%8D%AE/</url>
    <content><![CDATA[<p>因为需要对大量数据进行处理，有必要探讨比较下怎么操作具有较高的性能。</p>
<a id="more"></a>
<h2 id="创建dataframe数据">创建Dataframe数据</h2>
<p>使用QA创建了一个包含6列和61006行的Dataframe。它包含了2020年11月16日至12月4日的OHLC和成交量数据。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> QUANTAXIS <span class="keyword">as</span> QA</span><br><span class="line"></span><br><span class="line">code = QA.QA_fetch_stock_list_adv().code.tolist()</span><br><span class="line">daydata = QA.QA_fetch_stock_day_adv(code, <span class="string">&#x27;2020-11-16&#x27;</span>, <span class="string">&#x27;2020-12-04&#x27;</span>)</span><br><span class="line">df = daydata.data</span><br><span class="line">print(df.shape)</span><br><span class="line">df.head(<span class="number">10</span>)</span><br></pre></td></tr></table></figure>
<pre><code>you are using non-interactive mdoel quantaxis
(61001, 6)</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
</th>
<th>
open
</th>
<th>
high
</th>
<th>
low
</th>
<th>
close
</th>
<th>
volume
</th>
<th>
amount
</th>
</tr>
<tr>
<th>
date
</th>
<th>
code
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
</tr>
</thead>
<tbody>
<tr>
<th rowspan="10" valign="top">
2020-11-16
</th>
<th>
000001
</th>
<td>
17.08
</td>
<td>
17.43
</td>
<td>
16.90
</td>
<td>
17.37
</td>
<td>
759856.0
</td>
<td>
1.308190e+09
</td>
</tr>
<tr>
<th>
000002
</th>
<td>
29.39
</td>
<td>
29.50
</td>
<td>
29.00
</td>
<td>
29.20
</td>
<td>
516576.0
</td>
<td>
1.509810e+09
</td>
</tr>
<tr>
<th>
000004
</th>
<td>
31.15
</td>
<td>
31.46
</td>
<td>
30.11
</td>
<td>
30.61
</td>
<td>
72456.0
</td>
<td>
2.223127e+08
</td>
</tr>
<tr>
<th>
000005
</th>
<td>
2.68
</td>
<td>
2.70
</td>
<td>
2.65
</td>
<td>
2.69
</td>
<td>
64372.0
</td>
<td>
1.725762e+07
</td>
</tr>
<tr>
<th>
000006
</th>
<td>
5.66
</td>
<td>
5.74
</td>
<td>
5.62
</td>
<td>
5.72
</td>
<td>
98253.0
</td>
<td>
5.592563e+07
</td>
</tr>
<tr>
<th>
000007
</th>
<td>
9.42
</td>
<td>
9.42
</td>
<td>
9.18
</td>
<td>
9.20
</td>
<td>
22567.0
</td>
<td>
2.094628e+07
</td>
</tr>
<tr>
<th>
000008
</th>
<td>
2.72
</td>
<td>
2.74
</td>
<td>
2.70
</td>
<td>
2.73
</td>
<td>
171930.0
</td>
<td>
4.678304e+07
</td>
</tr>
<tr>
<th>
000009
</th>
<td>
7.71
</td>
<td>
7.88
</td>
<td>
7.66
</td>
<td>
7.82
</td>
<td>
320180.0
</td>
<td>
2.492149e+08
</td>
</tr>
<tr>
<th>
000010
</th>
<td>
4.19
</td>
<td>
4.27
</td>
<td>
4.10
</td>
<td>
4.24
</td>
<td>
71661.0
</td>
<td>
3.004320e+07
</td>
</tr>
<tr>
<th>
000011
</th>
<td>
13.76
</td>
<td>
14.40
</td>
<td>
13.58
</td>
<td>
14.39
</td>
<td>
105639.0
</td>
<td>
1.489735e+08
</td>
</tr>
</tbody>
</table>
</div>
<p>显示dataframe的内存占用情况。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">df.info(memory_usage = <span class="string">&#x27;deep&#x27;</span>)</span><br></pre></td></tr></table></figure>
<pre><code>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
MultiIndex: 61001 entries, (2020-11-16 00:00:00, 000001) to (2020-12-04 00:00:00, 689009)
Data columns (total 6 columns):
open      61001 non-null float64
high      61001 non-null float64
low       61001 non-null float64
close     61001 non-null float64
volume    61001 non-null float64
amount    61001 non-null float64
dtypes: float64(6)
memory usage: 3.2 MB</code></pre>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">%%time</span><br><span class="line"></span><br><span class="line">df1 = df</span><br><span class="line">col_name = df1.columns.tolist()</span><br><span class="line">col_name.insert(<span class="number">6</span>,<span class="string">&#x27;status&#x27;</span>)</span><br><span class="line">df1 = df1.reindex(columns=col_name)</span><br><span class="line">df1.head(<span class="number">10</span>)</span><br></pre></td></tr></table></figure>
<pre><code>CPU times: user 1.72 ms, sys: 1.99 ms, total: 3.71 ms
Wall time: 3.21 ms</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
</th>
<th>
open
</th>
<th>
high
</th>
<th>
low
</th>
<th>
close
</th>
<th>
volume
</th>
<th>
amount
</th>
<th>
status
</th>
</tr>
<tr>
<th>
date
</th>
<th>
code
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
</tr>
</thead>
<tbody>
<tr>
<th rowspan="10" valign="top">
2020-11-16
</th>
<th>
000001
</th>
<td>
17.08
</td>
<td>
17.43
</td>
<td>
16.90
</td>
<td>
17.37
</td>
<td>
759856.0
</td>
<td>
1.308190e+09
</td>
<td>
NaN
</td>
</tr>
<tr>
<th>
000002
</th>
<td>
29.39
</td>
<td>
29.50
</td>
<td>
29.00
</td>
<td>
29.20
</td>
<td>
516576.0
</td>
<td>
1.509810e+09
</td>
<td>
NaN
</td>
</tr>
<tr>
<th>
000004
</th>
<td>
31.15
</td>
<td>
31.46
</td>
<td>
30.11
</td>
<td>
30.61
</td>
<td>
72456.0
</td>
<td>
2.223127e+08
</td>
<td>
NaN
</td>
</tr>
<tr>
<th>
000005
</th>
<td>
2.68
</td>
<td>
2.70
</td>
<td>
2.65
</td>
<td>
2.69
</td>
<td>
64372.0
</td>
<td>
1.725762e+07
</td>
<td>
NaN
</td>
</tr>
<tr>
<th>
000006
</th>
<td>
5.66
</td>
<td>
5.74
</td>
<td>
5.62
</td>
<td>
5.72
</td>
<td>
98253.0
</td>
<td>
5.592563e+07
</td>
<td>
NaN
</td>
</tr>
<tr>
<th>
000007
</th>
<td>
9.42
</td>
<td>
9.42
</td>
<td>
9.18
</td>
<td>
9.20
</td>
<td>
22567.0
</td>
<td>
2.094628e+07
</td>
<td>
NaN
</td>
</tr>
<tr>
<th>
000008
</th>
<td>
2.72
</td>
<td>
2.74
</td>
<td>
2.70
</td>
<td>
2.73
</td>
<td>
171930.0
</td>
<td>
4.678304e+07
</td>
<td>
NaN
</td>
</tr>
<tr>
<th>
000009
</th>
<td>
7.71
</td>
<td>
7.88
</td>
<td>
7.66
</td>
<td>
7.82
</td>
<td>
320180.0
</td>
<td>
2.492149e+08
</td>
<td>
NaN
</td>
</tr>
<tr>
<th>
000010
</th>
<td>
4.19
</td>
<td>
4.27
</td>
<td>
4.10
</td>
<td>
4.24
</td>
<td>
71661.0
</td>
<td>
3.004320e+07
</td>
<td>
NaN
</td>
</tr>
<tr>
<th>
000011
</th>
<td>
13.76
</td>
<td>
14.40
</td>
<td>
13.58
</td>
<td>
14.39
</td>
<td>
105639.0
</td>
<td>
1.489735e+08
</td>
<td>
NaN
</td>
</tr>
</tbody>
</table>
</div>
<h2 id="效率测试">效率测试</h2>
<h3 id="测试1使用下标循环">测试1：使用下标循环</h3>
<p>下标循环是通过循环一个下标数列，通过iloc去不断获取数据。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">%%time</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(df1)):</span><br><span class="line">    <span class="keyword">if</span> (df1.iloc[i][<span class="string">&#x27;close&#x27;</span>] - df1.iloc[i][<span class="string">&#x27;open&#x27;</span>]) &gt;=<span class="number">0</span>:</span><br><span class="line">        df1.iloc[i][<span class="string">&#x27;status&#x27;</span>] = <span class="number">1</span>        </span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        df1.iloc[i][<span class="string">&#x27;status&#x27;</span>] = -<span class="number">1</span>   </span><br><span class="line">df1.head(<span class="number">10</span>)</span><br></pre></td></tr></table></figure>
<pre><code>CPU times: user 33.6 s, sys: 136 ms, total: 33.8 s
Wall time: 34.1 s</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
</th>
<th>
open
</th>
<th>
high
</th>
<th>
low
</th>
<th>
close
</th>
<th>
volume
</th>
<th>
amount
</th>
<th>
status
</th>
</tr>
<tr>
<th>
date
</th>
<th>
code
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
</tr>
</thead>
<tbody>
<tr>
<th rowspan="10" valign="top">
2020-11-16
</th>
<th>
000001
</th>
<td>
17.08
</td>
<td>
17.43
</td>
<td>
16.90
</td>
<td>
17.37
</td>
<td>
759856.0
</td>
<td>
1.308190e+09
</td>
<td>
1.0
</td>
</tr>
<tr>
<th>
000002
</th>
<td>
29.39
</td>
<td>
29.50
</td>
<td>
29.00
</td>
<td>
29.20
</td>
<td>
516576.0
</td>
<td>
1.509810e+09
</td>
<td>
-1.0
</td>
</tr>
<tr>
<th>
000004
</th>
<td>
31.15
</td>
<td>
31.46
</td>
<td>
30.11
</td>
<td>
30.61
</td>
<td>
72456.0
</td>
<td>
2.223127e+08
</td>
<td>
-1.0
</td>
</tr>
<tr>
<th>
000005
</th>
<td>
2.68
</td>
<td>
2.70
</td>
<td>
2.65
</td>
<td>
2.69
</td>
<td>
64372.0
</td>
<td>
1.725762e+07
</td>
<td>
1.0
</td>
</tr>
<tr>
<th>
000006
</th>
<td>
5.66
</td>
<td>
5.74
</td>
<td>
5.62
</td>
<td>
5.72
</td>
<td>
98253.0
</td>
<td>
5.592563e+07
</td>
<td>
1.0
</td>
</tr>
<tr>
<th>
000007
</th>
<td>
9.42
</td>
<td>
9.42
</td>
<td>
9.18
</td>
<td>
9.20
</td>
<td>
22567.0
</td>
<td>
2.094628e+07
</td>
<td>
-1.0
</td>
</tr>
<tr>
<th>
000008
</th>
<td>
2.72
</td>
<td>
2.74
</td>
<td>
2.70
</td>
<td>
2.73
</td>
<td>
171930.0
</td>
<td>
4.678304e+07
</td>
<td>
1.0
</td>
</tr>
<tr>
<th>
000009
</th>
<td>
7.71
</td>
<td>
7.88
</td>
<td>
7.66
</td>
<td>
7.82
</td>
<td>
320180.0
</td>
<td>
2.492149e+08
</td>
<td>
1.0
</td>
</tr>
<tr>
<th>
000010
</th>
<td>
4.19
</td>
<td>
4.27
</td>
<td>
4.10
</td>
<td>
4.24
</td>
<td>
71661.0
</td>
<td>
3.004320e+07
</td>
<td>
1.0
</td>
</tr>
<tr>
<th>
000011
</th>
<td>
13.76
</td>
<td>
14.40
</td>
<td>
13.58
</td>
<td>
14.39
</td>
<td>
105639.0
</td>
<td>
1.489735e+08
</td>
<td>
1.0
</td>
</tr>
</tbody>
</table>
</div>
<h3 id="测试2iterrows循环">测试2：Iterrows循环</h3>
<p>该循环方式是通过iterrows进行循环，ind和row分别代表了每一行的index和内容。测试例子大概需要s，比起下标循环速度提升了321倍。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">%%time</span><br><span class="line"></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> ind, row <span class="keyword">in</span> df1.iterrows():</span><br><span class="line">    <span class="keyword">if</span> row[<span class="string">&#x27;close&#x27;</span>] - row[<span class="string">&#x27;open&#x27;</span>] &gt;=<span class="number">0</span>:</span><br><span class="line">        df1.iloc[i][<span class="string">&#x27;status&#x27;</span>] = <span class="number">1</span>     </span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        df1.iloc[i][<span class="string">&#x27;status&#x27;</span>] = -<span class="number">1</span>  </span><br><span class="line">    i += <span class="number">1</span></span><br><span class="line">df1.head(<span class="number">10</span>)</span><br></pre></td></tr></table></figure>
<pre><code>CPU times: user 18.5 s, sys: 82.7 ms, total: 18.6 s
Wall time: 18.8 s</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
</th>
<th>
open
</th>
<th>
high
</th>
<th>
low
</th>
<th>
close
</th>
<th>
volume
</th>
<th>
amount
</th>
<th>
status
</th>
</tr>
<tr>
<th>
date
</th>
<th>
code
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
</tr>
</thead>
<tbody>
<tr>
<th rowspan="10" valign="top">
2020-11-16
</th>
<th>
000001
</th>
<td>
17.08
</td>
<td>
17.43
</td>
<td>
16.90
</td>
<td>
17.37
</td>
<td>
759856.0
</td>
<td>
1.308190e+09
</td>
<td>
1.0
</td>
</tr>
<tr>
<th>
000002
</th>
<td>
29.39
</td>
<td>
29.50
</td>
<td>
29.00
</td>
<td>
29.20
</td>
<td>
516576.0
</td>
<td>
1.509810e+09
</td>
<td>
-1.0
</td>
</tr>
<tr>
<th>
000004
</th>
<td>
31.15
</td>
<td>
31.46
</td>
<td>
30.11
</td>
<td>
30.61
</td>
<td>
72456.0
</td>
<td>
2.223127e+08
</td>
<td>
-1.0
</td>
</tr>
<tr>
<th>
000005
</th>
<td>
2.68
</td>
<td>
2.70
</td>
<td>
2.65
</td>
<td>
2.69
</td>
<td>
64372.0
</td>
<td>
1.725762e+07
</td>
<td>
1.0
</td>
</tr>
<tr>
<th>
000006
</th>
<td>
5.66
</td>
<td>
5.74
</td>
<td>
5.62
</td>
<td>
5.72
</td>
<td>
98253.0
</td>
<td>
5.592563e+07
</td>
<td>
1.0
</td>
</tr>
<tr>
<th>
000007
</th>
<td>
9.42
</td>
<td>
9.42
</td>
<td>
9.18
</td>
<td>
9.20
</td>
<td>
22567.0
</td>
<td>
2.094628e+07
</td>
<td>
-1.0
</td>
</tr>
<tr>
<th>
000008
</th>
<td>
2.72
</td>
<td>
2.74
</td>
<td>
2.70
</td>
<td>
2.73
</td>
<td>
171930.0
</td>
<td>
4.678304e+07
</td>
<td>
1.0
</td>
</tr>
<tr>
<th>
000009
</th>
<td>
7.71
</td>
<td>
7.88
</td>
<td>
7.66
</td>
<td>
7.82
</td>
<td>
320180.0
</td>
<td>
2.492149e+08
</td>
<td>
1.0
</td>
</tr>
<tr>
<th>
000010
</th>
<td>
4.19
</td>
<td>
4.27
</td>
<td>
4.10
</td>
<td>
4.24
</td>
<td>
71661.0
</td>
<td>
3.004320e+07
</td>
<td>
1.0
</td>
</tr>
<tr>
<th>
000011
</th>
<td>
13.76
</td>
<td>
14.40
</td>
<td>
13.58
</td>
<td>
14.39
</td>
<td>
105639.0
</td>
<td>
1.489735e+08
</td>
<td>
1.0
</td>
</tr>
</tbody>
</table>
</div>
<h3 id="测试3apply循环">测试3：Apply循环</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">%%time</span><br><span class="line"></span><br><span class="line">df1[<span class="string">&#x27;status&#x27;</span>] = (df1[<span class="string">&#x27;close&#x27;</span>]-df[<span class="string">&#x27;open&#x27;</span>]).apply(<span class="keyword">lambda</span> x: <span class="number">1</span> <span class="keyword">if</span> x &gt;=<span class="number">0</span> <span class="keyword">else</span> -<span class="number">1</span>)</span><br><span class="line">df1.head(<span class="number">10</span>)</span><br></pre></td></tr></table></figure>
<pre><code>CPU times: user 23.8 ms, sys: 1.99 ms, total: 25.8 ms
Wall time: 35.6 ms</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
</th>
<th>
open
</th>
<th>
high
</th>
<th>
low
</th>
<th>
close
</th>
<th>
volume
</th>
<th>
amount
</th>
<th>
status
</th>
</tr>
<tr>
<th>
date
</th>
<th>
code
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
</tr>
</thead>
<tbody>
<tr>
<th rowspan="10" valign="top">
2020-11-16
</th>
<th>
000001
</th>
<td>
17.08
</td>
<td>
17.43
</td>
<td>
16.90
</td>
<td>
17.37
</td>
<td>
759856.0
</td>
<td>
1.308190e+09
</td>
<td>
1
</td>
</tr>
<tr>
<th>
000002
</th>
<td>
29.39
</td>
<td>
29.50
</td>
<td>
29.00
</td>
<td>
29.20
</td>
<td>
516576.0
</td>
<td>
1.509810e+09
</td>
<td>
-1
</td>
</tr>
<tr>
<th>
000004
</th>
<td>
31.15
</td>
<td>
31.46
</td>
<td>
30.11
</td>
<td>
30.61
</td>
<td>
72456.0
</td>
<td>
2.223127e+08
</td>
<td>
-1
</td>
</tr>
<tr>
<th>
000005
</th>
<td>
2.68
</td>
<td>
2.70
</td>
<td>
2.65
</td>
<td>
2.69
</td>
<td>
64372.0
</td>
<td>
1.725762e+07
</td>
<td>
1
</td>
</tr>
<tr>
<th>
000006
</th>
<td>
5.66
</td>
<td>
5.74
</td>
<td>
5.62
</td>
<td>
5.72
</td>
<td>
98253.0
</td>
<td>
5.592563e+07
</td>
<td>
1
</td>
</tr>
<tr>
<th>
000007
</th>
<td>
9.42
</td>
<td>
9.42
</td>
<td>
9.18
</td>
<td>
9.20
</td>
<td>
22567.0
</td>
<td>
2.094628e+07
</td>
<td>
-1
</td>
</tr>
<tr>
<th>
000008
</th>
<td>
2.72
</td>
<td>
2.74
</td>
<td>
2.70
</td>
<td>
2.73
</td>
<td>
171930.0
</td>
<td>
4.678304e+07
</td>
<td>
1
</td>
</tr>
<tr>
<th>
000009
</th>
<td>
7.71
</td>
<td>
7.88
</td>
<td>
7.66
</td>
<td>
7.82
</td>
<td>
320180.0
</td>
<td>
2.492149e+08
</td>
<td>
1
</td>
</tr>
<tr>
<th>
000010
</th>
<td>
4.19
</td>
<td>
4.27
</td>
<td>
4.10
</td>
<td>
4.24
</td>
<td>
71661.0
</td>
<td>
3.004320e+07
</td>
<td>
1
</td>
</tr>
<tr>
<th>
000011
</th>
<td>
13.76
</td>
<td>
14.40
</td>
<td>
13.58
</td>
<td>
14.39
</td>
<td>
105639.0
</td>
<td>
1.489735e+08
</td>
<td>
1
</td>
</tr>
</tbody>
</table>
</div>
<h3 id="测试4numpy内置向量化函数">测试4：numpy内置向量化函数</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">%%time</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">df1[<span class="string">&#x27;status&#x27;</span>] = np.where((df1.close -  df1.<span class="built_in">open</span>)&gt;=<span class="number">0</span>, <span class="number">1</span>, -<span class="number">1</span>)</span><br><span class="line">df1.head(<span class="number">10</span>)</span><br></pre></td></tr></table></figure>
<pre><code>CPU times: user 1.74 ms, sys: 2.99 ms, total: 4.72 ms
Wall time: 10.4 ms</code></pre>
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
    
    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th>
</th>
<th>
</th>
<th>
open
</th>
<th>
high
</th>
<th>
low
</th>
<th>
close
</th>
<th>
volume
</th>
<th>
amount
</th>
<th>
status
</th>
</tr>
<tr>
<th>
date
</th>
<th>
code
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
<th>
</th>
</tr>
</thead>
<tbody>
<tr>
<th rowspan="10" valign="top">
2020-11-16
</th>
<th>
000001
</th>
<td>
17.08
</td>
<td>
17.43
</td>
<td>
16.90
</td>
<td>
17.37
</td>
<td>
759856.0
</td>
<td>
1.308190e+09
</td>
<td>
1
</td>
</tr>
<tr>
<th>
000002
</th>
<td>
29.39
</td>
<td>
29.50
</td>
<td>
29.00
</td>
<td>
29.20
</td>
<td>
516576.0
</td>
<td>
1.509810e+09
</td>
<td>
-1
</td>
</tr>
<tr>
<th>
000004
</th>
<td>
31.15
</td>
<td>
31.46
</td>
<td>
30.11
</td>
<td>
30.61
</td>
<td>
72456.0
</td>
<td>
2.223127e+08
</td>
<td>
-1
</td>
</tr>
<tr>
<th>
000005
</th>
<td>
2.68
</td>
<td>
2.70
</td>
<td>
2.65
</td>
<td>
2.69
</td>
<td>
64372.0
</td>
<td>
1.725762e+07
</td>
<td>
1
</td>
</tr>
<tr>
<th>
000006
</th>
<td>
5.66
</td>
<td>
5.74
</td>
<td>
5.62
</td>
<td>
5.72
</td>
<td>
98253.0
</td>
<td>
5.592563e+07
</td>
<td>
1
</td>
</tr>
<tr>
<th>
000007
</th>
<td>
9.42
</td>
<td>
9.42
</td>
<td>
9.18
</td>
<td>
9.20
</td>
<td>
22567.0
</td>
<td>
2.094628e+07
</td>
<td>
-1
</td>
</tr>
<tr>
<th>
000008
</th>
<td>
2.72
</td>
<td>
2.74
</td>
<td>
2.70
</td>
<td>
2.73
</td>
<td>
171930.0
</td>
<td>
4.678304e+07
</td>
<td>
1
</td>
</tr>
<tr>
<th>
000009
</th>
<td>
7.71
</td>
<td>
7.88
</td>
<td>
7.66
</td>
<td>
7.82
</td>
<td>
320180.0
</td>
<td>
2.492149e+08
</td>
<td>
1
</td>
</tr>
<tr>
<th>
000010
</th>
<td>
4.19
</td>
<td>
4.27
</td>
<td>
4.10
</td>
<td>
4.24
</td>
<td>
71661.0
</td>
<td>
3.004320e+07
</td>
<td>
1
</td>
</tr>
<tr>
<th>
000011
</th>
<td>
13.76
</td>
<td>
14.40
</td>
<td>
13.58
</td>
<td>
14.39
</td>
<td>
105639.0
</td>
<td>
1.489735e+08
</td>
<td>
1
</td>
</tr>
</tbody>
</table>
</div>
<h2 id="结论">结论</h2>
<p><code>for</code>循环及向量化的使用对性能有着较大的影响：<br />
1、如果确定需要使用循环，则应始终选择apply方法。<br />
2、否则，vectorization总是更好的，因为它更快！</p>
]]></content>
      <categories>
        <category>技术笔记</category>
        <category>博客</category>
      </categories>
      <tags>
        <tag>python</tag>
        <tag>pandas</tag>
      </tags>
  </entry>
  <entry>
    <title>线性代数在量化投资分析中的应用</title>
    <url>/2020/12/17/%E7%BA%BF%E6%80%A7%E4%BB%A3%E6%95%B0%E5%9C%A8%E9%87%8F%E5%8C%96%E6%8A%95%E8%B5%84%E5%88%86%E6%9E%90%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8/</url>
    <content><![CDATA[<h1 id="基本概念">基本概念</h1>
<h2 id="标量向量矩阵和张量">标量、向量、矩阵和张量</h2>
<p><img src="https://s2.loli.net/2022/04/14/KAo4Ji1u7qktjnm.png" style="zoom:25%;float:left" /></p>
<p><br/> <br/></p>
<p>• <code>标量（scalar）</code>：一个标量就是一个单独的数，它不同于线性代数中研究的其他大部分对象（通常是多个数的数组）。<br />
• <code>向量（vector）</code>：一个向量是一列数。这些数是有序排列的。<br />
• <code>矩阵（matrix）</code>：矩阵是一个二维数组，其中的每一个元素被两个索引（而非一个）所确定。<br />
• <code>张量（tensor）</code>：在某些情况下，我们会讨论坐标超过两维的数组。一般地，一个数组中的元素分布在若干维坐标的规则网格中，我们称之为张量。</p>
<a id="more"></a>
<h2 id="转置">转置</h2>
<p><code>转置（transpose）</code>是矩阵的重要操作之一。矩阵的转置是以对角线为轴的镜像，这条从左上角到右下角的对角线被称为 主对角线（main diagonal）。</p>
<p>向量可以看作只有一列的矩阵。对应地，向量的转置可以看作是只有一行的矩阵。<br />
<img src="https://s2.loli.net/2022/04/14/iUMGpmav9JezSfc.png" align=left style="zoom:35%" ><br />
<br/> <br/> 方阵的转置<br />
<img src="https://s2.loli.net/2022/04/14/vSE8k3dbUfD1QRV.png" style="zoom:25%;float:left"/> <br/> <br/> 非方阵的转置<br />
<img src="https://s2.loli.net/2022/04/14/3stURNkzihx56dn.png" style="zoom:25%;float:left"/><br />
<br/> <br/> <br/> 上标 <span class="math inline">\(^\text{T}\)</span>用来表述转置矩阵</p>
<p><span class="math inline">\({A}= \begin{bmatrix} A_{1,1} &amp; A_{1,2} \\ A_{2,1} &amp; A_{2,2} \\ A_{3,1} &amp; A_{3,2} \end{bmatrix}\)</span> 的转置矩阵为：</p>
<p><span class="math inline">\({A}^{\text{T}}= \begin{bmatrix} A_{1,1} &amp; A_{2,1} &amp; A_{3,1} \\ A_{1,2} &amp; A_{2,2} &amp; A_{3,2} \end{bmatrix}\)</span><br />
<br/> <img src="https://s2.loli.net/2022/04/14/bHZtks2YRfeNn9X.png" style="zoom:25%;float:left"/> <br/> 矩阵的形状 (<span class="math inline">\(m \times n\)</span>) 在转置后变为 (<span class="math inline">\(n \times m\)</span>).</p>
<p><br/></p>
<h2 id="线性方程组">线性方程组</h2>
<p>对于一个线性方程组</p>
<p><span class="math inline">\(\large \begin{equation} \left\{ \begin{aligned} x_1+x_2=2\\ x_1-x_2=4\\ \end{aligned} \right. \end{equation}\)</span></p>
<p>这里有两个方程和两个变量，一般可以得到唯一解或无穷多解。利用线性代数可以对其进行简洁地表示和运算。线性代数的运算离不开矩阵，矩阵是按照长方阵列排列的实数或复数集合。例如存在矩阵</p>
<p><span class="math inline">\(\large  A=\left[  \begin{matrix}  1 &amp; 1 \\  1 &amp; -1 \\  \end{matrix}  \right], X=\left[  \begin{matrix}  x_1 \\  x_2 \\  \end{matrix}  \right], b=\left[  \begin{matrix}  2 \\  4 \\  \end{matrix}  \right]\)</span></p>
<p>这样，上述线性方程组可记为<span class="math inline">\(AX=b\)</span>.</p>
<p>即： <span class="math inline">\(\large \left[  \begin{matrix}  1 &amp; 1 \\  1 &amp; -1 \\  \end{matrix}  \right]\left[  \begin{matrix}  x_1 \\  x_2 \\  \end{matrix}  \right]=\left[  \begin{matrix}  2 \\  4 \\  \end{matrix}  \right]\)</span></p>
<p>假想<br />
<span class="math inline">\(\large \frac{1}{\left[  \begin{matrix}  1 &amp; 1 \\  1 &amp; -1 \\  \end{matrix}  \right]}\left[  \begin{matrix}  1 &amp; 1 \\  1 &amp; -1 \\  \end{matrix}  \right]\left[  \begin{matrix}  x_1 \\  x_2 \\  \end{matrix}  \right]=\frac{1}{\left[  \begin{matrix}  1 &amp; 1 \\  1 &amp; -1 \\  \end{matrix}  \right]}\left[  \begin{matrix}  2 \\  4 \\  \end{matrix}  \right]\)</span></p>
<p>得： <span class="math inline">\(\large \left[  \begin{matrix}  x_1 \\  x_2 \\  \end{matrix}  \right]=\frac{1}{\left[  \begin{matrix}  1 &amp; 1 \\  1 &amp; -1 \\  \end{matrix}  \right]}\left[  \begin{matrix}  2 \\  4 \\  \end{matrix}  \right]\)</span></p>
<h2 id="示例">示例</h2>
<p>在Python中，使用numpy库可以方便的进行矩阵操作。</p>
<h3 id="使用numpy来创建向量vector">使用numpy来创建向量(vector)</h3>
<p><span class="math inline">\({x} =\begin{bmatrix} x_1 \\ x_2 \\ \cdots \\ x_n \end{bmatrix}\)</span></p>
<h4 id="创建指定长度及数值的向量">创建指定长度及数值的向量</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line">x = np.array([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>])</span><br><span class="line">x</span><br></pre></td></tr></table></figure>
<pre><code>array([1, 2, 3, 4])</code></pre>
<h4 id="创建指定长度及随机数值的向量">创建指定长度及随机数值的向量</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">x = np.random.randint(<span class="number">1</span>,<span class="number">10</span>,size=<span class="number">10</span>)</span><br><span class="line">x</span><br></pre></td></tr></table></figure>
<pre><code>array([8, 2, 2, 6, 5, 7, 5, 4, 4, 4])</code></pre>
<h3 id="使用numpy来创建矩阵matrix">使用numpy来创建矩阵(matrix)</h3>
<p><span class="math inline">\({A}= \begin{bmatrix} A_{1,1} &amp; A_{1,2} &amp; \cdots &amp; A_{1,n} \\ A_{2,1} &amp; A_{2,2} &amp; \cdots &amp; A_{2,n} \\ \cdots &amp; \cdots &amp; \cdots &amp; \cdots \\ A_{m,1} &amp; A_{m,2} &amp; \cdots &amp; A_{m,n} \end{bmatrix}\)</span></p>
<h4 id="创建指定长度及数值的矩阵">创建指定长度及数值的矩阵</h4>
<p>例如：<span class="math inline">\(3 \times 2\)</span> 的矩阵</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">A = np.array([[<span class="number">1</span>, <span class="number">2</span>], [<span class="number">3</span>, <span class="number">4</span>], [<span class="number">5</span>, <span class="number">6</span>]])</span><br><span class="line">A</span><br></pre></td></tr></table></figure>
<pre><code>array([[1, 2],
       [3, 4],
       [5, 6]])</code></pre>
<h4 id="创建指定长度及随机数值的矩阵">创建指定长度及随机数值的矩阵</h4>
<p>例如：<span class="math inline">\(3 \times 2\)</span> 的矩阵</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">A = np.random.randint(<span class="number">1</span>,<span class="number">10</span>,size=(<span class="number">3</span>,<span class="number">2</span>))</span><br><span class="line">A</span><br></pre></td></tr></table></figure>
<pre><code>array([[6, 5],
       [7, 5],
       [7, 6]])</code></pre>
<h3 id="利用numpy来进行矩阵转置">利用numpy来进行矩阵转置</h3>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">A = np.array([[<span class="number">1</span>, <span class="number">2</span>], [<span class="number">3</span>, <span class="number">4</span>], [<span class="number">5</span>, <span class="number">6</span>]])</span><br><span class="line">A</span><br></pre></td></tr></table></figure>
<pre><code>array([[1, 2],
       [3, 4],
       [5, 6]])</code></pre>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">A_t = A.T</span><br><span class="line">A_t</span><br></pre></td></tr></table></figure>
<pre><code>array([[1, 3, 5],
       [2, 4, 6]])</code></pre>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">print(A.shape)</span><br><span class="line">print(A_t.shape)</span><br></pre></td></tr></table></figure>
<pre><code>(3, 2)
(2, 3)</code></pre>
<h3 id="求解线性方程组">求解线性方程组</h3>
<p>求二元一次线性方程组</p>
<p><span class="math inline">\(\large \begin{equation} \left\{ \begin{aligned} x_1+x_2=2\\ x_1-x_2=4\\ \end{aligned} \right. \end{equation}\)</span></p>
<p>的解。</p>
<p><strong>分析</strong>：如章节1.3中所述。<br />
<span class="math inline">\(\large  A=\left[  \begin{matrix}  1 &amp; 1 \\  1 &amp; -1 \\  \end{matrix}  \right], X=\left[  \begin{matrix}  x_1 \\  x_2 \\  \end{matrix}  \right], b=\left[  \begin{matrix}  2 \\  4 \\  \end{matrix}  \right].\)</span></p>
<p>这样，上述线性方程组可记为<span class="math inline">\(AX=b\)</span>.<br />
则：<span class="math inline">\(X=\large\frac{1}{A}b\)</span></p>
<p>即：<span class="math inline">\(\large \left[  \begin{matrix}  x_1 \\  x_2 \\  \end{matrix}  \right]=\frac{1}{\left[  \begin{matrix}  1 &amp; 1 \\  1 &amp; -1 \\  \end{matrix}  \right]}\left[  \begin{matrix}  2 \\  4 \\  \end{matrix}  \right]\)</span></p>
<p>说明：<br />
<span class="math inline">\({A}\)</span>的逆矩阵表述为<span class="math inline">\({A}^{-1}\)</span>. 逆矩阵满足如一条件。</p>
<p><span class="math inline">\({A}^{-1}{A}={I}_n\)</span></p>
<p>NumPy 提供了线性代数函数库 <strong>linalg</strong>，该库包含了线性代数所需的所有功能，可以看看下面的说明：</p>
<table>
<thead>
<tr class="header">
<th style="text-align: left;">函数</th>
<th style="text-align: left;">描述</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>dot</code></td>
<td style="text-align: left;">两个数组的点积，即元素对应相乘。</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>vdot</code></td>
<td style="text-align: left;">两个向量的点积</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>inner</code></td>
<td style="text-align: left;">两个数组的内积</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>matmul</code></td>
<td style="text-align: left;">两个数组的矩阵积</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>determinant</code></td>
<td style="text-align: left;">数组的行列式</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>solve</code></td>
<td style="text-align: left;">求解线性矩阵方程</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>inv</code></td>
<td style="text-align: left;">计算矩阵的乘法逆矩阵</td>
</tr>
</tbody>
</table>
<p>计算过程如下：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建矩阵A, 这里用了两种方法，实际中A1 =A2</span></span><br><span class="line">A1 = np.mat(<span class="string">&#x27;1 1;1 -1&#x27;</span>)</span><br><span class="line">A2 = np.array([[<span class="number">1</span>, <span class="number">1</span>], [<span class="number">1</span>,-<span class="number">1</span>]])</span><br><span class="line">b = np.array([<span class="number">2</span>,<span class="number">4</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment">#用solve函数求解线性方程</span></span><br><span class="line">X1 = np.linalg.solve(A1,b)</span><br><span class="line">X2 = np.linalg.solve(A2,b)</span><br><span class="line">print(X1)</span><br><span class="line">print(X2)</span><br></pre></td></tr></table></figure>
<pre><code>[ 3. -1.]
[ 3. -1.]</code></pre>
<p>此外，也可利用先求A的逆矩阵，然后和b进行点积求解。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">A = np.array([[<span class="number">1</span>, <span class="number">1</span>], [<span class="number">1</span>,-<span class="number">1</span>]])</span><br><span class="line">b = np.array([<span class="number">2</span>,<span class="number">4</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment">#使用点积的两种方式</span></span><br><span class="line">X1 = (np.linalg.inv(A)).dot(b)</span><br><span class="line">X2 = np.dot(np.linalg.inv(A),b)</span><br><span class="line">print(X1)</span><br><span class="line">print(X2)</span><br></pre></td></tr></table></figure>
<pre><code>[ 3. -1.]
[ 3. -1.]</code></pre>
<h1 id="线性回归模型简介">线性回归模型简介</h1>
<p>假设被解释变量<span class="math inline">\(y\)</span>与多个解释变量<span class="math inline">\(X_1,X_2,...,X_p\)</span>之间具有线性关系，则记为</p>
<p><span class="math inline">\(\large y=\beta_0+\beta_1X_1+\beta_2X_2+...+\beta_pX_p+\mu\)</span></p>
<p>称之为多元线性回归模型，其中<span class="math inline">\(\beta_0,\beta_1,...,\beta_p\)</span>为<span class="math inline">\(p+1\)</span>个未知参数，<span class="math inline">\(\mu\)</span>为随机扰动项，表示除<span class="math inline">\(X_1,X_2,...,X_p\)</span>以外影响<span class="math inline">\(y\)</span>的所有非观测因素，并假设<span class="math inline">\(\mu\sim N(0,\sigma^2)\)</span>。</p>
<p>假设有<span class="math inline">\(n\)</span>组观测数据<span class="math inline">\(y_i,X_{1i},X_{2i},...,X_{pi},i=1,2,...,n\)</span>，则存在线性方程组</p>
<p><span class="math inline">\(\large \begin{equation} \left\{ \begin{aligned} y_1=\beta_0+\beta_1X_{11}+\beta_2X_{21}+...+\beta_pX_{p1}+\mu_1\\ y_2=\beta_0+\beta_1X_{12}+\beta_2X_{22}+...+\beta_pX_{p2}+\mu_2\\ \vdots\\ y_n=\beta_0+\beta_1X_{1n}+\beta_2X_{2n}+...+\beta_pX_{pn}+\mu_n\\ \end{aligned} \right. \end{equation}\)</span></p>
<p>若记</p>
<p><span class="math inline">\(Y=(y_1,y_2,...,y_n)^\tau， X=\left[  \begin{matrix}  1&amp;X_{11} &amp; X_{21}&amp;...&amp;X_{p1} \\  1&amp;X_{12} &amp; X_{22}&amp;...&amp;X_{p2} \\  \vdots &amp; \vdots&amp;\ddots\\  1&amp;X_{1n} &amp; X_{2n}&amp;...&amp;X_{pn} \\  \end{matrix}  \right]，\beta=(\beta_1,\beta_2,...,\beta_n)^\tau，\mu=(\mu_1,\mu_2,...,\mu_n)^\tau\)</span> 则线性方程组可表示为</p>
<p><span class="math inline">\(\large Y=X\beta+\mu\)</span></p>
<p>通过参数估计方法，可以得到未知参数<span class="math inline">\(\beta\)</span>的估计值。参见<a href="https://zhuanlan.zhihu.com/p/91095053">计量经济学：多元线性回归的最小二乘估计</a></p>
<p><span class="math inline">\(\large \hat{\beta}=(X^\tau X)^{-1}X^\tau Y\)</span></p>
<h1 id="线性回归模型求解模拟">线性回归模型求解模拟</h1>
<p><code>statsmodels</code>是Python中一个强大的统计分析包，包含了回归分析、时间序列分析、假设检验等等的功能，当需要在Python中进行回归分析时，就可以导入statsmodels。</p>
<p><code>statsmodels.regression.linear_model</code>里有回归函数<code>statsmodels.OLS</code>，它的输入参数有<code>(endog, exog, missing, hasconst)</code>。一般只考虑前两个输入，其中，<code>endog</code>是回归中的因变量<span class="math inline">\(Y\)</span>，是一个<span class="math inline">\(n\)</span>维的向量；<code>exog</code>是回归中的自变量<span class="math inline">\(X_1,X_2,...,X_P\)</span>，由于statsmodels.OLS不会假设回归模型有常数项，所以我们应该假设模型是</p>
<p><span class="math inline">\(\large y_t=\beta_0X_{0t}+\beta_1X_{1t}+\beta_2X_{2t}+...+\beta_pX_{pt}+\mu,t=1,2,...,n\)</span></p>
<p>其中，对所有<span class="math inline">\(t=1,2,...,n\)</span>，令<span class="math inline">\(X_{0t}=1\)</span>。因此，exog的输入是一个<span class="math inline">\(n\times (p+1)\)</span>的向量。</p>
<p>statsmodels.OLS的输出结果是statsmodels.regression.linear_model.OLS类，并没有进行任何运算。在OLS的模型之上调用拟合函数 fit()，才进行回归运算，并且得到statsmodels.regression.linear_model.RegressionResultsWrapper，它包含了这组数据进行回归拟合的结果摘要。调用params可以查看计算出的回归系数<span class="math inline">\(\beta_0,\beta_1,...,\beta_p\)</span>。 下面将分连续变量和离散变量两种情况来模拟求解线性回归模型。</p>
<h1 id="参考">参考</h1>
<ol type="1">
<li><a href="https://hadrienj.github.io/posts/Deep-Learning-Book-Series-Introduction/">Deep Learning Book Series · Introduction</a><br />
</li>
<li><a href="https://zhuanlan.zhihu.com/p/65259880">Numpy中矩阵计算模块linalg的常用函数</a></li>
</ol>
]]></content>
      <categories>
        <category>技术笔记</category>
        <category>量化投资</category>
      </categories>
      <tags>
        <tag>python</tag>
        <tag>线性代数</tag>
      </tags>
  </entry>
  <entry>
    <title>使用github/gitee来作为图床系统</title>
    <url>/2020/12/10/%E4%BD%BF%E7%94%A8github%E5%8F%8Agitee%E6%9D%A5%E4%BD%9C%E4%B8%BA%E5%9B%BE%E5%BA%8A%E7%B3%BB%E7%BB%9F/</url>
    <content><![CDATA[<p>日常进行博客及其它文章或笔记的写作时，经常需要在文章内容里插入图片。 当文档需要发布或存储到云服务器上时，就需要考虑将引用的图片放置到图床系统中。下面讲述下利用github或gitee来搭建图床系统的方法。</p>
<a id="more"></a>
<h2 id="一利用github来建立图床">一、利用github来建立图床</h2>
<h3 id="建立github图床仓库">建立Github图床仓库</h3>
<p><img src="https://s2.loli.net/2022/04/14/E62Lyc3w4xi9DFS.png" /> ### 设置Token</p>
<p>进入全局设置，点击<code>Developer Settings</code> -&gt; <code>Personal access tokens</code>，选择<code>Generate new token</code></p>
<p><img src="https://s2.loli.net/2022/04/14/cY3nCtzwTqhXiGE.png" /> ### 设置PicGO客户端</p>
<h4 id="下载">下载</h4>
<p><a href="https://github.com/Molunerfinn/PicGo/releases">PicGo的可执行文件下载地址</a></p>
<h4 id="设置">设置</h4>
<p><img src="https://s2.loli.net/2022/04/14/iElfYChU8GNwLXH.png" /> - 仓库名：按照“账户名/仓库名”的格式填写； - 分支名：统一填写为<code>main</code>； - Tocken：将之前的Github的Token黏贴在这里； - 存储路径：若设置为img/，则会在repository下创建一个“img”文件夹； - 自定义域名：在上传图片后成功后，PicGo会将“自定义域名+上传的图片名”生成的访问链接，放到剪切板。这里约定遵循如下的格式：<code>域名/用户名/仓库名/分支名。</code></p>
<h4 id="上传图片">上传图片</h4>
<p>在picgo上传区，可以直接上传剪贴板上的图片或保存成文件上传。这里不再说明。</p>
<hr />
<p>因为github显示图片相当不稳定。 所以可以使用gitee来替代它作为图床的托管仓库。</p>
<h2 id="二利用gitee来建立图床">二、利用gitee来建立图床</h2>
<h3 id="在gitee中创建仓库">在gitee中创建仓库</h3>
<p>按照常规创建仓库的方式创建一个专门用于图床的仓库</p>
<p><img src="https://s2.loli.net/2022/04/14/pvFt8EJju23MgfQ.png" /> ### 获取token</p>
<p><img src="https://s2.loli.net/2022/04/14/qYVEzvkCI52tjWi.png" /> ### 在PicGO中安装gitee插件</p>
<h4 id="安装">安装</h4>
<p><img src="https://s2.loli.net/2022/04/14/lKsvgEtIMRVG2nS.png" /> #### 配置插件</p>
<p><img src="https://s2.loli.net/2022/04/14/e4CiMmgEPFR2caf.png" /> 这里需要注意的是repo的名字中大小写字母需要完全一致且是repo仓库路径。否则会报404错误。</p>
<h4 id="上传图片-1">上传图片</h4>
<p>至此，图床系统搭建完成，可以愉快地写作了。</p>
]]></content>
      <categories>
        <category>技术笔记</category>
        <category>美好生活</category>
        <category>博客</category>
      </categories>
      <tags>
        <tag>github</tag>
        <tag>gitee</tag>
        <tag>picgo</tag>
      </tags>
  </entry>
  <entry>
    <title>【Sunflower】Dash应用程序实践（二）</title>
    <url>/2024/11/11/%E3%80%90Sunflower%E3%80%91Dash%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E5%AE%9E%E8%B7%B5%EF%BC%88%E4%BA%8C%EF%BC%89/</url>
    <content><![CDATA[<p>现在开始逐步构建页面布局中的元素。先从 Header 开始</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Generate Header</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_header</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    :return: A Header</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    header = dbc.Row(</span><br><span class="line">                [</span><br><span class="line">                    dbc.Col(html.Img(<span class="built_in">id</span>=<span class="string">&quot;plotly-image&quot;</span>, src=app.get_asset_url(<span class="string">&quot;sunflower_logo.png&quot;</span>),style=&#123;<span class="string">&quot;height&quot;</span>: <span class="string">&quot;2rem&quot;</span>&#125;), width=<span class="string">&quot;auto&quot;</span>),</span><br><span class="line">                    dbc.Col(html.H5(<span class="string">&quot;回测分析(Back Test analysis)&quot;</span>, <span class="built_in">id</span>=<span class="string">&quot;header-title&quot;</span>)),</span><br><span class="line">                ],</span><br><span class="line">                <span class="built_in">id</span>=<span class="string">&quot;header&quot;</span>,</span><br><span class="line">            )</span><br><span class="line">    <span class="keyword">return</span> header</span><br></pre></td></tr></table></figure>
<p><strong>代码详解：</strong></p>
<p>该代码定义了一个 <code>generate_header</code> 函数，用于生成一个 <code>Dash Bootstrap</code> 网页的顶部标题栏 (<code>Header</code>)。此 <code>Header</code> 包含了一个图标和标题，并且它们按行布局排列。</p>
<ul>
<li><p><strong>函数定义</strong>: <code>generate_header()</code></p>
<ul>
<li>定义了一个返回 <code>Header</code> 的函数，不接受任何参数。</li>
</ul></li>
<li><p><strong>创建 <code>Header</code> 内容</strong>:</p>
<ul>
<li><p><code>header = dbc.Row([...])</code>:</p>
<ul>
<li>创建了一个 <code>Row</code> 容器，使用 <code>dash-bootstrap-components</code> (简称 <code>dbc</code>) 中的 <code>Row</code> 组件，用于行布局。</li>
</ul></li>
<li><p><strong>第一列 (<code>dbc.Col</code>)</strong>:</p>
<ul>
<li><code>dbc.Col(html.Img(...), width="auto")</code>:
<ul>
<li>这一列包含了一个图像元素 <code>Img</code>，图像的 <code>src</code> 路径由 <code>app.get_asset_url("sunflower_logo.png")</code> 指定，显示了名为 <code>sunflower_logo.png</code> 的图像文件。</li>
<li><code>width="auto"</code>：让这一列宽度根据图像大小自适应。</li>
<li><code>style=&#123;"height": "2rem"&#125;</code>：设置图像的高度为 2rem。</li>
</ul></li>
</ul></li>
<li><p><strong>第二列 (<code>dbc.Col</code>)</strong>:</p>
<ul>
<li><code>dbc.Col(html.H5(...))</code>:
<ul>
<li>包含一个 <code>H5</code> 标题元素，显示文本为 “回测分析(Back Test analysis)”，ID 为 <code>"header-title"</code>。</li>
</ul></li>
</ul></li>
</ul></li>
<li><p><strong>Row 样式</strong>：</p>
<ul>
<li><code>id="header"</code>：给 <code>Row</code> 容器赋予 <code>id</code> 值 <code>header</code>，方便之后在样式或回调函数中引用。</li>
</ul></li>
</ul>
<h3 id="备注">备注</h3>
<ul>
<li><strong>行列布局</strong>：图像和标题文本在同一行中依次排列。</li>
</ul>
<p>相关的 css 样式如下：</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-id">#header</span> &#123;</span><br><span class="line">    <span class="attribute">background-color</span>: <span class="number">#ffffff</span>;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">flex-direction</span>: row;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">4rem</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#header-title</span> &#123;</span><br><span class="line">    <span class="attribute">font-family</span>: Acumin;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">1.5rem</span>;</span><br><span class="line">    <span class="attribute">font-weight</span>: bold;</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#5cb3cc</span>;</span><br><span class="line">    <span class="attribute">margin-left</span>: <span class="number">1rem</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>代码解释：</strong></p>
<p><strong><code>#header</code></strong>: 选择器为 <code>id</code> 为 <code>header</code> 的元素应用样式。</p>
<ul>
<li><strong><code>background-color: #ffffff;</code></strong>：设置背景颜色为白色。</li>
<li><strong><code>display: flex;</code></strong>：将 <code>#header</code> 设为 <code>flex</code> 容器，以便其子元素按弹性布局排列。</li>
<li><strong><code>flex-direction: row;</code></strong>：设置主轴为水平方向，使子元素按行排列。</li>
<li><strong><code>align-items: center;</code></strong>：沿着交叉轴（垂直方向）居中对齐 <code>#header</code> 中的子元素。</li>
<li><strong><code>height: 4rem;</code></strong>：设置 <code>#header</code> 的高度为 <code>4rem</code>，保证其在页面中占据适当的垂直空间。</li>
</ul>
<p><strong><code>#header-title</code></strong>：选择器为 <code>id</code> 为 <code>header-title</code> 的元素应用样式。</p>
<ul>
<li><strong><code>font-family: Acumin;</code></strong>：设置字体为 <code>Acumin</code>。</li>
<li><strong><code>font-size: 1.5rem;</code></strong>：字体大小为 <code>1.5rem</code>，相对较大。</li>
<li><strong><code>font-weight: bold;</code></strong>：设置字体粗细为 <code>bold</code>，使文字加粗。</li>
<li><strong><code>color: #5cb3cc;</code></strong>：字体颜色为蓝绿色（<code>#5cb3cc</code>）。</li>
<li><strong><code>margin-left: 1rem;</code></strong>：设置左外边距为 <code>1rem</code>，使其与前面的元素保持适当间距。</li>
</ul>
<p>Logo 的设计可以用 <a href="https://www.logodesign.net/">logodesign</a> 完成。</p>
<p>最终效果如图：</p>
<p><img src="https://s2.loli.net/2024/11/11/2ghF8skwX7onDYy.png" /></p>
]]></content>
      <categories>
        <category>量化交易</category>
      </categories>
      <tags>
        <tag>python</tag>
        <tag>dash</tag>
        <tag>plotly</tag>
      </tags>
  </entry>
  <entry>
    <title>【Sunflower】Dash应用程序实践（三）</title>
    <url>/2024/11/12/%E3%80%90Sunflower%E3%80%91Dash%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E5%AE%9E%E8%B7%B5%EF%BC%88%E4%B8%89%EF%BC%89/</url>
    <content><![CDATA[<h2 id="分栏左侧控制卡">分栏左侧控制卡</h2>
<p>下面是分栏左侧的控制卡部分，主要作用是选取回测组合测试，先选择回测账户，然后选择回测策略。然后从数据库中提取数据。用两个下拉框控件及一个按钮控件实现。</p>
<p>首先，我们需要创建 <code>dcc.Store</code> 来存储获取到的数据。在 App 的 layout 中增加以下代码。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">pp.layout = dbc.Container(    </span><br><span class="line">    [   </span><br><span class="line">        dcc.Location(<span class="built_in">id</span>=<span class="string">&quot;url-refresh&quot;</span>, refresh=<span class="literal">True</span>),</span><br><span class="line">        <span class="comment"># Header</span></span><br><span class="line">        dbc.Container(</span><br><span class="line">            [</span><br><span class="line">                generate_header()</span><br><span class="line">            ],</span><br><span class="line">            <span class="built_in">id</span>=<span class="string">&quot;header-container&quot;</span>,</span><br><span class="line">            fluid=<span class="literal">True</span>,            </span><br><span class="line">        ),</span><br><span class="line">        dbc.Row(</span><br><span class="line">            [</span><br><span class="line">                dbc.Col(<span class="built_in">id</span>=<span class="string">&quot;left-column&quot;</span>, children=generate_control_card(), md=<span class="number">2</span>),</span><br><span class="line">                dbc.Col(<span class="built_in">id</span>=<span class="string">&quot;right-column&quot;</span>, children=generate_display_tabs(), md=<span class="number">10</span>),</span><br><span class="line">            ]</span><br><span class="line"></span><br><span class="line">        ),</span><br><span class="line">        <span class="comment"># 增加以下四行内容</span></span><br><span class="line">        dcc.Store(<span class="built_in">id</span>=<span class="string">&quot;account-trade-history&quot;</span>),</span><br><span class="line">        dcc.Store(<span class="built_in">id</span>=<span class="string">&quot;stock-day&quot;</span>),   </span><br><span class="line">        dcc.Store(<span class="built_in">id</span>=<span class="string">&quot;benchmark-day&quot;</span>),     </span><br><span class="line">        dcc.Store(<span class="built_in">id</span>=<span class="string">&#x27;asset&#x27;</span>)</span><br><span class="line">        </span><br><span class="line">               </span><br><span class="line">    ],</span><br><span class="line">    <span class="built_in">id</span>=<span class="string">&quot;app-container&quot;</span>,</span><br><span class="line">    fluid=<span class="literal">True</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p><strong>代码详解：</strong> 1. <strong><code>dcc.Store(id="account-trade-history")</code></strong></p>
<pre><code>- 这是一个存储组件，`id=&quot;account-trade-history&quot;` 可以唯一标识这个存储单元。
- 用于存储与“回测账户交易历史”相关的数据，方便在多个回调函数间访问该数据而无需重新加载或处理。</code></pre>
<ol start="2" type="1">
<li><p><strong><code>dcc.Store(id="stock-day")</code></strong></p>
<ul>
<li>用于存储“每日股票日线数据”。</li>
<li>这可以是一个 DataFrame 格式的数据表，包含每日股票的 OHLC 等信息。</li>
</ul></li>
<li><p><strong><code>dcc.Store(id="benchmark-day")</code></strong></p>
<ul>
<li>存储“基准日”数据，可能包含基准指数（如沪深300、上证 50、科创 50、中证 500）的日线数据，用于与投资组合的表现做对比。</li>
</ul></li>
<li><p><strong><code>dcc.Store(id="asset")</code></strong></p>
<ul>
<li>存储资产信息，包括投资组合中的当前资产信息。</li>
</ul></li>
</ol>
<p>然后创建两个下拉框及一个按钮控制数据的读取。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_control_card</span>():</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">:return: A Card containing controls(dropdown, button) in left column</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">card = dbc.Card(</span><br><span class="line">    [</span><br><span class="line">        </span><br><span class="line">        html.Div(</span><br><span class="line">            [</span><br><span class="line">                dbc.Label(<span class="string">&quot;回测账户&quot;</span>),</span><br><span class="line">                dcc.Dropdown(</span><br><span class="line">                    <span class="built_in">id</span>=<span class="string">&quot;account-select&quot;</span>,</span><br><span class="line">                    options=fetch_account_list(),</span><br><span class="line">                    placeholder=<span class="string">&quot;Select Account&quot;</span>,</span><br><span class="line">                ),</span><br><span class="line">            ]</span><br><span class="line">        ),</span><br><span class="line">        html.Div(</span><br><span class="line">            [</span><br><span class="line">                dbc.Label(<span class="string">&quot;回测组合策略&quot;</span>),</span><br><span class="line">                dcc.Dropdown(</span><br><span class="line">                    <span class="built_in">id</span>=<span class="string">&quot;portfolio-select&quot;</span>,</span><br><span class="line">                    options=[],</span><br><span class="line">                    placeholder=<span class="string">&quot;Select Portfolio&quot;</span>,</span><br><span class="line">                ),</span><br><span class="line">            ]</span><br><span class="line">        ),</span><br><span class="line">        html.Br(),</span><br><span class="line">        html.Div(</span><br><span class="line">            <span class="built_in">id</span>=<span class="string">&quot;submit-btn-control-card&quot;</span>,</span><br><span class="line">            children=dbc.Button(<span class="string">&quot;确认&quot;</span>, <span class="built_in">id</span>=<span class="string">&quot;submit-btn&quot;</span>, n_clicks=<span class="number">0</span>, className=<span class="string">&quot;mb-3&quot;</span>, disabled=<span class="literal">True</span>),</span><br><span class="line">        ),</span><br><span class="line">    ],</span><br><span class="line">    <span class="built_in">id</span>=<span class="string">&quot;control-card&quot;</span>,</span><br><span class="line">    body=<span class="literal">True</span>,</span><br><span class="line">    style=&#123;<span class="string">&quot;margin-top&quot;</span>: <span class="string">&quot;45px&quot;</span>, <span class="string">&quot;margin-left&quot;</span>: <span class="string">&quot;20px&quot;</span>, <span class="string">&quot;margin-right&quot;</span>: <span class="string">&quot;10px&quot;</span>&#125; </span><br><span class="line">    </span><br><span class="line">)</span><br><span class="line"><span class="keyword">return</span> card</span><br><span class="line"></span><br><span class="line"><span class="comment"># get portfolio list after account selection</span></span><br><span class="line"><span class="meta">@app.callback(<span class="params"></span></span></span><br><span class="line"><span class="meta"><span class="params">    Output(<span class="params"><span class="string">&#x27;portfolio-select&#x27;</span>, <span class="string">&#x27;options&#x27;</span></span>),    </span></span></span><br><span class="line"><span class="meta"><span class="params">    Input(<span class="params"><span class="string">&quot;account-select&quot;</span>, <span class="string">&quot;value&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params">    prevent_initial_call=<span class="literal">True</span></span></span></span><br><span class="line"><span class="meta"><span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update_dropdown_portfolio_select</span>(<span class="params">account</span>):</span>  </span><br><span class="line">    <span class="keyword">return</span> fetch_portfolio_list(account) </span><br><span class="line"></span><br><span class="line"><span class="comment"># disable submit button before both account and portfolio selected</span></span><br><span class="line"><span class="meta">@app.callback(<span class="params"></span></span></span><br><span class="line"><span class="meta"><span class="params">    Output(<span class="params"><span class="string">&#x27;submit-btn&#x27;</span>, <span class="string">&#x27;disabled&#x27;</span></span>),    </span></span></span><br><span class="line"><span class="meta"><span class="params">    Input(<span class="params"><span class="string">&quot;account-select&quot;</span>, <span class="string">&quot;value&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params">    Input(<span class="params"><span class="string">&quot;portfolio-select&quot;</span>, <span class="string">&quot;value&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params">    prevent_initial_call=<span class="literal">True</span></span></span></span><br><span class="line"><span class="meta"><span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update_btn_availibility</span>(<span class="params">account, portfolio</span>):</span>  </span><br><span class="line">    <span class="keyword">if</span> account <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> portfolio <span class="keyword">is</span> <span class="literal">None</span>: </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># get account trade history, stock daily data and benchmark daily data and put them into localstore</span></span><br><span class="line"><span class="meta">@app.callback(<span class="params"></span></span></span><br><span class="line"><span class="meta"><span class="params">    Output(<span class="params"><span class="string">&quot;account-trade-history&quot;</span>, <span class="string">&quot;data&quot;</span></span>),    </span></span></span><br><span class="line"><span class="meta"><span class="params">    Output(<span class="params"><span class="string">&quot;stock-day&quot;</span>, <span class="string">&quot;data&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params">    Output(<span class="params"><span class="string">&quot;benchmark-day&quot;</span>, <span class="string">&quot;data&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params">    Output(<span class="params"><span class="string">&quot;asset&quot;</span>, <span class="string">&quot;data&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params">    State(<span class="params"><span class="string">&quot;account-select&quot;</span>, <span class="string">&quot;value&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params">    State(<span class="params"><span class="string">&quot;portfolio-select&quot;</span>, <span class="string">&quot;value&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params">    Input(<span class="params"><span class="string">&quot;submit-btn&quot;</span>, <span class="string">&quot;n_clicks&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params">    prevent_initial_call=<span class="literal">True</span></span></span></span><br><span class="line"><span class="meta"><span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">output_localstore</span>(<span class="params">account, portfolio, submit_click</span>):</span>  </span><br><span class="line">    acc = Account(account_cookie=account, portfolio_cookie=portfolio)</span><br><span class="line">    df = acc.history_trade.reset_index()</span><br><span class="line">    df_tmp = df[[<span class="string">&#x27;date&#x27;</span>, <span class="string">&#x27;code&#x27;</span>, <span class="string">&#x27;price&#x27;</span>, <span class="string">&#x27;direction&#x27;</span>, <span class="string">&#x27;amount&#x27;</span>]].copy()</span><br><span class="line">    df_tmp[<span class="string">&#x27;交易方向&#x27;</span>] = np.where(df_tmp[<span class="string">&#x27;direction&#x27;</span>] == <span class="number">1</span>, <span class="string">&#x27;买入&#x27;</span>, <span class="string">&#x27;卖出&#x27;</span>)    </span><br><span class="line">    df_tmp[<span class="string">&#x27;成交价格&#x27;</span>] = df_tmp[<span class="string">&#x27;price&#x27;</span>].<span class="built_in">round</span>(<span class="number">2</span>)</span><br><span class="line">    df_tmp[<span class="string">&#x27;成交数量&#x27;</span>] = df_tmp[<span class="string">&#x27;amount&#x27;</span>].<span class="built_in">abs</span>()</span><br><span class="line">    df_tmp.drop([<span class="string">&#x27;direction&#x27;</span>, <span class="string">&#x27;amount&#x27;</span>, <span class="string">&#x27;price&#x27;</span>], axis=<span class="number">1</span>, inplace=<span class="literal">True</span>)</span><br><span class="line">    df_tmp = df_tmp.rename(columns=&#123;<span class="string">&#x27;date&#x27;</span>: <span class="string">&#x27;日期&#x27;</span>, <span class="string">&#x27;code&#x27;</span>: <span class="string">&#x27;股票代码&#x27;</span>&#125;)</span><br><span class="line">    account_trade_history = df_tmp.to_json(date_format=<span class="string">&#x27;iso&#x27;</span>, orient=<span class="string">&#x27;split&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">## stock daily data</span></span><br><span class="line">    df_tmp = acc.stock_day.reset_index().copy()</span><br><span class="line">    stock_day = df_tmp.to_json(date_format=<span class="string">&#x27;iso&#x27;</span>, orient=<span class="string">&#x27;split&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">## benchmark daily data(上证50(000016), 沪深300(000300)， 中证500(000905)， 科创50(000688))</span></span><br><span class="line">    df_tmp = fetch_index_day([<span class="string">&#x27;000016&#x27;</span>,<span class="string">&#x27;000300&#x27;</span>,<span class="string">&#x27;000905&#x27;</span>,<span class="string">&#x27;000688&#x27;</span>], acc.start_date, acc.end_date, dataset_type=<span class="string">&#x27;pandas&#x27;</span>)</span><br><span class="line">    benchmark_day = df_tmp.to_json(date_format=<span class="string">&#x27;iso&#x27;</span>, orient=<span class="string">&#x27;split&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">## backtest assets</span></span><br><span class="line">    asset = acc.assets.get(<span class="string">&#x27;asset&#x27;</span>).reset_index().to_json(date_format=<span class="string">&#x27;iso&#x27;</span>, orient=<span class="string">&#x27;split&#x27;</span>)</span><br><span class="line">    dataset = &#123;<span class="string">&#x27;init_cash&#x27;</span>:acc.init_cash, <span class="string">&#x27;asset&#x27;</span>:asset, &#125;</span><br><span class="line">    asset_dataset = json.dumps(dataset)    </span><br><span class="line">    <span class="keyword">return</span> account_trade_history, stock_day, benchmark_day, asset_dataset</span><br><span class="line"></span><br><span class="line"><span class="comment"># controls(dropdown) are disabled after submit button clicked, and button name is changed to &#x27;Return&#x27;</span></span><br><span class="line"><span class="meta">@app.callback(<span class="params"></span></span></span><br><span class="line"><span class="meta"><span class="params">    Output(<span class="params"><span class="string">&quot;submit-btn&quot;</span>, <span class="string">&quot;children&quot;</span></span>),   </span></span></span><br><span class="line"><span class="meta"><span class="params">    Output(<span class="params"><span class="string">&quot;account-select&quot;</span>, <span class="string">&quot;disabled&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params">    Output(<span class="params"><span class="string">&quot;portfolio-select&quot;</span>, <span class="string">&quot;disabled&quot;</span></span>), </span></span></span><br><span class="line"><span class="meta"><span class="params">    Input(<span class="params"><span class="string">&quot;submit-btn&quot;</span>, <span class="string">&quot;n_clicks&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params">    prevent_initial_call=<span class="literal">True</span></span></span></span><br><span class="line"><span class="meta"><span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">disable_control_card</span>(<span class="params">submit_click</span>):</span>  </span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;返回&quot;</span>, <span class="literal">True</span>, <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>以上代码定义了一个函数 <code>generate_control_card()</code>，用于创建并返回一个包含控制元素的卡片组件。这个卡片会在左侧列显示，包含两个下拉框（用于选择回测账户和回测组合策略）和一个确认按钮。下面是代码的逐步解释：</p>
<p><strong>代码详解：</strong></p>
<h3 id="函数定义和描述">1. 函数定义和描述</h3>
<ul>
<li><code>generate_control_card()</code>: 函数名，创建一个包含控制选项的卡片。</li>
<li><code>return</code>: 表示函数返回值，返回一个包含控件的卡片。</li>
</ul>
<h3 id="卡片结构">2. 卡片结构</h3>
<ul>
<li><code>dbc.Card()</code>: 创建一个卡片组件。
<ul>
<li><code>id="control-card"</code>：为卡片设置 ID <code>control-card</code>，便于其他代码引用。</li>
<li><code>body=True</code>: 设置卡片的样式，使其外观与 <code>Dash Bootstrap</code> 的卡片格式一致。</li>
<li><code>style</code>: 设置卡片的边距和顶部位置，使其在页面布局中稍微向右偏移。</li>
</ul></li>
</ul>
<h3 id="卡片内容">3. 卡片内容</h3>
<h4 id="下拉框---选择账户">3.1 下拉框 - 选择账户</h4>
<ul>
<li><code>html.Div()</code> 包裹第一个下拉框，用于选择回测账户。
<ul>
<li><code>dbc.Label("回测账户")</code>：一个标签 <code>回测账户</code>，放在下拉框上方，用于标识控件的功能。</li>
<li><code>dcc.Dropdown()</code>：创建一个下拉选择框。
<ul>
<li><code>id="account-select"</code>：为下拉框指定 ID，便于后续回调函数和 JavaScript 操作。</li>
<li><code>options=fetch_account_list()</code>：使用 <code>fetch_account_list()</code> 函数生成的账户列表作为下拉框的可选项。</li>
<li><code>placeholder="Select Account"</code>：下拉框的提示文字。</li>
</ul></li>
</ul></li>
</ul>
<h4 id="下拉框---选择组合策略">3.2 下拉框 - 选择组合策略</h4>
<ul>
<li>类似于账户选择框，生成一个新的下拉框用于选择回测组合策略。
<ul>
<li><code>id="portfolio-select"</code>：ID 为 <code>portfolio-select</code>。</li>
<li><code>options=[]</code>：初始时选项为空，可以在后续逻辑中更新。</li>
<li><code>placeholder="Select Portfolio"</code>：显示 <code>Select Portfolio</code> 作为提示文字。</li>
</ul></li>
</ul>
<h4 id="确认按钮">3.3 确认按钮</h4>
<ul>
<li><code>html.Div()</code> 包裹一个按钮。
<ul>
<li><code>dbc.Button("确认")</code>: 按钮显示文字为 <code>确认</code>。
<ul>
<li><code>id="submit-btn"</code>：按钮的 ID，便于控制和事件处理。</li>
<li><code>n_clicks=0</code>：按钮被点击次数，初始化为 <code>0</code>。</li>
<li><code>className="mb-3"</code>：按钮的底部留出 3 个单位的空白，避免与其他控件紧贴。</li>
<li><code>disabled=True</code>：按钮在初始状态下禁用，后续可能通过回调函数启用。</li>
</ul></li>
</ul></li>
</ul>
<h4 id="样式">3.4 样式</h4>
<ul>
<li><code>style=&#123;"margin-top": "45px", "margin-left": "20px", "margin-right": "10px"&#125;</code>：卡片的外边距，顶部 45 像素，左侧 20 像素，右侧 10 像素，保证卡片在布局中具有适当的空白边距。</li>
</ul>
<p>以下是对涉及到的回调函数的详细解释，它们分别用于更新组合选择列表、控制“确认”按钮的可用状态，以及在按下“确认”按钮后将账户交易数据、股票日数据和基准数据存入到客户端本地存储 (<code>dcc.Store</code>) 中。</p>
<h4 id="第一个回调函数更新组合选择列表">第一个回调函数：更新组合选择列表</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@app.callback(<span class="params"></span></span></span><br><span class="line"><span class="meta"><span class="params">    Output(<span class="params"><span class="string">&#x27;portfolio-select&#x27;</span>, <span class="string">&#x27;options&#x27;</span></span>),    </span></span></span><br><span class="line"><span class="meta"><span class="params">    Input(<span class="params"><span class="string">&quot;account-select&quot;</span>, <span class="string">&quot;value&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params">    prevent_initial_call=<span class="literal">True</span></span></span></span><br><span class="line"><span class="meta"><span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update_dropdown_portfolio_select</span>(<span class="params">account</span>):</span>  </span><br><span class="line">    <span class="keyword">return</span> fetch_portfolio_list(account)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ol type="1">
<li><strong>触发条件</strong>：当 <code>account-select</code>（账户选择下拉框）的值发生变化时触发回调。</li>
<li><strong>功能</strong>：调用 <code>fetch_portfolio_list(account)</code> 函数，从数据库中获取指定账户的组合列表，具体代码这里不列出。更新 <code>portfolio-select</code>（组合选择下拉框）的 <code>options</code> 属性。</li>
<li><strong>用途</strong>：动态加载组合策略的选项，使组合选择与账户选择保持一致。</li>
</ol>
<h4 id="第二个回调函数控制确认按钮的可用状态">第二个回调函数：控制“确认”按钮的可用状态</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@app.callback(<span class="params"></span></span></span><br><span class="line"><span class="meta"><span class="params">    Output(<span class="params"><span class="string">&#x27;submit-btn&#x27;</span>, <span class="string">&#x27;disabled&#x27;</span></span>),    </span></span></span><br><span class="line"><span class="meta"><span class="params">    Input(<span class="params"><span class="string">&quot;account-select&quot;</span>, <span class="string">&quot;value&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params">    Input(<span class="params"><span class="string">&quot;portfolio-select&quot;</span>, <span class="string">&quot;value&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params">    prevent_initial_call=<span class="literal">True</span></span></span></span><br><span class="line"><span class="meta"><span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update_btn_availibility</span>(<span class="params">account, portfolio</span>):</span>  </span><br><span class="line">    <span class="keyword">if</span> account <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> portfolio <span class="keyword">is</span> <span class="literal">None</span>: </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span> </span><br></pre></td></tr></table></figure>
<ol type="1">
<li><strong>触发条件</strong>：<code>account-select</code> 和 <code>portfolio-select</code> 的值发生变化时触发。</li>
<li><strong>功能</strong>：根据是否选择了有效的账户和组合策略，来设置 <code>submit-btn</code>（确认按钮）的 <code>disabled</code> 属性。
<ul>
<li>如果账户或组合为空，则返回 <code>True</code>，使按钮不可用。</li>
<li>如果都选择了，则返回 <code>False</code>，使按钮可用。</li>
</ul></li>
<li><strong>用途</strong>：防止在未选择账户和组合时按下按钮。</li>
</ol>
<h4 id="第三个回调函数获取数据并存入本地存储">第三个回调函数：获取数据并存入本地存储</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@app.callback(<span class="params"></span></span></span><br><span class="line"><span class="meta"><span class="params">    Output(<span class="params"><span class="string">&quot;account-trade-history&quot;</span>, <span class="string">&quot;data&quot;</span></span>),    </span></span></span><br><span class="line"><span class="meta"><span class="params">    Output(<span class="params"><span class="string">&quot;stock-day&quot;</span>, <span class="string">&quot;data&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params">    Output(<span class="params"><span class="string">&quot;benchmark-day&quot;</span>, <span class="string">&quot;data&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params">    Output(<span class="params"><span class="string">&quot;asset&quot;</span>, <span class="string">&quot;data&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params">    State(<span class="params"><span class="string">&quot;account-select&quot;</span>, <span class="string">&quot;value&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params">    State(<span class="params"><span class="string">&quot;portfolio-select&quot;</span>, <span class="string">&quot;value&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params">    Input(<span class="params"><span class="string">&quot;submit-btn&quot;</span>, <span class="string">&quot;n_clicks&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params">    prevent_initial_call=<span class="literal">True</span></span></span></span><br><span class="line"><span class="meta"><span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">output_localstore</span>(<span class="params">account, portfolio, submit_click</span>):</span>  </span><br><span class="line">    acc = Account(account_cookie=account, portfolio_cookie=portfolio)</span><br><span class="line">    df = acc.history_trade.reset_index()</span><br><span class="line">    df_tmp = df[[<span class="string">&#x27;date&#x27;</span>, <span class="string">&#x27;code&#x27;</span>, <span class="string">&#x27;price&#x27;</span>, <span class="string">&#x27;direction&#x27;</span>, <span class="string">&#x27;amount&#x27;</span>]].copy()</span><br><span class="line">    df_tmp[<span class="string">&#x27;交易方向&#x27;</span>] = np.where(df_tmp[<span class="string">&#x27;direction&#x27;</span>] == <span class="number">1</span>, <span class="string">&#x27;买入&#x27;</span>, <span class="string">&#x27;卖出&#x27;</span>)    </span><br><span class="line">    df_tmp[<span class="string">&#x27;成交价格&#x27;</span>] = df_tmp[<span class="string">&#x27;price&#x27;</span>].<span class="built_in">round</span>(<span class="number">2</span>)</span><br><span class="line">    df_tmp[<span class="string">&#x27;成交数量&#x27;</span>] = df_tmp[<span class="string">&#x27;amount&#x27;</span>].<span class="built_in">abs</span>()</span><br><span class="line">    df_tmp.drop([<span class="string">&#x27;direction&#x27;</span>, <span class="string">&#x27;amount&#x27;</span>, <span class="string">&#x27;price&#x27;</span>], axis=<span class="number">1</span>, inplace=<span class="literal">True</span>)</span><br><span class="line">    df_tmp = df_tmp.rename(columns=&#123;<span class="string">&#x27;date&#x27;</span>: <span class="string">&#x27;日期&#x27;</span>, <span class="string">&#x27;code&#x27;</span>: <span class="string">&#x27;股票代码&#x27;</span>&#125;)</span><br><span class="line">    account_trade_history = df_tmp.to_json(date_format=<span class="string">&#x27;iso&#x27;</span>, orient=<span class="string">&#x27;split&#x27;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="comment">## stock daily data</span></span><br><span class="line">	df_tmp = acc.stock_day.reset_index().copy()</span><br><span class="line">	stock_day = df_tmp.to_json(date_format=<span class="string">&#x27;iso&#x27;</span>, orient=<span class="string">&#x27;split&#x27;</span>)</span><br><span class="line">	 </span><br><span class="line">	<span class="comment">## benchmark daily data(上证50(000016), 沪深300(000300)， 中证500(000905)， 科创50(000688))</span></span><br><span class="line">	df_tmp = fetch_index_day([<span class="string">&#x27;000016&#x27;</span>,<span class="string">&#x27;000300&#x27;</span>,<span class="string">&#x27;000905&#x27;</span>,<span class="string">&#x27;000688&#x27;</span>], acc.start_date, acc.end_date, dataset_type=<span class="string">&#x27;pandas&#x27;</span>)</span><br><span class="line">	benchmark_day = df_tmp.to_json(date_format=<span class="string">&#x27;iso&#x27;</span>, orient=<span class="string">&#x27;split&#x27;</span>)</span><br><span class="line">	 </span><br><span class="line">	<span class="comment">## backtest assets</span></span><br><span class="line">	asset = acc.assets.get(<span class="string">&#x27;asset&#x27;</span>).reset_index().to_json(date_format=<span class="string">&#x27;iso&#x27;</span>, orient=<span class="string">&#x27;split&#x27;</span>)</span><br><span class="line">	dataset = &#123;<span class="string">&#x27;init_cash&#x27;</span>:acc.init_cash, <span class="string">&#x27;asset&#x27;</span>:asset, &#125;</span><br><span class="line">	asset_dataset = json.dumps(dataset)</span><br><span class="line">	 </span><br><span class="line">	<span class="keyword">return</span> account_trade_history, stock_day, benchmark_day, asset_dataset</span><br></pre></td></tr></table></figure>
<ol type="1">
<li><strong>触发条件</strong>：当 <code>submit-btn</code> 被点击时触发。</li>
<li><strong>参数说明</strong>：
<ul>
<li><code>account</code> 和 <code>portfolio</code> 是从 <code>State</code> 中获取的，即选中的账户和组合策略。</li>
<li><code>submit_click</code> 是点击事件计数器。</li>
</ul></li>
<li><strong>功能</strong>：根据选定账户和组合策略，执行以下操作：
<ul>
<li>创建一个 <code>Account</code> 对象 <code>acc</code>。</li>
<li>获取交易历史 <code>acc.history_trade</code> 并重置索引。</li>
<li>生成一个临时数据框 <code>df_tmp</code>，保留必要列，并进行处理：
<ul>
<li>使用 <code>np.where</code> 判断交易方向（<code>direction</code> 为 1 则是买入，其他情况为卖出）。</li>
<li>将价格保留两位小数，数量取绝对值。</li>
<li>重命名列以适配最终展示格式。</li>
</ul></li>
<li>将处理后的数据转换为 JSON 格式 <code>account_trade_history</code>，以便存入 <code>dcc.Store</code> 中。</li>
<li>获取基准指数数据：调用 fetch_index_day 函数，获取上证 50、沪深 300、中证 500 和科创 50 的每日数据，范围从账户开始日期至结束日期。
<ul>
<li>转换为 JSON：将 df_tmp 转换成 JSON 格式 benchmark_day。</li>
</ul></li>
<li>提取资产数据：获取账户资产数据的 JSON 格式，并与账户初始现金一起放入 <code>dataset</code> 字典。
<ul>
<li>转换为 JSON：将 <code>dataset</code> 转换成 JSON 格式 <code>asset_dataset</code>。</li>
</ul></li>
<li>返回所有数据的 JSON 格式，将其存储在 <code>dcc.Store</code> 中供前端使用。</li>
</ul></li>
</ol>
<h4 id="第四个回调函数获取数据后禁用下拉框的选择功能并将按钮内容设置为返回">第四个回调函数：获取数据后，禁用下拉框的选择功能，并将按钮内容设置为“返回”。</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@app.callback(<span class="params"></span></span></span><br><span class="line"><span class="meta"><span class="params">    Output(<span class="params"><span class="string">&quot;submit-btn&quot;</span>, <span class="string">&quot;children&quot;</span></span>),   </span></span></span><br><span class="line"><span class="meta"><span class="params">    Output(<span class="params"><span class="string">&quot;account-select&quot;</span>, <span class="string">&quot;disabled&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params">    Output(<span class="params"><span class="string">&quot;portfolio-select&quot;</span>, <span class="string">&quot;disabled&quot;</span></span>), </span></span></span><br><span class="line"><span class="meta"><span class="params">    Input(<span class="params"><span class="string">&quot;submit-btn&quot;</span>, <span class="string">&quot;n_clicks&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params">    prevent_initial_call=<span class="literal">True</span></span></span></span><br><span class="line"><span class="meta"><span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">disable_control_card</span>(<span class="params">submit_click</span>):</span>  </span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;返回&quot;</span>, <span class="literal">True</span>, <span class="literal">True</span> </span><br></pre></td></tr></table></figure>
<ol type="1">
<li><strong>触发条件</strong>：当 <code>submit-btn</code> 被点击时触发。</li>
<li><strong>功能</strong>：
<ul>
<li>按钮按下后，将两个下拉选择框设为不可用（禁用状态）。并更改按钮的 <code>children</code> 内容为 <code>"返回"</code>。</li>
</ul></li>
</ol>
<p>相应的 css 样式如下：</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.form-label</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>:<span class="number">#1a94bc</span>;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">0.75rem</span>;</span><br><span class="line">    <span class="attribute">font-weight</span>: bold;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.Select-input</span>&#123;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">25px</span> <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.Select-control</span>&#123;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">27px</span> <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.Select-placeholder</span>&#123;</span><br><span class="line">    <span class="attribute">line-height</span>: <span class="number">25px</span> <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.Select-value-label</span>&#123;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">27px</span> <span class="meta">!important</span>;</span><br><span class="line">    <span class="attribute">display</span>: flex <span class="meta">!important</span>;</span><br><span class="line">    <span class="attribute">align-items</span>: center <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以下是对每个 CSS 类的解释，这些类用于控制表单标签和选择框的样式。</p>
<ol type="1">
<li><code>.form-label</code></li>
</ol>
<ul>
<li><strong>目标</strong>: 控制表单标签的字体样式。
<ul>
<li><code>color: #1a94bc;</code>: 标签字体颜色为蓝色 ( #1a94bc )。</li>
<li><code>font-size: 0.75rem;</code>: 设置标签的字体大小为 <code>0.75rem</code>。</li>
<li><code>font-weight: bold;</code>: 标签字体加粗，增加视觉上的重要性。</li>
</ul></li>
</ul>
<ol start="2" type="1">
<li><code>.Select-input</code></li>
</ol>
<ul>
<li><strong>目标</strong>: 控制选择框的输入框高度。
<ul>
<li><code>height: 25px !important;</code>: 设置输入框的高度为 <code>25px</code>，使用 <code>!important</code> 确保该高度不会被其他样式覆盖。</li>
</ul></li>
</ul>
<ol start="3" type="1">
<li><code>.Select-control</code></li>
</ol>
<ul>
<li><strong>目标</strong>: 控制选择框整体的高度。
<ul>
<li><code>height: 27px !important;</code>: 将整个选择控件的高度设置为 <code>27px</code>，并使用 <code>!important</code> 以确保高度不受其他样式影响。</li>
</ul></li>
</ul>
<ol start="4" type="1">
<li><code>.Select-placeholder</code></li>
</ol>
<ul>
<li><strong>目标</strong>: 控制选择框中占位符文本的行高。
<ul>
<li><code>line-height: 25px !important;</code>: 设置占位符的行高为 <code>25px</code>，使占位文本在选择框中垂直居中。</li>
</ul></li>
</ul>
<ol start="5" type="1">
<li><code>.Select-value-label</code></li>
</ol>
<ul>
<li><strong>目标</strong>: 控制选择框中已选择标签的样式。
<ul>
<li><code>height: 27px !important;</code>: 将选择值标签的高度设置为 <code>27px</code>。</li>
<li><code>display: flex !important;</code>: 使用 Flexbox 布局，使内容可以在水平方向和垂直方向对齐。</li>
<li><code>align-items: center !important;</code>: 将选择框内已选值的内容垂直居中。</li>
</ul></li>
</ul>
<h2 id="总结">总结</h2>
<p>该函数返回一个包含账户选择、策略选择和确认按钮的卡片，整体样式整洁，适用于 <code>Dash Bootstrap</code> 项目中的侧边控制栏。</p>
<h2 id="效果展示">效果展示</h2>
<figure>
<img src="https://s2.loli.net/2024/11/12/N4vWZS96xwPXK8B.gif" alt="|300" /><figcaption aria-hidden="true">|300</figcaption>
</figure>
]]></content>
      <categories>
        <category>量化交易</category>
      </categories>
      <tags>
        <tag>python</tag>
        <tag>dash</tag>
        <tag>plotly</tag>
      </tags>
  </entry>
  <entry>
    <title>贝塔收益(β)</title>
    <url>/2021/07/17/%E8%B4%9D%E5%A1%94%E6%94%B6%E7%9B%8A(%CE%B2)/</url>
    <content><![CDATA[<h1 id="目的">目的</h1>
<p>在量化分析中，经常会需要获取 <span class="math inline">\(\beta\)</span> (贝塔收益或贝塔系数），那该如何查询或计算该系数呢？</p>
<h2 id="贝塔β的含义">贝塔(β)的含义</h2>
<p>贝塔系数衡量了个股或基金相对于整个股市的波动情况。</p>
<table>
<thead>
<tr class="header">
<th>β范围</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>β=1</td>
<td>股票或基金的风险收益率与市场平均风险收益率相同</td>
</tr>
<tr class="even">
<td>β&gt;1</td>
<td>股票或基金的风险相较于市场平均更大</td>
</tr>
<tr class="odd">
<td>β&lt;1</td>
<td>股票或基金的风险相较于市场平均更小</td>
</tr>
</tbody>
</table>
<a id="more"></a>
<h2 id="查询">查询</h2>
<p>可以在<a href="http://www.iwencai.com/stockpick/search?typed=1&amp;preParams=&amp;ts=1&amp;f=1&amp;qs=stockpick_ambiguity_index&amp;selfsectsn=&amp;querytype=stock&amp;searchfilter=&amp;tid=stockpick&amp;multiIndex=%E8%B4%9D%E5%A1%94%E7%B3%BB%E6%95%B0&amp;stockpick&amp;w=%E8%B4%9D%E5%A1%94%E7%B3%BB%E6%95%B0">同花顺网站</a>中查到上市公司当日的贝塔系数。</p>
<h2 id="计算">计算</h2>
<p>相对于沪深300指数(000300.SH)的beta系数计算方式如下：</p>
<blockquote>
<p><span class="math inline">\(\large \begin{equation} \beta_i = \frac{标的资产i的收益与市场收益的协方差}{市场收益的方差} = \frac{Cov(r_i,r_m)}{\sigma_m^2} \end{equation}\)</span></p>
</blockquote>
<p>例1、顺丰控股(002352.SZ)相对于沪深300指数(000300.SH)的beta系数计算，一定周期的沪深300指数(000300.SH)与顺丰控股(002352.SZ)的每日涨跌幅，如：2019年全年。</p>
<p>关于协方差、方差的计算方法:<br />
<a href="https://nokiasonic.github.io/2021/07/16/%E3%80%90Python%E3%80%91Pandas%E4%B9%8Bdataframe%E4%B8%8Eseries%E7%9A%84%E5%8D%8F%E6%96%B9%E5%B7%AE%E8%AE%A1%E7%AE%97/">【Python】Pandas之dataframe与series的协方差计算</a><br />
<a href="https://nokiasonic.github.io/2021/07/16/%E3%80%90Python%E3%80%91Pandas%E4%B9%8B%E6%96%B9%E5%B7%AE%E8%AE%A1%E7%AE%97/">【Python】Pandas、Numpy之方差计算</a></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> QUANTAXIS <span class="keyword">as</span> QA</span><br><span class="line"><span class="keyword">from</span> IPython.core.interactiveshell <span class="keyword">import</span> InteractiveShell</span><br><span class="line">InteractiveShell.ast_node_interactivity = <span class="string">&quot;all&quot;</span> </span><br><span class="line"></span><br><span class="line">stock = QA.QA_fetch_stock_day_adv(<span class="string">&#x27;002352&#x27;</span>,<span class="string">&#x27;2018-12-28&#x27;</span>,<span class="string">&#x27;2019-12-31&#x27;</span>)</span><br><span class="line">index = QA.QA_fetch_index_day_adv(<span class="string">&#x27;000300&#x27;</span>,<span class="string">&#x27;2018-12-28&#x27;</span>,<span class="string">&#x27;2019-12-31&#x27;</span>)</span><br><span class="line"></span><br><span class="line">returns_stock = stock.data.close.pct_change()</span><br><span class="line">returns_index = index.data.close.pct_change()</span><br><span class="line"><span class="comment">#计算两组数据的协方差</span></span><br><span class="line">covr = np.cov(returns_stock[<span class="number">1</span>:],returns_index[<span class="number">1</span>:])[<span class="number">0</span>][<span class="number">1</span>]</span><br><span class="line"><span class="comment">#计算沪深300指数数据的方差</span></span><br><span class="line">var = np.var(returns_index)</span><br><span class="line"><span class="comment">#计算贝塔值</span></span><br><span class="line">beta = covr/var</span><br><span class="line">print(<span class="string">&quot;Covariance:&#123;&#125;,Variance:&#123;&#125;,Beta:&#123;&#125;&quot;</span>.<span class="built_in">format</span>(covr,var,beta))</span><br></pre></td></tr></table></figure>
<pre><code>Covariance:9.712842264272448e-05,Variance:0.00015577588074696037,Beta:0.6235138724748936</code></pre>
<h1 id="参考">参考</h1>
<p>1/ <a href="https://wiki.mbalib.com/wiki/%E8%B4%9D%E5%A1%94%E7%B3%BB%E6%95%B0">贝塔系数</a><br />
2/ <a href="https://zhuanlan.zhihu.com/p/136858300">股票β系数（贝塔、beta）计算的具体操作</a><br />
3/ <a href="https://blog.csdn.net/thfyshz/article/details/83443783?utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-2.control&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EBlogCommendFromMachineLearnPai2%7Edefault-2.control">Python计算贝塔系数和夏普比率</a></p>
]]></content>
      <categories>
        <category>量化交易</category>
      </categories>
      <tags>
        <tag>线性代数</tag>
        <tag>风险分析</tag>
      </tags>
  </entry>
  <entry>
    <title>【Sunflower】Dash应用程序实践（四）</title>
    <url>/2024/11/14/%E3%80%90Sunflower%E3%80%91Dash%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E5%AE%9E%E8%B7%B5%EF%BC%88%E5%9B%9B%EF%BC%89/</url>
    <content><![CDATA[<h1 id="分栏右侧显示卡">分栏右侧显示卡</h1>
<p>下面是分栏右侧的显示卡部分，使用 tabs 来分别展示“绩效分析”及“交易明细”。</p>
<h2 id="绩效分析">绩效分析</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_display_tabs</span>():</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">:return: A Tab containing display graphs in right column</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">tabs = html.Div(</span><br><span class="line">    [</span><br><span class="line">        dbc.Tabs(</span><br><span class="line">            [</span><br><span class="line">                dbc.Tab(label=<span class="string">&quot;绩效分析&quot;</span>, tab_id=<span class="string">&quot;tab-summary&quot;</span>),</span><br><span class="line">                dbc.Tab(label=<span class="string">&quot;交易明细&quot;</span>, tab_id=<span class="string">&quot;tab-details&quot;</span>),</span><br><span class="line">            ],</span><br><span class="line">            <span class="built_in">id</span>=<span class="string">&quot;tabs&quot;</span>,</span><br><span class="line">            active_tab=<span class="string">&quot;tab-summary&quot;</span>,</span><br><span class="line">        ),</span><br><span class="line">        html.Div(<span class="built_in">id</span>=<span class="string">&quot;tabs-content&quot;</span>, children=generate_tab_summary_content()),</span><br><span class="line">    ],</span><br><span class="line">)</span><br><span class="line"><span class="keyword">return</span> tabs</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_tab_summary_content</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    :return: A Tab containing display graphs in right column</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    df = pd.DataFrame(</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;指标&quot;</span>: [<span class="string">&quot;alpha&quot;</span>, <span class="string">&quot;beta&quot;</span>, <span class="string">&quot;夏普比率&quot;</span>, <span class="string">&quot;信息比率&quot;</span>, <span class="string">&quot;年化收益&quot;</span>, <span class="string">&quot;最大回撤&quot;</span>, <span class="string">&quot;胜率&quot;</span>, <span class="string">&quot;利润&quot;</span>, <span class="string">&quot;持续时间&quot;</span>],</span><br><span class="line">        <span class="string">&quot;值&quot;</span>: [<span class="string">&quot;0.0&quot;</span>, <span class="string">&quot;0.11&quot;</span>, <span class="string">&quot;-0.04&quot;</span>, <span class="string">&quot;0.0&quot;</span>, <span class="string">&quot;0.0263&quot;</span>, <span class="string">&quot;0.05&quot;</span>, <span class="string">&quot;0.56&quot;</span>, <span class="string">&quot;2637.7&quot;</span>, <span class="string">&quot;190&quot;</span>],</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">    tab_summary_content = html.Div(</span><br><span class="line">        <span class="built_in">id</span>=<span class="string">&quot;tab_summary_content&quot;</span>,</span><br><span class="line">        children=[</span><br><span class="line">            html.Br(),</span><br><span class="line">            html.Div(</span><br><span class="line">                <span class="built_in">id</span>=<span class="string">&quot;performance&quot;</span>,</span><br><span class="line">                children=[</span><br><span class="line">                    dbc.Label(<span class="string">&quot;组合表现&quot;</span>),</span><br><span class="line">                    dcc.Graph(<span class="built_in">id</span>=<span class="string">&quot;performance-chart&quot;</span>, figure=initialize_performance_chart(),</span><br><span class="line">                    )</span><br><span class="line">                ],</span><br><span class="line">            ),</span><br><span class="line">            html.Br(),</span><br><span class="line">            html.Div(</span><br><span class="line">                <span class="built_in">id</span>=<span class="string">&quot;indicator&quot;</span>,</span><br><span class="line">                children=[</span><br><span class="line">                    dbc.Label(<span class="string">&quot;风险分析&quot;</span>),</span><br><span class="line">                    dbc.Table.from_dataframe(df, striped=<span class="literal">True</span>, bordered=<span class="literal">True</span>, hover=<span class="literal">True</span>)</span><br><span class="line">                ],</span><br><span class="line">            ),</span><br><span class="line">        ],</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> tab_summary_content</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>这个代码段定义了一个用于生成金融分析展示界面的模块。它包括两个主要的功能：<code>generate_display_tabs</code> 和 <code>generate_tab_summary_content</code>，分别用于生成一个包含多个标签页的布局，以及定义这些标签页的具体内容。以下是代码的详细解释：</p>
<h3 id="generate_display_tabs-函数"><code>generate_display_tabs()</code> 函数</h3>
<p>这个函数生成包含不同展示内容的标签页组件，并默认显示第一个标签页。</p>
<h4 id="代码解析">代码解析：</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_display_tabs</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    :return: A Tab containing display graphs in right column</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    tabs = html.Div(</span><br><span class="line">        [</span><br><span class="line">            dbc.Tabs(</span><br><span class="line">                [</span><br><span class="line">                    dbc.Tab(label=<span class="string">&quot;绩效分析&quot;</span>, tab_id=<span class="string">&quot;tab-summary&quot;</span>),</span><br><span class="line">                    dbc.Tab(label=<span class="string">&quot;交易明细&quot;</span>, tab_id=<span class="string">&quot;tab-details&quot;</span>),</span><br><span class="line">                    <span class="comment"># dbc.Tab(label=&quot;其它&quot;, tab_id=&quot;tab-3&quot;),</span></span><br><span class="line">                ],</span><br><span class="line">                <span class="built_in">id</span>=<span class="string">&quot;tabs&quot;</span>,</span><br><span class="line">                active_tab=<span class="string">&quot;tab-summary&quot;</span>,</span><br><span class="line">            ),</span><br><span class="line">            html.Div(<span class="built_in">id</span>=<span class="string">&quot;tabs-content&quot;</span>, children=generate_tab_summary_content()),</span><br><span class="line">        ],</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> tabs</span><br></pre></td></tr></table></figure>
<ol type="1">
<li><p><code>dbc.Tabs</code>: 创建一个标签页组件，用于显示不同的内容选项。它包含多个 <code>dbc.Tab</code>，每个标签页都有一个 <code>label</code> 和 <code>tab_id</code>。</p>
<ul>
<li><code>label="绩效分析"</code>: 标签页的显示名称。</li>
<li><code>tab_id="tab-summary"</code>: 标签页的唯一标识符。</li>
</ul></li>
<li><p><code>id="tabs"</code>: <code>dbc.Tabs</code> 组件的唯一标识符，便于在其他地方引用和操作。</p></li>
<li><p><code>active_tab="tab-summary"</code>: 指定初始显示的标签页为“绩效分析”。</p></li>
<li><p><code>html.Div(id="tabs-content", children=generate_tab_summary_content())</code>: <code>tabs-content</code> 是一个用于容纳标签页内容的 <code>Div</code> 容器。初始内容由 <code>generate_tab_summary_content()</code> 函数生成。</p></li>
</ol>
<h3 id="generate_tab_summary_content-函数"><code>generate_tab_summary_content()</code> 函数</h3>
<p>该函数用于生成“绩效分析”标签页的具体内容。它定义了一些图表和指标表格，用于展示组合表现和风险分析。</p>
<h4 id="代码解析-1">代码解析：</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_tab_summary_content</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    :return: A Tab containing display graphs in right column</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    df = pd.DataFrame(</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;指标&quot;</span>: [<span class="string">&quot;alpha&quot;</span>, <span class="string">&quot;beta&quot;</span>, <span class="string">&quot;夏普比率&quot;</span>, <span class="string">&quot;信息比率&quot;</span>, <span class="string">&quot;年化收益&quot;</span>, <span class="string">&quot;最大回撤&quot;</span>, <span class="string">&quot;胜率&quot;</span>, <span class="string">&quot;利润&quot;</span>, <span class="string">&quot;持续时间&quot;</span>],</span><br><span class="line">            <span class="string">&quot;值&quot;</span>: [<span class="string">&quot;0.0&quot;</span>, <span class="string">&quot;0.11&quot;</span>, <span class="string">&quot;-0.04&quot;</span>, <span class="string">&quot;0.0&quot;</span>, <span class="string">&quot;0.0263&quot;</span>, <span class="string">&quot;0.05&quot;</span>, <span class="string">&quot;0.56&quot;</span>, <span class="string">&quot;2637.7&quot;</span>, <span class="string">&quot;190&quot;</span>],</span><br><span class="line">        &#125;</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>
<ol type="1">
<li><code>df = pd.DataFrame(...)</code>: 定义一个包含风险指标和相应数值的 DataFrame，用于创建风险分析的表格。后续会从回测分析中计算相应的 DataFrame。这里初始化主要用于展示。
<ul>
<li><code>指标</code>: 风险分析指标（如 Alpha、Beta、夏普比率等）。</li>
<li><code>值</code>: 每个指标对应的值。</li>
</ul></li>
</ol>
<h4 id="子组件解释">子组件解释：</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">tab_summary_content = html.Div(</span><br><span class="line">    <span class="built_in">id</span>=<span class="string">&quot;tab_summary_content&quot;</span>,</span><br><span class="line">    children=[</span><br><span class="line">        html.Br(),</span><br></pre></td></tr></table></figure>
<ol type="1">
<li><code>html.Div(id="tab_summary_content", ...)</code>：容器 <code>Div</code>，包含多个显示子组件。</li>
<li><code>html.Br()</code>: 插入一个换行元素，为内容提供间隔。</li>
</ol>
<h5 id="a-组合表现graph-图表">(a) 组合表现（Graph 图表）</h5>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">html.Div(</span><br><span class="line">    <span class="built_in">id</span>=<span class="string">&quot;performance&quot;</span>,</span><br><span class="line">    children=[</span><br><span class="line">        dbc.Label(<span class="string">&quot;组合表现&quot;</span>),</span><br><span class="line">        dcc.Graph(</span><br><span class="line">            <span class="built_in">id</span>=<span class="string">&quot;performance-chart&quot;</span>,</span><br><span class="line">            figure=initialize_performance_chart()</span><br><span class="line">        )</span><br><span class="line">    ],</span><br><span class="line">),</span><br></pre></td></tr></table></figure>
<ol type="1">
<li><code>id="performance"</code>: 定义了显示组合表现的 <code>Div</code>。</li>
<li><code>dbc.Label("组合表现")</code>: 使用标签显示“组合表现”文本。</li>
<li><code>dcc.Graph</code>: 这是 Dash 中的图表组件，用于绘制组合表现图表。
<ul>
<li><code>id="performance-chart"</code>: 图表的唯一标识符。</li>
<li><code>figure=initialize_performance_chart()</code>: 使用 <code>initialize_performance_chart()</code> 函数生成图表的数据。</li>
</ul></li>
</ol>
<h5 id="b-风险分析table-表格">(b) 风险分析（Table 表格）</h5>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">html.Div(</span><br><span class="line">    <span class="built_in">id</span>=<span class="string">&quot;indicator&quot;</span>,</span><br><span class="line">    children=[</span><br><span class="line">        dbc.Label(<span class="string">&quot;风险分析&quot;</span>),</span><br><span class="line">        dbc.Table.from_dataframe(df, striped=<span class="literal">True</span>, bordered=<span class="literal">True</span>, hover=<span class="literal">True</span>)</span><br><span class="line">    ],</span><br><span class="line">),</span><br></pre></td></tr></table></figure>
<ol type="1">
<li><code>id="indicator"</code>: 定义了显示风险分析的 <code>Div</code>。</li>
<li><code>dbc.Label("风险分析")</code>: 使用标签显示“风险分析”文本。</li>
<li><code>dbc.Table.from_dataframe(df, ...)</code>: 从 DataFrame <code>df</code> 中生成表格，用于展示风险指标和其对应的值。
<ul>
<li><code>striped=True</code>: 使用条纹样式。</li>
<li><code>bordered=True</code>: 显示表格边框。</li>
<li><code>hover=True</code>: 表格行在鼠标悬停时突出显示。</li>
</ul></li>
</ol>
<h3 id="函数返回值">函数返回值</h3>
<ul>
<li><code>generate_display_tabs()</code> 返回包含所有标签页的布局，用于放置在页面的右侧。</li>
<li><code>generate_tab_summary_content()</code> 返回“绩效分析”标签页的内容，用于填充该标签页的展示内容。</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">initialize_performance_chart</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    :return: A empty performance line chart.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    layout = <span class="built_in">dict</span>(</span><br><span class="line">        title=<span class="string">&quot;&quot;</span>,</span><br><span class="line">        hoversubplots=<span class="string">&quot;axis&quot;</span>,</span><br><span class="line">        hovermode=<span class="string">&quot;closest&quot;</span>,</span><br><span class="line">        grid=<span class="built_in">dict</span>(rows=<span class="number">2</span>, columns=<span class="number">1</span>),   </span><br><span class="line">        xaxis=&#123;<span class="string">&quot;showticklabels&quot;</span>: <span class="literal">False</span>&#125;,</span><br><span class="line">        xaxis2=&#123;<span class="string">&quot;showticklabels&quot;</span>: <span class="literal">False</span>&#125;,</span><br><span class="line">        yaxis=&#123;<span class="string">&quot;visible&quot;</span>: <span class="literal">False</span>&#125;,</span><br><span class="line">        yaxis2=&#123;<span class="string">&quot;visible&quot;</span>: <span class="literal">False</span>&#125;,</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    data = [go.Scatter(x=[], y=[], xaxis=<span class="string">&quot;x&quot;</span>, yaxis=<span class="string">&quot;y&quot;</span>,  name=<span class="string">&quot;Asset vs. Benchmark&quot;</span>),</span><br><span class="line">            go.Bar(x=[], y=[], xaxis=<span class="string">&quot;x1&quot;</span>, yaxis=<span class="string">&quot;y2&quot;</span>, name=<span class="string">&quot;Monthly Profit&quot;</span>)]  </span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    fig = go.Figure(data=data, layout=layout)</span><br><span class="line">    <span class="keyword">return</span> fig</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_performance_chart</span>(<span class="params">benchmark_data, asset_data</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    :return: A performance line chart.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    df_benchmark_data = pd.read_json(StringIO(benchmark_data), orient=<span class="string">&#x27;split&#x27;</span>, dtype=&#123;<span class="string">&quot;code&quot;</span>: <span class="built_in">str</span>, <span class="string">&quot;date&quot;</span>: <span class="built_in">str</span>&#125;)</span><br><span class="line">    df = df_benchmark_data.copy()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># handle the date to form continous date(get rid of date without trade)</span></span><br><span class="line">    _dt_all = pd.date_range(start=df[<span class="string">&#x27;date&#x27;</span>].iloc[<span class="number">0</span>], end=df[<span class="string">&#x27;date&#x27;</span>].iloc[-<span class="number">1</span>])</span><br><span class="line">    dt_all = [d.strftime(<span class="string">&quot;%Y-%m-%d&quot;</span>) <span class="keyword">for</span> d <span class="keyword">in</span> _dt_all]</span><br><span class="line">    trade_date = <span class="built_in">list</span>(df[<span class="string">&#x27;date&#x27;</span>].values)</span><br><span class="line">    dt_breaks = <span class="built_in">list</span>(<span class="built_in">set</span>(dt_all) - <span class="built_in">set</span>(trade_date))</span><br><span class="line"></span><br><span class="line">    <span class="comment">#normalized index close price.</span></span><br><span class="line">    df_sz50 = df[df[<span class="string">&#x27;code&#x27;</span>]==<span class="string">&#x27;000016&#x27;</span>].copy()</span><br><span class="line">    df_sz50[<span class="string">&#x27;normalized&#x27;</span>] = df_sz50[<span class="string">&#x27;close&#x27;</span>]/df_sz50[<span class="string">&#x27;close&#x27;</span>].iloc[<span class="number">0</span>] - <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    df_hs300 = df[df[<span class="string">&#x27;code&#x27;</span>]==<span class="string">&#x27;000300&#x27;</span>].copy()</span><br><span class="line">    df_hs300[<span class="string">&#x27;normalized&#x27;</span>] = df_hs300[<span class="string">&#x27;close&#x27;</span>]/df_hs300[<span class="string">&#x27;close&#x27;</span>].iloc[<span class="number">0</span>] - <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    df_zz500 = df[df[<span class="string">&#x27;code&#x27;</span>]==<span class="string">&#x27;000905&#x27;</span>].copy()</span><br><span class="line">    df_zz500[<span class="string">&#x27;normalized&#x27;</span>] = df_zz500[<span class="string">&#x27;close&#x27;</span>]/df_zz500[<span class="string">&#x27;close&#x27;</span>].iloc[<span class="number">0</span>] - <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    df_kc50 = df[df[<span class="string">&#x27;code&#x27;</span>]==<span class="string">&#x27;000688&#x27;</span>].copy()</span><br><span class="line">    df_kc50[<span class="string">&#x27;normalized&#x27;</span>] = df_kc50[<span class="string">&#x27;close&#x27;</span>]/df_kc50[<span class="string">&#x27;close&#x27;</span>].iloc[<span class="number">0</span>] - <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#normalized asset daily balance</span></span><br><span class="line">    dataset_asset = json.loads(asset_data)</span><br><span class="line">    asset_init_cash = dataset_asset.get(<span class="string">&#x27;init_cash&#x27;</span>)</span><br><span class="line">    df_asset = pd.read_json(StringIO(dataset_asset[<span class="string">&#x27;asset&#x27;</span>]), orient=<span class="string">&#x27;split&#x27;</span>, dtype=&#123;<span class="string">&quot;code&quot;</span>: <span class="built_in">str</span>, <span class="string">&quot;date&quot;</span>: <span class="built_in">str</span>&#125;)</span><br><span class="line">    df_asset[<span class="string">&#x27;normalized&#x27;</span>] = df_asset[<span class="string">&#x27;balance&#x27;</span>]/(asset_init_cash * <span class="number">1.0</span>) - <span class="number">1</span></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    layout = <span class="built_in">dict</span>(</span><br><span class="line">        title=<span class="string">&quot;&quot;</span>,</span><br><span class="line">        hoversubplots=<span class="string">&quot;axis&quot;</span>,</span><br><span class="line">        hovermode=<span class="string">&quot;x unified&quot;</span>,</span><br><span class="line">        grid=<span class="built_in">dict</span>(rows=<span class="number">2</span>, columns=<span class="number">1</span>),        </span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    data = [go.Scatter(x=df_sz50[<span class="string">&#x27;date&#x27;</span>], y=df_sz50[<span class="string">&#x27;normalized&#x27;</span>], xaxis=<span class="string">&quot;x&quot;</span>, yaxis=<span class="string">&quot;y&quot;</span>,  name=<span class="string">&quot;上证50&quot;</span>, line=<span class="built_in">dict</span>(color=<span class="string">&#x27;rgb(17,101,154)&#x27;</span>), fill=<span class="string">&#x27;tozeroy&#x27;</span>, fillcolor=<span class="string">&#x27;rgba(17,101,154,0.3)&#x27;</span>), </span><br><span class="line">            go.Scatter(x=df_hs300[<span class="string">&#x27;date&#x27;</span>], y=df_hs300[<span class="string">&#x27;normalized&#x27;</span>], xaxis=<span class="string">&quot;x&quot;</span>, yaxis=<span class="string">&quot;y&quot;</span>,  name=<span class="string">&quot;沪深300&quot;</span>, line=<span class="built_in">dict</span>(color=<span class="string">&#x27;rgb(97,154,195)&#x27;</span>), fill=<span class="string">&#x27;tozeroy&#x27;</span>, fillcolor=<span class="string">&#x27;rgba(97,154,195,0.3)&#x27;</span>),  </span><br><span class="line">            go.Scatter(x=df_zz500[<span class="string">&#x27;date&#x27;</span>], y=df_zz500[<span class="string">&#x27;normalized&#x27;</span>], xaxis=<span class="string">&quot;x&quot;</span>, yaxis=<span class="string">&quot;y&quot;</span>,  name=<span class="string">&quot;中证500&quot;</span>, line=<span class="built_in">dict</span>(color=<span class="string">&#x27;rgb(147,181,207)&#x27;</span>), fill=<span class="string">&#x27;tozeroy&#x27;</span>, fillcolor=<span class="string">&#x27;rgba(147,181,207,0.3)&#x27;</span>),</span><br><span class="line">            go.Scatter(x=df_kc50[<span class="string">&#x27;date&#x27;</span>], y=df_kc50[<span class="string">&#x27;normalized&#x27;</span>], xaxis=<span class="string">&quot;x&quot;</span>, yaxis=<span class="string">&quot;y&quot;</span>,  name=<span class="string">&quot;科创50&quot;</span>, line=<span class="built_in">dict</span>(color=<span class="string">&#x27;rgb(186,204,217)&#x27;</span>), fill=<span class="string">&#x27;tozeroy&#x27;</span>, fillcolor=<span class="string">&#x27;rgba(186,204,217,0.3)&#x27;</span>),    </span><br><span class="line">            go.Scatter(x=df_asset[<span class="string">&#x27;date&#x27;</span>], y=df_asset[<span class="string">&#x27;normalized&#x27;</span>], xaxis=<span class="string">&quot;x&quot;</span>, yaxis=<span class="string">&quot;y&quot;</span>,  name=<span class="string">&quot;账户权益&quot;</span>, line=<span class="built_in">dict</span>(color=<span class="string">&#x27;rgb(237,81,38)&#x27;</span>), fill=<span class="string">&#x27;tozeroy&#x27;</span>, fillcolor=<span class="string">&#x27;rgba(237,81,38,0.3)&#x27;</span>),        </span><br><span class="line">            go.Bar(x=[], y=[], xaxis=<span class="string">&quot;x1&quot;</span>, yaxis=<span class="string">&quot;y2&quot;</span>, name=<span class="string">&quot;Monthly Profit&quot;</span>)]  </span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    fig = go.Figure(data=data, layout=layout)</span><br><span class="line">    fig.update_layout(</span><br><span class="line">        xaxis_rangeslider_visible=<span class="literal">False</span>,</span><br><span class="line">        showlegend=<span class="literal">True</span>,</span><br><span class="line">        yaxis_tickformat=<span class="string">&quot;.2%&quot;</span>,</span><br><span class="line">    )</span><br><span class="line">    fig.update_xaxes(rangebreaks=[<span class="built_in">dict</span>(values=dt_breaks)])</span><br><span class="line">    fig.update_yaxes(hoverformat=<span class="string">&quot;.2%&quot;</span>, tickfont_size=<span class="number">8</span>)</span><br><span class="line">    <span class="keyword">return</span> fig</span><br></pre></td></tr></table></figure>
<p>这个代码段定义了两个函数：<code>initialize_performance_chart</code> 和 <code>generate_performance_chart</code>。其中，<code>initialize_performance_chart</code> 用于初始化一个空的绩效图表，而 <code>generate_performance_chart</code> 则根据实际的基准和资产数据生成包含各类指标的图表。这两个图表显示了不同的指数（如上证 50、沪深 300 等）的表现，以及账户的整体权益趋势。</p>
<h3 id="initialize_performance_chart-函数"><code>initialize_performance_chart()</code> 函数</h3>
<p>这个函数创建了一个空的、格式化的绩效图表，并返回 <code>plotly.graph_objects.Figure</code> 对象。</p>
<h4 id="代码解析-2">代码解析：</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">initialize_performance_chart</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    :return: A empty performance line chart.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    layout = <span class="built_in">dict</span>(</span><br><span class="line">        title=<span class="string">&quot;&quot;</span>,</span><br><span class="line">        hoversubplots=<span class="string">&quot;axis&quot;</span>,</span><br><span class="line">        hovermode=<span class="string">&quot;closest&quot;</span>,</span><br><span class="line">        grid=<span class="built_in">dict</span>(rows=<span class="number">2</span>, columns=<span class="number">1</span>),   </span><br><span class="line">        xaxis=&#123;<span class="string">&quot;showticklabels&quot;</span>: <span class="literal">False</span>&#125;,</span><br><span class="line">        xaxis2=&#123;<span class="string">&quot;showticklabels&quot;</span>: <span class="literal">False</span>&#125;,</span><br><span class="line">        yaxis=&#123;<span class="string">&quot;visible&quot;</span>: <span class="literal">False</span>&#125;,</span><br><span class="line">        yaxis2=&#123;<span class="string">&quot;visible&quot;</span>: <span class="literal">False</span>&#125;,</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    data = [go.Scatter(x=[], y=[], xaxis=<span class="string">&quot;x&quot;</span>, yaxis=<span class="string">&quot;y&quot;</span>, name=<span class="string">&quot;Asset vs. Benchmark&quot;</span>),</span><br><span class="line">            go.Bar(x=[], y=[], xaxis=<span class="string">&quot;x1&quot;</span>, yaxis=<span class="string">&quot;y2&quot;</span>, name=<span class="string">&quot;Monthly Profit&quot;</span>)]  </span><br><span class="line">    </span><br><span class="line">    fig = go.Figure(data=data, layout=layout)</span><br><span class="line">    <span class="keyword">return</span> fig</span><br></pre></td></tr></table></figure>
<ol type="1">
<li><strong>布局配置 (<code>layout</code>)</strong>:
<ul>
<li><code>title</code>: 图表标题为空。</li>
<li><code>hoversubplots="axis"</code>: 设置悬停时的显示方式。</li>
<li><code>hovermode="closest"</code>: 设定鼠标悬停显示最接近的点。</li>
<li><code>grid=dict(rows=2, columns=1)</code>: 图表按 2 行 1 列布局。</li>
<li><code>xaxis</code> 和 <code>xaxis2</code>: 隐藏横坐标的标签。</li>
<li><code>yaxis</code> 和 <code>yaxis2</code>: 隐藏纵坐标轴。</li>
</ul></li>
<li><strong>图表数据 (<code>data</code>)</strong>:
<ul>
<li><code>go.Scatter</code>：用于创建资产与基准对比的折线图，但目前是空数据。</li>
<li><code>go.Bar</code>：用于显示每月利润的柱状图，当前也为空数据。</li>
</ul></li>
<li><strong>生成图表</strong>:
<ul>
<li><code>fig = go.Figure(data=data, layout=layout)</code>: 使用上述配置生成图表。</li>
<li>返回这个空图表，以便后续在没有数据时也能显示图表框架。</li>
</ul></li>
</ol>
<h3 id="generate_performance_chartbenchmark_data-asset_data-函数"><code>generate_performance_chart(benchmark_data, asset_data)</code> 函数</h3>
<p>这个函数生成包含不同基准指数与账户权益的图表。数据通过基准和账户的数据传入，函数会处理和标准化它们的表现，并将它们绘制在图表上。</p>
<h4 id="代码解析-3">代码解析：</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_performance_chart</span>(<span class="params">benchmark_data, asset_data</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    :return: A performance line chart.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    df_benchmark_data = pd.read_json(StringIO(benchmark_data), orient=<span class="string">&#x27;split&#x27;</span>, dtype=&#123;<span class="string">&quot;code&quot;</span>: <span class="built_in">str</span>, <span class="string">&quot;date&quot;</span>: <span class="built_in">str</span>&#125;)</span><br><span class="line">    df = df_benchmark_data.copy()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># handle the date to form continuous date(get rid of date without trade)</span></span><br><span class="line">    _dt_all = pd.date_range(start=df[<span class="string">&#x27;date&#x27;</span>].iloc[<span class="number">0</span>], end=df[<span class="string">&#x27;date&#x27;</span>].iloc[-<span class="number">1</span>])</span><br><span class="line">    dt_all = [d.strftime(<span class="string">&quot;%Y-%m-%d&quot;</span>) <span class="keyword">for</span> d <span class="keyword">in</span> _dt_all]</span><br><span class="line">    trade_date = <span class="built_in">list</span>(df[<span class="string">&#x27;date&#x27;</span>].values)</span><br><span class="line">    dt_breaks = <span class="built_in">list</span>(<span class="built_in">set</span>(dt_all) - <span class="built_in">set</span>(trade_date))</span><br></pre></td></tr></table></figure>
<ol type="1">
<li><strong>数据准备</strong>：
<ul>
<li><code>pd.read_json</code>：将 JSON 格式的基准数据读取为 <code>DataFrame</code>。</li>
<li><code>pd.date_range</code>：生成从起始到结束日期的连续日期。</li>
<li><code>dt_breaks</code>：计算非交易日（即 <code>dt_all</code> 与 <code>trade_date</code> 的差集），用于图表中日期的断开处理。</li>
</ul></li>
</ol>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#normalized index close price.</span></span><br><span class="line">df_sz50 = df[df[<span class="string">&#x27;code&#x27;</span>]==<span class="string">&#x27;000016&#x27;</span>].copy()</span><br><span class="line">df_sz50[<span class="string">&#x27;normalized&#x27;</span>] = df_sz50[<span class="string">&#x27;close&#x27;</span>]/df_sz50[<span class="string">&#x27;close&#x27;</span>].iloc[<span class="number">0</span>] - <span class="number">1</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<ol start="2" type="1">
<li><strong>基准指数标准化</strong>：
<ul>
<li>依次筛选上证 50（000016）、沪深 300（000300）、中证 500（000905）、科创 50（000688）的数据并生成副本。</li>
<li><code>normalized</code>：将每个指数的每日收盘价标准化，计算出相对于第一天的百分比变化，用于统一显示不同指数的表现。</li>
</ul></li>
</ol>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">dataset_asset = json.loads(asset_data)</span><br><span class="line">asset_init_cash = dataset_asset.get(<span class="string">&#x27;init_cash&#x27;</span>)</span><br><span class="line">df_asset = pd.read_json(StringIO(dataset_asset[<span class="string">&#x27;asset&#x27;</span>]), orient=<span class="string">&#x27;split&#x27;</span>, dtype=&#123;<span class="string">&quot;code&quot;</span>: <span class="built_in">str</span>, <span class="string">&quot;date&quot;</span>: <span class="built_in">str</span>&#125;)</span><br><span class="line">df_asset[<span class="string">&#x27;normalized&#x27;</span>] = df_asset[<span class="string">&#x27;balance&#x27;</span>]/(asset_init_cash * <span class="number">1.0</span>) - <span class="number">1</span></span><br></pre></td></tr></table></figure>
<ol start="3" type="1">
<li><strong>账户资产标准化</strong>：
<ul>
<li>读取资产数据，获取初始现金。</li>
<li>将每日资产权益标准化为百分比变化，以便与基准指数的变化进行比较。</li>
</ul></li>
</ol>
<h4 id="图表布局和数据">图表布局和数据</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">layout = <span class="built_in">dict</span>(</span><br><span class="line">    title=<span class="string">&quot;&quot;</span>,</span><br><span class="line">    hoversubplots=<span class="string">&quot;axis&quot;</span>,</span><br><span class="line">    hovermode=<span class="string">&quot;x unified&quot;</span>,</span><br><span class="line">    grid=<span class="built_in">dict</span>(rows=<span class="number">2</span>, columns=<span class="number">1</span>),        </span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">data = [go.Scatter(x=df_sz50[<span class="string">&#x27;date&#x27;</span>], y=df_sz50[<span class="string">&#x27;normalized&#x27;</span>], xaxis=<span class="string">&quot;x&quot;</span>, yaxis=<span class="string">&quot;y&quot;</span>,  name=<span class="string">&quot;上证50&quot;</span>, line=<span class="built_in">dict</span>(color=<span class="string">&#x27;rgb(17,101,154)&#x27;</span>), fill=<span class="string">&#x27;tozeroy&#x27;</span>, fillcolor=<span class="string">&#x27;rgba(17,101,154,0.3)&#x27;</span>), </span><br><span class="line">        ...</span><br><span class="line">        go.Scatter(x=df_asset[<span class="string">&#x27;date&#x27;</span>], y=df_asset[<span class="string">&#x27;normalized&#x27;</span>], xaxis=<span class="string">&quot;x&quot;</span>, yaxis=<span class="string">&quot;y&quot;</span>,  name=<span class="string">&quot;账户权益&quot;</span>, line=<span class="built_in">dict</span>(color=<span class="string">&#x27;rgb(237,81,38)&#x27;</span>), fill=<span class="string">&#x27;tozeroy&#x27;</span>, fillcolor=<span class="string">&#x27;rgba(237,81,38,0.3)&#x27;</span>),</span><br><span class="line">        go.Bar(x=[], y=[], xaxis=<span class="string">&quot;x1&quot;</span>, yaxis=<span class="string">&quot;y2&quot;</span>, name=<span class="string">&quot;Monthly Profit&quot;</span>)]  </span><br></pre></td></tr></table></figure>
<ol type="1">
<li><strong>布局定义</strong>：
<ul>
<li><code>hovermode="x unified"</code>: 横坐标悬停模式。</li>
<li><code>grid=dict(rows=2, columns=1)</code>: 图表布局为 2 行 1 列。</li>
</ul></li>
<li><strong>图表数据</strong>：
<ul>
<li><code>go.Scatter</code>: 用于绘制每个基准指数和账户权益的标准化折线图，填充色指定透明度和颜色。</li>
<li><code>go.Bar</code>: 占位柱状图（目前为空数据），用于日后显示月度利润。</li>
</ul></li>
</ol>
<h4 id="生成并返回图表">生成并返回图表</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">fig = go.Figure(data=data, layout=layout)</span><br><span class="line">fig.update_layout(</span><br><span class="line">    xaxis_rangeslider_visible=<span class="literal">False</span>,</span><br><span class="line">    showlegend=<span class="literal">True</span>,</span><br><span class="line">    yaxis_tickformat=<span class="string">&quot;.2%&quot;</span>,</span><br><span class="line">)</span><br><span class="line">fig.update_xaxes(rangebreaks=[<span class="built_in">dict</span>(values=dt_breaks)])</span><br><span class="line">fig.update_yaxes(hoverformat=<span class="string">&quot;.2%&quot;</span>, tickfont_size=<span class="number">8</span>)</span><br><span class="line"><span class="keyword">return</span> fig</span><br></pre></td></tr></table></figure>
<ul>
<li><code>fig.update_layout(...)</code>: 设置图表的整体布局，包括隐藏日期范围滑块、显示图例等。</li>
<li><code>fig.update_xaxes(rangebreaks=[dict(values=dt_breaks)])</code>: 设置日期轴，跳过非交易日。</li>
<li><code>fig.update_yaxes(...)</code>: 设置纵轴的格式，以百分比显示数据。</li>
</ul>
<p>返回的 <code>fig</code> 是一个包含多个指数与账户资产表现的对比图表，用于在图形界面上展示各项数据的走势。</p>
<h2 id="交易明细">交易明细</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_tab_details_content</span>():</span></span><br><span class="line">   <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">   :return: A Tab containing display graphs in right column</span></span><br><span class="line"><span class="string">   &quot;&quot;&quot;</span></span><br><span class="line">   tab_details_content = html.Div(</span><br><span class="line">       <span class="built_in">id</span>=<span class="string">&quot;tab_details_content&quot;</span>,</span><br><span class="line">       <span class="comment">#className=&quot;eleven columns&quot;,</span></span><br><span class="line">       children=[</span><br><span class="line">           <span class="comment">#html.Br(),</span></span><br><span class="line">           html.Div(</span><br><span class="line">               <span class="built_in">id</span>=<span class="string">&quot;stock_list&quot;</span>,</span><br><span class="line">               children=[</span><br><span class="line">                   dbc.Label(<span class="string">&quot;回测组合中的股票&quot;</span>),</span><br><span class="line">                   dcc.Dropdown(</span><br><span class="line">                       <span class="built_in">id</span>=<span class="string">&quot;security-select&quot;</span>,</span><br><span class="line">                       options = [],</span><br><span class="line">                       placeholder=<span class="string">&quot;Select the security&quot;</span>,</span><br><span class="line">                       style=&#123;<span class="string">&quot;width&quot;</span>:<span class="string">&quot;200px&quot;</span>&#125;,</span><br><span class="line">                   ),</span><br><span class="line">                   html.Br()</span><br><span class="line">               ],</span><br><span class="line">           ),</span><br><span class="line">           <span class="comment"># Stock candle chart</span></span><br><span class="line">           html.Div(</span><br><span class="line">               <span class="built_in">id</span>=<span class="string">&quot;stock-candle-chart-card&quot;</span>,</span><br><span class="line">               children=[</span><br><span class="line">                   dbc.Label(<span class="string">&quot;回测时段行情数据&quot;</span>),</span><br><span class="line">                   <span class="comment">#html.Hr(),</span></span><br><span class="line">                   dcc.Graph(<span class="built_in">id</span>=<span class="string">&quot;stock-candle-chart&quot;</span>, figure=initialize_stock_candle_chart())</span><br><span class="line">               ],</span><br><span class="line">           ),</span><br><span class="line">           html.Br(),</span><br><span class="line">           <span class="comment"># trade records</span></span><br><span class="line">           html.Div(</span><br><span class="line">               <span class="built_in">id</span>=<span class="string">&quot;trade_records&quot;</span>,</span><br><span class="line">               children=[</span><br><span class="line">                   dbc.Label(<span class="string">&quot;交易记录&quot;</span>),</span><br><span class="line">                   <span class="comment">#html.Hr(),</span></span><br><span class="line">                   dash_table.DataTable(<span class="built_in">id</span>=<span class="string">&#x27;current-stock-trade-history&#x27;</span>, columns=initialize_data_table(), page_size= <span class="number">10</span>, style_cell=&#123;<span class="string">&#x27;textAlign&#x27;</span>: <span class="string">&#x27;center&#x27;</span>&#125;)</span><br><span class="line">               ],</span><br><span class="line">           ),</span><br><span class="line">       ],</span><br><span class="line">   )</span><br><span class="line">   <span class="keyword">return</span> tab_details_content</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">initialize_stock_candle_chart</span>():</span></span><br><span class="line">   <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">   :return: A empty stock candle chart.</span></span><br><span class="line"><span class="string">   &quot;&quot;&quot;</span></span><br><span class="line">   df = pd.DataFrame(columns=[<span class="string">&#x27;date&#x27;</span>, <span class="string">&#x27;open&#x27;</span>, <span class="string">&#x27;high&#x27;</span>, <span class="string">&#x27;low&#x27;</span>, <span class="string">&#x27;close&#x27;</span>, <span class="string">&#x27;vol&#x27;</span>])</span><br><span class="line">   layout = <span class="built_in">dict</span>(</span><br><span class="line">       title=<span class="string">&quot;&quot;</span>,</span><br><span class="line">       hoversubplots=<span class="string">&quot;axis&quot;</span>,</span><br><span class="line">       hovermode=<span class="string">&quot;x unified&quot;</span>,</span><br><span class="line">       grid=<span class="built_in">dict</span>(rows=<span class="number">2</span>, columns=<span class="number">1</span>),   </span><br><span class="line">       xaxis=&#123;<span class="string">&quot;showticklabels&quot;</span>: <span class="literal">False</span>&#125;,</span><br><span class="line">       yaxis=&#123;<span class="string">&quot;visible&quot;</span>: <span class="literal">False</span>&#125;,</span><br><span class="line">       yaxis2=&#123;<span class="string">&quot;visible&quot;</span>: <span class="literal">False</span>&#125;,</span><br><span class="line">   )</span><br><span class="line">   </span><br><span class="line">   data = [go.Candlestick(x=df[<span class="string">&quot;date&quot;</span>], <span class="built_in">open</span>=df[<span class="string">&#x27;open&#x27;</span>], high=df[<span class="string">&#x27;high&#x27;</span>], low=df[<span class="string">&#x27;low&#x27;</span>], close=df[<span class="string">&#x27;close&#x27;</span>],</span><br><span class="line">                          xaxis=<span class="string">&quot;x&quot;</span>, yaxis=<span class="string">&quot;y&quot;</span>, increasing_line_color=<span class="string">&#x27;red&#x27;</span>, decreasing_line_color=<span class="string">&#x27;green&#x27;</span>, name=<span class="string">&quot;&quot;</span>),</span><br><span class="line">           go.Bar(x=df[<span class="string">&#x27;date&#x27;</span>], y=df[<span class="string">&#x27;vol&#x27;</span>], xaxis=<span class="string">&quot;x&quot;</span>, yaxis=<span class="string">&quot;y2&quot;</span>, name=<span class="string">&quot;volume&quot;</span>)]  </span><br><span class="line">   </span><br><span class="line"></span><br><span class="line">   fig = go.Figure(data=data, layout=layout)</span><br><span class="line">   <span class="keyword">return</span> fig</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_stock_candle_chart</span>(<span class="params">data, code</span>):</span></span><br><span class="line">   <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">   :return: A stock candle chart.</span></span><br><span class="line"><span class="string">   &quot;&quot;&quot;</span></span><br><span class="line">   df_pandas = pd.read_json(StringIO(data), orient=<span class="string">&#x27;split&#x27;</span>, dtype=&#123;<span class="string">&quot;date&quot;</span>: <span class="built_in">str</span>, <span class="string">&quot;code&quot;</span>: <span class="built_in">str</span>&#125;)</span><br><span class="line">   df = df_pandas.copy()</span><br><span class="line">   print(df)</span><br><span class="line"></span><br><span class="line">   <span class="comment"># handle the date to form continous date(get rid of date without trade)</span></span><br><span class="line">   _dt_all = pd.date_range(start=df[<span class="string">&#x27;date&#x27;</span>].iloc[<span class="number">0</span>], end=df[<span class="string">&#x27;date&#x27;</span>].iloc[-<span class="number">1</span>])</span><br><span class="line">   dt_all = [d.strftime(<span class="string">&quot;%Y-%m-%d&quot;</span>) <span class="keyword">for</span> d <span class="keyword">in</span> _dt_all]</span><br><span class="line">   trade_date = <span class="built_in">list</span>(df[<span class="string">&#x27;date&#x27;</span>].values)</span><br><span class="line">   dt_breaks = <span class="built_in">list</span>(<span class="built_in">set</span>(dt_all) - <span class="built_in">set</span>(trade_date))</span><br><span class="line"></span><br><span class="line">   <span class="comment"># handle volume color to use the same color with candlestick</span></span><br><span class="line">   df[<span class="string">&#x27;bar_color&#x27;</span>] = np.where(</span><br><span class="line">       df[<span class="string">&#x27;close&#x27;</span>] - df[<span class="string">&#x27;open&#x27;</span>] &gt;= <span class="number">0</span>, <span class="string">&#x27;red&#x27;</span>, <span class="string">&#x27;green&#x27;</span>)</span><br><span class="line">   </span><br><span class="line">   df=df.loc[df[<span class="string">&#x27;code&#x27;</span>]==code]</span><br><span class="line">   </span><br><span class="line">   <span class="comment"># use plotly to plot</span></span><br><span class="line">   <span class="comment">## define layout &amp; data</span></span><br><span class="line">   layout = <span class="built_in">dict</span>(</span><br><span class="line">       title= <span class="string">f&quot;<span class="subst">&#123;fetch_stock_name(code)&#125;</span>(<span class="subst">&#123;code&#125;</span>)&quot;</span>,</span><br><span class="line">       hoversubplots=<span class="string">&quot;axis&quot;</span>,</span><br><span class="line">       hovermode=<span class="string">&quot;x unified&quot;</span>,</span><br><span class="line">       grid=<span class="built_in">dict</span>(rows=<span class="number">2</span>, columns=<span class="number">1</span>),</span><br><span class="line">       yaxis=<span class="built_in">dict</span>(domain=[<span class="number">0.25</span>, <span class="number">1</span>]),</span><br><span class="line">       yaxis2=<span class="built_in">dict</span>(domain=[<span class="number">0</span>, <span class="number">0.20</span>]),</span><br><span class="line">   )</span><br><span class="line"></span><br><span class="line">   data = [</span><br><span class="line">       go.Candlestick(x=df[<span class="string">&quot;date&quot;</span>], <span class="built_in">open</span>=df[<span class="string">&#x27;open&#x27;</span>], high=df[<span class="string">&#x27;high&#x27;</span>], low=df[<span class="string">&#x27;low&#x27;</span>], close=df[<span class="string">&#x27;close&#x27;</span>],</span><br><span class="line">                   xaxis=<span class="string">&quot;x&quot;</span>, yaxis=<span class="string">&quot;y&quot;</span>, increasing_line_color=<span class="string">&#x27;red&#x27;</span>, decreasing_line_color=<span class="string">&#x27;green&#x27;</span>, name=<span class="string">&quot;&quot;</span>, </span><br><span class="line">                  </span><br><span class="line">       ),</span><br><span class="line">       go.Bar(x=df[<span class="string">&#x27;date&#x27;</span>], y=df[<span class="string">&#x27;vol&#x27;</span>], xaxis=<span class="string">&quot;x&quot;</span>, yaxis=<span class="string">&quot;y2&quot;</span>,</span><br><span class="line">           marker_color=df[<span class="string">&#x27;bar_color&#x27;</span>], name=<span class="string">&quot;volume&quot;</span>)</span><br><span class="line">   ]</span><br><span class="line"></span><br><span class="line">   <span class="comment">## custom the layout</span></span><br><span class="line">   <span class="comment">## define hoverlabel background color/font</span></span><br><span class="line">   <span class="comment">## plot without rangeslider</span></span><br><span class="line">   fig = go.Figure(data=data, layout=layout)</span><br><span class="line">   fig.update_xaxes(rangebreaks=[<span class="built_in">dict</span>(values=dt_breaks)])</span><br><span class="line">   fig.update_layout(</span><br><span class="line">       hoverlabel=<span class="built_in">dict</span>(</span><br><span class="line">           bgcolor=<span class="string">&quot;white&quot;</span>,</span><br><span class="line">           font_size=<span class="number">12</span>,</span><br><span class="line">           font_family=<span class="string">&quot;Rockwell&quot;</span>,</span><br><span class="line">       ),</span><br><span class="line">       xaxis_rangeslider_visible=<span class="literal">False</span>,</span><br><span class="line">       showlegend=<span class="literal">False</span>,</span><br><span class="line">       yaxis_tickformat=<span class="string">&quot;.2f&quot;</span>,</span><br><span class="line">   )</span><br><span class="line">   fig.update_yaxes(hoverformat=<span class="string">&quot;.2f&quot;</span>, tickfont_size=<span class="number">8</span>)</span><br><span class="line">   <span class="keyword">return</span> fig</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">initialize_data_table</span>():</span></span><br><span class="line">   <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">   :return: data table columns.</span></span><br><span class="line"><span class="string">   &quot;&quot;&quot;</span></span><br><span class="line">   columns=[</span><br><span class="line">           &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;日期&#x27;</span>, <span class="string">&#x27;id&#x27;</span>: <span class="string">&#x27;日期&#x27;</span>&#125;,</span><br><span class="line">           &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;股票代码&#x27;</span>, <span class="string">&#x27;id&#x27;</span>: <span class="string">&#x27;股票代码&#x27;</span>&#125;,</span><br><span class="line">           &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;交易方向&#x27;</span>, <span class="string">&#x27;id&#x27;</span>: <span class="string">&#x27;交易方向&#x27;</span>&#125;,</span><br><span class="line">           &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;成交价格&#x27;</span>, <span class="string">&#x27;id&#x27;</span>: <span class="string">&#x27;成交价格&#x27;</span>&#125;,</span><br><span class="line">           &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;成交数量&#x27;</span>, <span class="string">&#x27;id&#x27;</span>: <span class="string">&#x27;成交数量&#x27;</span>&#125;</span><br><span class="line">       ]</span><br><span class="line">   <span class="keyword">return</span> columns</span><br></pre></td></tr></table></figure>
<p>这个代码片段创建了一个包含股票回测分析界面的 Dash 应用程序。该应用分为多个部分，如股票选择、K 线图、交易记录表等。各部分展示了用户在回测时段中的持仓股票、股价行情、交易记录等信息。</p>
<h3 id="generate_tab_details_content-函数"><code>generate_tab_details_content</code> 函数</h3>
<p><code>generate_tab_details_content</code> 函数创建了一个 "交易明细" 标签页的内容，包括股票选择、K 线图和交易记录表。</p>
<h4 id="代码解析-4">代码解析：</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_tab_details_content</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    :return: A Tab containing display graphs in right column</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    tab_details_content = html.Div(</span><br><span class="line">        <span class="built_in">id</span>=<span class="string">&quot;tab_details_content&quot;</span>,</span><br><span class="line">        children=[</span><br><span class="line">            <span class="comment"># 股票选择下拉菜单</span></span><br><span class="line">            html.Div(</span><br><span class="line">                <span class="built_in">id</span>=<span class="string">&quot;stock_list&quot;</span>,</span><br><span class="line">                children=[</span><br><span class="line">                    dbc.Label(<span class="string">&quot;回测组合中的股票&quot;</span>),</span><br><span class="line">                    dcc.Dropdown(</span><br><span class="line">                        <span class="built_in">id</span>=<span class="string">&quot;security-select&quot;</span>,</span><br><span class="line">                        options=[],</span><br><span class="line">                        placeholder=<span class="string">&quot;Select the security&quot;</span>,</span><br><span class="line">                        style=&#123;<span class="string">&quot;width&quot;</span>:<span class="string">&quot;200px&quot;</span>&#125;,</span><br><span class="line">                    ),</span><br><span class="line">                    html.Br()</span><br><span class="line">                ],</span><br><span class="line">            ),</span><br><span class="line">            <span class="comment"># 股票行情 K 线图</span></span><br><span class="line">            html.Div(</span><br><span class="line">                <span class="built_in">id</span>=<span class="string">&quot;stock-candle-chart-card&quot;</span>,</span><br><span class="line">                children=[</span><br><span class="line">                    dbc.Label(<span class="string">&quot;回测时段行情数据&quot;</span>),</span><br><span class="line">                    dcc.Graph(<span class="built_in">id</span>=<span class="string">&quot;stock-candle-chart&quot;</span>, figure=initialize_stock_candle_chart())</span><br><span class="line">                ],</span><br><span class="line">            ),</span><br><span class="line">            html.Br(),</span><br><span class="line">            <span class="comment"># 交易记录表格</span></span><br><span class="line">            html.Div(</span><br><span class="line">                <span class="built_in">id</span>=<span class="string">&quot;trade_records&quot;</span>,</span><br><span class="line">                children=[</span><br><span class="line">                    dbc.Label(<span class="string">&quot;交易记录&quot;</span>),</span><br><span class="line">                    dash_table.DataTable(<span class="built_in">id</span>=<span class="string">&#x27;current-stock-trade-history&#x27;</span>, columns=initialize_data_table(), page_size=<span class="number">10</span>, style_cell=&#123;<span class="string">&#x27;textAlign&#x27;</span>: <span class="string">&#x27;center&#x27;</span>&#125;)</span><br><span class="line">                ],</span><br><span class="line">            ),</span><br><span class="line">        ],</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">return</span> tab_details_content</span><br></pre></td></tr></table></figure>
<ol type="1">
<li><strong><code>security-select</code></strong>: 创建股票选择的下拉菜单组件。</li>
<li><strong><code>stock-candle-chart</code></strong>: 使用 <code>initialize_stock_candle_chart</code> 生成一个空的 K 线图，用于展示所选股票的历史行情数据。</li>
<li><strong><code>current-stock-trade-history</code></strong>: 使用 <code>initialize_data_table</code> 设置列信息，用于显示股票的交易记录。</li>
</ol>
<h3 id="initialize_stock_candle_chart-函数"><code>initialize_stock_candle_chart</code> 函数</h3>
<p>这个函数生成一个空的 K 线图，为股票交易数据展示提供图表结构。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">initialize_stock_candle_chart</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    :return: A empty stock candle chart.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    df = pd.DataFrame(columns=[<span class="string">&#x27;date&#x27;</span>, <span class="string">&#x27;open&#x27;</span>, <span class="string">&#x27;high&#x27;</span>, <span class="string">&#x27;low&#x27;</span>, <span class="string">&#x27;close&#x27;</span>, <span class="string">&#x27;vol&#x27;</span>])</span><br><span class="line">    layout = <span class="built_in">dict</span>(</span><br><span class="line">        title=<span class="string">&quot;&quot;</span>,</span><br><span class="line">        hoversubplots=<span class="string">&quot;axis&quot;</span>,</span><br><span class="line">        hovermode=<span class="string">&quot;x unified&quot;</span>,</span><br><span class="line">        grid=<span class="built_in">dict</span>(rows=<span class="number">2</span>, columns=<span class="number">1</span>),   </span><br><span class="line">        xaxis=&#123;<span class="string">&quot;showticklabels&quot;</span>: <span class="literal">False</span>&#125;,</span><br><span class="line">        yaxis=&#123;<span class="string">&quot;visible&quot;</span>: <span class="literal">False</span>&#125;,</span><br><span class="line">        yaxis2=&#123;<span class="string">&quot;visible&quot;</span>: <span class="literal">False</span>&#125;,</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    data = [go.Candlestick(x=df[<span class="string">&quot;date&quot;</span>], <span class="built_in">open</span>=df[<span class="string">&#x27;open&#x27;</span>], high=df[<span class="string">&#x27;high&#x27;</span>], low=df[<span class="string">&#x27;low&#x27;</span>], close=df[<span class="string">&#x27;close&#x27;</span>],</span><br><span class="line">                           xaxis=<span class="string">&quot;x&quot;</span>, yaxis=<span class="string">&quot;y&quot;</span>, increasing_line_color=<span class="string">&#x27;red&#x27;</span>, decreasing_line_color=<span class="string">&#x27;green&#x27;</span>, name=<span class="string">&quot;&quot;</span>),</span><br><span class="line">            go.Bar(x=df[<span class="string">&#x27;date&#x27;</span>], y=df[<span class="string">&#x27;vol&#x27;</span>], xaxis=<span class="string">&quot;x&quot;</span>, yaxis=<span class="string">&quot;y2&quot;</span>, name=<span class="string">&quot;volume&quot;</span>)]</span><br><span class="line">    </span><br><span class="line">    fig = go.Figure(data=data, layout=layout)</span><br><span class="line">    <span class="keyword">return</span> fig</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>布局</strong>：布局指定图表显示样式，包括隐藏轴标签，设置多图层布局。</li>
<li><strong>数据格式</strong>：使用空数据集初始化一个 K 线图和成交量柱状图的结构，使用 Plotly 生成图形对象 <code>fig</code>。</li>
</ul>
<h3 id="generate_stock_candle_chart-函数"><code>generate_stock_candle_chart</code> 函数</h3>
<p><code>generate_stock_candle_chart</code> 函数根据数据生成实际的股票 K 线图，显示特定股票的行情数据。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_stock_candle_chart</span>(<span class="params">data, code</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    :return: A stock candle chart.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    df_pandas = pd.read_json(StringIO(data), orient=<span class="string">&#x27;split&#x27;</span>, dtype=&#123;<span class="string">&quot;date&quot;</span>: <span class="built_in">str</span>, <span class="string">&quot;code&quot;</span>: <span class="built_in">str</span>&#125;)</span><br><span class="line">    df = df_pandas.copy()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 计算交易日缺口</span></span><br><span class="line">    _dt_all = pd.date_range(start=df[<span class="string">&#x27;date&#x27;</span>].iloc[<span class="number">0</span>], end=df[<span class="string">&#x27;date&#x27;</span>].iloc[-<span class="number">1</span>])</span><br><span class="line">    dt_all = [d.strftime(<span class="string">&quot;%Y-%m-%d&quot;</span>) <span class="keyword">for</span> d <span class="keyword">in</span> _dt_all]</span><br><span class="line">    trade_date = <span class="built_in">list</span>(df[<span class="string">&#x27;date&#x27;</span>].values)</span><br><span class="line">    dt_breaks = <span class="built_in">list</span>(<span class="built_in">set</span>(dt_all) - <span class="built_in">set</span>(trade_date))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 设置成交量颜色</span></span><br><span class="line">    df[<span class="string">&#x27;bar_color&#x27;</span>] = np.where(df[<span class="string">&#x27;close&#x27;</span>] - df[<span class="string">&#x27;open&#x27;</span>] &gt;= <span class="number">0</span>, <span class="string">&#x27;red&#x27;</span>, <span class="string">&#x27;green&#x27;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 过滤指定股票代码</span></span><br><span class="line">    df = df.loc[df[<span class="string">&#x27;code&#x27;</span>] == code]</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 布局与数据设置</span></span><br><span class="line">    layout = <span class="built_in">dict</span>(</span><br><span class="line">        title=<span class="string">f&quot;<span class="subst">&#123;fetch_stock_name(code)&#125;</span>(<span class="subst">&#123;code&#125;</span>)&quot;</span>,</span><br><span class="line">        hoversubplots=<span class="string">&quot;axis&quot;</span>,</span><br><span class="line">        hovermode=<span class="string">&quot;x unified&quot;</span>,</span><br><span class="line">        grid=<span class="built_in">dict</span>(rows=<span class="number">2</span>, columns=<span class="number">1</span>),</span><br><span class="line">        yaxis=<span class="built_in">dict</span>(domain=[<span class="number">0.25</span>, <span class="number">1</span>]),</span><br><span class="line">        yaxis2=<span class="built_in">dict</span>(domain=[<span class="number">0</span>, <span class="number">0.20</span>]),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    data = [</span><br><span class="line">        go.Candlestick(x=df[<span class="string">&quot;date&quot;</span>], <span class="built_in">open</span>=df[<span class="string">&#x27;open&#x27;</span>], high=df[<span class="string">&#x27;high&#x27;</span>], low=df[<span class="string">&#x27;low&#x27;</span>], close=df[<span class="string">&#x27;close&#x27;</span>],</span><br><span class="line">                       xaxis=<span class="string">&quot;x&quot;</span>, yaxis=<span class="string">&quot;y&quot;</span>, increasing_line_color=<span class="string">&#x27;red&#x27;</span>, decreasing_line_color=<span class="string">&#x27;green&#x27;</span>, name=<span class="string">&quot;&quot;</span>),</span><br><span class="line">        go.Bar(x=df[<span class="string">&#x27;date&#x27;</span>], y=df[<span class="string">&#x27;vol&#x27;</span>], xaxis=<span class="string">&quot;x&quot;</span>, yaxis=<span class="string">&quot;y2&quot;</span>,</span><br><span class="line">               marker_color=df[<span class="string">&#x27;bar_color&#x27;</span>], name=<span class="string">&quot;volume&quot;</span>)</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    fig = go.Figure(data=data, layout=layout)</span><br><span class="line">    fig.update_xaxes(rangebreaks=[<span class="built_in">dict</span>(values=dt_breaks)])</span><br><span class="line">    fig.update_layout(</span><br><span class="line">        hoverlabel=<span class="built_in">dict</span>(</span><br><span class="line">            bgcolor=<span class="string">&quot;white&quot;</span>,</span><br><span class="line">            font_size=<span class="number">12</span>,</span><br><span class="line">            font_family=<span class="string">&quot;Rockwell&quot;</span>,</span><br><span class="line">        ),</span><br><span class="line">        xaxis_rangeslider_visible=<span class="literal">False</span>,</span><br><span class="line">        showlegend=<span class="literal">False</span>,</span><br><span class="line">        yaxis_tickformat=<span class="string">&quot;.2f&quot;</span>,</span><br><span class="line">    )</span><br><span class="line">    fig.update_yaxes(hoverformat=<span class="string">&quot;.2f&quot;</span>, tickfont_size=<span class="number">8</span>)</span><br><span class="line">    <span class="keyword">return</span> fig</span><br></pre></td></tr></table></figure>
<ol type="1">
<li><strong>数据准备</strong>：读取数据并处理日期，将非交易日移除。</li>
<li><strong>布局配置</strong>：设置图表标题、图例、标签格式、颜色等，以便图表更具可读性。</li>
<li><strong>数据展示</strong>：生成 K 线图和成交量柱状图，颜色区分涨跌，<code>rangebreaks</code> 跳过非交易日。</li>
</ol>
<h3 id="initialize_data_table-函数"><code>initialize_data_table</code> 函数</h3>
<p><code>initialize_data_table</code> 函数设置 DataTable 的列信息，用于显示股票交易的明细信息。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">initialize_data_table</span>():</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    :return: data table columns.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    columns = [</span><br><span class="line">        &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;日期&#x27;</span>, <span class="string">&#x27;id&#x27;</span>: <span class="string">&#x27;日期&#x27;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;股票代码&#x27;</span>, <span class="string">&#x27;id&#x27;</span>: <span class="string">&#x27;股票代码&#x27;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;交易方向&#x27;</span>, <span class="string">&#x27;id&#x27;</span>: <span class="string">&#x27;交易方向&#x27;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;成交价格&#x27;</span>, <span class="string">&#x27;id&#x27;</span>: <span class="string">&#x27;成交价格&#x27;</span>&#125;,</span><br><span class="line">        &#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;成交数量&#x27;</span>, <span class="string">&#x27;id&#x27;</span>: <span class="string">&#x27;成交数量&#x27;</span>&#125;</span><br><span class="line">    ]</span><br><span class="line">    <span class="keyword">return</span> columns</span><br></pre></td></tr></table></figure>
<ul>
<li>返回列的字典列表，定义了 DataTable 中每列的标题和数据 ID。</li>
</ul>
<p>通过这些函数和布局结构，应用提供了股票的回测分析功能，包括 K 线图、成交量柱状图、交易记录等视图。</p>
<h2 id="回调函数">回调函数</h2>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># output tab content based on active tab and data in localstore</span></span><br><span class="line"><span class="meta">@app.callback(<span class="params"></span></span></span><br><span class="line"><span class="meta"><span class="params">    Output(<span class="params"><span class="string">&quot;tabs-content&quot;</span>, <span class="string">&quot;children&quot;</span></span>), </span></span></span><br><span class="line"><span class="meta"><span class="params">    Input(<span class="params"><span class="string">&quot;tabs&quot;</span>, <span class="string">&quot;active_tab&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params">    prevent_initial_call=<span class="literal">True</span>,    </span></span></span><br><span class="line"><span class="meta"><span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init_tab</span>(<span class="params">active_tab</span>):</span></span><br><span class="line">    <span class="keyword">if</span> active_tab == <span class="string">&#x27;tab-details&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> generate_tab_details_content()</span><br><span class="line">    <span class="keyword">elif</span> active_tab == <span class="string">&#x27;tab-summary&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> generate_tab_summary_content()</span><br><span class="line"><span class="comment"># output performance chart when active tab is &#x27;tab-summary&#x27;, if use &#x27;prevent_initial_call=True&#x27;, the callback will not be triggered</span></span><br><span class="line"><span class="meta">@app.callback(<span class="params"></span></span></span><br><span class="line"><span class="meta"><span class="params">    Output(<span class="params"><span class="string">&quot;performance-chart&quot;</span>, <span class="string">&quot;figure&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params">    Input(<span class="params"><span class="string">&quot;benchmark-day&quot;</span>, <span class="string">&quot;data&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params">    Input(<span class="params"><span class="string">&quot;asset&quot;</span>, <span class="string">&quot;data&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params">    Input(<span class="params"><span class="string">&quot;tabs&quot;</span>, <span class="string">&quot;active_tab&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params">    <span class="comment">#prevent_initial_call=True</span></span></span></span><br><span class="line"><span class="meta"><span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update_performance_chart</span>(<span class="params">benchmark_data, asset_data, active_tab</span>):</span></span><br><span class="line">    <span class="keyword">if</span> active_tab == <span class="string">&#x27;tab-summary&#x27;</span> <span class="keyword">and</span> benchmark_data <span class="keyword">and</span> asset_data:</span><br><span class="line">        <span class="keyword">return</span> generate_performance_chart(benchmark_data, asset_data)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> no_update</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="meta">@app.callback(<span class="params"></span></span></span><br><span class="line"><span class="meta"><span class="params">    Output(<span class="params"><span class="string">&quot;security-select&quot;</span>, <span class="string">&quot;options&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params">    Output(<span class="params"><span class="string">&quot;security-select&quot;</span>, <span class="string">&quot;value&quot;</span></span>),      </span></span></span><br><span class="line"><span class="meta"><span class="params">    Input(<span class="params"><span class="string">&quot;account-trade-history&quot;</span>, <span class="string">&quot;data&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params">    Input(<span class="params"><span class="string">&quot;tabs&quot;</span>, <span class="string">&quot;active_tab&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params">    <span class="comment">#prevent_initial_call=True,</span></span></span></span><br><span class="line"><span class="meta"><span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">output_code_selector</span>(<span class="params">data, active_tab</span>):</span>  </span><br><span class="line">    <span class="keyword">if</span> active_tab == <span class="string">&#x27;tab-details&#x27;</span> <span class="keyword">and</span> data:</span><br><span class="line">        df = pd.read_json(StringIO(data), orient=<span class="string">&#x27;split&#x27;</span>, dtype=&#123;<span class="string">&quot;股票代码&quot;</span>: <span class="built_in">str</span>&#125;)</span><br><span class="line">        stock_list = df[<span class="string">&#x27;股票代码&#x27;</span>].unique().tolist()</span><br><span class="line">        <span class="keyword">return</span> stock_list, stock_list[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">else</span>: </span><br><span class="line">        <span class="keyword">return</span> no_update</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.callback(<span class="params"></span></span></span><br><span class="line"><span class="meta"><span class="params">    Output(<span class="params"><span class="string">&quot;current-stock-trade-history&quot;</span>, <span class="string">&quot;data&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params">    Input(<span class="params"><span class="string">&quot;account-trade-history&quot;</span>, <span class="string">&quot;data&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params">    Input(<span class="params"><span class="string">&quot;security-select&quot;</span>, <span class="string">&quot;value&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params">    Input(<span class="params"><span class="string">&quot;tabs&quot;</span>, <span class="string">&quot;active_tab&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params">    prevent_initial_call=<span class="literal">True</span></span></span></span><br><span class="line"><span class="meta"><span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update_current_trade_history_table</span>(<span class="params">data, code, active_tab</span>):</span></span><br><span class="line">    <span class="keyword">if</span> active_tab == <span class="string">&#x27;tab-details&#x27;</span>:</span><br><span class="line">        df = pd.read_json(StringIO(data), orient=<span class="string">&#x27;split&#x27;</span>, dtype=&#123;<span class="string">&quot;股票代码&quot;</span>: <span class="built_in">str</span>&#125;)</span><br><span class="line">        df_tmp = df.loc[df[<span class="string">&#x27;股票代码&#x27;</span>]==code].reset_index()</span><br><span class="line">        data_table = df_tmp.to_dict(<span class="string">&#x27;records&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> data_table</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> no_update</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.callback(<span class="params"></span></span></span><br><span class="line"><span class="meta"><span class="params">    Output(<span class="params"><span class="string">&quot;stock-candle-chart&quot;</span>, <span class="string">&quot;figure&quot;</span></span>), </span></span></span><br><span class="line"><span class="meta"><span class="params">    Input(<span class="params"><span class="string">&quot;stock-day&quot;</span>, <span class="string">&quot;data&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params">    Input(<span class="params"><span class="string">&quot;security-select&quot;</span>, <span class="string">&quot;value&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params">    Input(<span class="params"><span class="string">&quot;tabs&quot;</span>, <span class="string">&quot;active_tab&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params">    prevent_initial_call=<span class="literal">True</span></span></span></span><br><span class="line"><span class="meta"><span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update_candle_stick_chart</span>(<span class="params">data, code, active_tab</span>):</span>  </span><br><span class="line">    <span class="keyword">if</span> active_tab == <span class="string">&#x27;tab-details&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> generate_stock_candle_chart(data, code)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> no_update</span><br></pre></td></tr></table></figure>
<p>这个代码片段通过 Dash 回调函数实现了一个多标签页的应用，展示了股票的相关数据分析。它包含五个主要回调函数，分别用于显示标签页内容、更新绩效图表、更新股票选择下拉菜单、更新交易记录表格以及更新 K 线图。每个回调函数通过 <code>active_tab</code> 输入来控制在不同标签页下显示不同的内容。</p>
<h3 id="init_tab-回调函数"><code>init_tab</code> 回调函数</h3>
<p>该函数根据当前激活的标签页决定显示的内容：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@app.callback(<span class="params"></span></span></span><br><span class="line"><span class="meta"><span class="params">    Output(<span class="params"><span class="string">&quot;tabs-content&quot;</span>, <span class="string">&quot;children&quot;</span></span>), </span></span></span><br><span class="line"><span class="meta"><span class="params">    Input(<span class="params"><span class="string">&quot;tabs&quot;</span>, <span class="string">&quot;active_tab&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params">    prevent_initial_call=<span class="literal">True</span>,    </span></span></span><br><span class="line"><span class="meta"><span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init_tab</span>(<span class="params">active_tab</span>):</span></span><br><span class="line">    <span class="keyword">if</span> active_tab == <span class="string">&#x27;tab-details&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> generate_tab_details_content()</span><br><span class="line">    <span class="keyword">elif</span> active_tab == <span class="string">&#x27;tab-summary&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> generate_tab_summary_content()</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>功能</strong>：当用户切换到 <code>tab-details</code> 时显示“交易明细”内容，切换到 <code>tab-summary</code> 时显示“绩效分析”内容。</li>
<li><strong>参数</strong>：
<ul>
<li><code>active_tab</code>：当前选中的标签。</li>
<li><code>prevent_initial_call=True</code>：回调不会在应用首次加载时触发，仅在用户操作（切换标签）时触发。</li>
</ul></li>
</ul>
<h3 id="update_performance_chart-回调函数"><code>update_performance_chart</code> 回调函数</h3>
<p>该回调在切换到绩效分析页且存在基准和资产数据时生成绩效图表：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@app.callback(<span class="params"></span></span></span><br><span class="line"><span class="meta"><span class="params">    Output(<span class="params"><span class="string">&quot;performance-chart&quot;</span>, <span class="string">&quot;figure&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params">    Input(<span class="params"><span class="string">&quot;benchmark-day&quot;</span>, <span class="string">&quot;data&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params">    Input(<span class="params"><span class="string">&quot;asset&quot;</span>, <span class="string">&quot;data&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params">    Input(<span class="params"><span class="string">&quot;tabs&quot;</span>, <span class="string">&quot;active_tab&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update_performance_chart</span>(<span class="params">benchmark_data, asset_data, active_tab</span>):</span></span><br><span class="line">    <span class="keyword">if</span> active_tab == <span class="string">&#x27;tab-summary&#x27;</span> <span class="keyword">and</span> benchmark_data <span class="keyword">and</span> asset_data:</span><br><span class="line">        <span class="keyword">return</span> generate_performance_chart(benchmark_data, asset_data)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> no_update</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>功能</strong>：在 <code>tab-summary</code> 标签页选中并且 <code>benchmark-day</code> 和 <code>asset</code> 数据不为空时，调用 <code>generate_performance_chart</code> 生成绩效图表。</li>
<li><strong>返回值</strong>：如果条件不满足，则返回 <code>no_update</code>，图表保持不变。</li>
</ul>
<h3 id="output_code_selector-回调函数"><code>output_code_selector</code> 回调函数</h3>
<p>此回调为 <code>security-select</code> 下拉菜单提供选项：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@app.callback(<span class="params"></span></span></span><br><span class="line"><span class="meta"><span class="params">    Output(<span class="params"><span class="string">&quot;security-select&quot;</span>, <span class="string">&quot;options&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params">    Output(<span class="params"><span class="string">&quot;security-select&quot;</span>, <span class="string">&quot;value&quot;</span></span>),      </span></span></span><br><span class="line"><span class="meta"><span class="params">    Input(<span class="params"><span class="string">&quot;account-trade-history&quot;</span>, <span class="string">&quot;data&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params">    Input(<span class="params"><span class="string">&quot;tabs&quot;</span>, <span class="string">&quot;active_tab&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">output_code_selector</span>(<span class="params">data, active_tab</span>):</span>  </span><br><span class="line">    <span class="keyword">if</span> active_tab == <span class="string">&#x27;tab-details&#x27;</span> <span class="keyword">and</span> data:</span><br><span class="line">        df = pd.read_json(StringIO(data), orient=<span class="string">&#x27;split&#x27;</span>, dtype=&#123;<span class="string">&quot;股票代码&quot;</span>: <span class="built_in">str</span>&#125;)</span><br><span class="line">        stock_list = df[<span class="string">&#x27;股票代码&#x27;</span>].unique().tolist()</span><br><span class="line">        <span class="keyword">return</span> stock_list, stock_list[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">else</span>: </span><br><span class="line">        <span class="keyword">return</span> no_update</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>功能</strong>：当用户在 <code>tab-details</code> 页面中时，根据 <code>account-trade-history</code> 数据设置 <code>security-select</code> 下拉菜单的选项。</li>
<li><strong>参数</strong>：
<ul>
<li><code>account-trade-history</code>：包含交易记录数据的 <code>dcc.Store</code> 数据。</li>
<li><strong>返回值</strong>：股票列表和默认选中的股票代码。若条件不满足则返回 <code>no_update</code>。</li>
</ul></li>
</ul>
<h3 id="update_current_trade_history_table-回调函数"><code>update_current_trade_history_table</code> 回调函数</h3>
<p>此回调函数更新 <code>current-stock-trade-history</code> 表格内容：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@app.callback(<span class="params"></span></span></span><br><span class="line"><span class="meta"><span class="params">    Output(<span class="params"><span class="string">&quot;current-stock-trade-history&quot;</span>, <span class="string">&quot;data&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params">    Input(<span class="params"><span class="string">&quot;account-trade-history&quot;</span>, <span class="string">&quot;data&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params">    Input(<span class="params"><span class="string">&quot;security-select&quot;</span>, <span class="string">&quot;value&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params">    Input(<span class="params"><span class="string">&quot;tabs&quot;</span>, <span class="string">&quot;active_tab&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params">    prevent_initial_call=<span class="literal">True</span></span></span></span><br><span class="line"><span class="meta"><span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update_current_trade_history_table</span>(<span class="params">data, code, active_tab</span>):</span></span><br><span class="line">    <span class="keyword">if</span> active_tab == <span class="string">&#x27;tab-details&#x27;</span>:</span><br><span class="line">        df = pd.read_json(StringIO(data), orient=<span class="string">&#x27;split&#x27;</span>, dtype=&#123;<span class="string">&quot;股票代码&quot;</span>: <span class="built_in">str</span>&#125;)</span><br><span class="line">        df_tmp = df.loc[df[<span class="string">&#x27;股票代码&#x27;</span>]==code].reset_index()</span><br><span class="line">        data_table = df_tmp.to_dict(<span class="string">&#x27;records&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> data_table</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> no_update</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>功能</strong>：当用户切换到 <code>tab-details</code> 页面时，通过 <code>security-select</code> 选中的股票代码过滤交易记录数据，并显示该股票的交易记录。</li>
<li><strong>参数</strong>：
<ul>
<li><code>account-trade-history</code>：包含全部交易数据。</li>
<li><code>security-select</code>：当前选中的股票代码。</li>
<li><strong>返回值</strong>：过滤后的交易记录，以字典列表的格式返回给 <code>current-stock-trade-history</code> 表格。</li>
</ul></li>
</ul>
<h3 id="update_candle_stick_chart-回调函数"><code>update_candle_stick_chart</code> 回调函数</h3>
<p>该函数更新股票的 K 线图，显示选中股票的日 K 线数据：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@app.callback(<span class="params"></span></span></span><br><span class="line"><span class="meta"><span class="params">    Output(<span class="params"><span class="string">&quot;stock-candle-chart&quot;</span>, <span class="string">&quot;figure&quot;</span></span>), </span></span></span><br><span class="line"><span class="meta"><span class="params">    Input(<span class="params"><span class="string">&quot;stock-day&quot;</span>, <span class="string">&quot;data&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params">    Input(<span class="params"><span class="string">&quot;security-select&quot;</span>, <span class="string">&quot;value&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params">    Input(<span class="params"><span class="string">&quot;tabs&quot;</span>, <span class="string">&quot;active_tab&quot;</span></span>),</span></span></span><br><span class="line"><span class="meta"><span class="params">    prevent_initial_call=<span class="literal">True</span></span></span></span><br><span class="line"><span class="meta"><span class="params"></span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update_candle_stick_chart</span>(<span class="params">data, code, active_tab</span>):</span>  </span><br><span class="line">    <span class="keyword">if</span> active_tab == <span class="string">&#x27;tab-details&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> generate_stock_candle_chart(data, code)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> no_update</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>功能</strong>：在 <code>tab-details</code> 标签页选中时，读取 <code>stock-day</code> 数据生成股票的 K 线图。</li>
<li><strong>参数</strong>：
<ul>
<li><code>stock-day</code>：包含日 K 线数据的 <code>dcc.Store</code> 数据。</li>
<li><code>security-select</code>：用户选中的股票代码，用于从 <code>stock-day</code> 中筛选数据。</li>
</ul></li>
<li><strong>返回值</strong>：返回生成的 K 线图图表对象，若条件不满足则返回 <code>no_update</code>。</li>
</ul>
<h3 id="总结">总结</h3>
<p>这个代码片段通过多个回调实现了多标签页数据展示功能： - <code>init_tab</code> 控制标签页内容。 - <code>update_performance_chart</code> 和 <code>update_candle_stick_chart</code> 根据选中的标签页动态更新图表。 - <code>output_code_selector</code> 和 <code>update_current_trade_history_table</code> 在“交易明细”页面动态生成股票选择和交易记录表格内容。</p>
<h1 id="效果展示">效果展示</h1>
<p><img src="https://s2.loli.net/2024/11/14/iXryhwnW1HGPzFc.gif" /></p>
]]></content>
      <categories>
        <category>量化交易</category>
      </categories>
      <tags>
        <tag>python</tag>
        <tag>dash</tag>
        <tag>plotly</tag>
      </tags>
  </entry>
  <entry>
    <title>阿尔法收益(α)</title>
    <url>/2024/11/12/%E9%98%BF%E5%B0%94%E6%B3%95%E6%94%B6%E7%9B%8A(%CE%B1)/</url>
    <content><![CDATA[<p><strong>阿尔法 (Alpha)</strong><br />
<code>Alpha</code> 或 <span class="math inline">\(\alpha\)</span>，指的是一种投资相对于基准指数或市场基准的超额收益。Alpha 是投资策略成功与否的指标之一，反映了投资经理或投资策略在控制风险的前提下，相比基准市场（如标普 500 指数、沪深 300 等）创造的额外价值。 在金融分析中，<strong>Alpha 收益</strong>（Alpha Return）指的是一种投资相对于基准指数或市场基准的超额收益。Alpha 是投资策略成功与否的指标之一，反映了投资经理或投资策略在控制风险的前提下，相比基准市场（如标普 500 指数、沪深 300 等）创造的额外价值。</p>
<h3 id="alpha-的定义">Alpha 的定义</h3>
<p>Alpha 的计算公式如下：</p>
<blockquote>
<p><span class="math inline">\(\large \begin{equation} \alpha = R_p - (R_f + \beta \times (R_m - R_f)) \end{equation}\)</span></p>
</blockquote>
<p>其中： - <span class="math inline">\(R_p\)</span> 是投资组合的总收益率； - <span class="math inline">\(R_f\)</span> 是无风险利率； - <span class="math inline">\(\beta\)</span> 是投资组合对市场波动的敏感度，表示该组合的系统性风险； - <span class="math inline">\(R_m\)</span> 是基准市场的收益率。</p>
<p>Alpha 代表了在控制了市场波动（即 Beta）的基础上，投资组合还能产生多少超额收益。这个超额收益体现了投资策略的有效性，也可以被视为投资经理增加的附加价值。</p>
<h3 id="alpha-的意义">Alpha 的意义</h3>
<table>
<thead>
<tr class="header">
<th>α范围</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>α=0</td>
<td>表明该投资策略准确地反映其内在价值</td>
</tr>
<tr class="even">
<td>α&gt;0</td>
<td>表明投资策略在一定的风险水平下跑赢了基准，显示出超额收益。</td>
</tr>
<tr class="odd">
<td>α&lt;0</td>
<td>表明该投资策略未能跑赢基准指数，收益不理想。</td>
</tr>
</tbody>
</table>
<p><strong>Alpha 的大小</strong>：Alpha 越高，说明投资策略的效果越显著，其回报越高，通常是投资经理投资能力的体现。</p>
<h3 id="alpha-收益在投资策略中的应用">Alpha 收益在投资策略中的应用</h3>
<ul>
<li><strong>业绩评估</strong>：用于衡量投资经理或基金的表现，看其是否能够在控制风险的前提下为投资者带来超额收益。</li>
<li><strong>策略优化</strong>：通过分析 Alpha，可以改进投资策略，找出在特定市场条件下的最佳组合。</li>
<li><strong>风险管理</strong>：与 Beta 收益不同，Alpha 收益反映的是对特定市场条件的相对表现，帮助管理特定市场风险。</li>
</ul>
<p>简而言之，Alpha 收益是投资策略的一个关键表现指标，用于衡量相对于市场的主动管理效果，是投资管理中分析和评估超额收益的重要工具。</p>
<h3 id="计算实例">计算实例</h3>
<p>使用 MACD 金叉死叉策略回测，时间段为 <code>2024-01-05</code> 至 <code>2024-10-23</code>。基准市场为沪深300。十年期国债收益率为 2.25%。</p>
<h4 id="从数据库载入回测账户数据">从数据库载入回测账户数据</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> sf_account.account <span class="keyword">import</span> Account</span><br><span class="line"></span><br><span class="line">account = <span class="string">&#x27;test&#x27;</span></span><br><span class="line">portfolio = <span class="string">&#x27;s-pandas-qfq&#x27;</span></span><br><span class="line">acc = Account(account_cookie=account, portfolio_cookie=portfolio)</span><br><span class="line">df_asset = acc.assets.get(<span class="string">&#x27;asset&#x27;</span>).reset_index()</span><br><span class="line">return_asset = df_asset[<span class="string">&#x27;balance&#x27;</span>] / (asset_init_cash * <span class="number">1.0</span>) - <span class="number">1</span></span><br></pre></td></tr></table></figure>
<h4 id="载入基准沪深-300-同时间段行情数据">载入基准沪深 300 同时间段行情数据</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> sf_query.query <span class="keyword">import</span> fetch_index_day</span><br><span class="line"></span><br><span class="line">df_hs300 = fetch_index_day(</span><br><span class="line">    [<span class="string">&#x27;000300&#x27;</span>], acc.start_date, acc.end_date, dataset_type=<span class="string">&#x27;pandas&#x27;</span>).reset_index()</span><br><span class="line">return_hs300 = df_hs300[<span class="string">&#x27;close&#x27;</span>] / df_hs300[<span class="string">&#x27;close&#x27;</span>].iloc[<span class="number">0</span>] - <span class="number">1</span></span><br></pre></td></tr></table></figure>
<h4 id="计算β值">计算β值</h4>
<p>Beta 系数计算方式如下：</p>
<blockquote>
<p><span class="math inline">\(\large \begin{equation} \beta_i = \frac{标的资产 i 的收益与市场收益的协方差}{市场收益的方差} = \frac{Cov (r_i, r_m)}{\sigma_m^2} \end{equation}\)</span></p>
</blockquote>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 计算两者的协方差</span></span><br><span class="line">covr = return_asset.cov(return_hs300)</span><br><span class="line"><span class="comment"># 计算沪深300指数数据的方差, pandas计算的为样本方差</span></span><br><span class="line">var = return_hs300.var()</span><br><span class="line"><span class="comment"># 计算贝塔值</span></span><br><span class="line">beta = covr / var</span><br><span class="line">print(<span class="string">&quot;Covariance:&#123;&#125;,Variance:&#123;&#125;,Beta:&#123;&#125;&quot;</span>.<span class="built_in">format</span>(covr, var, beta))</span><br></pre></td></tr></table></figure>
<p>输出为：<strong><em>Covariance: 3.996268373876412e-05,Variance: 0.0031905766470259685,Beta: 0.012525222917310114</em></strong></p>
<h4 id="计算α值">计算α值</h4>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">rp = annual_return_portfolio</span><br><span class="line">rf = <span class="number">0.0225</span></span><br><span class="line">rm = annual_return_hs300</span><br><span class="line">alpha = rp - (rf + beta * (rm - rf))</span><br><span class="line">print(<span class="string">f&quot;Alpha:<span class="subst">&#123;alpha&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>输出为：<strong><em>Alpha:-0.01486024492682044</em></strong></p>
<h1 id="参考">参考</h1>
<p>【1】 <a href="https://nokiasonic.github.io/2021/07/16/%E3%80%90Python%E3%80%91Pandas%E4%B8%8Enumpy%E7%9A%84%E6%96%B9%E5%B7%AE%E8%AE%A1%E7%AE%97/">【Python】Pandas与numpy的方差计算 | 橘子树下</a></p>
<p>【2】 <a href="https://nokiasonic.github.io/2021/07/16/%E3%80%90Python%E3%80%91Pandas%E4%B9%8Bdataframe%E4%B8%8Eseries%E7%9A%84%E5%8D%8F%E6%96%B9%E5%B7%AE%E8%AE%A1%E7%AE%97/">【Python】Pandas之dataframe与series的协方差计算 | 橘子树下</a></p>
]]></content>
      <categories>
        <category>xxxx</category>
      </categories>
      <tags>
        <tag>xxxx/xxx</tag>
      </tags>
  </entry>
</search>
